{
  "sourceUrl": "https://medium.com/feed/airbnb-engineering",
  "title": "The Airbnb Tech Blog - Medium",
  "description": "Creative engineers and data scientists building a world where you can belong anywhere. http://airbnb.io - Medium",
  "link": "https://medium.com/airbnb-engineering?source=rss----53c7c27702d5---4",
  "items": [
    {
      "title": "ä»é™æ€é™æµåˆ°Airbnbé”®å€¼å­˜å‚¨ä¸­çš„è‡ªé€‚åº”æµé‡ç®¡ç† (åŸæ ‡é¢˜: From Static Rate Limiting to Adaptive Traffic Management in Airbnbâ€™s Key-Value Store)",
      "link": "https://medium.com/airbnb-engineering/from-static-rate-limiting-to-adaptive-traffic-management-in-airbnbs-key-value-store-29362764e5c2?source=rss----53c7c27702d5---4",
      "pubDate": "Thu, 09 Oct 2025 16:01:55 GMT",
      "isoDate": "2025-10-09T16:01:55.000Z",
      "creator": "Shravan Gaonkar",
      "summary": "Airbnbçš„é”®å€¼å­˜å‚¨Musselå·²ä»ç®€å•çš„é™æ€é™æµç³»ç»Ÿæ¼”è¿›ä¸ºå¤šå±‚çº§çš„è‡ªé€‚åº”æµé‡ç®¡ç†æ–¹æ¡ˆï¼Œä»¥ç¡®ä¿åœ¨æµé‡é«˜å³°ã€æ‰¹é‡ä¸Šä¼ ã€æœºå™¨äººæ”»å‡»æˆ–DDoSæ”»å‡»ç­‰å¤æ‚åœºæ™¯ä¸‹çš„å¿«é€Ÿå’Œå¯é æ€§ã€‚\n\n# Musselæµé‡ç®¡ç†æ¼”è¿›æ¦‚è¿°\n\nMusselä½œä¸ºAirbnbæ ¸å¿ƒæœåŠ¡çš„å…³é”®ç»„ä»¶ï¼Œå¤„ç†æ‰€æœ‰è¯·æ±‚ã€‚å…¶æ—©æœŸQoSç³»ç»Ÿä¾èµ–äºåŸºäºRedisçš„é™æ€QPSé™æµï¼Œä¸»è¦ç›®æ ‡æ˜¯é˜²æ­¢æœåŠ¡å´©æºƒã€‚ç„¶è€Œï¼Œéšç€æœåŠ¡æˆç†Ÿï¼Œç›®æ ‡è½¬å‘äº†æœ€å¤§åŒ–â€œæœ‰æ•ˆååé‡â€ï¼ˆgoodputï¼‰ï¼Œå³åœ¨ä¸é™ä½æ€§èƒ½çš„å‰æä¸‹å®Œæˆæœ€å¤šæœ‰ç”¨çš„å·¥ä½œã€‚è¿™ä¿ƒä½¿Airbnbå¼€å‘äº†ä¸€ä¸ªè‡ªé€‚åº”çš„QoSç³»ç»Ÿï¼Œè¯¥ç³»ç»Ÿèƒ½å¤Ÿè‡ªåŠ¨æ–½åŠ ä¼˜å…ˆèƒŒå‹ã€‚\n\n![å›¾ç‰‡ 1](https://cdn-images-1.medium.com/max/1024/1*kBx_8QLd7El4TZ2nrouYUw.jpeg)\n\n# æ–°å¢çš„QoSå±‚çº§\n\nä¸ºå®ç°è‡ªé€‚åº”æµé‡ç®¡ç†å’Œæœ€å¤§åŒ–æœ‰æ•ˆååé‡ï¼ŒMusselçš„QoSç³»ç»Ÿå¢åŠ äº†ä»¥ä¸‹å‡ ä¸ªæ–°å±‚çº§ï¼š\n\n1.  **èµ„æºæ„ŸçŸ¥é™æµ (RARC)**ï¼šæ ¹æ®è¯·æ±‚çš„å®é™…èµ„æºæ¶ˆè€—ï¼ˆå¦‚è¡Œæ•°ã€å­—èŠ‚å’Œå»¶è¿Ÿï¼‰è€Œéç®€å•çš„è¯·æ±‚è®¡æ•°æ¥è®¡è´¹ã€‚\n2.  **åˆ†çº§è´Ÿè½½å¸è½½**ï¼šåœ¨å®¹é‡ä¸è¶³æ—¶ï¼Œä¼˜å…ˆä¿éšœé«˜ä¼˜å…ˆçº§æµé‡ï¼ˆå¦‚å®¢æˆ·æ”¯æŒã€ä¿¡ä»»ä¸å®‰å…¨ï¼‰çš„å“åº”æ€§ã€‚\n3.  **çƒ­é”®æ£€æµ‹ä¸DDoSç¼“è§£**ï¼šå®æ—¶æ£€æµ‹è®¿é—®æ¨¡å¼å€¾æ–œï¼Œå¹¶é€šè¿‡ç¼“å­˜æˆ–åˆå¹¶é‡å¤è¯·æ±‚æ¥ä¿æŠ¤åç«¯å­˜å‚¨å±‚ã€‚\n\n# é™æ€å®¢æˆ·ç«¯é…é¢é™æµçš„å±€é™æ€§\n\nMusselæœ€åˆçš„é™æµç³»ç»Ÿç®€å•ä¸”æ˜“äºæ“ä½œï¼Œä¸ºæ¯ä¸ªè°ƒç”¨è€…è®¾ç½®é™æ€çš„æ¯åˆ†é’ŸQPSé…é¢ã€‚ç„¶è€Œï¼Œéšç€ç³»ç»Ÿé‡‡ç”¨ç‡çš„å¢é•¿ï¼Œå…¶å±€é™æ€§é€æ¸æ˜¾ç°ï¼š\n\n*   **æˆæœ¬å·®å¼‚**ï¼šä¸€ä¸ªå•è¡ŒæŸ¥è¯¢å’Œä¸€ä¸ªåä¸‡è¡Œæ‰«æè¢«è§†ä¸ºç›¸åŒçš„æˆæœ¬ï¼Œæœªèƒ½åæ˜ å…¶å¯¹åç«¯è´Ÿè½½çš„å·¨å¤§å·®å¼‚ã€‚\n*   **æµé‡å€¾æ–œ**ï¼šæ— æ³•è¯†åˆ«â€œçƒ­é”®â€é—®é¢˜ã€‚å½“ä¸€ä¸ªé”®è¢«å¤§é‡ä¸åŒè°ƒç”¨è€…åŒæ—¶è®¿é—®æ—¶ï¼Œå³ä½¿æ¯ä¸ªè°ƒç”¨è€…éƒ½åœ¨å…¶é…é¢å†…ï¼Œèšåˆæµé‡ä»å¯èƒ½ä½¿åº•å±‚å­˜å‚¨åˆ†ç‰‡è¿‡è½½ï¼Œå¯¼è‡´å±€éƒ¨ç“¶é¢ˆå¹¶å½±å“æ•´ä¸ªé›†ç¾¤çš„æ€§èƒ½ã€‚\n\nè¿™äº›å±€é™æ€§ä¿ƒä½¿Airbnbä»â€œè¯·æ±‚è®¡æ•°â€æ€ç»´è½¬å‘â€œèµ„æºæ ¸ç®—â€æ€ç»´ã€‚\n\n![å›¾ç‰‡ 2](https://cdn-images-1.medium.com/max/1024/1*XVDMQb8i2pQEUogiZipFbQ.jpeg)\n\n# èµ„æºæ„ŸçŸ¥é™æµ (RARC)\n\nRARCé€šè¿‡å¼•å…¥â€œè¯·æ±‚å•ä½â€ï¼ˆRUï¼‰æ¥è§£å†³æˆæœ¬å·®å¼‚é—®é¢˜ã€‚RUçš„è®¡ç®—ç»¼åˆäº†å››ä¸ªå¯è§‚æµ‹å› ç´ ï¼š\n\n*   å›ºå®šçš„æ¯æ¬¡è°ƒç”¨å¼€é”€\n*   å¤„ç†çš„è¡Œæ•°\n*   è´Ÿè½½å­—èŠ‚æ•°\n*   **å…³é”®çš„å»¶è¿Ÿ**ï¼šå»¶è¿Ÿèƒ½å¤Ÿåæ˜ ç¼“å­˜å‘½ä¸­ä¸ç£ç›˜è®¿é—®ç­‰ä¸åŒæˆæœ¬ã€‚\n\nRUçš„è®¡ç®—å…¬å¼ç¤ºä¾‹ï¼š\n*   `RU_read = 1 + w_r Ã— bytes_read + w_l Ã— latency_ms`\n*   `RU_write = 6 + w_b Ã— bytes_written / 4096 bytes + w_l Ã— latency_ms`\n\næ¯ä¸ªè°ƒåº¦å™¨ä½¿ç”¨ä¸€ä¸ªæœ¬åœ°ä»¤ç‰Œæ¡¶æ¥ç®¡ç†RUé…é¢ï¼Œå¹¶æ ¹æ®è¯·æ±‚çš„RUæˆæœ¬è¿›è¡Œæ‰£é™¤ã€‚å½“ä»¤ç‰Œæ¡¶ä¸ºç©ºæ—¶ï¼Œè¯·æ±‚å°†è¢«æ‹’ç»ï¼ˆHTTP 419ï¼‰ã€‚åç«¯å»¶è¿Ÿä¼šå½±å“è´Ÿè½½å¸è½½å±‚ï¼Œè€ŒéRUçš„å‘¨æœŸæ€§è¡¥å……ï¼Œè¿™ä½¿å¾—é™æµæ ¸ç®—ä¿æŒç®€å•ï¼ŒåŒæ—¶èƒ½å¿«é€Ÿå“åº”å­˜å‚¨å±‚çš„å‹åŠ›ã€‚\n\n![å›¾ç‰‡ 3](https://cdn-images-1.medium.com/max/1024/1*VuIeZSMzyRqXuXpfSzM_yg.jpeg)\n\n# è´Ÿè½½å¸è½½ï¼šåº”å¯¹å¿«é€Ÿå˜åŒ–çš„å®¹é‡é—®é¢˜\n\nRARCåœ¨ç§’çº§å°ºåº¦ä¸Šè°ƒæ•´ï¼Œä½†æ— æ³•åº”å¯¹æ›´å¿«çš„è´Ÿè½½å˜åŒ–ã€‚è´Ÿè½½å¸è½½å±‚é€šè¿‡ç»“åˆä¸‰ä¸ªå®æ—¶ä¿¡å·æ¥å¼¥è¡¥è¿™ä¸€ä¸è¶³ï¼š\n\n1.  **æµé‡å…³é”®æ€§**ï¼šæ ¹æ®é¢„å®šä¹‰çš„ä¼˜å…ˆçº§ï¼Œç¡®ä¿é«˜ä¼˜å…ˆçº§æµé‡åœ¨å®¹é‡ç´§å¼ æ—¶ä»èƒ½å“åº”ã€‚\n2.  **å»¶è¿Ÿæ¯”ç‡**ï¼šå®æ—¶ç³»ç»Ÿå‹åŠ›æŒ‡æ ‡ï¼Œé€šè¿‡é•¿æœŸp95å»¶è¿Ÿé™¤ä»¥çŸ­æœŸp95å»¶è¿Ÿè®¡ç®—ã€‚æ¯”ç‡è¶‹è¿‘0.3è¡¨ç¤ºå»¶è¿Ÿæ€¥å‰§ä¸Šå‡ã€‚å½“è¾¾åˆ°é˜ˆå€¼æ—¶ï¼Œè°ƒåº¦å™¨ä¼šæš‚æ—¶å¢åŠ æŒ‡å®šå®¢æˆ·ç«¯ç±»åˆ«çš„RUæˆæœ¬ï¼ŒåŠ é€Ÿå…¶ä»¤ç‰Œæ¡¶è€—å°½ï¼Œä»è€Œé™ä½è¯·æ±‚é€Ÿç‡ã€‚è¯¥æ¯”ç‡ä½¿ç”¨PÂ²ç®—æ³•è®¡ç®—ã€‚\n3.  **CoDelå¯å‘å¼æ’é˜Ÿç­–ç•¥**ï¼šç›‘æ§è¯·æ±‚åœ¨è°ƒåº¦å™¨å†…éƒ¨é˜Ÿåˆ—çš„ç­‰å¾…æ—¶é—´ã€‚å¦‚æœç­‰å¾…æ—¶é—´è¿‡é•¿è¡¨æ˜ç³»ç»Ÿå·²é¥±å’Œï¼Œè¯·æ±‚å°†æå‰å¤±è´¥ï¼Œé‡Šæ”¾å†…å­˜å’Œçº¿ç¨‹ã€‚\n\nè¿™äº›æœºåˆ¶ååŒå·¥ä½œï¼Œä½¿Musselåœ¨åç«¯å‡ºç°é—®é¢˜æ—¶èƒ½å°†æ¢å¤æ—¶é—´ç¼©çŸ­çº¦ä¸€åŠï¼Œå¹¶ä½¿è°ƒåº¦å™¨æ— éœ€äººå·¥å¹²é¢„å³å¯ä¿æŒç¨³å®šã€‚\n\n![å›¾ç‰‡ 4](https://cdn-images-1.medium.com/max/1024/1*GWv-z2hXM6RiW6sRJKzYCg.png)\n\n# çƒ­é”®æ£€æµ‹ä¸DDoSé˜²å¾¡\n\nRUé™æµå’Œè´Ÿè½½å¸è½½æ— æ³•æœ‰æ•ˆé˜»æ­¢é’ˆå¯¹å•ä¸ªè®°å½•çš„å¤§é‡ç›¸åŒè¯»å–è¯·æ±‚ï¼ˆå¦‚çƒ­é—¨åˆ—è¡¨ã€çˆ¬è™«æˆ–DDoSæ”»å‡»ï¼‰ã€‚Musselé€šè¿‡ä¸‰æ­¥çƒ­é”®é˜²å¾¡å±‚æ¥è§£å†³æ­¤é—®é¢˜ï¼š\n\n1.  **å®æ—¶æ£€æµ‹**ï¼šæ¯ä¸ªè°ƒåº¦å™¨ä½¿ç”¨å†…å­˜ä¸­çš„top-kè®¡æ•°å™¨ï¼ˆSpace-Savingç®—æ³•å˜ä½“ï¼‰å®æ—¶è¿½è¸ªæœ€çƒ­é—¨çš„é”®ã€‚\n2.  **æœ¬åœ°ç¼“å­˜**ï¼šå½“ä¸€ä¸ªé”®è¾¾åˆ°â€œçƒ­â€é˜ˆå€¼æ—¶ï¼Œè°ƒåº¦å™¨ä¼šä»è¿›ç¨‹æœ¬åœ°çš„LRUç¼“å­˜ä¸­æä¾›æœåŠ¡ï¼Œæ¡ç›®åœ¨å¤§çº¦ä¸‰ç§’åè¿‡æœŸã€‚\n3.  **è¯·æ±‚åˆå¹¶**ï¼šå¯¹äºç¼“å­˜æœªå‘½ä¸­ï¼Œè°ƒåº¦å™¨ä¼šè·Ÿè¸ªæ­£åœ¨è¿›è¡Œçš„è¯»å–è¯·æ±‚ï¼Œæ–°åˆ°è¾¾çš„ç›¸åŒè¯·æ±‚ä¼šé™„åŠ åˆ°å¾…å¤„ç†çš„Futureä¸Šï¼Œç¬¬ä¸€ä¸ªåç«¯å“åº”ä¼šæ‰‡å‡ºç»™æ‰€æœ‰ç­‰å¾…è€…ã€‚è¿™ç¡®ä¿äº†é€šå¸¸æ¯ä¸ªçƒ­é”®æ¯ä¸ªè°ƒåº¦å™¨Podåªæœ‰ä¸€ä¸ªè¯·æ±‚åˆ°è¾¾å­˜å‚¨å±‚ã€‚\n\nåœ¨ä¸€æ¬¡æ¨¡æ‹ŸDDoSæ¼”ç»ƒä¸­ï¼Œé’ˆå¯¹å°‘é‡é”®çš„ç™¾ä¸‡QPSè§„æ¨¡çªå‘æµé‡è¢«çƒ­é”®å±‚å‹ç¼©åˆ°æä½æ°´å¹³ï¼Œåç«¯æœªå—åˆ°å½±å“ã€‚\n\n![å›¾ç‰‡ 5](https://cdn-images-1.medium.com/max/1024/1*DuwP-cqJEnQcbD64RGUTYA.png)\n\n# å›é¡¾ä¸å…³é”®å¯ç¤º\n\n*   **æ—©æœŸå¯è§æˆæœçš„ä»·å€¼**ï¼šRARCçš„æ—©æœŸéƒ¨ç½²éªŒè¯äº†æ¦‚å¿µï¼Œä¸ºåç»­æ›´æ·±å±‚æ¬¡çš„æ”¹è¿›å¥ å®šäº†åŸºç¡€ã€‚\n*   **åå¥½æœ¬åœ°æ§åˆ¶å¾ªç¯**ï¼šæ‰€æœ‰å…³é”®ä¿¡å·ï¼ˆPÂ²å»¶è¿Ÿåˆ†ä½æ•°ã€Space-Saving top-kè®¡æ•°å™¨ã€CoDelé˜Ÿåˆ—å»¶è¿Ÿï¼‰éƒ½åœ¨æ¯ä¸ªè°ƒåº¦å™¨å†…éƒ¨è¿è¡Œï¼Œæ— éœ€è·¨èŠ‚ç‚¹åè°ƒï¼Œå®ç°äº†çº¿æ€§æ‰©å±•ï¼Œå³ä½¿æ§åˆ¶å¹³é¢å—å‹ä¹Ÿèƒ½ä¿æŠ¤å®¹é‡ã€‚\n*   **åˆ†æ—¶å°ºåº¦çš„æœ‰æ•ˆä¿æŠ¤**ï¼šRUå®šä»·å¤„ç†å¾®çªå‘ï¼Œè€Œå»¶è¿Ÿæ¯”ç‡å’ŒCoDelé˜Ÿåˆ—é˜ˆå€¼å“åº”å®è§‚å‡é€Ÿã€‚ä¸¤è€…ç»“åˆæ‰èƒ½æœ‰æ•ˆåº”å¯¹å„ç§å†²å‡»ã€‚\n*   **QoSæ˜¯ä¸€ä¸ªæ´»çš„ç³»ç»Ÿ**ï¼šæµé‡æ¨¡å¼ã€åç«¯èƒ½åŠ›å’Œæ–°å·¥ä½œè´Ÿè½½ä¸æ–­æ¼”å˜ã€‚æœªæ¥çš„è®¡åˆ’åŒ…æ‹¬æ•°æ®åº“åŸç”Ÿèµ„æºç»„å’ŒåŸºäºå†å²ä½¿ç”¨æ›²çº¿çš„è‡ªåŠ¨é…é¢è°ƒæ•´ã€‚æŒ‡å¯¼åŸåˆ™æ˜¯ï¼šè¡¡é‡çœŸå®æˆæœ¬ã€æœ¬åœ°å¿«é€Ÿå“åº”ã€åˆ†å±‚é˜²å¾¡ã€‚",
      "shortSummary": "Airbnbçš„é”®å€¼å­˜å‚¨Musselå·²ä»é™æ€é™æµæ¼”è¿›ä¸ºè‡ªé€‚åº”æµé‡ç®¡ç†ï¼Œä»¥åº”å¯¹é«˜å³°æµé‡å’ŒDDoSæ”»å‡»ã€‚æœ€åˆçš„QPSé™æµå› æ— æ³•åŒºåˆ†è¯·æ±‚æˆæœ¬å’Œå¤„ç†çƒ­é”®è€Œå—é™ã€‚æ–°ç³»ç»Ÿå¼•å…¥äº†èµ„æºæ„ŸçŸ¥é™æµï¼ˆRARCï¼‰ï¼Œæ ¹æ®è¯·æ±‚çš„å®é™…èµ„æºæ¶ˆè€—ï¼ˆåŒ…æ‹¬å»¶è¿Ÿï¼‰è®¡è´¹ã€‚æ­¤å¤–ï¼Œå®ƒè¿˜é€šè¿‡åˆ†çº§è´Ÿè½½å¸è½½ï¼ˆåŸºäºæµé‡å…³é”®æ€§ã€å®æ—¶å»¶è¿Ÿæ¯”ç‡å’Œæ’é˜Ÿç­–ç•¥ï¼‰å’Œçƒ­é”®æ£€æµ‹ä¸é˜²å¾¡ï¼ˆå®æ—¶ç¼“å­˜å’Œè¯·æ±‚åˆå¹¶ï¼‰æ¥ç¡®ä¿æœåŠ¡å¯é æ€§ã€‚è¿™äº›æ”¹è¿›æ˜¾è‘—æå‡äº†ç³»ç»Ÿåœ¨å‹åŠ›ä¸‹çš„éŸ§æ€§ï¼Œå¹¶å‡å°‘äº†æ¢å¤æ—¶é—´ã€‚",
      "translated_title": "ä»é™æ€é™æµåˆ°Airbnbé”®å€¼å­˜å‚¨ä¸­çš„è‡ªé€‚åº”æµé‡ç®¡ç†",
      "images": [
        {
          "url": "https://cdn-images-1.medium.com/max/1024/1*kBx_8QLd7El4TZ2nrouYUw.jpeg",
          "alt": "",
          "title": "",
          "position": 1
        },
        {
          "url": "https://cdn-images-1.medium.com/max/1024/1*XVDMQb8i2pQEUogiZipFbQ.jpeg",
          "alt": "",
          "title": "",
          "position": 2
        },
        {
          "url": "https://cdn-images-1.medium.com/max/1024/1*VuIeZSMzyRqXuXpfSzM_yg.jpeg",
          "alt": "",
          "title": "",
          "position": 3
        },
        {
          "url": "https://cdn-images-1.medium.com/max/1024/1*GWv-z2hXM6RiW6sRJKzYCg.png",
          "alt": "",
          "title": "",
          "position": 4
        },
        {
          "url": "https://cdn-images-1.medium.com/max/1024/1*DuwP-cqJEnQcbD64RGUTYA.png",
          "alt": "",
          "title": "",
          "position": 5
        }
      ],
      "contentSource": "RSS",
      "content": "<p>How Airbnb hardened Mussel, our key-value store, with smarter traffic controls to stay fast and reliable during trafficÂ spikes.</p><figure><img alt=\"\" src=\"https://cdn-images-1.medium.com/max/1024/1*kBx_8QLd7El4TZ2nrouYUw.jpeg\" /></figure><p>By <a href=\"https://www.linkedin.com/in/shravangaonkar/\">Shravan Gaonkar</a>, <a href=\"https://www.linkedin.com/in/caseygetz/\">Casey Getz</a>, <a href=\"https://www.linkedin.com/in/wonheec/\">WonheeÂ Cho</a></p><h3>Introduction</h3><p>Every request lookup on Airbnb, from stays, experiences, and services search to customer support inquiries ultimately hits <a href=\"https://medium.com/airbnb-engineering/mussel-airbnbs-key-value-store-for-derived-data-406b9fa1b296\">Mussel</a>, our multi-tenant key-value store for derived data. Mussel operates as a proxy service, deployed as a fleet of stateless dispatchersâ€Šâ€”â€Šeach a Kubernetes pod. On a typical day, this fleet handles millions of predictable point and range reads. During peak events, however, it must absorb several-fold higher volume, terabyte-scale bulk uploads, and sudden bursts from automated bots or DDoS attacks. Its ability to reliably serve this volatile mix of traffic is therefore critical to both the Airbnb user experience and the stability of the many services that power our platform.</p><p>Given Musselâ€™s traffic volume and its role in core Airbnb flows, <a href=\"https://en.wikipedia.org/wiki/Quality_of_service\">quality of service</a> (QoS) is one of the productâ€™s defining features. The first-generation QoS system was primarily an isolation tool. It relied on a Redis-backed counter, client quota based rate-limiter, that checked a callerâ€™s requests per second (QPS) against a configurable fixed quota. The goal was to prevent a single misbehaving client from overwhelming the service and causing a complete outage. For this purpose, it was simple and effective.</p><p>However, as the service matured, our goal shifted from merely preventing meltdowns to maximizing goodputâ€Šâ€”â€Šthat is, getting the most useful work done without degrading performance. A system of fixed, manually configured quotas canâ€™t achieve this, as it canâ€™t adapt in real time to shifting traffic patterns, new query shapes, or sudden threats like a DDoS attack. A truly effective QoS system needs to be adaptive, automatically exerting prioritized backpressure when it senses the system has reached its useful capacity.</p><p>To better match our QoS system to the realities of online traffic and maximize goodput, over time we evolved it to add several newÂ layers.</p><ul><li><strong>Resource-aware rate control (RARC)</strong>: Charges each request in <em>request units</em> (RU) that reflect rows, bytes, and latency, not justÂ counts.</li><li><strong>Load shedding with criticality tiers</strong>: Guarantees that high-priority traffic (e.g., customer support, trust and safety) stays responsive when capacity evaporates.</li><li><strong>Hot-key detection &amp; DDoS mitigation</strong>: Detects skewed access patterns in real time and then shields the backendâ€Šâ€”â€Šwhether the surge is legitimate or a DDoS burstâ€Šâ€”â€Šby caching or coalescing the duplicate requests before they reach the storageÂ layer.</li></ul><p>What follows is an engineerâ€™s view of how these layers were designed, deployed, and battle-tested, and why the same ideas may apply to any multi-tenant system that has outgrown simple QPSÂ limits.</p><figure><img alt=\"\" src=\"https://cdn-images-1.medium.com/max/1024/1*XVDMQb8i2pQEUogiZipFbQ.jpeg\" /><figcaption>Progression Timeline</figcaption></figure><h3>Background: Life with Client Quota RateÂ Limiter</h3><p>When Mussel launched, rate-limiting was entirely handled via simple QPS rate-limiting using a Redis-based distributed counter service. Each caller received a static, per-minute quota, and the dispatcher incremented a Redis key for every incoming request. If the keyâ€™s value exceeded the callerâ€™s quota, the dispatcher returned an HTTP 429. The design was simple, predictable, and easy toÂ operate.</p><p>Two architectural details made this feasible. First, Mussel and its storage engine were tightly coupled; backend effort correlated reasonably well with the number of calls at the front door. Second, the traffic mix was modest in size and variety, so a single global limit per caller rarely causedÂ trouble.</p><p>As adoption grew, two limitations becameÂ clear.</p><ol><li><strong>Cost variance:</strong> A one-row lookup and a 100,000-row scan were treated equally, even though their load on the backend differed by orders of magnitude. The system couldnâ€™t distinguish high-value cheap work from low-value expensive work.</li><li><strong>Traffic skew:</strong> Per-caller rate limits provided isolation at the client level, but were blind to the dataâ€™s access pattern. When a single key became â€œhotâ€â€Šâ€”â€Šfor example, a popular listing accessed by thousands of different callers simultaneouslyâ€Šâ€”â€Šthe aggregate traffic could overwhelm the underlying storage shard, even if each individual caller remained within its quota. This created a localized bottleneck that degraded performance for the entire cluster, impacting clients requesting completely unrelated data. Isolation by <em>caller</em> was insufficient to prevent this kind of resource contention.</li></ol><p>Addressing these gaps meant shifting from a <em>request-counting</em> mindset to a <em>resource-accounting</em> mindset and designing controls that reflect the real cost of each operation.</p><h3>Resource-aware rateÂ control</h3><p>A fair quota system must account for the real work a request imposes on the storage layer. Resource-aware rate control (RARC) meets this need by charging operations in <em>request units</em> (RU) rather than raw requests perÂ second.</p><p>A request unit blends four observable factors: fixed per-call overhead, rows processed, payload bytes, andâ€Šâ€”â€Šcruciallyâ€Šâ€”â€Šlatency. Latency captures effects that rows and bytes alone miss: two one-megabyte reads can differ greatly in cost if one hits cache and the other triggers disk. In practice, we use a linear model. For both reads and writes, the costÂ is:</p><pre><br>RU_read = 1 + w_r Ã— bytes_read + w_l Ã— latency_ms<br>RU_write = 6 + w_b Ã— bytes_written / 4096 bytes + w_l Ã— latency_ms<br><br>Weight factors w_r, w_b, and w_l come from load-test calibration <br>based on the compute, network and disk I/O. <br>bytes_read, bytes_written and latency is measured per request</pre><p>Although approximate, the formula separates operations whose surface metrics look similar yet load the backend very differently.</p><figure><img alt=\"\" src=\"https://cdn-images-1.medium.com/max/1024/1*VuIeZSMzyRqXuXpfSzM_yg.jpeg\" /><figcaption>Impact of Latency on RU computation</figcaption></figure><p>Each dispatcher continues to rely on rate-limiter for distributed counting, but the counter now represents request-unit tokens instead of raw QPS. At the start of every epoch, the dispatcher adds the callerâ€™s static RU quota to a local token bucket and immediately debits that bucket by the RU cost of each incoming request. When the bucket is empty, the request is rejected with HTTP 419. Because all dispatchers follow the same procedure and epochs are short, their buckets remain closely aligned without additional coordination.</p><p>Adaptive protection is handled in the separate load-shedding layer; backend latency influences which traffic is dropped or delayed, not the size of the periodic RU refill. This keeps rate accounting straightforwardâ€Šâ€”â€Šstatic quotas expressed in request unitsâ€Šâ€”â€Šwhile still reacting quickly when the storage layer shows signs ofÂ stress.</p><h3>Load shedding: Staying healthy when capacity evaporates or developsÂ hotspots</h3><p>Rate limits based on request units excel at smoothing normal traffic, but they adjust on a scale of seconds. When the workload shifts fasterâ€Šâ€”â€Ša bot floods a key, a shard stalls, or a batch job begins a full-table scanâ€Šâ€”â€Šthose seconds are enough for queues to balloon and service-level objectives to slip. To bridge this reaction-time gap, Mussel uses a load-shedding safety net that combines three real-time signals: (1) traffic criticality, (2) a latency ratio, and (3) a CoDel-inspired queueingÂ policy.</p><p>The latency ratio is a ratio that serves as a real-time indicator of stress on the system stress. Each dispatcher computes this ratio by dividing the long-term p95 latency by the short-term p95 latency. A stable system has a ratio near 1.0; a value dropping towards 0.3 indicates that latency is rising sharply. When that threshold is crossed, the dispatcher temporarily increases the RU cost applied to a designated client class so that its token bucket drains faster and the request rate naturally backs off. If the ratio keeps falling, the same penalty can be expanded to additional classes until latency returns to a safeÂ range.</p><p>The estimate uses the constant-memory PÂ² algorithm [1], requiring no raw sample storage or cross-node coordination.</p><figure><img alt=\"\" src=\"https://cdn-images-1.medium.com/max/1024/1*GWv-z2hXM6RiW6sRJKzYCg.png\" /><figcaption>Latency response over time and illustration of throttling</figcaption></figure><p>The Control-Delay (CoDel) thread pool tackles the second hazard: queue buildup <em>inside the dispatcher itself</em> [2]. It monitors the time a request <em>waits</em> in the queue. If that sojourn time proves the system is already saturated, the request fails early, freeing up memory and threads for higher-priority work. An optional latency penalty can also be applied to RU accounting, charging more for queries from callers that persistently trigger the latencyÂ ratio.</p><p>Together, these layersâ€Šâ€”â€Šcriticality, a real-time latency ratio, and adaptive queueingâ€Šâ€”â€Šform a shield that lets guest-facing traffic ride out backend hiccups. In practice, this system has cut recovery times by about half and keeps dispatchers stable without human intervention.</p><h3>Hot-key detection and DDoSÂ defence</h3><p>Request-unit limits and load shedding keep client usage fair, but they cannot stop a stampede of identical reads aimed at one record. Imagine a listing that hits the front page of a major news outlet: tens of thousands of guests refresh their browser, all asking for the same key. A misconfigured crawlerâ€Šâ€”â€Šor a deliberate botnetâ€Šâ€”â€Šcan generate the same access pattern, only faster. The result is shard overload, a full dispatcher queue, and rising latency for unrelated work.</p><p>Mussel neutralises this amplification with a three-step<strong> </strong>hot-key defence layer<strong>:</strong> real-time detection, local caching, and request coalescing.</p><h3>Real-time detection in constantÂ space</h3><p>Every dispatcher streams incoming keys into an in-memory <em>top-k</em> counter. The counter is a variant of the Space-Saving algorithm [2] popularized in Brian Hayesâ€™s â€œBritney Spears Problemâ€ essay [4]. In just a few megabytes, it tracks approximate hit counts, maintains a frequency-ordered heap, and surfaces the hottest keys in real time in each individual dispatcher.</p><h3>Local caching and request coalescing</h3><p>When a key crosses the hot threshold, the dispatcher serves it from a process-local LRU cache. Entries expire after roughly three seconds, so they vanish as soon as demand cools; no global cache is required. A cache miss can still arrive multiple times in the same millisecond, so the dispatcher tracks in-flight reads for hot keys. New arrivals attach to the pending future; the first backend response then fans out to all waiters. In most cases only <em>one</em> request per hot key per dispatcher pod ever reaches the storageÂ layer.</p><h3>Impact in production</h3><p>In a controlled DDoS drill that targeted a small set of keys at â‰ˆ million-QPS scale, the hot-key layer collapsed the burst to a trickleâ€Šâ€”â€Šeach dispatcher forwarded only an occasional request, well below the capacity of any individual shardâ€Šâ€”â€Šso the backend never felt theÂ surge.</p><figure><img alt=\"\" src=\"https://cdn-images-1.medium.com/max/1024/1*DuwP-cqJEnQcbD64RGUTYA.png\" /><figcaption>Hotkeys detected and served from dispatcher cache in realÂ time</figcaption></figure><h3>Retrospective and key takeaways</h3><p>The journey from a single QPS counter to a layered, cost-aware QoS stack has reshaped how Mussel handles traffic and, just as importantly, how engineers think about fairness and resilience. A few themes surface when we look back across the stages described above.</p><p>The first is the value of early, visible impact. The initial release of request-unit accounting went live well before load shedding or hot-key defence. Soon after deployment it automatically throttled a caller whose range scans had been quietly inflating cluster latency. That early win validated the concept and built momentum for the deeper changes that followed.</p><p>A second lesson is to prefer to keep control loops local. All the key signalsâ€Šâ€”â€ŠPÂ² latency quantiles, the Space-Saving top-k counter, and CoDel queue delayâ€Šâ€”â€Šrun entirely inside each dispatcher. Because no cross-node coordination is required, the system scales linearly and continues to protect capacity even if the control plane is itself underÂ stress.</p><p>Third, effective protection works on<strong> </strong>two different time-scales<strong>.</strong> Per-call RU pricing catches micro-spikes; the latency ratio and CoDel queue thresholds respond to macro slow-downs. Neither mechanism alone would have kept latency flat during the last controlled DDoS drill, but in concert they absorbed the shock and recovered withinÂ seconds.</p><p>Finally, QoS is a living system. Traffic patterns evolve, back-end capabilities improve, and new workloads appear. Planned next steps include database-native resource groups and automatic quota tuning from thirty-day usage curves. The principles that guided this projectâ€Šâ€”â€Šmeasure true cost, react locally and quickly, layer defencesâ€Šâ€”â€Šform a durable template, but the implementation will continue to grow with the platform it protects.</p><p>Does this type of work interest you? Weâ€™re hiring, check out open rolesÂ <a href=\"https://careers.airbnb.com/\">here</a>.</p><h3>ğŸ“š References</h3><ol><li>Raj Jain and Imrich Chlamtac. 1985. The PÂ² algorithm for dynamic calculation of quantiles and histograms without storing observations. <em>Communications of the ACM</em>, <strong>28</strong>(10), 1076â€“1085.<a href=\"https://doi.org/10.1145/4372.4378\"> https://doi.org/10.1145/4372.4378</a></li><li>Erik D. Demaine, Alejandro LÃ³pez-Ortiz, and J. Ian Munro. 2002. Frequency estimation of internet packet streams with limited space. In <em>Algorithmsâ€Šâ€”â€ŠESA 2002: 10th Annual European Symposium</em>, Rome, Italy, September 17â€“21, 2002. Rolf H. MÃ¶hring and Rajeev Raman (Eds.). <em>Lecture Notes in Computer Science</em>, Vol. <strong>2461</strong>. Springer, 348â€“360.</li><li>Kathleen M. Nichols and Van Jacobson. 2012. Controlling queue delay. <em>Communications of the ACM</em>, <strong>55</strong>(7), 42â€“50.<a href=\"https://doi.org/10.1145/2209249.2209264\"> https://doi.org/10.1145/2209249.2209264</a></li><li>Brian Hayes. 2008. Computing science: The Britney Spears problem. <em>American Scientist</em>, <strong>96</strong>(4), 274â€“279. <a href=\"https://www.americanscientist.org/article/the-britney-spears-problem\">https://www.americanscientist.org/article/the-britney-spears-problem</a></li></ol><img src=\"https://medium.com/_/stat?event=post.clientViewed&referrerSource=full_rss&postId=29362764e5c2\" width=\"1\" height=\"1\" alt=\"\"><hr><p><a href=\"https://medium.com/airbnb-engineering/from-static-rate-limiting-to-adaptive-traffic-management-in-airbnbs-key-value-store-29362764e5c2\">From Static Rate Limiting to Adaptive Traffic Management in Airbnbâ€™s Key-Value Store</a> was originally published in <a href=\"https://medium.com/airbnb-engineering\">The Airbnb Tech Blog</a> on Medium, where people are continuing the conversation by highlighting and responding to this story.</p>"
    },
    {
      "title": "åœ¨ Airbnb æ„å»ºä¸‹ä¸€ä»£é”®å€¼å­˜å‚¨ (åŸæ ‡é¢˜: Building a Next-Generation Key-Value Store at Airbnb)",
      "link": "https://medium.com/airbnb-engineering/building-a-next-generation-key-value-store-at-airbnb-0de8465ba354?source=rss----53c7c27702d5---4",
      "pubDate": "Wed, 24 Sep 2025 16:02:09 GMT",
      "isoDate": "2025-09-24T16:02:09.000Z",
      "creator": "Shravan Gaonkar",
      "summary": "# Airbnb ä¸‹ä¸€ä»£é”®å€¼å­˜å‚¨ Mussel çš„æ„å»º\n\nAirbnb é‡æ–°è®¾è®¡äº†å…¶æ ¸å¿ƒé”®å€¼å­˜å‚¨ Musselï¼Œä» v1 å‡çº§åˆ° v2ï¼Œä»¥æ»¡è¶³ç°ä»£æ•°æ®éœ€æ±‚ã€‚Mussel æ—¨åœ¨è¿æ¥ç¦»çº¿å’Œåœ¨çº¿å·¥ä½œè´Ÿè½½ï¼Œæä¾›é«˜å¯æ‰©å±•çš„æ‰¹é‡åŠ è½½èƒ½åŠ›å’Œä¸ªä½æ•°æ¯«ç§’çº§çš„è¯»å–é€Ÿåº¦ã€‚\n\n![å›¾ç‰‡ 1](https://cdn-images-1.medium.com/max/1024/1*sUS0d9nGKa-WQupVS8Wb4g.jpeg)\n\n## ä¸ºä»€ä¹ˆè¿›è¡Œé‡æ–°æ¶æ„ï¼Ÿ\n\nMussel v1 æ›¾å¯é æ”¯æŒ Airbnb å¤šå¹´ï¼Œä½†æ–°çš„ä¸šåŠ¡éœ€æ±‚ï¼ˆå¦‚å®æ—¶æ¬ºè¯ˆæ£€æŸ¥ã€å³æ—¶ä¸ªæ€§åŒ–ã€åŠ¨æ€å®šä»·å’Œæµ·é‡æ•°æ®å¤„ç†ï¼‰è¦æ±‚ä¸€ä¸ªèƒ½ç»“åˆå®æ—¶æµå¤„ç†ä¸æ‰¹é‡æ‘„å–ã€ä¸”æ˜“äºç®¡ç†çš„å¹³å°ã€‚\n\n## v1 çš„ä¸»è¦æŒ‘æˆ˜\n\nMussel v2 æ—¨åœ¨è§£å†³ v1 çš„ä»¥ä¸‹é—®é¢˜ï¼š\n\n*   **æ“ä½œå¤æ‚æ€§ï¼š** v1 æ‰©å±•æˆ–æ›¿æ¢èŠ‚ç‚¹éœ€æ‰‹åŠ¨æ‰§è¡Œå¤šæ­¥ Chef è„šæœ¬ï¼›v2 é‡‡ç”¨ Kubernetes manifests å’Œè‡ªåŠ¨åŒ–éƒ¨ç½²ï¼Œå°†æ•°å°æ—¶å·¥ä½œç¼©çŸ­è‡³æ•°åˆ†é’Ÿã€‚\n*   **å®¹é‡ä¸çƒ­ç‚¹ï¼š** v1 çš„é™æ€å“ˆå¸Œåˆ†åŒºå¯èƒ½å¯¼è‡´èŠ‚ç‚¹è¿‡è½½å’Œå»¶è¿Ÿå³°å€¼ï¼›v2 çš„åŠ¨æ€èŒƒå›´åˆ†ç‰‡å’Œé¢„åˆ†ç‰‡ç¡®ä¿äº†å³ä½¿å¯¹äº 100TB+ çš„è¡¨ï¼Œè¯»å–é€Ÿåº¦ä¾ç„¶å¿«é€Ÿï¼ˆp99 < 25msï¼‰ã€‚\n*   **ä¸€è‡´æ€§çµæ´»æ€§ï¼š** v1 æä¾›æœ‰é™çš„ä¸€è‡´æ€§æ§åˆ¶ï¼›v2 å…è®¸å›¢é˜Ÿæ ¹æ® SLA éœ€æ±‚é€‰æ‹©å³æ—¶æˆ–æœ€ç»ˆä¸€è‡´æ€§ã€‚\n*   **æˆæœ¬ä¸é€æ˜åº¦ï¼š** v1 çš„èµ„æºä½¿ç”¨ä¸é€æ˜ï¼›v2 å¢åŠ äº†å‘½åç©ºé—´ç§Ÿç”¨ã€é…é¢å¼ºåˆ¶å’Œä»ªè¡¨æ¿ï¼Œæä¾›æˆæœ¬å¯è§æ€§å’Œæ§åˆ¶ã€‚\n\n## æ–°æ¶æ„ï¼šMussel v2\n\n![å›¾ç‰‡ 2](https://cdn-images-1.medium.com/max/1024/1*yjXZcYHPpQdl-peEhfEAmA.png)\n\nMussel v2 æ˜¯ä¸€ä¸ªå½»åº•çš„é‡æ–°æ¶æ„ï¼Œæ—¨åœ¨è§£å†³ v1 çš„æ“ä½œå’Œå¯æ‰©å±•æ€§æŒ‘æˆ˜ã€‚å®ƒè¢«è®¾è®¡ä¸ºè‡ªåŠ¨åŒ–ã€å¯ç»´æŠ¤å’Œå¯æ‰©å±•ï¼ŒåŒæ—¶ç¡®ä¿åŠŸèƒ½å¯¹ç­‰ï¼Œå¹¶ä¸º 100 å¤šä¸ªç°æœ‰ç”¨ä¾‹æä¾›ç®€ä¾¿çš„è¿ç§»ã€‚\n\n### è°ƒåº¦å™¨ (Dispatcher)\n\n*   æ— çŠ¶æ€ã€å¯æ°´å¹³æ‰©å±•çš„ Kubernetes æœåŠ¡ï¼Œå–ä»£äº† v1 ç´§è€¦åˆã€åè®®ç‰¹å®šçš„è®¾è®¡ã€‚\n*   å°†å®¢æˆ·ç«¯ API è°ƒç”¨è½¬æ¢ä¸ºåç«¯æŸ¥è¯¢/ä¿®æ”¹ã€‚\n*   æ”¯æŒåŒå†™å’Œå½±å­è¯»æ¨¡å¼ä»¥è¿›è¡Œè¿ç§»ã€‚\n*   ç®¡ç†é‡è¯•å’Œé€Ÿç‡é™åˆ¶ï¼Œå¹¶ä¸ Airbnb çš„æœåŠ¡ç½‘æ ¼é›†æˆä»¥å®ç°å®‰å…¨å’ŒæœåŠ¡å‘ç°ã€‚\n*   **è¯»å–ï¼š** æ¯ä¸ªæ•°æ®åç§°æ˜ å°„åˆ°ä¸€ä¸ªé€»è¾‘è¡¨ï¼Œæ”¯æŒä¼˜åŒ–çš„ç‚¹æŸ¥æ‰¾ã€èŒƒå›´/å‰ç¼€æŸ¥è¯¢ï¼Œä»¥åŠä»æœ¬åœ°å‰¯æœ¬è¿›è¡Œé™ˆæ—§è¯»å–ä»¥é™ä½å»¶è¿Ÿã€‚åŠ¨æ€é™æµå’Œä¼˜å…ˆçº§ç®¡ç†ç¡®ä¿äº†åœ¨æµé‡å˜åŒ–ä¸‹çš„æ€§èƒ½ã€‚\n*   **å†™å…¥ï¼š** é¦–å…ˆæŒä¹…åŒ–åˆ° Kafka ä»¥ç¡®ä¿æŒä¹…æ€§ï¼Œç„¶åç”± Replayer å’Œ Write Dispatcher æŒ‰é¡ºåºåº”ç”¨åˆ°åç«¯ã€‚è¿™ç§äº‹ä»¶é©±åŠ¨æ¨¡å‹å¸æ”¶çªå‘æµé‡ï¼Œç¡®ä¿ä¸€è‡´æ€§ï¼Œå¹¶æ¶ˆé™¤äº† v1 çš„æ“ä½œå¼€é”€ã€‚Kafka ä¹Ÿæ”¯æŒå‡çº§ã€å¼•å¯¼å’Œè¿ç§»ã€‚\n\n### æ‰¹é‡åŠ è½½ (Bulk Load)\n\n*   ä¿ç•™äº† v1 çš„è¯­ä¹‰ï¼Œæ”¯æŒâ€œåˆå¹¶â€ï¼ˆæ·»åŠ åˆ°ç°æœ‰è¡¨ï¼‰å’Œâ€œæ›¿æ¢â€ï¼ˆäº¤æ¢æ•°æ®é›†ï¼‰æ“ä½œã€‚\n*   ä½¿ç”¨åŸºäº Airflow çš„ç°æœ‰æ¥å£è¿›è¡Œæ•°æ®å¯¼å…¥ï¼Œå°†æ•°æ®ä»“åº“æ•°æ®è½¬æ¢ä¸ºæ ‡å‡†åŒ–æ ¼å¼å¹¶ä¸Šä¼ åˆ° S3ã€‚\n*   æ— çŠ¶æ€æ§åˆ¶å™¨åè°ƒä½œä¸šï¼Œåˆ†å¸ƒå¼æœ‰çŠ¶æ€å·¥ä½œèŠ‚ç‚¹é›†ç¾¤ï¼ˆKubernetes StatefulSetsï¼‰å¹¶è¡Œæ‰§è¡Œæ‘„å–ï¼Œå°† S3 ä¸­çš„è®°å½•åŠ è½½åˆ°è¡¨ä¸­ã€‚\n*   é€šè¿‡å»é‡ã€å¢é‡åˆå¹¶å’Œæ’å…¥æ—¶é‡å¤é”®å¿½ç•¥ç­‰ä¼˜åŒ–ï¼Œç¡®ä¿äº† Airbnb è§„æ¨¡ä¸‹çš„é«˜ååé‡å’Œé«˜æ•ˆå†™å…¥ã€‚\n\n### æ•°æ®ç”Ÿå‘½å‘¨æœŸç®¡ç† (TTL)\n\n*   v2 å¼•å…¥äº†æ‹“æ‰‘æ„ŸçŸ¥çš„è¿‡æœŸæœåŠ¡ï¼Œå°†æ•°æ®å‘½åç©ºé—´åˆ†ç‰‡ä¸ºåŸºäºèŒƒå›´çš„å­ä»»åŠ¡ï¼Œç”±å¤šä¸ªå·¥ä½œèŠ‚ç‚¹å¹¶å‘å¤„ç†ã€‚\n*   è¿‡æœŸè®°å½•è¢«å¹¶è¡Œæ‰«æå’Œåˆ é™¤ï¼Œæœ€å¤§é™åº¦åœ°å‡å°‘äº†å¤§å‹æ•°æ®é›†çš„æ¸…ç†æ—¶é—´ã€‚\n*   å­ä»»åŠ¡çš„è°ƒåº¦æ—¨åœ¨é™åˆ¶å¯¹å®æ—¶æŸ¥è¯¢çš„å½±å“ã€‚\n*   å†™å…¥å¯†é›†å‹è¡¨ä½¿ç”¨æœ€å¤§ç‰ˆæœ¬å¼ºåˆ¶å’Œå®šå‘åˆ é™¤æ¥ç»´æŠ¤æ€§èƒ½å’Œæ•°æ®å«ç”Ÿã€‚\n\n## è¿ç§»è¿‡ç¨‹\n\n### æŒ‘æˆ˜\n\nMussel å­˜å‚¨æµ·é‡æ•°æ®ï¼ŒæœåŠ¡äº Airbnb æ•°åƒä¸ªè¡¨ï¼Œæ‰¿è½½ç€å…³é”®ä»»åŠ¡çš„è¯»å†™æµé‡ã€‚è¿ç§»ç›®æ ‡æ˜¯ï¼šå°†æ‰€æœ‰æ•°æ®å’Œæµé‡ä» Mussel v1 è¿ç§»åˆ° v2ï¼Œå®ç°é›¶æ•°æ®ä¸¢å¤±å’Œå¯¹å®¢æˆ·å¯ç”¨æ€§é›¶å½±å“ã€‚\n\n### è¿‡ç¨‹\n\né‡‡ç”¨äº†è“/ç»¿è¿ç§»ç­–ç•¥ï¼Œä½†ç”±äº v1 ä¸æä¾›è¡¨çº§å¿«ç…§æˆ– CDC æµï¼Œå› æ­¤å¢åŠ äº†å¤æ‚æ€§ã€‚\n\n*   **è‡ªå®šä¹‰è¿ç§»ç®¡é“ï¼š** å¼€å‘äº†è‡ªå®šä¹‰ç®¡é“ï¼Œèƒ½å¤Ÿå¼•å¯¼è¡¨åˆ° v2ã€‚\n*   **åŒå†™ï¼š** ä¸€æ—¦è¡¨è¢«å¼•å¯¼ï¼Œå°±å¯ç”¨åŒå†™ï¼Œä½¿ v2 ä¸ v1 ä¿æŒåŒæ­¥ã€‚\n*   **é˜¶æ®µåˆ’åˆ†ï¼š**\n    1.  **è“è‰²åŒºåŸŸ (Blue Zone)ï¼š** æ‰€æœ‰æµé‡æµå‘ v1ã€‚\n    2.  **å½±å­æ¨¡å¼ (Shadowing - Green)ï¼š** v2 å¼€å§‹å½±å­ v1ï¼Œå¹¶è¡Œå¤„ç†è¯»å†™ï¼Œä½†ä»… v1 å“åº”ã€‚ç”¨äºæ£€æŸ¥ v2 çš„æ­£ç¡®æ€§å’Œæ€§èƒ½ã€‚\n    3.  **åå‘æ¨¡å¼ (Reverse)ï¼š** v2 æ¥ç®¡æ´»è·ƒæµé‡ï¼Œv1 ä¿æŒå¾…æœºã€‚å†…ç½®è‡ªåŠ¨æ–­è·¯å™¨å’Œå›é€€é€»è¾‘ã€‚\n    4.  **åˆ‡æ¢ (Cutover)ï¼š** v2 é€šè¿‡æ‰€æœ‰æ£€æŸ¥åï¼ŒæŒ‰æ•°æ®åç§°é€ä¸€å®Œæˆåˆ‡æ¢ï¼ŒKafka ä½œä¸ºå†™å…¥å¯é æ€§çš„ä¸­é—´ä»¶ã€‚\n*   **é£é™©é™ä½ï¼š** è¿ç§»é€è¡¨è¿›è¡Œï¼Œæ¯ä¸€æ­¥éƒ½å¯é€†ï¼Œå¹¶å¯æ ¹æ®è¡¨çš„é£é™©é…ç½®æ–‡ä»¶è¿›è¡Œå¾®è°ƒã€‚\n\n### è¿ç§»ç®¡é“è¯¦æƒ…\n\n![å›¾ç‰‡ 3](https://cdn-images-1.medium.com/max/1024/1*4Q-yjBQu8jwWSv0pkkNIHQ.jpeg)\n\nv1 æ¶æ„ä½¿ç”¨ Kafka ä½œä¸ºå¤åˆ¶æ—¥å¿—ã€‚åœ¨æ•°æ®è¿ç§»åˆ° v2 æœŸé—´ï¼Œåˆ©ç”¨ç›¸åŒçš„ Kafka æµæ¥ç»´æŠ¤ v1 å’Œ v2 ä¹‹é—´çš„æœ€ç»ˆä¸€è‡´æ€§ã€‚\n\nè‡ªå®šä¹‰ç®¡é“æ­¥éª¤ï¼š\n\n1.  **æºæ•°æ®é‡‡æ ·ï¼š** ä» v1 ä¸‹è½½å¤‡ä»½æ•°æ®ï¼Œæå–ç›¸å…³è¡¨å¹¶é‡‡æ ·ä»¥äº†è§£æ•°æ®åˆ†å¸ƒã€‚\n2.  **åœ¨ v2 ä¸Šåˆ›å»ºé¢„åˆ†ç‰‡è¡¨ï¼š** æ ¹æ®é‡‡æ ·ç»“æœï¼Œåˆ›å»ºå…·æœ‰é¢„å®šä¹‰åˆ†ç‰‡å¸ƒå±€çš„ v2 è¡¨ï¼Œä»¥æœ€å°åŒ–è¿ç§»æœŸé—´çš„æ•°æ®é‡æ’ã€‚\n3.  **å¼•å¯¼ (Bootstrap)ï¼š** æœ€è€—æ—¶æ­¥éª¤ï¼Œä½¿ç”¨ Kubernetes StatefulSets æŒä¹…åŒ–æœ¬åœ°çŠ¶æ€å¹¶å®šæœŸæ£€æŸ¥ç‚¹è¿›åº¦ã€‚\n4.  **æ ¡éªŒå’ŒéªŒè¯ï¼š** éªŒè¯ v1 å¤‡ä»½ä¸­çš„æ‰€æœ‰æ•°æ®æ˜¯å¦å·²æ­£ç¡®æ‘„å–åˆ° v2ã€‚\n5.  **è¿½èµ¶ (Catch-up)ï¼š** åº”ç”¨åœ¨å¼•å¯¼é˜¶æ®µ Kafka ä¸­ç´¯ç§¯çš„ä»»ä½•æ»åæ¶ˆæ¯ã€‚\n6.  **åŒå†™ï¼š** v1 å’Œ v2 ä»ç›¸åŒçš„ Kafka ä¸»é¢˜æ¶ˆè´¹ï¼Œç¡®ä¿æœ€ç»ˆä¸€è‡´æ€§ã€‚\n7.  **è¯»æµé‡è¿ç§»ï¼š** è°ƒåº¦å™¨åŠ¨æ€é…ç½®ï¼Œé€æ­¥å°†è¯»è¯·æ±‚ä» v1 åˆ‡æ¢åˆ° v2ï¼Œå¹¶è¿›è¡Œå½±å­è¯·æ±‚å’Œå›é€€ã€‚\n\n## ç»éªŒæ•™è®­\n\n*   **ä¸€è‡´æ€§å¤æ‚æ€§ï¼š** ä»æœ€ç»ˆä¸€è‡´æ€§ (v1) åˆ°å¼ºä¸€è‡´æ€§ (v2) å¼•å…¥äº†æ–°çš„æŒ‘æˆ˜ï¼Œéœ€è¦å†™å…¥å»é‡ã€çƒ­é”®é˜»å¡å’Œå»¶è¿Ÿå†™å…¥ä¿®å¤ã€‚\n*   **é¢„åˆ†ç‰‡è‡³å…³é‡è¦ï¼š** ä»åŸºäºå“ˆå¸Œ (v1) åˆ°åŸºäºèŒƒå›´ (v2) çš„åˆ†åŒºï¼Œéœ€è¦å‡†ç¡®é‡‡æ · v1 æ•°æ®å¹¶é¢„åˆ†ç‰‡ï¼Œä»¥ç¡®ä¿è¿ç§»æœŸé—´åç«¯èŠ‚ç‚¹çš„å‡è¡¡æ‘„å–æµé‡ã€‚\n*   **æŸ¥è¯¢æ¨¡å‹è°ƒæ•´ï¼š** v2 ä¸åƒ v1 é‚£æ ·æœ‰æ•ˆåœ°å‘ä¸‹æ¨é€èŒƒå›´è¿‡æ»¤å™¨ï¼Œéœ€è¦å®ç°å®¢æˆ·ç«¯åˆ†é¡µã€‚\n*   **æ–°é²œåº¦ä¸æˆæœ¬ï¼š** ä¸åŒç”¨ä¾‹éœ€è¦ä¸åŒçš„æƒè¡¡ï¼Œä¾‹å¦‚ä½¿ç”¨ä¸»å‰¯æœ¬è·å–æœ€æ–°æ•°æ®æˆ–ä½¿ç”¨è¾…åŠ©å‰¯æœ¬å¹³è¡¡é™ˆæ—§åº¦ä¸æˆæœ¬/æ€§èƒ½ã€‚\n*   **Kafka çš„ä½œç”¨ï¼š** Kafka ç¨³å®šçš„ p99 æ¯«ç§’çº§å»¶è¿Ÿä½¿å…¶æˆä¸ºè¿ç§»è¿‡ç¨‹ä¸­ä¸å¯æˆ–ç¼ºçš„ä¸€éƒ¨åˆ†ã€‚\n*   **æ„å»ºçµæ´»æ€§ï¼š** å®¢æˆ·é‡è¯•å’Œå¸¸è§„æ‰¹é‡ä½œä¸šæä¾›äº†å®‰å…¨ç½‘ï¼Œè¿ç§»è®¾è®¡å…è®¸æŒ‰è¡¨åˆ†é…é˜¶æ®µå’Œå³æ—¶å¯é€†æ€§ï¼Œè¿™å¯¹äºå¤§è§„æ¨¡é£é™©ç®¡ç†è‡³å…³é‡è¦ã€‚\n\næœ€ç»ˆï¼ŒAirbnb æˆåŠŸè¿ç§»äº†è¶…è¿‡ PB çº§çš„æ•°æ®ï¼Œæ¶‰åŠæ•°åƒä¸ªè¡¨ï¼Œå®ç°äº†é›¶åœæœºå’Œé›¶æ•°æ®ä¸¢å¤±ã€‚\n\n## ç»“è®ºä¸å±•æœ›\n\nMussel v2 èåˆäº†é€šå¸¸ä»…é™äºç‹¬ç«‹ä¸“ä¸šç³»ç»Ÿçš„åŠŸèƒ½ã€‚å®ƒèƒ½å¤ŸåŒæ—¶ï¼š\n\n*   æ‰¹é‡ä¸Šä¼ æ•°å TB æ•°æ®ã€‚\n*   åœ¨åŒä¸€é›†ç¾¤ä¸­æ¯ç§’å¤„ç† 100k+ æµå¼å†™å…¥ã€‚\n*   ä¿æŒ p99 è¯»å–å»¶è¿Ÿä½äº 25 æ¯«ç§’ã€‚\n*   å…è®¸è°ƒç”¨è€…æŒ‰å‘½åç©ºé—´åˆ‡æ¢é™ˆæ—§è¯»å–ã€‚\n\né€šè¿‡å°† NewSQL åç«¯ä¸ Kubernetes åŸç”Ÿæ§åˆ¶å¹³é¢ç»“åˆï¼ŒMussel v2 æä¾›äº†å¯¹è±¡å­˜å‚¨çš„å¼¹æ€§ã€ä½å»¶è¿Ÿç¼“å­˜çš„å“åº”èƒ½åŠ›å’Œç°ä»£æœåŠ¡ç½‘æ ¼çš„å¯æ“ä½œæ€§ã€‚å·¥ç¨‹å¸ˆæ— éœ€å†æ‹¼å‡‘ç¼“å­˜ã€é˜Ÿåˆ—å’Œæ•°æ®å­˜å‚¨æ¥æ»¡è¶³ SLAï¼ŒMussel å¼€ç®±å³ç”¨ï¼Œè®©å›¢é˜Ÿä¸“æ³¨äºäº§å“åˆ›æ–°ã€‚\n\næœªæ¥ï¼ŒAirbnb å°†åˆ†äº«æ›´å¤šå…³äº Mussel ä¸­ QoS ç®¡ç†çš„æ¼”è¿›ä»¥åŠå¤§è§„æ¨¡æ‰¹é‡åŠ è½½ä¼˜åŒ–çš„è§è§£ã€‚",
      "shortSummary": "Airbnb é‡æ–°æ¶æ„äº†å…¶æ ¸å¿ƒé”®å€¼å­˜å‚¨ Musselï¼Œä» v1 å‡çº§åˆ°åŸºäº NewSQL åç«¯å’Œ Kubernetes çš„ v2ã€‚æ­¤ä¸¾æ—¨åœ¨è§£å†³ v1 çš„æ“ä½œå¤æ‚æ€§ã€å¯æ‰©å±•æ€§ã€ä¸€è‡´æ€§åŠæˆæœ¬é€æ˜åº¦é—®é¢˜ã€‚Mussel v2 å®ç°äº†é«˜å¯æ‰©å±•æ€§ã€ä½å»¶è¿Ÿè¯»å–å’Œé«˜æ•ˆæ‰¹é‡åŠ è½½ï¼Œå¹¶æ”¯æŒçµæ´»çš„ä¸€è‡´æ€§æ¨¡å‹ã€‚é€šè¿‡è“/ç»¿éƒ¨ç½²ã€åŒå†™å’Œè‡ªå®šä¹‰è¿ç§»ç®¡é“ï¼ŒAirbnb æˆåŠŸè¿ç§»äº†æ•° PB æ•°æ®ï¼Œå®ç°äº†é›¶åœæœºå’Œé›¶æ•°æ®ä¸¢å¤±ï¼Œæå¤§åœ°ç®€åŒ–äº†æ•°æ®åŸºç¡€è®¾æ–½ç®¡ç†ï¼Œä½¿å·¥ç¨‹å¸ˆèƒ½ä¸“æ³¨äºäº§å“åˆ›æ–°ã€‚",
      "translated_title": "åœ¨ Airbnb æ„å»ºä¸‹ä¸€ä»£é”®å€¼å­˜å‚¨",
      "images": [
        {
          "url": "https://cdn-images-1.medium.com/max/1024/1*sUS0d9nGKa-WQupVS8Wb4g.jpeg",
          "alt": "",
          "title": "",
          "position": 1
        },
        {
          "url": "https://cdn-images-1.medium.com/max/1024/1*yjXZcYHPpQdl-peEhfEAmA.png",
          "alt": "",
          "title": "",
          "position": 2
        },
        {
          "url": "https://cdn-images-1.medium.com/max/1024/1*4Q-yjBQu8jwWSv0pkkNIHQ.jpeg",
          "alt": "",
          "title": "",
          "position": 3
        },
        {
          "url": "https://medium.com/_/stat?event=post.clientViewed&referrerSource=full_rss&postId=0de8465ba354",
          "alt": "",
          "title": "",
          "position": 4
        }
      ],
      "contentSource": "RSS",
      "content": "<figure><img alt=\"\" src=\"https://cdn-images-1.medium.com/max/1024/1*sUS0d9nGKa-WQupVS8Wb4g.jpeg\" /></figure><p>How we completely rearchitected Mussel, our storage engine for derived data, and lessons learned from the migration from Mussel V1 toÂ V2.</p><p>By <a href=\"https://www.linkedin.com/in/shravangaonkar/\">Shravan Gaonkar</a>, <a href=\"https://www.linkedin.com/in/chandramoulir/\">Chandramouli Rangarajan</a>, <a href=\"https://www.linkedin.com/in/yanhan-zhang/\">YanhanÂ Zhang</a></p><p>How we completely rearchitected Mussel, our storage engine for derived data, and lessons learned from the migration from Mussel V1 toÂ V2.</p><p>Airbnbâ€™s core key-value store, internally known as Mussel, bridges offline and online workloads, providing highly scalable bulk load capabilities combined with single-digit millisecond reads.</p><p>Since first writing about Mussel in a 2022 <a href=\"https://medium.com/airbnb-engineering/mussel-airbnbs-key-value-store-for-derived-data-406b9fa1b296\">blog post</a>, we have completely deprecated the storage backend of the original system (what we now call Mussel v1) and have replaced it with a NewSQL backend which we are referring to as Mussel v2. Mussel v2 has been running successfully in production for a year, and we wanted to share why we undertook this rearchitecture, what the challenges were, and what benefits we got fromÂ it.</p><h3>Why rearchitect</h3><p>Mussel v1 reliably supported Airbnb for years, but new requirementsâ€Šâ€”â€Šreal-time fraud checks, instant personalization, dynamic pricing, and massive dataâ€Šâ€”â€Šdemand a platform that combines real-time streaming with bulk ingestion, all while being easy toÂ manage.</p><h3>Key Challenges withÂ v1</h3><p>Mussel v2 solves a number of issues with v1, delivering a scalable, cloud-native key-value store with predictable performance and minimal operational overhead.</p><ul><li><strong>Operational complexity:</strong> Scaling or replacing nodes required multi-step Chef scripts on EC2; v2 uses Kubernetes manifests and automated rollouts, reducing hours of manual work toÂ minutes.</li><li><strong>Capacity &amp; hotspots:</strong> Static hash partitioning sometimes overloaded nodes, leading to latency spikes. V2â€™s dynamic range sharding and presplitting keep reads fast (p99 &lt; 25ms), even for 100TB+Â tables.</li><li><strong>Consistency flexibility:</strong> v1 offered limited consistency control. v2 lets teams choose between immediate or eventual consistency based on their SLAÂ needs.</li><li><strong>Cost &amp; Transparency:</strong> Resource usage in v1 was opaque. v2 adds namespace tenancy, quota enforcement, and dashboards, providing cost visibility andÂ control.</li></ul><h3>New architecture</h3><figure><img alt=\"\" src=\"https://cdn-images-1.medium.com/max/1024/1*yjXZcYHPpQdl-peEhfEAmA.png\" /></figure><p>Mussel v2 is a complete re-architecture addressing v1â€™s operational and scalability challenges. Itâ€™s designed to be automated, maintainable, and scalable, while ensuring feature parity and an easy migration for 100+ existing userÂ cases.</p><h3>Dispatcher</h3><p>In Mussel v2, the Dispatcher is a stateless, horizontally-scalable Kubernetes service that replaces the tightly coupled, protocol-specific design of v1. It translates client API calls into backend queries/mutations, supports dual-write and shadow-read modes for migration, manages retries and rate limits, and integrates with Airbnbâ€™s service mesh for security and service discovery.</p><p><strong>Reads</strong> are simplified: Each dataname maps to a logical table, enabling optimized point lookups, range/prefix queries, and stale reads from local replicas to reduce latency. Dynamic throttling and prioritization maintain performance under changingÂ traffic.</p><p><strong>Writes</strong> are persisted in Kafka for durability first, with the Replayer and Write Dispatcher applying them in order to the backend. This event-driven model absorbs bursts, ensures consistency, and removes v1â€™s operational overhead. Kafka also underpins upgrades, bootstrapping, and migrations until CDC and snapshotting mature.</p><p>The architecture suits derived data and replay-heavy use cases today, with a long-term goal of shifting ingestion and replication fully to the distributed backend database to bring down latency and simplify operations.</p><p>Bulk load<strong><br></strong>Bulk load remains essential for moving large datasets from offline warehouses into Mussel for low-latency queries. v2 preserves v1 semantics, supporting both â€œmergeâ€ (add to existing tables) and â€œreplaceâ€ (swap datasets) semantics.</p><p>To maintain a familiar interface, v2 keeps the existing Airflow-based onboarding and transforms warehouse data into a standardized format, uploading to S3 for ingestion. <a href=\"https://airbnb.io/projects/airflow/\">Airflow</a> is an open-source platform for authoring, scheduling, and monitoring data pipelines. Created at Airbnb, it lets users define workflows in code as directed acyclic graphs (DAGs), enabling quick iteration and easy orchestration of tasks for data engineers and scientists worldwide.</p><p>A stateless controller orchestrates jobs, while a distributed, stateful worker fleet (Kubernetes StatefulSets) performs parallel ingestion, loading records from S3 into tables. Optimizationsâ€Šâ€”â€Šlike deduplication for replace jobs, delta merges, and insert-on-duplicate-key-ignoreâ€Šâ€”â€Šensure high throughput and efficient writes at AirbnbÂ scale.</p><h3>TTL</h3><p>Automated data expiration (TTL) can help support data governance goals and storage efficiency. In v1, expiration relied on the storage engineâ€™s compaction cycle, which struggled atÂ scale.</p><p>Mussel v2 introduces a topology-aware expiration service that shards data namespaces into range-based subtasks processed concurrently by multiple workers. Expired records are scanned and deleted in parallel, minimizing sweep time for large datasets. Subtasks are scheduled to limit impact on live queries, and write-heavy tables use max-version enforcement with targeted deletes to maintain performance and dataÂ hygiene.</p><p>These enhancements provide the same retention functionality as v1 but with far greater efficiency, transparency, and scalability, meeting Airbnbâ€™s modern data platform demands and enabling future useÂ cases.</p><h3>The migration process</h3><h3>Challenge</h3><p>Mussel stores vast amounts of data and serves thousands of tables across a wide array of Airbnb services, sustaining mission-critical read and write traffic at high scale. Given the criticality of Mussel to Airbnbâ€™s online traffic, our migration goal was straightforward but challenging: Move all data and traffic from Mussel v1 to v2 with zero data loss and no impact on availability to our customers.</p><h3>Process</h3><p>We adopted a blue/green migration strategy, but with notable complexities. Mussel v1 didnâ€™t provide table-level snapshots or CDC streams, which are standard in many datastores. To bridge this gap, we developed a custom migration pipeline capable of bootstrapping tables to v2, selected by usage patterns and risk profiles. Once bootstrapped, dual writes were enabled on a per-table basis to keep v2 in sync as the migration progressed.</p><p>The migration itself followed several distinctÂ stages:</p><ul><li><strong>Blue Zone:</strong> All traffic initially flowed to v1 (â€œBlueâ€). This provided a stable baseline as we migrated data behind theÂ scenes.</li><li><strong>Shadowing (Green):</strong> Once tables were bootstrapped, v2 (â€œGreenâ€) began shadowing v1â€Šâ€”â€Šhandling reads/writes in parallel, but only v1 responded. This allowed us to check v2â€™s correctness and performance withoutÂ risk.</li><li><strong>Reverse:</strong> After building confidence, v2 took over active traffic while v1 remained on standby. We built automatic circuit breakers and fallback logic: If v2 showed elevated error rates or lagged behind v1, we could instantly return traffic to v1 or revert to shadowing.</li><li><strong>Cutover:</strong> When v2 passed all checks, we completed the cutover on a dataname-by-dataname basis, with Kafka serving as a robust intermediary for write reliability throughout.</li></ul><p>To further de-risk the process, migration was performed one table at a time. Every step was reversible and could be fine-tuned per table or group of tables based on their risk profile. This granular, staged approach allowed for rapid iteration, safe rollbacks, and continuous progress without impacting the business.</p><h3>Migration pipeline</h3><figure><img alt=\"\" src=\"https://cdn-images-1.medium.com/max/1024/1*4Q-yjBQu8jwWSv0pkkNIHQ.jpeg\" /></figure><p>As described in our previous blog post, the v1 architecture uses Kafka as a replication logâ€Šâ€”â€Šdata is first written to Kafka, then consumed by the v1 backend. During the data migration to v2, we leveraged the same Kafka stream to maintain eventual consistency between v1 andÂ v2.</p><p>To migrate any given table from v1 to v2, we built a custom pipeline consisting of the following steps:</p><ol><li><strong>Source data sampling</strong>: We download backup data from v1, extract the relevant tables, and sample the data to understand its distribution.</li><li><strong>Create pre-split table on v2</strong>: Based on the sampling results, we create a corresponding v2 table with a pre-defined shard layout to minimize data reshuffling during migration.</li><li><strong>Bootstrap</strong>: This is the most time-consuming step, taking hours or even days depending on table size. To bootstrap efficiently, we use Kubernetes StatefulSets to persist local state and periodically checkpoint progress.</li><li><strong>Checksum verification</strong>: We verify that all data from the v1 backup has been correctly ingested intoÂ v2.</li><li><strong>Catch-up</strong>: We apply any lagging messages that accumulated in Kafka during the bootstrap phase.</li><li><strong>Dual writes</strong>: At this stage, both v1 and v2 consume from the same Kafka topic. We ensure eventual consistency between the two, with replication lag typically within tens of milliseconds.</li></ol><p>Once data migration is complete and we enter dual write mode, we can begin the read traffic migration phase. During this phase, our dispatcher can be dynamically configured to serve read requests for specific tables from v1, while sending shadow requests to v2 for consistency checks. We then gradually shift to serving reads from v2, accompanied by reverse shadow requests to v1 for consistency checks, which also enables quick fallback to v1 responses if v2 becomes unstable. Eventually, we fully transition to serving all read traffic fromÂ v2.</p><h3>Lessons learned</h3><p>Several key insights emerged from this migration:</p><ul><li><strong>Consistency complexity:</strong> Migrating from an eventually consistent (v1) to a strongly consistent (v2) backend introduced new challenges, particularly around write conflicts. Addressing these required features like write deduplication, hotkey blocking, and lazy write repairâ€Šâ€”â€Šsometimes trading off storage cost or read performance.</li><li><strong>Presplitting is critical:</strong> As we shifted from hash-based (v1) to range-based partitioning (v2), inserting large consecutive data could cause hotspots and disrupt our v2 backend. To prevent this, we needed to accurately sample the v1 data and presplit it into multiple shards based on v2â€™s topology, ensuring balanced ingestion traffic across backend nodes during data migration.</li><li><strong>Query model adjustments:</strong> v2 doesnâ€™t push down range filters as effectively, requiring us to implement client-side pagination for prefix and rangeÂ queries.</li><li><strong>Freshness vs. cost:</strong> Different use cases required different tradeoffs. Some prioritized data freshness and used primary replicas for the latest reads, while others leveraged secondary replicas to balance staleness with cost and performance.</li><li><strong>Kafkaâ€™s role:</strong> Kafkaâ€™s proven stable p99 millisecond latency made it an invaluable part of our migration process.</li><li><strong>Building in flexibility:</strong> Customer retries and routine bulk jobs provided a safety net for the rare inconsistencies, and our migration design allowed for per-table stage assignments and instant reversibilityâ€Šâ€”â€Škey for managing risk atÂ scale.</li></ul><p>As a result, we migrated more than a petabyte of data across thousands of tables with zero downtime or data loss, thanks to a blue/green rollout, dual-write pipeline, and automated fallbacksâ€Šâ€”â€Šso the product teams could keep shipping features while the engine under themÂ evolved.</p><h3>Conclusion and nextÂ steps</h3><p>What sets Mussel v2 apart is the way it fuses capabilities that are usually confined to separate, specialized systems. In our deployment of Mussel V2, we observe that this system can simultaneously</p><ol><li>ingest tens of terabytes in bulk dataÂ upload,</li><li>sustain 100 k+ streaming writes per second in the same cluster,Â and</li><li>keep p99 reads under 25Â ms</li></ol><p>â€” all while giving callers a simple dial to toggle stale reads on a per-namespace basis. By pairing a NewSQL backend with a Kubernetes-native control plane, Mussel v2 delivers the elasticity of object storage, the responsiveness of a low-latency cache, and the operability of modern service meshesâ€Šâ€”â€Šrolled into one platform. Engineers no longer need to stitch together a cache, a queue, and a datastore to hit their SLAs; Mussel provides those guarantees out of the box, letting teams focus on product innovation instead of data plumbing.</p><p>Looking ahead, weâ€™ll be sharing deeper insights into how weâ€™re evolving quality of service (QoS) management within Mussel, now orchestrated cleanly from the Dispatcher layer. Weâ€™ll also describe our journey in optimizing bulk loading at scaleâ€Šâ€”â€Šunlocking new performance and reliability wins for complex data pipelines. If youâ€™re passionate about building large-scale distributed systems and want to help shape the future of data infrastructure at Airbnb, take a look at our <a href=\"https://careers.airbnb.com/\">Careers page</a>â€Šâ€”â€Šweâ€™re always looking for talented engineers to join us on thisÂ mission.</p><h3>References</h3><ol><li><a href=\"https://medium.com/airbnb-engineering/mussel-airbnbs-key-value-store-for-derived-data-406b9fa1b296\">https://medium.com/airbnb-engineering/mussel-airbnbs-key-value-store-for-derived-data-406b9fa1b296</a></li></ol><img src=\"https://medium.com/_/stat?event=post.clientViewed&referrerSource=full_rss&postId=0de8465ba354\" width=\"1\" height=\"1\" alt=\"\"><hr><p><a href=\"https://medium.com/airbnb-engineering/building-a-next-generation-key-value-store-at-airbnb-0de8465ba354\">Building a Next-Generation Key-Value Store at Airbnb</a> was originally published in <a href=\"https://medium.com/airbnb-engineering\">The Airbnb Tech Blog</a> on Medium, where people are continuing the conversation by highlighting and responding to this story.</p>"
    },
    {
      "title": "Viaductï¼Œäº”å¹´å›é¡¾ï¼šæ•°æ®å¯¼å‘å‹æœåŠ¡ç½‘æ ¼çš„ç°ä»£åŒ– (åŸæ ‡é¢˜: Viaduct, Five Years On: Modernizing the Data-Oriented Service Mesh)",
      "link": "https://medium.com/airbnb-engineering/viaduct-five-years-on-modernizing-the-data-oriented-service-mesh-e66397c9e9a9?source=rss----53c7c27702d5---4",
      "pubDate": "Wed, 17 Sep 2025 17:01:58 GMT",
      "isoDate": "2025-09-17T17:01:58.000Z",
      "creator": "Adam Miskiewicz",
      "summary": "![å›¾ç‰‡ 1](https://cdn-images-1.medium.com/max/1024/1*q_owFEOLfQlioFXHP7UqBA.avif)\n\næœ¬æ–‡å›é¡¾äº†Airbnbæ•°æ®å¯¼å‘å‹æœåŠ¡ç½‘æ ¼Viaductäº”å¹´æ¥çš„å‘å±•ï¼Œå¹¶å®£å¸ƒå…¶å·²å¼€æºã€‚Viaductè‡ª2020å¹´ä»¥æ¥å–å¾—äº†æ˜¾è‘—å¢é•¿ï¼Œæµé‡å¢é•¿äº†å…«å€ï¼Œæ‰˜ç®¡ä»£ç çš„å›¢é˜Ÿæ•°é‡ç¿»å€è‡³130å¤šä¸ªï¼Œä»£ç åº“è§„æ¨¡æ‰©å¤§äº†ä¸¤å€å¤šï¼ŒåŒæ—¶ä¿æŒäº†è¿è¥å¼€é”€ä¸å˜ã€äº‹æ•…æ—¶é—´å‡åŠï¼Œå¹¶ä½¿æˆæœ¬ä¸QPSçº¿æ€§å¢é•¿ã€‚\n\n## Viaduct çš„æ ¸å¿ƒåŸåˆ™ï¼ˆä¿æŒä¸å˜ï¼‰\n\nViaductè‡ªæˆç«‹ä»¥æ¥ä¸€ç›´éµå¾ªä¸‰ä¸ªæ ¸å¿ƒåŸåˆ™ï¼š\n\n*   **ä¸­å¿ƒåŒ– Schemaï¼š** Viaductæä¾›ä¸€ä¸ªå•ä¸€ã€é›†æˆçš„Schemaï¼Œè¿æ¥å…¬å¸æ‰€æœ‰é¢†åŸŸã€‚å°½ç®¡Schemaç”±å¤šä¸ªå›¢é˜Ÿåˆ†æ•£å¼€å‘ï¼Œä½†å®ƒæ˜¯ä¸€ä¸ªé«˜åº¦äº’è”çš„å›¾ã€‚è¶…è¿‡75%çš„Viaductè¯·æ±‚æ˜¯å†…éƒ¨è¯·æ±‚ï¼Œå› ä¸ºå®ƒå·²æˆä¸ºè¿æ¥å¼€å‘è€…ä¸æ‰€æœ‰æ•°æ®å’Œèƒ½åŠ›çš„â€œä¸€ç«™å¼â€æ•°æ®ç½‘æ ¼ã€‚\n*   **æ‰˜ç®¡ä¸šåŠ¡é€»è¾‘ï¼š** å›¢é˜Ÿè¢«é¼“åŠ±ç›´æ¥åœ¨Viaductä¸­æ‰˜ç®¡ä¸šåŠ¡é€»è¾‘ï¼Œè¿™ä¸GraphQLæœåŠ¡å™¨ä½œä¸ºå¾®æœåŠ¡è–„å±‚çš„å¸¸è§åšæ³•ä¸åŒã€‚Viaductæä¾›äº†ä¸€ä¸ªæ— æœåŠ¡å™¨å¹³å°ï¼Œè®©å¼€å‘è€…ä¸“æ³¨äºä¸šåŠ¡é€»è¾‘ç¼–å†™ï¼Œè€Œéè¿ç»´é—®é¢˜ã€‚\n*   **å¯é‡å…¥æ€§ï¼ˆRe-entrancyï¼‰ï¼š** Viaductä¸Šæ‰˜ç®¡çš„é€»è¾‘å¯ä»¥é€šè¿‡å‘å¸ƒGraphQLç‰‡æ®µå’ŒæŸ¥è¯¢æ¥ä¸å…¶ä»–é€»è¾‘ç»„åˆã€‚è¿™å¯¹äºç»´æŠ¤å¤§å‹ä»£ç åº“çš„æ¨¡å—åŒ–å’Œé¿å…ä¼ ç»Ÿå•ä½“æ¶æ„çš„é£é™©è‡³å…³é‡è¦ã€‚\n\n## Viaduct çš„æ¼”å˜ï¼šâ€œViaduct Modernâ€ç°ä»£åŒ–è®¡åˆ’\n\nViaductåœ¨å¤§éƒ¨åˆ†å†å²ä¸­æ˜¯è‡ªä¸‹è€Œä¸Šã€å“åº”å¼€å‘è€…éœ€æ±‚æ¼”è¿›çš„ï¼Œè¿™å¯¼è‡´äº†å¤šç§å®ç°æ–¹å¼ã€æ··ä¹±çš„å¼€å‘è€…ä½“éªŒå’Œæ¶æ„å®Œæ•´æ€§ä¸è¶³ã€‚ä¸ºè§£å†³è¿™äº›é—®é¢˜ï¼ŒAirbnbå¯åŠ¨äº†â€œViaduct Modernâ€è®¡åˆ’ï¼Œå¯¹é¢å‘å¼€å‘è€…çš„APIå’Œæ‰§è¡Œå¼•æ“è¿›è¡Œäº†å½»åº•æ”¹é€ ã€‚\n\n### ç§Ÿæˆ· API ç®€åŒ–\n\n*   **æ—§æ¨¡å‹ï¼š** ç¼–ç¨‹æ¨¡å‹å¤æ‚ï¼Œå¼€å‘è€…é¢ä¸´å¤šç§å®ç°åŠŸèƒ½çš„æœºåˆ¶ï¼ˆè§ä¸‹å›¾ï¼‰ã€‚\n    ![å›¾ç‰‡ 2](https://cdn-images-1.medium.com/max/1024/1*0Gujn6vAspuKh3ZuPjlK-g.png)\n    *Viaduct åŸå§‹çš„å¤æ‚ç¼–ç¨‹æ¨¡å‹*\n*   **æ–°æ¨¡å‹ï¼š** æ˜¾è‘—ç®€åŒ–ï¼Œåªæä¾›ä¸¤ç§æœºåˆ¶ï¼šèŠ‚ç‚¹è§£æå™¨ï¼ˆnode resolversï¼‰å’Œå­—æ®µè§£æå™¨ï¼ˆfield resolversï¼‰ã€‚é€‰æ‹©ç”±Schemaæœ¬èº«é©±åŠ¨ï¼Œè€ŒéåŸºäºåŠŸèƒ½è¡Œä¸ºçš„éšæ„åŒºåˆ†ï¼ˆè§ä¸‹å›¾ï¼‰ã€‚\n    ![å›¾ç‰‡ 3](https://cdn-images-1.medium.com/max/1024/1*xuL1H_ylQR5PU2eh2JuXEA.png)\n    *Viaduct Modern çš„ç®€åŒ–æ¨¡å‹*\n*   APIåœ¨ä¸¤ç§è§£æå™¨ç±»å‹ä¹‹é—´å°½å¯èƒ½ç»Ÿä¸€ï¼Œæå‡äº†å¼€å‘ä½“éªŒã€‚\n\n### ç§Ÿæˆ·æ¨¡å—åŒ–\n\n*   é€šè¿‡æ¨¡å—å’Œå¯é‡å…¥æ€§å®ç°å¼ºå¤§çš„æŠ½è±¡è¾¹ç•Œã€‚\n*   ä»æ¨¡ç³Šçš„ä»£ç ç»„ç»‡çº¦å®šæ¼”å˜ä¸ºæ­£å¼çš„â€œç§Ÿæˆ·æ¨¡å—â€æ¦‚å¿µï¼šä¸€ä¸ªSchemaå•å…ƒåŠå…¶å®ç°ä»£ç ï¼Œç”±å•ä¸ªå›¢é˜Ÿæ‹¥æœ‰ã€‚\n*   æ¨¡å—ä¹‹é—´é€šè¿‡GraphQLç‰‡æ®µå’ŒæŸ¥è¯¢è¿›è¡Œç»„åˆï¼Œè€Œéç›´æ¥çš„ä»£ç ä¾èµ–ã€‚\n*   **ç¤ºä¾‹ï¼š** â€œæ ¸å¿ƒç”¨æˆ·â€å›¢é˜Ÿå®šä¹‰`User`ç±»å‹ï¼Œè€Œâ€œæ¶ˆæ¯â€å›¢é˜Ÿå¯ä»¥é€šè¿‡`extend type User { displayName: String @resolver}`æ‰©å±•`User`ç±»å‹ï¼Œå¹¶å£°æ˜å…¶`displayName`å­—æ®µçš„è§£æå™¨ï¼Œæ— éœ€äº†è§£`firstName`å’Œ`lastName`å­—æ®µçš„æ¥æºã€‚\n\n### æ¡†æ¶æ¨¡å—åŒ–\n\n*   ç›®æ ‡æ˜¯ä½¿æ¡†æ¶æœ¬èº«æ›´å…·æ¨¡å—åŒ–ï¼Œä»¥ä¾¿æ›´å¿«åœ°æ”¹è¿›æ€§èƒ½å’Œå¯é æ€§ï¼ŒåŒæ—¶å‡å°‘å¯¹åº”ç”¨ä»£ç çš„ä¿®æ”¹ã€‚\n*   Viaductç”±GraphQLæ‰§è¡Œå¼•æ“ã€ç§Ÿæˆ·APIå’Œæ‰˜ç®¡åº”ç”¨ä»£ç ä¸‰å±‚ç»„æˆã€‚\n*   **æ–°è®¾è®¡ï¼š** åœ¨è¿™äº›å±‚ä¹‹é—´åˆ›å»ºäº†å¼ºå¤§çš„æŠ½è±¡è¾¹ç•Œï¼ˆè§ä¸‹å›¾ï¼‰ã€‚\n    ![å›¾ç‰‡ 4](https://cdn-images-1.medium.com/max/1024/1*qvOOmI-Hs7-PMa52kSACqQ.png)\n    *Viaduct Modern çš„æ¨¡å—åŒ–è®¾è®¡*\n*   æœ€æ˜¾è‘—çš„å˜åŒ–æ˜¯å¼•æ“ä¸é¢å‘å¼€å‘è€…çš„ç§Ÿæˆ·APIä¹‹é—´çš„è¾¹ç•Œã€‚å¼•æ“APIçš„æ ¸å¿ƒæ˜¯GraphQLå€¼çš„åŠ¨æ€ç±»å‹è¡¨ç¤ºï¼Œè€Œç§Ÿæˆ·APIæ˜¯é™æ€ç±»å‹çš„ï¼ˆé€šè¿‡ç”Ÿæˆçš„Kotlinç±»ï¼‰ã€‚ç”Ÿæˆçš„ç±»å‹æ˜¯åŠ¨æ€è¡¨ç¤ºçš„è–„å°è£…ã€‚è¿™ç§åˆ†ç¦»å…è®¸å¼•æ“å’Œç§Ÿæˆ·APIç‹¬ç«‹æ¼”è¿›ã€‚\n\n### å¹³æ»‘è¿ç§»\n\n*   ä¸ºå®ç°æ¸è¿›å¼è¿ç§»ï¼Œæ–°çš„Modern APIå’Œç°æœ‰çš„Classic APIåœ¨æ–°å¼•æ“ä¹‹ä¸Šå¹¶è¡Œè¿è¡Œã€‚\n*   å›¢é˜Ÿå¯ä»¥ç«‹å³è·å¾—å¼•æ“å¸¦æ¥çš„æ€§èƒ½/æˆæœ¬ä¼˜åŠ¿ï¼Œå¹¶é€æ­¥é‡‡ç”¨Modern APIçš„æ”¹è¿›ã€‚\n*   åŒæ—¶æ„å»ºä¸¤ä¸ªAPIä¹Ÿä¿ƒä½¿å¼•æ“APIè®¾è®¡æ›´åŠ é€šç”¨å’Œæ¸…æ™°ã€‚\n\n## å…¶ä»–æ”¹è¿›\n\nè‡ª2020å¹´ä»¥æ¥ï¼ŒViaductè¿˜è¿›è¡Œäº†å…¶ä»–æ”¹è¿›ï¼š\n\n*   **å¯è§‚æµ‹æ€§ï¼š** æ–°æ¶æ„æ¸…æ™°çš„è¾¹ç•Œä½¿å¾—æ‰€æœ‰æƒå’Œå½’å› æ›´åŠ ç²¾ç¡®ã€‚\n*   **æ„å»ºæ—¶é—´ï¼š** é‡‡ç”¨Schemaä¼˜å…ˆã€ç›´æ¥ç”Ÿæˆå­—èŠ‚ç ç­‰æ–¹å¼ä¼˜åŒ–æ„å»ºæ—¶é—´ï¼ŒViaduct Modernçš„æ¨¡å—åŒ–ä¹Ÿæœ‰åŠ©äºæ§åˆ¶æ„å»ºæ—¶é—´ã€‚\n*   **è°ƒåº¦å™¨ï¼š** ä½œä¸ºæ°´å¹³æ‰©å±•çš„Kubernetesåº”ç”¨è¿è¡Œï¼Œä½¿ç”¨è°ƒåº¦å™¨å°†æ“ä½œè·¯ç”±åˆ°éƒ¨ç½²åˆ†ç‰‡ï¼Œå®ç°æ··æ´—åˆ†ç‰‡ï¼Œå¹¶ç®€åŒ–ç¦»çº¿/åœ¨çº¿æµé‡éš”ç¦»ï¼ˆç›®å‰ä¸å¼€æºï¼‰ã€‚\n\n## Viaduct å¼€æº\n\nAirbnbä»â€œViaduct Modernâ€é¡¹ç›®å¯åŠ¨ä¹‹åˆå°±è®¡åˆ’å°†å…¶å¼€æºï¼Œæ—¨åœ¨æå‡è½¯ä»¶è´¨é‡ã€å›é¦ˆå¼€æºç¤¾åŒºï¼Œå¹¶å¸Œæœ›é€šè¿‡æ›´å¹¿æ³›ç¤¾åŒºçš„è´¡çŒ®æ¥æ”¹è¿›Viaductã€‚ç›®å‰ï¼Œæ–°å¼•æ“å·²å…¨é¢æŠ•å…¥ç”Ÿäº§ï¼Œè€Œæ–°çš„ç§Ÿæˆ·APIä»å¤„äºAlphaé˜¶æ®µã€‚Airbnbé¼“åŠ±ç¤¾åŒºå‚ä¸ï¼Œå…±åŒå¡‘é€ APIã€‚\n\n## Viaduct é€‚ç”¨æ€§\n\nViaductå·²è¢«è¯æ˜å¯ä»¥æ‰©å±•åˆ°å¤§è§„æ¨¡å›¾ï¼ŒåŒæ—¶ä¹Ÿé€‚åˆä½œä¸ºåˆå­¦è€…å‹å¥½çš„GraphQLæœåŠ¡å™¨ã€‚å®ƒä»ä¸€å¼€å§‹å°±å¼ºè°ƒå¼€å‘è€…ä½“éªŒï¼Œå¹¶æä¾›äº†ä¸€ä¸ªä¼˜ç§€çš„GraphQLè§£å†³æ–¹æ¡ˆæ„å»ºç¯å¢ƒã€‚",
      "shortSummary": "Airbnbå®£å¸ƒå°†å…¶æ•°æ®å¯¼å‘å‹æœåŠ¡ç½‘æ ¼Viaductå¼€æºã€‚è¿‡å»äº”å¹´ï¼ŒViaductåœ¨Airbnbå†…éƒ¨å®ç°äº†æ˜¾è‘—å¢é•¿ï¼Œæµé‡å¢é•¿å…«å€ï¼Œå›¢é˜Ÿæ•°é‡ç¿»å€ã€‚ä¸ºè§£å†³æ—©æœŸæ¼”è¿›ä¸­çš„å¤æ‚æ€§ï¼ŒViaductæ¨å‡ºäº†â€œViaduct Modernâ€è®¡åˆ’ï¼Œå½»åº•æ”¹é€ äº†å¼€å‘è€…APIå’Œæ‰§è¡Œå¼•æ“ï¼Œç®€åŒ–äº†ç¼–ç¨‹æ¨¡å‹ï¼Œå¢å¼ºäº†æ¨¡å—åŒ–ï¼Œå¹¶å®ç°äº†å¹³æ»‘è¿ç§»ã€‚ViaductåŸºäºä¸­å¿ƒåŒ–Schemaã€æ‰˜ç®¡ä¸šåŠ¡é€»è¾‘å’Œå¯é‡å…¥æ€§ä¸‰å¤§åŸåˆ™ï¼Œæ—¨åœ¨æä¾›å¼ºå¤§çš„ã€å¼€å‘è€…å‹å¥½çš„GraphQLè§£å†³æ–¹æ¡ˆã€‚å¼€æºæ—¨åœ¨æå‡è½¯ä»¶è´¨é‡å¹¶å¸çº³ç¤¾åŒºè´¡çŒ®ã€‚",
      "translated_title": "Viaductï¼Œäº”å¹´å›é¡¾ï¼šæ•°æ®å¯¼å‘å‹æœåŠ¡ç½‘æ ¼çš„ç°ä»£åŒ–",
      "images": [
        {
          "url": "https://cdn-images-1.medium.com/max/1024/1*q_owFEOLfQlioFXHP7UqBA.avif",
          "alt": "",
          "title": "",
          "position": 1
        },
        {
          "url": "https://cdn-images-1.medium.com/max/1024/1*0Gujn6vAspuKh3ZuPjlK-g.png",
          "alt": "",
          "title": "",
          "position": 2
        },
        {
          "url": "https://cdn-images-1.medium.com/max/1024/1*xuL1H_ylQR5PU2eh2JuXEA.png",
          "alt": "",
          "title": "",
          "position": 3
        },
        {
          "url": "https://cdn-images-1.medium.com/max/1024/1*qvOOmI-Hs7-PMa52kSACqQ.png",
          "alt": "",
          "title": "",
          "position": 4
        },
        {
          "url": "https://medium.com/_/stat?event=post.clientViewed&referrerSource=full_rss&postId=e66397c9e9a9",
          "alt": "",
          "title": "",
          "position": 5
        }
      ],
      "contentSource": "RSS",
      "content": "<figure><img alt=\"\" src=\"https://cdn-images-1.medium.com/max/1024/1*q_owFEOLfQlioFXHP7UqBA.avif\" /></figure><h4>A more powerful engine and a simpler API for our data-oriented mesh</h4><p>By: Adam Miskiewicz, RaymieÂ Stata</p><p>In November 2020 we <a href=\"https://medium.com/airbnb-engineering/taming-service-oriented-architecture-using-a-data-oriented-service-mesh-da771a841344\">published</a> a post about Viaduct, our data-oriented service mesh. Today, weâ€™re excited to announce Viaduct is available as open-source software (OSS) at <a href=\"https://github.com/airbnb/viaduct\">https://github.com/airbnb/viaduct</a>.</p><p>Before we talk about OSS, hereâ€™s a quick update on Viaductâ€™s adoption and evolution at Airbnb over the last five years. Since 2020, traffic through Viaduct has grown by a factor of eight. The number of teams hosting code in Viaduct has doubled to 130+ (with hundreds of weekly active developers). The codebase hosted by Viaduct has tripled to over <strong>1.5M</strong> lines (plus about the same in test code). Weâ€™ve achieved all this while keeping operational overhead constant, halving incident-minutes, and keeping costs growing linearly withÂ QPS.</p><h3>Whatâ€™s theÂ same?</h3><p>Three principles have guided Viaduct since day one and still anchor the project: a <strong>central schema</strong> served by <strong>hosted business logic</strong> via a <strong>re-entrant</strong> API.</p><p><strong>Central schema <br></strong>Viaduct serves our central schema: a single, integrated schema connecting all of our domains across the company. While that schema is developed in a <em>decentralized</em> manner by many teams, itâ€™s one, highly connected graph. Over 75% of Viaduct requests are internal because Viaduct has become a â€œoneâ€‘stopâ€ data-oriented mesh connecting developers to all of our data and capabilities.</p><p><strong>Hosted business logic <br></strong>From the beginning, weâ€™ve encouraged teams to host their business logic directly in Viaduct. This runs counter to what many consider to be best practices in GraphQL, which is that GraphQL servers should be a thin layer over microservices that host the real business logic. Weâ€™ve created a serverless platform for hosting business logic, allowing our developers to focus on writing business logic rather than on operational issues. As noted by Katie, an engineer on our MediaÂ team:</p><blockquote>â€œAs we migrate our media APIs into Viaduct, weâ€™re looking forward to retiring a handful of standalone services. Centralizing everything means less overhead, fewer moving parts, and a much smoother developer experience!â€</blockquote><p><strong>Re-entrancy</strong></p><p>At the heart of our developer experience is what we call <em>re-entrancy</em>: Logic hosted on Viaduct composes with other logic hosted on Viaduct by issuing GraphQL fragments and queries. Re-entrancy has been crucial for maintaining modularity in a large codebase and avoiding classic monolithÂ hazards.</p><h3>Whatâ€™s changed?</h3><p>For most of Viaductâ€™s history, evolution has been bottom-up and reactive to immediate developer needs. We added capabilities incrementally, which helped us move fast, but also produced multiple ways to accomplish similar tasks (some wellâ€‘supported, others not) and created a confusing developer experience, especially for new teams. Another side-effect of this reactive approach has been a lack of architectural integrity. The interfaces between the layers of Viaduct, described in more detail below, are loose and often arbitrary, and the abstraction boundary between the Viaduct framework and the code that it hosts is weak. As a result, it has become increasingly difficult to make changes to Viaduct without disrupting our customerÂ base.</p><p>To address these issues, over a year ago we launched a major initiative we call <strong>â€œViaduct Modernâ€</strong>, a ground-up overhaul of both the developer-facing API and the execution engine.</p><h3>Tenant API</h3><p>One driving principle of Viaduct Modern has been to simplify and rationalize the API we provide to developers in Viaduct, which we call the <strong>â€œTenant APIâ€</strong>. The following diagram captures the decision tree one faced when deciding how to implement functionality in the oldÂ API:</p><figure><img alt=\"\" src=\"https://cdn-images-1.medium.com/max/1024/1*0Gujn6vAspuKh3ZuPjlK-g.png\" /><figcaption>Viaductâ€™s original complex programming model</figcaption></figure><p>Each oval in this diagram represents a different mechanism for writing code. In contrast, the new API offers just two mechanisms: node resolvers and field resolvers.</p><figure><img alt=\"\" src=\"https://cdn-images-1.medium.com/max/1024/1*xuL1H_ylQR5PU2eh2JuXEA.png\" /><figcaption>Viaduct Modernâ€™s simplerÂ model</figcaption></figure><p>The choice between the two is driven by the schema itself, not adâ€‘hoc distinctions based on a featureâ€™s behavior. We unified the APIs for both resolver types wherever possible, which simplifies dev experience. After four years evolving the API in a useâ€‘caseâ€‘driven manner, we distilled the best ideas into a single simple surface (and left the mistakesÂ behind).</p><h3>Tenant modularity</h3><p>Strong abstraction boundaries are essential in any large codebase. Microservices achieve this via service definitions and RPC API boundaries; Viaduct achieves it via <strong>modules</strong> plus <strong>reâ€‘entrancy</strong>.</p><p>Modularity in the central schema and hosted code has evolved. Initially, all we had was a vague set of conventions for organizing code into team-owned directories. There was no formal concept of a module, and schema and code were kept in separate source directories with unenforced naming conventions to connect the two. Over time, we evolved that into a more formal abstraction we call a â€œtenant module.â€ A tenant module is a unit of schema together with the code that implements that schema, and crucially, is owned by a single team. While we encourage rich graphâ€‘level connections across modules, we <strong>discourage direct code dependencies</strong> between modules. Instead, modules compose via GraphQL fragments and queries. Viaduct Modern extends and simplifies these reâ€‘entrancy tools.</p><p>Letâ€™s look at an example. Imagine two teams, a â€œCore Userâ€ team that owns and manages the basic profile data of users, and then a â€œMessagingâ€ team that operates a messaging platform for users to interact with each other. In our example, the Messaging team would like to define a <em>displayName</em> field on a <em>User</em>, which is used in their user interface. This would look something likeÂ this:</p><p><strong>Core UserÂ team</strong></p><pre>type User implements Node {<br>  id: ID!<br>  firstName: String<br>  lastName: String<br>  â€¦ <br>}</pre><pre>class UserResolver : Nodes.User() {<br>    @Inject<br>    val userClient: UserServiceClient<br><br>    @Inject<br>    val userResponseMapper: UserResponseMapper<br><br>    override suspend fun resolve(ctx.Context): User {<br>        val r = userClient.fetch(ctx.id)<br>        return userResponseMapper(r)<br>    } <br>}</pre><p>This is the base definition of the <em>User</em> type that lives in the Core User teamâ€™s module. This base definition defines the first- and last-name fields (among many others), and itâ€™s the Core User teamâ€™s responsibility to materialize thoseÂ fields.</p><p><strong>Messaging team</strong></p><pre>extend type User {<br>  displayName: String @resolver<br>}</pre><pre>@Resolver(&quot;firstName lastName&quot;)<br>class DisplayNameResolver : UserResolvers.DisplayName() {<br>    override suspend fun resolve(ctx: Context): String {<br>        val f = ctx.objectValue.getFirstName()<br>        val l = ctx.objectValue.getLastName()<br>        return &quot;$f ${l.first()}.&quot;<br>    }<br>}</pre><p>The Messaging team can then extend the <em>User </em>type with the display name field, and also indicates that they intend to provide a resolver for it. The code has an <em>@Resolver </em>annotation that indicates which fields of the <em>User</em> object it needs to implement the <em>displayName</em> field. The Messaging team doesnâ€™t need to understand which module these fields come from, and their code doesnâ€™t depend on code from the Core User team. Instead, the Messaging team states their data needs in a declarative fashion.</p><h3>Framework modularity</h3><p>A major goal of Viaduct Modern has been to make the framework itself more modular. We want to enable faster improvements to Viaductâ€Šâ€”â€Šespecially regarding performance and reliabilityâ€Šâ€”â€Šwithout extensive changes to application code. Viaduct is composed of three main layers: the GraphQL execution engine, the tenant API, and the hosted application code. While these layers made sense, the interfaces between them were weak, making Viaduct difficult to update. The new design is focused on creating strong abstraction boundaries between these layers to improve flexibility and maintainability:</p><figure><img alt=\"\" src=\"https://cdn-images-1.medium.com/max/1024/1*qvOOmI-Hs7-PMa52kSACqQ.png\" /><figcaption>Viaduct Modernâ€™s modularÂ design</figcaption></figure><p>The most significant change is the boundary between the <strong>engine</strong> and the developer-facing <strong>tenant API</strong>. In the previous system, that boundary hardly existed. Viaduct Modern defines a strong <strong>engine API</strong> whose core is a <strong>dynamicallyâ€‘typed</strong> representation of GraphQL values (input and output objects as simple maps from field name â†’ value). The tenant API, by contrast, is <strong>statically typed</strong>: we generate Kotlin classes for every GraphQL type in the central schema. In the new architecture, generated types are thin wrappers over the dynamic representation. The tenant API forms the bridge between the engineâ€™s untyped world and tenantsâ€™ typedÂ world.</p><p>This separation lets us evolve the engine in relative isolation (to improve latency, throughput, and reliability) and evolve the tenant API in relative isolation (to improve dev experience). Large changes will still cross the boundary, but as Viaduct Modern stabilizes, that should beÂ rare.</p><h3>Migration without a â€œbigÂ bangâ€</h3><p>Viaduct Modern would be a nonâ€‘starter if it required a stepâ€‘function migration of a million+ lines of code. To enable gradual migration, weâ€™re shipping <strong>two tenant APIs</strong> sideâ€‘byâ€‘sideâ€Šâ€”â€Šthe new <strong>Modern</strong> API and the existing <strong>Classic</strong> APIâ€Šâ€”â€Šboth on top of the new engine. This lets teams realize performance/cost wins from the engine immediately, while adopting the ergonomic wins of the Modern API overÂ time.</p><p>Shipping two APIs has also improved the engine API design: building two tenant runtimes simultaneously forced us to keep the engineâ€™s concerns clean and general. Over time, we expect to build additional tenant APIs on the engine (e.g., <strong>TypeScript</strong>).</p><h3>Other improvements</h3><p>Viaduct has seen a lot of other improvements since 2020. The story is too long to be told in this post, but to list some of the highlights:</p><ul><li><strong>Observability.</strong> Hosting software from 100+ teams means our framework has to make ownership and attribution crystal clear. In the old system, there is no clear dividing line between tenant code and framework code, so our instrumentation includes a bit of guesswork in its attribution to parties. The new architecture draws a crisp boundary, which enables deeper, more accurate attribution.</li><li><strong>Build time.</strong> Weâ€™re schemaâ€‘first: Developers write schema as source, and Viaduct generates code to provide a strongly typed, ergonomic surface. At our scale, build time is a constant battle. Over the years weâ€™ve made numerous investments to improve build time, including direct-to-bytecode code generation that bypasses lengthy compilation of generated code. We anticipate that the improved modularity in Viaduct Modern will keep build times in check as the codebaseÂ grows.</li><li><strong>Dispatcher.</strong> We run Viaduct as a horizontally-scaled Kubernetes app. To mitigate blast radius, we use a dispatcher that routes operations to deployment shards, applying <a href=\"https://aws.amazon.com/blogs/architecture/shuffle-sharding-massive-and-magical-fault-isolation/\">shuffle sharding</a>. It also simplifies isolating offline vs. online traffic and hosting experimental framework builds. (We donâ€™t currently plan to openâ€‘source the dispatcher as itâ€™s tightly tied to Airbnbâ€™s serving framework, but we may talk more about our strategies here in theÂ future!)</li></ul><h3>Open-sourcing Viaduct</h3><p>Our intent from the start of Viaduct Modern was to openâ€‘source it. We believe that setting out to build software for the world will result in higher quality software for ourselves. Also, as a significant consumer of open-source software, we feel an obligation to give back. Last but not least, while weâ€™ve learned a lot by working with Airbnb developers, we think Viaduct can be massively improved by incorporating ideas and contributions from the wider community.</p><p>Weâ€™re openâ€‘sourcing at an interesting moment. Viaduct is <strong>mature and battleâ€‘tested</strong> <em>and also</em> <strong>new and evolving</strong>. The new engine is now in full production, while the new tenant API is still in alpha. Weâ€™ve implemented a small but robust kernel of the new API and are using it in a few (demanding) use cases. Weâ€™re investing heavily in the Modern API and migrating our own workloads to it, but itâ€™s early days. By openâ€‘sourcing early, we hope to grow a community who will shape the API with us together.</p><h3>Is Viaduct forÂ you?</h3><p>Although our use case proves Viaduct can scale to massive graphs, we think itâ€™s also a great GraphQL server when youâ€™re just starting. Weâ€™ve emphasized developer ergonomics from day one, and we believe Viaduct provides one of the best environments for building GraphQL solutions. Whether youâ€™re operating a super-graph today or just kicking the tires, weâ€™d love for you to try Viaduct Modern and tell us what worksâ€Šâ€”â€Šand whatÂ doesnâ€™t.</p><p>â€”</p><p>Thanks to the entire Viaduct team, and especially Aileen Chen and Raymie Stata, for the tireless work on ViaductÂ Modern.</p><p><em>All product names, logos, and brands are property of their respective owners. All company, product and service names used in this website are for identification purposes only. Use of these names, logos, and brands does not imply endorsement.</em></p><img src=\"https://medium.com/_/stat?event=post.clientViewed&referrerSource=full_rss&postId=e66397c9e9a9\" width=\"1\" height=\"1\" alt=\"\"><hr><p><a href=\"https://medium.com/airbnb-engineering/viaduct-five-years-on-modernizing-the-data-oriented-service-mesh-e66397c9e9a9\">Viaduct, Five Years On: Modernizing the Data-Oriented Service Mesh</a> was originally published in <a href=\"https://medium.com/airbnb-engineering\">The Airbnb Tech Blog</a> on Medium, where people are continuing the conversation by highlighting and responding to this story.</p>"
    },
    {
      "title": "ä½¿ç”¨æ•°æ®å¯¼å‘çš„æœåŠ¡ç½‘æ ¼é©¯æœé¢å‘æœåŠ¡çš„æ¶æ„ (åŸæ ‡é¢˜: Taming Service-Oriented Architecture Using A Data-Oriented Service Mesh)",
      "link": "https://medium.com/airbnb-engineering/taming-service-oriented-architecture-using-a-data-oriented-service-mesh-da771a841344?source=rss----53c7c27702d5---4",
      "pubDate": "Tue, 16 Sep 2025 18:37:58 GMT",
      "isoDate": "2025-09-16T18:37:58.000Z",
      "creator": "Adam Miskiewicz",
      "summary": "# ä½¿ç”¨æ•°æ®å¯¼å‘çš„æœåŠ¡ç½‘æ ¼é©¯æœé¢å‘æœåŠ¡çš„æ¶æ„ï¼šAirbnb çš„ Viaduct\n\nAirbnb æ¨å‡ºäº†ä¸€æ¬¾åä¸º Viaduct çš„æ•°æ®å¯¼å‘æœåŠ¡ç½‘æ ¼ï¼Œæ—¨åœ¨æ˜¾è‘—æå‡å…¶åŸºäºå¾®æœåŠ¡çš„é¢å‘æœåŠ¡æ¶æ„ï¼ˆSOAï¼‰çš„æ¨¡å—åŒ–æ°´å¹³ã€‚æœ¬æ–‡é˜è¿°äº† Viaduct çš„è®¾è®¡ç†å¿µå’Œå·¥ä½œåŸç†ã€‚\n\n## å¤§è§„æ¨¡ SOA ä¾èµ–å›¾çš„æŒ‘æˆ˜\nç°ä»£åº”ç”¨ç¨‹åºé€šå¸¸åŒ…å«æ•°åƒç”šè‡³æ•°ä¸‡ä¸ªå¾®æœåŠ¡ï¼Œå®ƒä»¬ä»¥ä¸å—çº¦æŸçš„æ–¹å¼ç›¸äº’è¿æ¥ï¼Œå¯¼è‡´å¤æ‚çš„ä¾èµ–å›¾ã€‚è¿™ç§â€œæ„å¤§åˆ©é¢æ¡å¼ SOAâ€ä½¿å¾—ç³»ç»Ÿä¿®æ”¹æ—¥ç›Šå›°éš¾ã€‚ä¸ºäº†ç®¡ç†åºå¤§çš„å¾®æœåŠ¡æ•°é‡ï¼Œéœ€è¦æ–°çš„ç»„ç»‡åŸåˆ™å’ŒæŠ€æœ¯æªæ–½ã€‚Airbnb çš„ç ”ç©¶å‘ç°ï¼Œæ•°æ®å¯¼å‘çš„æœåŠ¡ç½‘æ ¼èƒ½å¤Ÿä¸º SOA å¸¦æ¥æ–°çš„æ¨¡å—åŒ–æ°´å¹³ã€‚\n\n![å›¾ç‰‡ 1](https://cdn-images-1.medium.com/max/1024/1*KUevf-1aGcLQyit3wzmh8w.jpeg)\n\n*å›¾ç¤ºï¼šAirbnb å·¥ç¨‹å¸ˆ Raymie Stata, Arun Vijayvergiya, Adam Miskiewicz ä»‹ç» Viaduct*\n\n![å›¾ç‰‡ 2](https://cdn-images-1.medium.com/max/896/1*y2E1EmsS3paNhoChYGnJIw.png)\n\n*å›¾ç¤ºï¼šä¸€ä¸ªå…¸å‹çš„å¾®æœåŠ¡ä¾èµ–å›¾ï¼Œå±•ç¤ºäº†å¤æ‚çš„æœåŠ¡é—´å…³ç³»*\n\n## è¿‡ç¨‹å¯¼å‘ä¸æ•°æ®å¯¼å‘è®¾è®¡\nè½¯ä»¶å·¥ç¨‹ä¸­æ¨¡å—åŒ–ç»„ç»‡ç¨‹åºå¹¶éæ–°é—®é¢˜ï¼š\n*   **è¿‡ç¨‹å¯¼å‘è®¾è®¡ï¼ˆ1970å¹´ä»£å‰ï¼‰**ï¼šä»¥è¿‡ç¨‹å’Œæ¨¡å—ä¸ºä¸­å¿ƒï¼Œæ¨¡å—é€šè¿‡å…¬å…± API æš´éœ²åŠŸèƒ½ï¼Œéšè—å†…éƒ¨å®ç°ï¼ˆå¦‚ Pascal å’Œ Cï¼‰ã€‚\n*   **æ•°æ®å¯¼å‘è®¾è®¡ï¼ˆ1980å¹´ä»£åï¼‰**ï¼šä»¥æ•°æ®ä¸ºä¸­å¿ƒï¼Œæ¨¡å—å®šä¹‰å¯¹è±¡ç±»ï¼Œé€šè¿‡å…¬å…±æ–¹æ³• API è®¿é—®å°è£…çš„å†…éƒ¨æ•°æ®ï¼ˆå¦‚ Simula å’Œ Cluï¼‰ã€‚\n\nå½“å‰çš„ SOA åŠå…¶å¾®æœåŠ¡æœ¬è´¨ä¸Šæ˜¯è¿‡ç¨‹å¯¼å‘çš„ï¼Œç±»ä¼¼äº1970å¹´ä»£çš„æ¨¡å—ã€‚Airbnb è®¤ä¸º SOA éœ€è¦å‘æ•°æ®å¯¼å‘è®¾è®¡æ¼”è¿›ï¼Œè€ŒæœåŠ¡ç½‘æ ¼ä»è¿‡ç¨‹å¯¼å‘è½¬å‘æ•°æ®å¯¼å‘æ˜¯å®ç°è¿™ä¸€ç›®æ ‡çš„å…³é”®ã€‚\n\n## Viaductï¼šæ•°æ®å¯¼å‘çš„æœåŠ¡ç½‘æ ¼\nç°ä»£å¯æ‰©å±• SOA åº”ç”¨çš„æ ¸å¿ƒæ˜¯æœåŠ¡ç½‘æ ¼ï¼ˆå¦‚ Istio, Linkerdï¼‰ï¼Œè´Ÿè´£å°†æœåŠ¡è°ƒç”¨è·¯ç”±åˆ°ç›¸åº”çš„å¾®æœåŠ¡å®ä¾‹ã€‚ç„¶è€Œï¼Œè¡Œä¸šæ ‡å‡†çš„æœåŠ¡ç½‘æ ¼é€šå¸¸åªå…³æ³¨è¿œç¨‹è¿‡ç¨‹è°ƒç”¨ï¼Œå¯¹æ„æˆåº”ç”¨æ¶æ„çš„æ•°æ®ä¸€æ— æ‰€çŸ¥ã€‚Viaduct çš„æ„¿æ™¯æ˜¯ç”¨æ•°æ®å¯¼å‘çš„æœåŠ¡ç½‘æ ¼å–ä»£è¿™äº›è¿‡ç¨‹å¯¼å‘çš„æœåŠ¡ç½‘æ ¼ã€‚\n\nAirbnb ä½¿ç”¨ GraphQL æ„å»ºäº† Viaductï¼Œä¸€ä¸ªæ•°æ®å¯¼å‘çš„æœåŠ¡ç½‘æ ¼ã€‚Viaduct æœåŠ¡ç½‘æ ¼é€šè¿‡ GraphQL schema å®šä¹‰ï¼ŒåŒ…å«ï¼š\n*   **ç±»å‹ï¼ˆTypesï¼‰å’Œæ¥å£ï¼ˆInterfacesï¼‰**ï¼šæè¿°æœåŠ¡ç½‘æ ¼å†…ç®¡ç†çš„æ•°æ®ã€‚\n*   **æŸ¥è¯¢ï¼ˆQueriesï¼‰å’Œè®¢é˜…ï¼ˆSubscriptionsï¼‰**ï¼šæä¾›è®¿é—®æ•°æ®çš„æ–¹å¼ï¼Œè¿™äº›æ–¹å¼ä»æä¾›æ•°æ®çš„æœåŠ¡å…¥å£ç‚¹ä¸­æŠ½è±¡å‡ºæ¥ã€‚\n*   **å˜æ›´ï¼ˆMutationsï¼‰**ï¼šæä¾›æ›´æ–°æ•°æ®çš„æ–¹å¼ï¼ŒåŒæ ·ä»æœåŠ¡å…¥å£ç‚¹ä¸­æŠ½è±¡å‡ºæ¥ã€‚\n\nSchema ä¸­çš„ç±»å‹å’Œæ¥å£å®šä¹‰äº†æœåŠ¡ç½‘æ ¼ä¸­æ‰€æœ‰æ•°æ®çš„ä¸€ä¸ªç»Ÿä¸€å›¾ã€‚ä¾‹å¦‚ï¼Œä¸€ä¸ªç”µå•†å…¬å¸çš„ schema å¯èƒ½å®šä¹‰ `productById(id: ID)` å­—æ®µè¿”å› `Product` ç±»å‹ç»“æœï¼Œæ•°æ®æ¶ˆè´¹è€…å¯ä»¥é€šè¿‡ä¸€ä¸ªæŸ¥è¯¢ä»äº§å“å¯¼èˆªåˆ°åˆ¶é€ å•†ã€è¯„è®ºç”šè‡³è¯„è®ºä½œè€…ï¼Œè€Œæ— éœ€äº†è§£åº•å±‚æ•°æ®æ¥è‡ªå“ªäº›å¾®æœåŠ¡ã€‚Viaduct è´Ÿè´£ç®¡ç†æœåŠ¡ä¾èµ–ï¼Œå°†å…¶ä»æ•°æ®æ¶ˆè´¹è€…ä¸­æŠ½è±¡å‡ºæ¥ã€‚\n\n## ä»¥ Schema ä¸ºä¸­å¿ƒ\nViaduct å°† schema è§†ä¸ºä¸€ä¸ªå•ä¸€çš„å·¥ä»¶ï¼Œå¹¶å®ç°äº†å¤šé¡¹åŸè¯­ï¼Œå…è®¸å›¢é˜Ÿåœ¨ä¿æŒç»Ÿä¸€ schema çš„åŒæ—¶é«˜æ•ˆåä½œã€‚éšç€ Viaduct é€æ¸å–ä»£åº•å±‚çš„è¿‡ç¨‹å¯¼å‘æœåŠ¡ç½‘æ ¼ï¼Œå…¶ schema å°†æ›´å®Œæ•´åœ°æ•æ‰åº”ç”¨ç®¡ç†çš„æ•°æ®ã€‚Airbnb åˆ©ç”¨è¿™ä¸ªâ€œä¸­å¿ƒ schemaâ€æ¥å®šä¹‰éƒ¨åˆ†å¾®æœåŠ¡çš„ APIï¼Œè¿™äº›å¾®æœåŠ¡çš„ GraphQL schema æ˜¯ä¸­å¿ƒ schema çš„å­é›†ã€‚æœªæ¥ï¼Œè®¡åˆ’è¿›ä¸€æ­¥åˆ©ç”¨ä¸­å¿ƒ schema æ¥å®šä¹‰æ•°æ®åº“ä¸­å­˜å‚¨çš„æ•°æ®çš„ schemaã€‚\n\nè¿™ç§ä»¥ä¸­å¿ƒ schema å®šä¹‰ API å’Œæ•°æ®åº“ schema çš„æ–¹æ³•ï¼Œå°†è§£å†³å¤§è§„æ¨¡ SOA åº”ç”¨é¢ä¸´çš„ä¸€å¤§æŒ‘æˆ˜ï¼š**æ•°æ®æ•æ·æ€§**ã€‚ç›®å‰ï¼Œæ•°æ®åº“ schema çš„å˜æ›´å¾€å¾€éœ€è¦æ‰‹åŠ¨åæ˜ åœ¨ä¸¤å±‚ã€ä¸‰å±‚ç”šè‡³æ›´å¤šå±‚å¾®æœåŠ¡çš„ API ä¸­ï¼Œæ‰èƒ½æš´éœ²ç»™å®¢æˆ·ç«¯ä»£ç ï¼Œè¿™å¯èƒ½éœ€è¦æ•°å‘¨çš„å¤šå›¢é˜Ÿåè°ƒã€‚é€šè¿‡ä»å•ä¸€çš„ä¸­å¿ƒ schema æ´¾ç”ŸæœåŠ¡ API å’Œæ•°æ®åº“ schemaï¼Œæ•°æ®åº“ schema çš„å˜æ›´å¯ä»¥é€šè¿‡ä¸€æ¬¡æ›´æ–°ä¼ æ’­åˆ°å®¢æˆ·ç«¯ä»£ç ã€‚\n\n## æ— æœåŠ¡å™¨åŒ–ï¼ˆServerlessï¼‰\nåœ¨å¤§å‹ SOA åº”ç”¨ä¸­ï¼Œå­˜åœ¨è®¸å¤šæ— çŠ¶æ€çš„â€œæ´¾ç”Ÿæ•°æ®æœåŠ¡â€å’Œâ€œå‰ç«¯åç«¯æœåŠ¡â€ï¼Œå®ƒä»¬ä»åº•å±‚æœåŠ¡è·å–åŸå§‹æ•°æ®å¹¶è½¬æ¢ä¸ºé€‚åˆå®¢æˆ·ç«¯å±•ç¤ºçš„æ•°æ®ã€‚è¿™ç§æ— çŠ¶æ€é€»è¾‘éå¸¸é€‚åˆæ— æœåŠ¡å™¨è®¡ç®—æ¨¡å‹ï¼Œå®ƒæ¶ˆé™¤äº†å¾®æœåŠ¡çš„æ“ä½œå¼€é”€ï¼Œå°†é€»è¾‘æ‰˜ç®¡åœ¨â€œäº‘å‡½æ•°â€å¹³å°ä¸­ã€‚\n\nViaduct æ‹¥æœ‰ä¸€ç§æœºåˆ¶ï¼Œå¯ä»¥ä½¿ç”¨æ— æœåŠ¡å™¨äº‘å‡½æ•°è®¡ç®—â€œæ´¾ç”Ÿå­—æ®µâ€ï¼Œè¿™äº›å‡½æ•°åœ¨å›¾ä¹‹ä¸Šè¿è¡Œï¼Œæ— éœ€äº†è§£åº•å±‚æœåŠ¡ã€‚è¿™ä½¿å¾—è½¬æ¢é€»è¾‘å¯ä»¥ä»æœåŠ¡ç½‘æ ¼ä¸­ç§»å‡ºï¼Œæ”¾å…¥æ— çŠ¶æ€å®¹å™¨ï¼Œä»è€Œä¿æŒå›¾çš„æ•´æ´ï¼Œå¹¶å‡å°‘æ‰€éœ€æœåŠ¡çš„æ•°é‡å’Œå¤æ‚æ€§ã€‚\n\n## ç»“è®º\nViaduct åŸºäº `graphql-java` æ„å»ºï¼Œæ”¯æŒé€šè¿‡ GraphQL é€‰æ‹©é›†è¿›è¡Œç»†ç²’åº¦å­—æ®µé€‰æ‹©ã€‚å®ƒé‡‡ç”¨ç°ä»£æ•°æ®åŠ è½½æŠ€æœ¯ï¼Œå®ç°çŸ­è·¯å’Œè½¯ä¾èµ–ç­‰å¯é æ€§æŠ€æœ¯ï¼Œå¹¶åŒ…å«è¯·æ±‚å†…ç¼“å­˜ã€‚Viaduct æä¾›æ•°æ®å¯è§‚å¯Ÿæ€§ï¼Œå…è®¸åœ¨å­—æ®µçº§åˆ«ç†è§£å“ªäº›æœåŠ¡æ¶ˆè´¹äº†å“ªäº›æ•°æ®ã€‚ä½œä¸ºä¸€ä¸ª GraphQL æ¥å£ï¼ŒViaduct åˆ©ç”¨äº†åºå¤§çš„å¼€æºå·¥å…·ç”Ÿæ€ç³»ç»Ÿï¼ŒåŒ…æ‹¬å®æ—¶ IDEã€æ¨¡æ‹ŸæœåŠ¡å™¨å’Œ schema å¯è§†åŒ–å·¥å…·ã€‚\n\nViaduct å·²åœ¨ Airbnb ç”Ÿäº§ç¯å¢ƒä¸­è¿è¡Œä¸€å¹´å¤šï¼Œä»å°‘é‡æ ¸å¿ƒå®ä½“å¼€å§‹ï¼Œç°å·²å‘å±•åˆ°åŒ…å«80ä¸ªæ ¸å¿ƒå®ä½“ï¼Œèƒ½å¤Ÿæ”¯æŒ Airbnb 75% çš„ç°ä»£ API æµé‡ã€‚",
      "shortSummary": "Airbnb æ¨å‡ºäº† Viaductï¼Œä¸€ä¸ªåŸºäº GraphQL çš„æ•°æ®å¯¼å‘æœåŠ¡ç½‘æ ¼ï¼Œæ—¨åœ¨è§£å†³å¤§è§„æ¨¡é¢å‘æœåŠ¡æ¶æ„ï¼ˆSOAï¼‰ä¸­å¾®æœåŠ¡ä¾èµ–å›¾å¤æ‚æ€§é—®é¢˜ã€‚Viaduct å°†æœåŠ¡ç½‘æ ¼ä»ä¼ ç»Ÿçš„è¿‡ç¨‹å¯¼å‘è½¬å˜ä¸ºæ•°æ®å¯¼å‘ï¼Œé€šè¿‡ç»Ÿä¸€çš„ GraphQL schema æŠ½è±¡æ•°æ®è®¿é—®å’Œåº•å±‚æœåŠ¡ä¾èµ–ã€‚è¿™æ˜¾è‘—æå‡äº†æ¨¡å—åŒ–ï¼Œç®€åŒ–äº†æ•°æ®æ•æ·æ€§ï¼Œå¹¶æ”¯æŒæ— æœåŠ¡å™¨å‡½æ•°å¤„ç†æ´¾ç”Ÿæ•°æ®ã€‚Viaduct å·²åœ¨ Airbnb ç”Ÿäº§ç¯å¢ƒä¸­è¿è¡Œä¸€å¹´å¤šï¼Œæœ‰æ•ˆç®¡ç†äº†75%çš„ç°ä»£ API æµé‡ã€‚",
      "translated_title": "ä½¿ç”¨æ•°æ®å¯¼å‘çš„æœåŠ¡ç½‘æ ¼é©¯æœé¢å‘æœåŠ¡çš„æ¶æ„",
      "images": [
        {
          "url": "https://cdn-images-1.medium.com/max/1024/1*KUevf-1aGcLQyit3wzmh8w.jpeg",
          "alt": "",
          "title": "",
          "position": 1
        },
        {
          "url": "https://cdn-images-1.medium.com/max/896/1*y2E1EmsS3paNhoChYGnJIw.png",
          "alt": "",
          "title": "",
          "position": 2
        },
        {
          "url": "https://medium.com/_/stat?event=post.clientViewed&referrerSource=full_rss&postId=da771a841344",
          "alt": "",
          "title": "",
          "position": 3
        }
      ],
      "contentSource": "RSS",
      "content": "<p>Introducing Viaduct, Airbnbâ€™s data-oriented serviceÂ mesh</p><p>By: Raymie Stata, Arun Vijayvergiya, Adam Miskiewicz</p><figure><img alt=\"\" src=\"https://cdn-images-1.medium.com/max/1024/1*KUevf-1aGcLQyit3wzmh8w.jpeg\" /></figure><p>At Hasuraâ€™s <a href=\"https://hasura.io/enterprisegraphql/\">Enterprise GraphQL Conf</a> on October 22, we presented Viaduct, what weâ€™re calling a <em>data-oriented service mesh </em>that we believe will bring a step function improvement in the modularity of our microservices-based Service-Oriented Architecture (SOA). In this blog post, we describe the philosophy behind Viaduct and provide a rough sketch of how it works. Please <a href=\"https://www.youtube.com/watch?v=xxk9MWCk7cM\">watch the presentation</a> for a more detailedÂ look.</p><h3>Massive SOA Dependency Graphs</h3><p>For a while, <strong>S</strong>ervice-<strong>O</strong>riented <strong>A</strong>rchitectures have been moving towards ever larger numbers of small microservices. Modern applications can consist of thousands to tens of thousands of microservices connected in unconstrained ways. As a result, itâ€™s not uncommon to see dependency graphs like the following:</p><figure><img alt=\"\" src=\"https://cdn-images-1.medium.com/max/896/1*y2E1EmsS3paNhoChYGnJIw.png\" /></figure><p>This particular dependency graph happens to be from Airbnb, but itâ€™s not uncommon. <a href=\"https://twitter.com/werner/status/741673514567143424\">Amazon</a>, <a href=\"https://medium.com/refraction-tech-everything/how-netflix-works-the-hugely-simplified-complex-stuff-that-happens-every-time-you-hit-play-3a40c9be254b\">Netflix</a>, and <a href=\"https://eng.uber.com/microservice-architecture/\">Uber</a> are examples of those that shared similarly tangled dependency graphs.</p><p>These dependency graphs are reminiscent of <a href=\"https://en.wikipedia.org/wiki/Spaghetti_code\">spaghetti code</a>, just at the microservices level. Similar to how spaghetti code becomes harder and harder to modify over time, so does spaghetti SOA. To help manage the larger number of services inherent in a microservices-based architecture, we need organizing principles as well as technical measures to implement those principles. At Airbnb, we undertook an effort to find such principles and measures. Our investigations led us to the concept of a <em>data-oriented service mesh</em>,<em> </em>which we believe brings a new level of modularity toÂ SOA.</p><h3>Procedure- vs Data-Oriented Design</h3><p>Organizing large programs into modular units is not a new problem in software engineering. Up until the 1970s, the main paradigm of software organization focused on grouping code into procedures and procedures into modules. In this approach, modules publish a public API to be used by code outside of the module; behind this public API, modules hide their internal, helper procedures and other implementation details. Languages such as Pascal and C are based on this paradigm.</p><p>Starting in the â€™80s, the paradigm shifted to organizing software primarily around data, not procedures. In this approach, modules define classes of objects that encapsulate an internal representation of an object accessed via a public API of methods<em> </em>on the object. Languages such as Simula and Clu pioneered this form of organization.</p><p>SOA is a step back to more procedure-oriented designs. Todayâ€™s microservice is a collection of procedural endpointsâ€Šâ€”â€Ša classic, 1970s-style module. We believe that SOA needs to evolve to support data-oriented design, and that this evolution can be enabled by transitioning our service mesh from a procedural orientation to a data orientation.</p><h3>Viaduct: A Data-Oriented ServiceÂ Mesh</h3><p>Central to modern, scalable SOA applications is a <em>service mesh</em> (e.g., <a href=\"https://istio.io/\">Istio</a>, <a href=\"https://linkerd.io/\">Linkerd</a>), which routes service invocations to instances of microservices that can handle them. The current industry standard for service meshes is to organize exclusively around remote procedure invocations without knowing anything about the data that makes up the application architecture. Our vision is to replace these procedure-oriented service meshes with service meshes organized aroundÂ <em>data.</em></p><p>At Airbnb, we are using <a href=\"https://graphql.org/\">GraphQL</a>â„¢ï¸ to build a data-oriented service mesh called <em>Viaduct.</em> A Viaduct service mesh is defined in terms of a GraphQL schema consisting of:</p><ul><li><em>Types</em> (and <em>interfaces</em>) describing data managed within your serviceÂ mesh</li><li><em>Queries</em> (and <em>subscriptions</em>) providing means to access that data, which is abstracted from the service entry points that provide theÂ data</li><li><em>Mutations </em>providing ways to update data, again abstracted from service entryÂ points</li></ul><p>The types (and interfaces) in the schema define a single graph across all of the data managed within the service mesh. For example, at an eCommerce company, a service meshâ€™s schema may define a field productById(id: ID) that returns results of type Product. From this starting point, a single query allows a data consumer to navigate to information about the productâ€™s manufacturer, e.g., productById { manufacturer }; reviews of the product, e.g. productById { reviews }; and even the authors of those reviews, e.g., productById { reviews { author }Â }.</p><p>The data elements requested by such a query may come from many different microservices. In a procedure-oriented service mesh, the data consumer would need to take these services as explicit dependencies. In our data-oriented service mesh, it is the service mesh, i.e., Viaduct, not the data consumer, that knows which services provide which data element. Viaduct abstracts away the service dependencies from any single consumer.</p><h3>Putting Schema at theÂ Center</h3><p>In our talk we discuss how, unlike other distributed GraphQL systems like <a href=\"https://graphql-modules.com/\">GraphQL Modules</a> or <a href=\"https://www.apollographql.com/docs/federation/\">Apollo Federation</a>, Viaduct deals with the schema as a single artifact and has implemented several primitives that allow us to keep a unified schema while still allowing for many teams to collaborate on that schema productively. As Viaduct replaces more and more of our underlying procedure-oriented service mesh, its schema captures the data managed by our application more and more completely. We have taken advantage of this â€œcentral schema,â€ as we call it, as a place to define the APIs of some of our microservices. In particular, we have started using GraphQL for the API of some microservices. For these microservices, their GraphQL schemas are defined as a subset of the central schema. In the future, we want to take this idea further, using the central schema to define the schema of data stored in our database.</p><p>Among other things, using the central schema to define our APIs and database schemas will solve one of the bigger challenges of large-scale SOA applications: data agility. In todayâ€™s SOA applications, a change to a database schema often needs to be manually reflected in the APIs of two, three, and sometimes even more layers of microservices before it can be exposed to client code. Such changes can require weeks of coordinating among multiple teams. By deriving service APIs and database schemas from a single, central schema, a database schema change like this can be propagated to client code with a singleÂ update.</p><h3>Going Serverless</h3><p>Often in large SOA applications, there are many stateless â€œderived-dataâ€ services and â€œbackend-for-frontendâ€ services that take raw data from lower-level services and transform it into data thatâ€™s more appropriate for presentation in clients. Stateless logic like this is a good fit for the serverless computing model, which eliminates the operational overhead of microservices altogether and instead hosts logic in a â€œcloud functionsâ€ fabric.</p><p>Viaduct has a mechanism for computing what we call â€œderived fieldsâ€ using serverless cloud functions that operate on top of<em> </em>the graph without knowledge of the underlying services. These functions allow us to move transformational logic out of the service mesh and into stateless containers, keeping our graph clean and reducing the number and complexity of services weÂ need.</p><h3>Conclusion</h3><p>Viaduct is built on <a href=\"https://www.graphql-java.com/\">graphql-java</a> and supports fine-grained field selection via GraphQL selection sets. It uses modern data-loading techniques, employs reliability techniques such as short-circuiting and soft dependencies, and implements an intra-request cache. Viaduct provides <em>data observability, </em>allowing us to understand, down to the field level, what services consume what data. As a GraphQL interface, Viaduct allows us to take advantage of a large ecosystem of open source tooling, including live IDEs, mock servers, and schema visualizers.</p><p>Viaduct started powering production workflows at Airbnb over a year ago. We started from scratch with a clean schema consisting of a handful of entities and have grown it to include 80 core entities that are able to power 75% of our modern APIÂ traffic.</p><p>As mentioned in the introduction, more details on the motivation and technology behind Viaduct can be found in our <a href=\"https://www.youtube.com/watch?v=xxk9MWCk7cM\">presentation</a>.</p><img src=\"https://medium.com/_/stat?event=post.clientViewed&referrerSource=full_rss&postId=da771a841344\" width=\"1\" height=\"1\" alt=\"\"><hr><p><a href=\"https://medium.com/airbnb-engineering/taming-service-oriented-architecture-using-a-data-oriented-service-mesh-da771a841344\">Taming Service-Oriented Architecture Using A Data-Oriented Service Mesh</a> was originally published in <a href=\"https://medium.com/airbnb-engineering\">The Airbnb Tech Blog</a> on Medium, where people are continuing the conversation by highlighting and responding to this story.</p>"
    },
    {
      "title": "å°†Airbnbçš„JVMå•ä½“ä»“åº“è¿ç§»åˆ°Bazel (åŸæ ‡é¢˜: Migrating Airbnbâ€™s JVM Monorepo to Bazel)",
      "link": "https://medium.com/airbnb-engineering/migrating-airbnbs-jvm-monorepo-to-bazel-33f90eda51ec?source=rss----53c7c27702d5---4",
      "pubDate": "Wed, 13 Aug 2025 17:01:58 GMT",
      "isoDate": "2025-08-13T17:01:58.000Z",
      "creator": "Thomas Bao",
      "summary": "# å°†Airbnbçš„JVMå•ä½“ä»“åº“è¿ç§»åˆ°Bazel\n\nAirbnbè¿‘æœŸæˆåŠŸå°†å…¶æœ€å¤§çš„ä»£ç ä»“åº“â€”â€”JVMå•ä½“ä»“åº“è¿ç§»åˆ°äº†Bazelæ„å»ºç³»ç»Ÿã€‚è¯¥ä»“åº“åŒ…å«æ•°åƒä¸‡è¡ŒJavaã€Kotlinå’ŒScalaä»£ç ï¼Œä¸ºairbnb.comèƒŒåçš„ä¼—å¤šåç«¯æœåŠ¡å’Œæ•°æ®ç®¡é“æä¾›æ”¯æŒã€‚\n\n![å›¾ç‰‡ 1](https://cdn-images-1.medium.com/max/1024/1*rSkIrKYhc8Bwcv2xLE1mxA.jpeg)\n\n**è¿ç§»æˆæœæ¦‚è§ˆï¼ˆå†æ—¶4.5å¹´ï¼‰ï¼š**\n*   æ„å»ºCSATï¼ˆå®¢æˆ·æ»¡æ„åº¦ï¼‰ï¼šä»38%æå‡è‡³68%\n*   æœ¬åœ°æ„å»ºå’Œæµ‹è¯•æ—¶é—´ï¼šæé€Ÿ3-5å€\n*   IntelliJåŒæ­¥æ—¶é—´ï¼šæé€Ÿ2-3å€\n*   éƒ¨ç½²åˆ°å¼€å‘ç¯å¢ƒæ—¶é—´ï¼šæé€Ÿ2-3å€\n\næœ¬æ–‡å°†æ¢è®¨è¿ç§»çš„åŸå› ã€åˆ†äº«å…³é”®çš„å®æ–½äº®ç‚¹ï¼Œå¹¶æ€»ç»“ä¸»è¦ç»éªŒæ•™è®­ã€‚\n\n## ä¸ºä»€ä¹ˆé€‰æ‹©Bazelï¼Ÿ\n\nåœ¨è¿ç§»ä¹‹å‰ï¼ŒJVMå•ä½“ä»“åº“ä½¿ç”¨Gradleä½œä¸ºæ„å»ºç³»ç»Ÿã€‚é€‰æ‹©è¿ç§»åˆ°Bazelæ˜¯å› ä¸ºå®ƒæä¾›äº†ä¸‰å¤§æ ¸å¿ƒä¼˜åŠ¿ï¼šé€Ÿåº¦ã€å¯é æ€§å’Œç»Ÿä¸€çš„æ„å»ºåŸºç¡€è®¾æ–½å±‚ã€‚\n\n### 1. é€Ÿåº¦\n\nBazelçš„å¯ç¼“å­˜ã€å¯ç§»æ¤æ“ä½œå…è®¸é€šè¿‡è¿œç¨‹æ‰§è¡Œæ‰©å±•æ€§èƒ½ã€‚\n*   **Gradleçš„å±€é™æ€§ï¼š** 2021å¹´ï¼Œå¤§å‹æœåŠ¡çš„æœ¬åœ°æ„å»ºé€šå¸¸éœ€è¦20å¤šåˆ†é’Ÿï¼Œé¢„åˆå¹¶CIçš„p90æ—¶é—´ä¸º35åˆ†é’Ÿã€‚Gradleæ„å»ºå·²æ¥è¿‘æé™ï¼Œå³ä½¿åœ¨CIä¸Šå‚ç›´æ‰©å±•åˆ°é«˜ç«¯AWSæœºå™¨å¹¶ä½¿ç”¨å¯å‘å¼æ–¹æ³•æ‹†åˆ†é¡¹ç›®æ„å»ºå’Œæµ‹è¯•ï¼Œæ•ˆç‡ä¾ç„¶ä½ä¸‹ï¼Œå­˜åœ¨æœºå™¨åˆ©ç”¨ç‡ä¸è¶³å’Œå…±äº«ä»»åŠ¡é‡å¤çš„é—®é¢˜ã€‚\n*   **Bazelçš„ä¼˜åŠ¿ï¼š**\n    *   **è¿œç¨‹æ‰§è¡Œï¼ˆRBEï¼‰ï¼š** å…è®¸æ‰©å±•åˆ°æ•°åƒä¸ªå¹¶è¡Œæ“ä½œï¼Œæ¯”Gradleçš„åˆ†ç‰‡å¯å‘å¼æ–¹æ³•æ•ˆç‡æ›´é«˜ã€‚RBEå·¥ä½œèŠ‚ç‚¹æ˜¯çŸ­ç”Ÿå‘½å‘¨æœŸçš„ï¼Œæé«˜äº†æœºå™¨åˆ©ç”¨ç‡å’Œæˆæœ¬æ•ˆç›Šã€‚\n    *   **â€œæ— å­—èŠ‚æ„å»ºâ€ï¼ˆBuild without the Bytesï¼‰ï¼š** åªä¸‹è½½æ–‡ä»¶å­é›†ï¼Œå¤§å¹…å‡å°‘ä¸‹è½½é‡ï¼ˆGradleä¸­æ¯ä¸ªç¼“å­˜çš„å·¥ä»¶éƒ½éœ€è¦ä¸‹è½½ï¼‰ã€‚\n    *   **æœ¬åœ°æ„å»ºåŠ é€Ÿï¼š** RBEæ˜¾è‘—åŠ å¿«äº†æœ¬åœ°æ„å»ºé€Ÿåº¦ã€‚\n    ![å›¾ç‰‡ 2](https://cdn-images-1.medium.com/max/1024/0*y__bh8jYeKCNGmCW)\n    ![å›¾ç‰‡ 3](https://cdn-images-1.medium.com/max/1024/0*qEJJw_dqvH--5nS1)\n    *   **å¹¶è¡Œåˆ†æï¼š** Gradleå¤§å‹é¡¹ç›®çš„é…ç½®é€šå¸¸éœ€è¦æ•°åˆ†é’Ÿï¼Œå› ä¸ºå®ƒå•çº¿ç¨‹è¿è¡Œã€‚Bazelçš„åˆ†æé˜¶æ®µå¹¶è¡Œè¿è¡Œï¼Œéƒ¨åˆ†åŸå› æ˜¯å…¶é…ç½®è¯­è¨€Starlarkè¢«é™åˆ¶ä¸ºæ— å‰¯ä½œç”¨ã€‚\n\n### 2. å¯é æ€§\n\nBazelçš„å¯†å°æ€§ç¡®ä¿äº†å¯é ã€å¯é‡å¤çš„æ„å»ºã€‚\n*   **Gradleçš„é—®é¢˜ï¼š** Gradleä»»åŠ¡å¯ä»¥è®¿é—®å®Œæ•´çš„æ–‡ä»¶ç³»ç»Ÿï¼Œè¿™åœ¨å¤§è§„æ¨¡åº”ç”¨ä¸­å¯èƒ½å¯¼è‡´ä¸¥é‡çš„æ„å¤–åæœã€‚ä¾‹å¦‚ï¼Œå¼€å‘è€…æ›´æ–°ä»»åŠ¡æ¸…ç†`/tmp/`ç›®å½•ä¸­çš„æ–‡ä»¶ï¼Œå¯èƒ½ä¸å…¶ä»–ä½¿ç”¨è¯¥ç›®å½•çš„Gradleä»»åŠ¡äº§ç”Ÿç«æ€æ¡ä»¶ï¼Œå¯¼è‡´CIå¤±è´¥ã€‚\n*   **Bazelçš„è§£å†³æ–¹æ¡ˆï¼š**\n    *   **æ²™ç®±æœºåˆ¶ï¼š** Bazelé€šè¿‡æ²™ç®±è§£å†³æ­¤é—®é¢˜ï¼Œç¡®ä¿æ„å»ºæ“ä½œåªèƒ½è®¿é—®æŒ‡å®šçš„è¾“å…¥ã€‚æœªå£°æ˜ä¸ºè¾“å…¥çš„ä»»ä½•æ–‡ä»¶åœ¨æ²™ç®±ç¯å¢ƒä¸­å‡ä¸å­˜åœ¨ã€‚\n    *   **èµ„æºéš”ç¦»ï¼š** Gradleä»»åŠ¡éšå¼ä¾èµ–äºæœºå™¨èµ„æºï¼Œåœ¨ä¸åŒå¤§å°çš„æœºå™¨ä¸Šè¿è¡Œå¯èƒ½å¯¼è‡´èµ„æºäº‰ç”¨ã€‚RBEé€šè¿‡åœ¨å…·æœ‰ä¸¥æ ¼èµ„æºé™åˆ¶çš„ç›¸åŒå®¹å™¨ä¸­è¿è¡Œæ“ä½œæ¥è§£å†³æ­¤é—®é¢˜ã€‚æœ¬åœ°å’ŒCIæ„å»ºéƒ½é…ç½®ä¸ºä½¿ç”¨RBEï¼Œå¤§å¤§å‡å°‘äº†ç¯å¢ƒå·®å¼‚ã€‚\n\n### 3. å…±äº«åŸºç¡€è®¾æ–½\n\nAirbnbç›®å‰æ‹¥æœ‰å¤šä¸ªç‰¹å®šè¯­è¨€å’Œå¹³å°çš„ä»£ç ä»“åº“ï¼ˆå¦‚webã€iOSã€Pythonã€Goï¼‰ï¼Œæ‰€æœ‰è¿™äº›ç°åœ¨éƒ½å·²è¿ç§»åˆ°Bazelã€‚ç»Ÿä¸€ä½¿ç”¨Bazelå¯ä»¥åœ¨æ‰€æœ‰ä»“åº“ä¹‹é—´å®ç°ç»Ÿä¸€çš„æ„å»ºåŸºç¡€è®¾æ–½å±‚ï¼ŒåŒ…æ‹¬ï¼š\n*   è¿œç¨‹ç¼“å­˜\n*   è¿œç¨‹æ„å»ºæ‰§è¡Œ\n*   å—å½±å“ç›®æ ‡è®¡ç®—\n*   é€šè¿‡æ„å»ºäº‹ä»¶åè®®è¿›è¡Œæ£€æµ‹å’Œæ—¥å¿—è®°å½•\n\n## æˆ‘ä»¬å¦‚ä½•è¿ç§»ï¼Ÿ\n\n### 1. æ¦‚å¿µéªŒè¯\n\né¦–ä¸ªé‡Œç¨‹ç¢‘æ˜¯è¯æ˜å¯ä»¥åœ¨Bazelä¸­æ„å»ºæœåŠ¡å¹¶è¿è¡Œå…¶å•å…ƒæµ‹è¯•ã€‚ä¸ºäº†æœ€å¤§ç¨‹åº¦åœ°å‡å°‘å¯¹å·¥ç¨‹å¸ˆçš„å¹²æ‰°ï¼ŒBazelæ„å»ºä¸Gradleå¹¶è¡Œå­˜åœ¨ï¼Œå¼€å‘è€…å¯ä»¥é€‰æ‹©ä½¿ç”¨Gradleæˆ–Bazelã€‚\n*   **é€‰æ‹©ViaductæœåŠ¡ï¼š** é€‰æ‹©äº†Airbnbçš„GraphQLå•ä½“å¹³å°Viaductè¿›è¡Œæ¦‚å¿µéªŒè¯ï¼Œå› ä¸ºå®ƒï¼š\n    *   æ˜¯Airbnbæœ€å¤§ã€æœ€å¤æ‚çš„æœåŠ¡ä¹‹ä¸€ï¼Œå…¶æˆåŠŸè¿ç§»é¢„ç¤ºç€æ•´ä¸ªå•ä½“ä»“åº“çš„è¿ç§»å¯è¡Œæ€§ã€‚\n    *   æ„å»ºé€Ÿåº¦æ…¢æ˜¯ä¸»è¦ç—›ç‚¹ï¼ŒBazelèƒ½äº§ç”Ÿå·¨å¤§å½±å“ã€‚\n    *   æ¯æœˆæœ‰300åäº§å“å·¥ç¨‹å¸ˆä¿®æ”¹å…¶ä»£ç ï¼Œæé«˜æ„å»ºé€Ÿåº¦èƒ½æ˜¾è‘—æå‡ç”Ÿäº§åŠ›ã€‚\n    *   Viaductçš„æ ¸å¿ƒåŸºç¡€è®¾æ–½å›¢é˜Ÿæ¸´æœ›åˆä½œã€‚\n*   **å®ç°æ–¹å¼ï¼š**\n    *   å°†Viaductçš„å¤§éƒ¨åˆ†æ„å»ºé€»è¾‘ä»Gradleç§»æ¤åˆ°Bazelã€‚\n    *   æ„å»ºäº†ä¸€ä¸ªè‡ªåŠ¨åŒ–æ„å»ºæ–‡ä»¶ç”Ÿæˆå™¨ï¼Œä»¥åº”å¯¹Gradleæ„å»ºå›¾çš„æŒç»­å˜åŒ–å’Œå…±å­˜éœ€æ±‚ã€‚\n    ![å›¾ç‰‡ 4](https://cdn-images-1.medium.com/max/1024/0*sleFOnx1XS43xzAI)\n*   **åˆæœŸæŒ‘æˆ˜ä¸è§£å†³ï¼š** å°½ç®¡Bazelæœ¬åœ°æ„å»ºé€Ÿåº¦æå‡äº†2-4å€ï¼Œä½†è®¸å¤šå¼€å‘è€…æœ€åˆä¸æ„¿åˆ‡æ¢ã€‚ç»è¿‡ä¸æœåŠ¡æ‰€æœ‰è€…æ²Ÿé€šï¼Œå‘ç°äº†è®¸å¤šç¼ºå¤±çš„é›†æˆå’Œé”™è¯¯ã€‚åˆèŠ±äº†å‡ ä¸ªæœˆæ—¶é—´è§£å†³è¿™äº›ç—›ç‚¹åï¼ŒViaductå¼€å‘è€…æ‰è‡ªæ„¿åˆ‡æ¢åˆ°Bazelã€‚\n\n### 2. ä½¿ç”¨Bazelæ‰©å±•æ„å»ºå’Œæµ‹è¯•\n\næ¦‚å¿µéªŒè¯æˆåŠŸåï¼Œå›¢é˜Ÿå¼€å§‹å°†Bazelæ‰©å±•åˆ°JVMå•ä½“ä»“åº“çš„å…¶ä½™éƒ¨åˆ†ã€‚\n*   **å¹¿åº¦ä¼˜å…ˆç­–ç•¥ï¼š** é¦–å…ˆè®©æ‰€æœ‰ä»“åº“åœ¨Bazelä¸­ç¼–è¯‘å’Œæµ‹è¯•ã€‚\n*   **å…±å­˜çš„å¥½å¤„ï¼š**\n    *   å¼€å‘è€…ä»å¯ä½¿ç”¨Bazelè¿›è¡Œæœ¬åœ°å¼€å‘ï¼Œå³ä½¿éƒ¨ç½²ä»ä½¿ç”¨Gradleæ„å»ºã€‚\n    *   åœ¨BazelåŸºç¡€è®¾æ–½å‡ºç°é—®é¢˜æ—¶ï¼Œå¯ä»¥ç¦ç”¨Bazelï¼Œè®©ç”¨æˆ·å›é€€åˆ°Gradleã€‚\n*   **å…±å­˜çš„ç¼ºç‚¹ï¼š** å¿…é¡»ç»´æŠ¤Gradleå’ŒBazelä¸¤ä¸ªæ„å»ºå›¾ã€‚æ‰‹åŠ¨ç»´æŠ¤Bazelæ„å»ºå›¾ä¼šé™ä½å¼€å‘ä½“éªŒï¼Œå› æ­¤å›¢é˜Ÿè¿›ä¸€æ­¥æŠ•å…¥è‡ªåŠ¨åŒ–æ„å»ºæ–‡ä»¶ç”Ÿæˆã€‚\n\n### 3. è‡ªåŠ¨åŒ–æ„å»ºæ–‡ä»¶ç”Ÿæˆ\n\nå›¢é˜Ÿå—åˆ°Gazelleçš„å¯å‘ï¼ŒGazelleé€šè¿‡è§£ææºæ–‡ä»¶ç”ŸæˆBazelæ„å»ºæ–‡ä»¶ã€‚\n*   **è‡ªç ”ç”Ÿæˆå™¨ï¼š** è€ƒè™‘åˆ°ä¸¥æ ¼çš„æ€§èƒ½è¦æ±‚å’Œå¤„ç†ä¾èµ–å¾ªç¯çš„éœ€æ±‚ï¼Œå›¢é˜Ÿå†³å®šæ„å»ºè‡ªå·±çš„è‡ªåŠ¨åŒ–æ„å»ºæ–‡ä»¶ç”Ÿæˆå™¨ã€‚\n*   **æ€§èƒ½ä¼˜åŒ–ï¼š** ä¸ºäº†ä¸æ˜¾è‘—é™ä½å¼€å‘è€…ä½“éªŒï¼Œç”Ÿæˆå™¨å¿…é¡»åœ¨æ¯æ¬¡æäº¤åˆå¹¶åˆ°ä¸»çº¿å‰å¿«é€Ÿè¿è¡Œã€‚é€šè¿‡å®ç°å¤–éƒ¨ç¼“å­˜æ¥åŠ é€Ÿç”Ÿæˆè¿‡ç¨‹ã€‚\n*   **å·¥ä½œåŸç†ï¼š** ç±»ä¼¼Gazelleï¼Œç”Ÿæˆå™¨è§£æJavaã€Kotlinå’ŒScalaæºæ–‡ä»¶ä¸­çš„åŒ…ã€å¯¼å…¥è¯­å¥å’Œç¬¦å·å£°æ˜ï¼Œæ„å»ºæ–‡ä»¶çº§ä¾èµ–å›¾ã€‚\n*   **CIé›†æˆï¼š** åœ¨CIä¸­ï¼Œæ¯ä¸ªä¸»çº¿æäº¤éƒ½ä¼šå‘å¸ƒä¸€ä¸ªä»“åº“çš„ç¼“å­˜ç´¢å¼•ã€‚ç”¨æˆ·è¿è¡Œ`sync-configs`æ—¶ï¼Œä¼šä¸‹è½½æ­¤ç¼“å­˜ï¼Œå¹¶ä»…é‡æ–°æ‰«æè‡ªåˆå¹¶åŸºç¡€ä»¥æ¥æ›´æ”¹çš„ç›®å½•ï¼Œå¤§å¤§æé«˜äº†å¸¸è§æƒ…å†µä¸‹çš„æ€§èƒ½ã€‚\n*   **æ›´ç»†ç²’åº¦çš„æ„å»ºå›¾ï¼š** ç”Ÿæˆå™¨æ”¯æŒæ›´ç»†ç²’åº¦çš„æ„å»ºå›¾ï¼ŒBazelç›®æ ‡æ•°é‡æ˜¯Gradleé¡¹ç›®çš„10å€ä»¥ä¸Šï¼Œé€šè¿‡æ›´å¤šå¹¶è¡Œæ„å»ºå’Œæ›´å°‘ç¼“å­˜å¤±æ•ˆå®ç°æ›´å¿«çš„æ„å»ºã€‚å®ƒè¿˜èƒ½è‡ªåŠ¨æ£€æµ‹ç¼–è¯‘å¾ªç¯å¹¶åœ¨å¿…è¦æ—¶åˆå¹¶ç¼–è¯‘å•å…ƒã€‚\n![å›¾ç‰‡ 5](https://cdn-images-1.medium.com/max/1024/0*zmnMMjLRC2a-XCO0)\n*   **æŒç»­ä»·å€¼ï¼š** å³ä½¿åœ¨è¿ç§»åï¼Œæ„å»ºæ–‡ä»¶ç”Ÿæˆå™¨ä»åœ¨ä½¿ç”¨ï¼Œé€šè¿‡è‡ªåŠ¨ä¿®å¤æ„å»ºæ–‡ä»¶é…ç½®å’Œç§»é™¤æœªä½¿ç”¨çš„ä¾èµ–é¡¹æ¥æ”¹å–„å¼€å‘è€…ä½“éªŒã€‚ç›¸æ¯”ä¹‹ä¸‹ï¼ŒGradleæ—¶ä»£ç”¨æˆ·æ‰‹åŠ¨ç»´æŠ¤çº¦4500ä¸ªGradleæ–‡ä»¶ï¼Œå¯¼è‡´æœªä½¿ç”¨çš„ä¾èµ–é¡¹ã€è‡ƒè‚¿çš„ä¾èµ–å›¾å’Œæ›´æ…¢çš„æ„å»ºã€‚\n\n### 4. ç§»æ¤æ„å»ºé€»è¾‘\n\né™¤äº†JVMæºæ–‡ä»¶ï¼Œä»“åº“è¿˜æœ‰å¤§é‡ç”±å¤šä¸ªå›¢é˜Ÿæ‹¥æœ‰çš„æ„å»ºé€»è¾‘ï¼ˆå¦‚ä»£ç ç”Ÿæˆï¼‰ï¼Œé€šå¸¸ä»¥Gradleæ’ä»¶çš„å½¢å¼å­˜åœ¨ã€‚\n*   **ä¸ç”Ÿæˆå™¨é›†æˆï¼š** ç§»æ¤æ„å»ºé€»è¾‘æ—¶ï¼Œå¿…é¡»å°†å…¶ä¸æ„å»ºæ–‡ä»¶ç”Ÿæˆå™¨é›†æˆã€‚ç”±äºç›®æ ‡æ›´ç»†ç²’åº¦ï¼ŒGradleä¸­çš„ä¸€è¡Œé…ç½®å¯èƒ½éœ€è¦åº”ç”¨äº10å¤šä¸ªBazelæ„å»ºæ–‡ä»¶ã€‚\n*   **æ’ä»¶å’ŒæŒ‡ä»¤ï¼š** æ„å»ºæ–‡ä»¶ç”Ÿæˆå™¨æ¶æ„æ”¯æŒç±»ä¼¼äºGazelleæ‰©å±•çš„æ’ä»¶ï¼Œè¿™äº›æ’ä»¶ç”±ç‰¹å®šæ–‡ä»¶ï¼ˆå¦‚Thriftæˆ–GraphQLæ–‡ä»¶ï¼‰çš„å­˜åœ¨è§¦å‘ï¼Œå¹¶èƒ½ç”Ÿæˆæ–°çš„æ„å»ºç›®æ ‡ï¼ˆå¦‚ä»£ç ç”Ÿæˆæ“ä½œï¼‰ã€‚å¯¹äºæ‰‹åŠ¨æ·»åŠ æˆ–ä¸æ˜“ä»æ–‡ä»¶ç»“æ„æ¨æ–­çš„Gradleé€»è¾‘ï¼Œæ”¯æŒç±»ä¼¼äºGazelleçš„ç”Ÿæˆå™¨æŒ‡ä»¤ï¼ˆå¦‚æ·»åŠ ä¾èµ–é¡¹æˆ–è®¾ç½®å±æ€§ï¼‰ã€‚\n*   **å›¢é˜Ÿåä½œï¼š** æœ€åˆç”±æ ¸å¿ƒå›¢é˜Ÿç§»æ¤å¤§éƒ¨åˆ†æ„å»ºé€»è¾‘ã€‚éšç€Bazelçš„æ™®åŠï¼Œå¤æ‚æ„å»ºé€»è¾‘çš„æ‰€æœ‰è€…è¢«æ¿€åŠ±è¿ç§»åˆ°Bazelï¼Œå› ä¸ºå…¶æ›´å¿«ã€æ›´å¯é ï¼Œä»–ä»¬ä¹Ÿå¸¸ç¼–å†™è‡ªå·±çš„æ„å»ºæ–‡ä»¶ç”Ÿæˆå™¨æ’ä»¶ï¼Œä½“ç°äº†ç”Ÿæˆå™¨çš„å¯æ‰©å±•æ€§ã€‚\n\n### 5. ç¬¬ä¸‰æ–¹åº“å¤šç‰ˆæœ¬æ”¯æŒ\n\nè¿ç§»è¿‡ç¨‹ä¸­é‡åˆ°çš„ä¸€ä¸ªä¸»è¦é—®é¢˜æ˜¯åŒä¸€ç¬¬ä¸‰æ–¹åº“çš„å¤šä¸ªç‰ˆæœ¬ã€‚\n*   **é—®é¢˜ï¼š** æœ€åˆåªæŒ‡å®šæ¯ä¸ªåº“çš„å•ä¸€ç‰ˆæœ¬ï¼Œä½†Gradleä¸­æ¯ä¸ªå­é¡¹ç›®å¯ä»¥ä½¿ç”¨ä¸åŒç‰ˆæœ¬çš„ç¬¬ä¸‰æ–¹åº“ã€‚è¿™å¯¼è‡´åœ¨é’ˆå¯¹å•ä¸€ç‰ˆæœ¬ç¼–è¯‘æ—¶ï¼Œå¯èƒ½å› ç¼ºå°‘ç¬¦å·è€Œç¼–è¯‘æˆ–æµ‹è¯•å¤±è´¥ã€‚\n*   **è§£å†³æ–¹æ¡ˆï¼š** æ„å»ºäº†å·¥å…·æ¥ç”Ÿæˆå¤šä¸ª`maven_install`è§„åˆ™ï¼Œå¹¶æ·»åŠ äº†è‡ªå®šä¹‰æ–¹é¢æ¥åœ¨ç›®æ ‡çº§åˆ«è§£å†³å†²çªã€‚\n![å›¾ç‰‡ 6](https://cdn-images-1.medium.com/max/1024/0*_U1LAeex52squvmt)\n*   **åç»­æ”¹è¿›ï¼š** å°†å†²çªè§£å†³ç§»è‡³åˆ†ææ—¶ä»¥è·å¾—æ›´å¥½çš„IDEæ”¯æŒï¼Œå¹¶æ·»åŠ äº†æ›´å‹å¥½çš„åº“æ›´æ–°å·¥å…·ã€‚\n\n### 6. è¿ç§»éƒ¨ç½²\n\nåœ¨ç»å¤§å¤šæ•°é¡¹ç›®åœ¨CIä¸­é€šè¿‡Bazelæ„å»ºå¹¶å•å…ƒæµ‹è¯•é€šè¿‡åï¼Œå›¢é˜Ÿå¼€å§‹ä¸“æ³¨äºè¿ç§»éƒ¨ç½²ã€‚Bazelæ„å»ºçš„`.jar`ä¸Gradleæ„å»ºçš„`.jar`ä¸å®Œå…¨ç›¸åŒï¼Œå› æ­¤éœ€è¦ç­–ç•¥ç¡®ä¿éƒ¨ç½²å®‰å…¨ã€‚\n\n#### æœåŠ¡\n*   **éªŒè¯ï¼š** ä½¿ç”¨å¯åŠ¨å’Œé›†æˆæµ‹è¯•éªŒè¯æœåŠ¡çš„éƒ¨ç½²æ­£ç¡®æ€§ã€‚çº¦700ä¸ªæœåŠ¡ä¸­ï¼Œçº¦100ä¸ªé‡åˆ°å¯åŠ¨æˆ–é›†æˆæµ‹è¯•å¤±è´¥ã€‚\n*   **ä¸»è¦é—®é¢˜åŠè§£å†³ï¼š**\n    *   **ç¼ºå¤±ä¾èµ–ï¼š** å¤§å¤šæ•°å¤±è´¥æ˜¯ç”±äºJavaåå°„åŠ è½½çš„ç¼ºå¤±ä¾èµ–ï¼ˆé€šå¸¸æ¥è‡ªé…ç½®æ–‡ä»¶æˆ–å…¶ä»–æ–‡ä»¶ï¼‰ã€‚é€šè¿‡è§£ææ–‡ä»¶ä»¥æŸ¥æ‰¾å°†é€šè¿‡åå°„åŠ è½½çš„ç±»ï¼Œç„¶åæ·»åŠ æ‰€éœ€ä¾èµ–æ¥è§£å†³ã€‚\n    *   **åº“ç‰ˆæœ¬å·®å¼‚ï¼š** å¦ä¸€ä¸ªä¸»è¦é”™è¯¯æºæ˜¯åº“ç‰ˆæœ¬ä¸åŒï¼Œå¯èƒ½å¯¼è‡´è¿è¡Œæ—¶ç¼ºå°‘ç¬¦å·é”™è¯¯ã€‚Gradleä¸­ç”¨æˆ·æ‰‹åŠ¨æŒ‡å®šä¾èµ–å’Œç‰ˆæœ¬ï¼Œè€ŒBazelä¸­æ„å»ºæ–‡ä»¶ä»æºç”Ÿæˆï¼Œä¾èµ–ä»å¯¼å…¥è¯­å¥æ¨æ–­ï¼ˆä¸æŒ‡å®šç‰ˆæœ¬ï¼‰ã€‚é€šè¿‡å¼ºåˆ¶ç¬¬ä¸‰æ–¹åº“ç‰ˆæœ¬ä¸Gradleé¡¹ç›®åŒ¹é…æ¥è§£å†³ã€‚\n*   **ç»“æœï¼š** è€ƒè™‘åˆ°åå°„ç±»å’Œç‰ˆæœ¬åŒæ­¥åï¼Œåªæœ‰ä¸ªä½æ•°ç™¾åˆ†æ¯”çš„æœåŠ¡åœ¨ç”Ÿäº§ç¯å¢ƒä¸­é‡åˆ°è¿è¡Œæ—¶é—®é¢˜ï¼Œéœ€è¦æ›´æ·±å…¥çš„æ‰‹åŠ¨ä¿®å¤ã€‚\n\n#### æ•°æ®ç®¡é“å’Œå…¶ä»–é¡¹ç›®\n*   **è§„æ¨¡ï¼š** é™¤äº†æœåŠ¡ï¼Œè¿˜æœ‰450ä¸ªæ•°æ®ç®¡é“å’Œçº¦50ä¸ªå…¶ä»–é¡¹ç›®éƒ¨ç½²åˆ°Sparké›†ç¾¤æˆ–Flinkè¿è¡Œæ—¶ã€‚\n*   **éªŒè¯ï¼š** ç±»ä¼¼æœåŠ¡ï¼Œé€šè¿‡æµ‹è¯•æ•è·äº†è®¸å¤šé—®é¢˜ã€‚Airbnbæ•°æ®å·¥ç¨‹çš„â€œé“ºè·¯â€æ•°æ®ç®¡é“æœ‰CIæµ‹è¯•ï¼Œå¯åœ¨æœ¬åœ°è¿è¡Œå°ç‰ˆæœ¬Sparkç®¡é“ã€‚\n*   **ç»“æœï¼š** å¯¹äºçº¦400ä¸ªâ€œé“ºè·¯â€ç®¡é“ï¼Œé€šè¿‡CIæµ‹è¯•åï¼Œåªæœ‰çº¦3%åœ¨ç”Ÿäº§ç¯å¢ƒä¸­å‡ºç°è¿è¡Œæ—¶é—®é¢˜ï¼Œå› æ­¤å¯ä»¥éå¸¸å¿«é€Ÿåœ°è¿ç§»ã€‚\n*   **å‰©ä½™æŒ‘æˆ˜ï¼š** å°‘æ•°æ›´å®šåˆ¶åŒ–çš„å¯éƒ¨ç½²é¡¹ç›®éœ€è¦å•ç‹¬éƒ¨ç½²å’Œç›‘æ§ä»¥éªŒè¯æ­£ç¡®æ€§ã€‚\n\n## æˆ‘ä»¬å­¦åˆ°äº†ä»€ä¹ˆï¼Ÿ\n\n### 1. å®¢æˆ·åˆä½œ\n\nåœ¨è¿ç§»æ—©æœŸï¼Œå›¢é˜Ÿç¡®å®šäº†å…·æœ‰å·¨å¤§å½±å“æ½œåŠ›å’Œæ„¿æ„æŠ•èµ„æ–°æ„å»ºç³»ç»Ÿçš„å…³é”®è¯•ç‚¹æœåŠ¡ã€‚ä¾‹å¦‚ï¼ŒViaductå…·æœ‰å¤æ‚çš„æ„å»ºé€»è¾‘ï¼Œå¯¼è‡´æ„å»ºç¼“æ…¢å’Œå¯é æ€§é—®é¢˜ï¼Œä¸”è®¸å¤šå¼€å‘è€…è´¡çŒ®è¯¥æœåŠ¡ï¼Œæ”¹è¿›å…¶æ„å»ºå¯¹Airbnbçš„å¼€å‘è€…ä½“éªŒå½±å“å·¨å¤§ã€‚\n*   ä¸è¯•ç‚¹å›¢é˜Ÿçš„åˆä½œéå¸¸æœ‰ä»·å€¼ã€‚ä»–ä»¬æ˜¯æ—©æœŸé‡‡ç”¨è€…ï¼Œåœ¨æŠ¥å‘Šå’Œè°ƒè¯•é—®é¢˜ã€åˆ†ææ€§èƒ½ç“¶é¢ˆå’Œæå‡ºåŠŸèƒ½æ–¹é¢åšå‡ºäº†é‡å¤§è´¡çŒ®ã€‚è¯•ç‚¹å›¢é˜Ÿä¹Ÿæˆä¸ºäº†å€¡å¯¼è€…ï¼Œæä¾›å†…éƒ¨æ”¯æŒï¼Œå¸®åŠ©æ¿€åŠ±Airbnbå…¶ä»–å¼€å‘è€…ç¤¾åŒºã€‚\n\n### 2. è¿‡æ—©ä¼˜åŒ–çš„å±é™©\n\nè¿™æ¬¡è¿ç§»å†æ—¶4.5å¹´ã€‚äº‹åçœ‹æ¥ï¼Œå¦‚æœå›¢é˜Ÿå…ˆè¿ç§»å†ä¼˜åŒ–ï¼Œå¯ä»¥å¤§å¹…ç¼©çŸ­è¿ç§»æ—¶é—´ã€‚\n*   è™½ç„¶å¢åŠ æ„å»ºç²’åº¦ç¼©çŸ­äº†æ„å»ºæ—¶é—´ï¼Œä½†å´å¢åŠ äº†è¿ç§»æ—¶é—´ã€‚å…·ä½“æ¥è¯´ï¼Œå¢åŠ æ„å»ºç²’åº¦å¤§å¤§å¢åŠ äº†é…ç½®æ–‡ä»¶æ•°é‡ï¼Œä½¿å¾—æ‰‹åŠ¨ç®¡ç†é…ç½®å˜å¾—æ›´åŠ å›°éš¾ã€‚è¿™è¿«ä½¿æ›´å¤šåŠŸèƒ½é›†æˆåˆ°è‡ªåŠ¨åŒ–æ„å»ºä¸­ã€‚",
      "shortSummary": "Airbnbå†æ—¶4.5å¹´æˆåŠŸå°†å…¶åºå¤§çš„JVMå•ä½“ä»“åº“ä»Gradleè¿ç§»åˆ°Bazelã€‚æ­¤æ¬¡è¿ç§»æ˜¾è‘—æå‡äº†æ„å»ºCSATã€æœ¬åœ°æ„å»ºå’Œæµ‹è¯•é€Ÿåº¦ï¼ˆ3-5å€ï¼‰ã€IntelliJåŒæ­¥é€Ÿåº¦ï¼ˆ2-3å€ï¼‰åŠéƒ¨ç½²é€Ÿåº¦ï¼ˆ2-3å€ï¼‰ã€‚é€‰æ‹©Bazelæ˜¯å› å…¶å“è¶Šçš„é€Ÿåº¦ã€å¯é æ€§å’Œç»Ÿä¸€çš„æ„å»ºåŸºç¡€è®¾æ–½ã€‚è¿ç§»è¿‡ç¨‹æ¶‰åŠæ¦‚å¿µéªŒè¯ã€è‡ªåŠ¨åŒ–æ„å»ºæ–‡ä»¶ç”Ÿæˆã€æ„å»ºé€»è¾‘ç§»æ¤åŠç¬¬ä¸‰æ–¹åº“å¤šç‰ˆæœ¬æ”¯æŒï¼Œæœ€ç»ˆæˆåŠŸè¿ç§»äº†æœåŠ¡å’Œæ•°æ®ç®¡é“çš„éƒ¨ç½²ã€‚å…³é”®ç»éªŒæ˜¯å®¢æˆ·åˆä½œçš„é‡è¦æ€§ï¼Œä»¥åŠé¿å…è¿‡æ—©ä¼˜åŒ–å¯èƒ½å¸¦æ¥çš„è¿ç§»æ—¶é—´å»¶é•¿ã€‚",
      "translated_title": "å°†Airbnbçš„JVMå•ä½“ä»“åº“è¿ç§»åˆ°Bazel",
      "images": [
        {
          "url": "https://cdn-images-1.medium.com/max/1024/1*rSkIrKYhc8Bwcv2xLE1mxA.jpeg",
          "alt": "",
          "title": "",
          "position": 1
        },
        {
          "url": "https://cdn-images-1.medium.com/max/1024/0*y__bh8jYeKCNGmCW",
          "alt": "",
          "title": "",
          "position": 2
        },
        {
          "url": "https://cdn-images-1.medium.com/max/1024/0*qEJJw_dqvH--5nS1",
          "alt": "",
          "title": "",
          "position": 3
        },
        {
          "url": "https://cdn-images-1.medium.com/max/1024/0*sleFOnx1XS43xzAI",
          "alt": "",
          "title": "",
          "position": 4
        },
        {
          "url": "https://cdn-images-1.medium.com/max/1024/0*zmnMMjLRC2a-XCO0",
          "alt": "",
          "title": "",
          "position": 5
        }
      ],
      "contentSource": "RSS",
      "content": "<figure><img alt=\"\" src=\"https://cdn-images-1.medium.com/max/1024/1*rSkIrKYhc8Bwcv2xLE1mxA.jpeg\" /></figure><p><strong>By: </strong>Jack Dai, Howard Ho, Loc Dinh, Stepan Goncharov, Ted Tenedorio, and ThomasÂ Bao</p><p>At Airbnb, we recently completed migrating our largest repo, the JVM monorepo, to Bazel. This repo contains <strong>tens of millions of lines</strong> of Java, Kotlin, and Scala code that power the vast array of backend services and data pipelines behind airbnb.com.</p><p><strong>Migration in numbers (4.5 years ofÂ work):</strong></p><ul><li>Build CSAT: 38% â†’Â 68%</li><li><strong>3â€“5x </strong>faster local build and testÂ times</li><li><strong>2â€“3x </strong>faster IntelliJÂ syncs</li><li><strong>2â€“3x</strong> faster deploys to the development environment</li></ul><p>In this blog post, weâ€™ll discuss the <strong>why</strong>, share some highlights on the <strong>how</strong>, and finish off with <strong>key learnings</strong>.</p><h3>Why Bazel?</h3><p>Before the migration, our JVM monorepo used Gradle as its build system. We decided to migrate to<strong> </strong>Bazel because it offered three key advantages: speed, reliability, and a uniform build infrastructure layer.</p><h4>Speed</h4><p><em>Bazelâ€™s cacheable, portable actions allow us to scale performance with remote execution</em></p><p>In 2021, builds of large services often took &gt;20 minutes locally and pre-merge CI p90 was 35Â minutes.</p><p>Building with Gradle was near its limit. We had already vertically scaled to high-end AWS machines on CI and remote development machines for developers of large services. In CI, we also used heuristics to split project builds and tests across multiple machines. However, this was inefficient, because of machine underutilization and duplication of sharedÂ tasks.</p><figure><img alt=\"\" src=\"https://cdn-images-1.medium.com/max/1024/0*y__bh8jYeKCNGmCW\" /></figure><p>Bazel remote execution allowed us to scale to thousands of parallel actions. This was far more efficient than our sharding heuristics. Remote build execution (RBE) workers are also short-lived, which results in better machine utilization and cost efficiency. In addition, <a href=\"https://blog.bazel.build/2021/04/07/build-without-the-bytes.html\">Build without the Bytes</a> allows downloading only a subset of files, greatly reducing download volume (in Gradle, every cached artifact needs to be downloaded). Finally and most importantly, local builds are significantly faster thanks toÂ RBE.</p><figure><img alt=\"\" src=\"https://cdn-images-1.medium.com/max/1024/0*qEJJw_dqvH--5nS1\" /></figure><p>In addition, <a href=\"https://docs.gradle.org/current/userguide/build_lifecycle.html#sec:configuration\">Gradle configuration</a> of some large projects often took minutes due to it being single-threaded. Bazel analysis, in contrast, runs in parallel, in part because its configuration language, Starlark, is constrained to be side-effect-free.</p><h4>Reliability</h4><p><em>Bazelâ€™s hermeticity ensures reliable, repeatable builds</em></p><p>Gradle tasks have access to the full file system, which can lead to serious unintended consequences at scale. One example we ran into was when a developer updated a task to clean up recent files in the /tmp/ directory. This created a race condition with other Gradle tasks that used the /tmp/ directory and caused CI to fail when thousands of Gradle tasks had to beÂ rerun.</p><p>Bazel solves this issue with sandboxing, which ensures that only specified inputs are available to a build action. If a file isnâ€™t declared as an input, it simply doesnâ€™t exist in the sandboxed environment.</p><p>Gradle tasks also implicitly depend on the machineâ€™s resources. Gradle builds run on local machines and CI machines of different sizes. This can lead to resource contention when a task is run on a smaller machine or when the cache is cold and thousands of tasks are run on the sameÂ machine.</p><p>Remote build execution (RBE) solves this by running actions in identical containers with strict resource limits. We also configured both local and CI builds to use RBE, which greatly reduces environment differences.</p><h4>Shared infrastructure</h4><p>Airbnb currently has a collection of language- and platform-specific repos, such as <a href=\"https://medium.com/airbnb-engineering/adopting-bazel-for-web-at-scale-a784b2dbe325\">web</a>, <a href=\"https://medium.com/airbnb-engineering/migrating-our-ios-build-system-from-buck-to-bazel-ddd6f3f25aa3\">iOS</a>, Python, and Go, all of which are now on Bazel. Unifying on Bazel enables a uniform build infrastructure layer across repos, which includes:</p><ul><li>Remote caching</li><li>Remote build execution</li><li>Affected targets calculation</li><li>Instrumentation &amp; logging from the <a href=\"https://bazel.build/docs/build-event-protocol\">Build EventÂ Protocol</a></li></ul><h3>How did weÂ migrate?</h3><h4>Proof ofÂ concept</h4><p>As a first milestone, we wanted to show that we could build a service and run its unit tests in Bazel. Because this was a proof of concept, we wanted to <strong>minimize disruption to engineers</strong>. Therefore, the Bazel build <em>co-existed </em>with Gradle<strong>. </strong>As a result, developers could choose between using Gradle or BazelÂ locally<em>.</em></p><p>We needed to prove that developers would <em>choose</em> to opt in to using Bazel over Gradle. It wasnâ€™t enough for Bazel to be faster, developers had to willingly opt in to usingÂ Bazel.</p><p>For this proof of concept, we chose Airbnbâ€™s GraphQL monolith platform, <a href=\"https://medium.com/airbnb-engineering/taming-service-oriented-architecture-using-a-data-oriented-service-mesh-da771a841344\">Viaduct</a>, which had the following important properties:</p><ol><li>It was one of Airbnbâ€™s largest and most complex services. If we could migrate Viaduct to Bazel, then we could likely migrate the rest of the monorepo.</li><li>Slow builds were a major pain point, so Bazel could have a largeÂ impact.</li><li>Viaduct has 300 product engineers modifying its code every month, so improving Viaductâ€™s build speed would be a substantial productivity win.</li><li>Because of (2) and (3) above, Viaductâ€™s core infrastructure team was eager to partner withÂ us.</li></ol><p>To achieve a working Viaduct build with Bazel, we did two things. First, we had to port much of Viaductâ€™s build logic from Gradle to Bazel. Second, because we decided to maintain co-existing builds and the Gradle build graph was still changing, we decided to build an automated build file generator (which weâ€™ll cover in detail in a separate section).</p><figure><img alt=\"\" src=\"https://cdn-images-1.medium.com/max/1024/1*8d_f127RDGo6fHBHcqmN3g.png\" /></figure><p>Importantly, even though we were able to locally build the service 2â€“4x faster with Bazel, many developers did not yet want toÂ switch.</p><p>In talking with the serviceâ€™s owners, we discovered a number of missing integrations and bugs. It took us an additional few months to address these pain points, after which Viaduct developers willingly switched from Gradle toÂ Bazel.</p><h4>Scaling builds and tests withÂ Bazel</h4><p>The proof of concept showed that Bazel was superior to Gradle for one of Airbnbâ€™s largest services and a large audience of developers. Now we wanted to scale it to the rest of Airbnbâ€™s JVM monorepo.</p><p>We decided to scale breadth-first, getting all of the repo compiling and testing in Bazel. Again, to minimize disruption, Bazel builds co-existed with Gradle, which had two important benefits.</p><p>First, developers could still use Bazel for local development and get most of its benefits even though their code was still built with Gradle for deployment. Second, we could always disable Bazel if it was negatively impacting developers. For example, when Bazel infrastructure like the remote cache or remote execution cluster experienced an incident, we could and did disable Bazel, letting users fall back toÂ Gradle.</p><p>However, a major downside was that both Gradle and Bazel build graphs had to be maintained. Manually maintaining a Bazel build graph would have degraded the developer experience. As a result, we invested further in automated build file generation, so that developers didnâ€™t need to manually maintain Bazel buildÂ files.</p><h4>Automated build file generation</h4><p>For our build file generator, we were heavily inspired by <a href=\"https://github.com/bazel-contrib/bazel-gazelle\">Gazelle</a>, which generates Bazel build files by parsing source files to build a dependency graph.</p><p>Although we considered extending Gazelle to support JVM languages, we had very strict performance requirements and needed to handle dependency cycles. This ultimately led us to build our own automated build file generator.</p><p>Because we had to maintain <em>co-existing build graphs</em>, we needed to run the build file generator on every commit before merging into mainline. This meant it had to run as fast as possible to not significantly degrade the developer experience. To achieve this, we implemented external caching to speed up the automated build file generation.</p><p>Similar to Gazelle, the build file generator parses Java, Kotlin, and Scala source files for package and import statements and symbol declarations to build a file-level dependency graph.</p><p>In CI, we publish a cached index of the repository at each mainline commit. When a user runs sync-configs, it downloads this cache and only re-scans directories which have changed since the merge base. This greatly improves performance for the common case where users only modify a small set ofÂ files.</p><p>In addition, with this build file generator, we were able to support a more fine-grained build graph, which resulted in &gt;10x more Bazel targets than Gradle projects. This enabled faster builds through more parallel builds and less cache invalidation. However, one challenge of moving to a more fine-grained build graph is the possibility of introducing compilation cycles; sync-configs is able to detect this automatically and merge compilation units when necessary.</p><figure><img alt=\"\" src=\"https://cdn-images-1.medium.com/max/1024/1*UnuZOwRc8X-lT3onIEYHiA.png\" /></figure><p>Even after the migration, the build file generator remains in use. It improves the developer experience by automatically fixing build file configurations and removing unused dependencies. In contrast, when we were on Gradle, users manually maintained ~4,500 Gradle files, which led to unused dependencies, a bloated dependency graph, and slower builds with fewer cacheÂ hits.</p><h4>Porting buildÂ logic</h4><p>In addition to JVM source files, our repo has a large amount of build logic such as code generation owned by multiple teams. These often took the form of GradleÂ plugins.</p><p>Because we now had automated build file generation, when porting the build logic, we also had to integrate it with the build file generator. Also, because we had more granular targets, a single line of Gradle config now might need to apply to 10+ Bazel buildÂ files.</p><p>As a result, our build file generator architecture supported plugins similar to Gazelle extensions. These plugins were triggered by the presence of specific files such as Thrift or GraphQL files. These plugins could also generate new build targets such as codegenÂ actions.</p><p>In some cases, the Gradle logic was manually added as a one-off or not easily inferred from the file structure. As a result, we also supported generator <em>directives</em> similar to Gazelle, such as adding dependencies or setting attributes.</p><p>Initially, our team ported much of this build logic ourselves with minimal help from service owners. As Bazel adoption grew, owners of complex build logic were incentivized to migrate to Bazel, because it was faster and more reliable than Gradle. In the process, they often wrote their own build file generator plugins, highlighting the extensibility of our generator.</p><h4>Third-party library multi-version support</h4><p>Another major issue we hit on the road to 100% compilation and testing with Bazel was multiple versions of the same third-party library.</p><p>Initially, we specified a single version of each library. The build file generator would add dependencies from this universe.</p><p>However, in Gradle, each sub-project within the monorepo could use different versions of third-party libraries. As a result, when compiling against a single version, compilation or testing could fail with a missingÂ symbol.</p><p>To bring multi-version support to our Bazel system, we built tooling to generate multiple maven_install rules and added a custom <a href=\"https://bazel.build/extending/aspects\">aspect</a> to resolve conflicts at the targetÂ level.</p><figure><img alt=\"\" src=\"https://cdn-images-1.medium.com/max/1024/0*_U1LAeex52squvmt\" /></figure><p><em>Multiple versions of Guava in Bazel before we added conflict resolution</em></p><p>Once we had this capability, we systematically synced library versions from Gradle so that each build targetâ€™s classpath more closely matched its Gradle counterpart.</p><p>To learn more about our approach, see our <a href=\"https://www.youtube.com/watch?v=Ui4YtqWhqYU\">BazelCon 2022 talk</a>. Since giving this talk, we have made improvements like moving the resolution to analysis-time for better IDE support and adding more user-friendly tooling for updating libraries.</p><h4>Migrating theÂ deploys</h4><p>As we got the vast majority of projects building and passing unit tests with Bazel in CI, we began to focus on migrating deployments. The Bazel-built jars were not identical to the Gradle-built jars. As a result, we needed a strategy to ensure the deployments were safe. We started with services.</p><h4>Services</h4><p>To verify the correctness of deploying services with Bazel, we used startup and integration tests. Of ~700 services, ~100 encountered startup or integration test failures. The majority of failures were missing dependencies that were loaded via Java reflection, usually from config files or other files. As a result, we were able to fix a number of these issues by parsing files for classes that would be loaded via reflection, and then adding the required dependency.</p><p>Another major source of errors was differing library versions, which could lead to missing symbol errors at runtime. In Gradle, users manually specified dependencies and their versions. However, in Bazel, build files were generated from source and dependencies were inferred from import statements, which didnâ€™t specify the version. We solved many of these errors forcing third-party library versions to match those of the GradleÂ project.</p><p>After taking into account reflected classes and syncing versions, only a single-digit percentage of services hit production runtime issues that required more in-depth manual work toÂ fix.</p><h4>Data pipelines and otherÂ projects</h4><p>In addition to services, we had 450 data pipelines and ~50 other projects that were deployed to either a Spark cluster or a FlinkÂ runtime.</p><p>Similar to services, we were able to catch a number of issues using tests. In particular, data pipelines on Airbnbâ€™s data engineering paved path have CI tests that run a small version of the Spark pipeline locally. For these ~400 paved-path pipelines, after passing CI tests, only about 3% had production issues at runtime. As a result, we were able to very quickly migrate the paved-path pipelines.</p><p>As with services, we had a few remaining deployables that were a bit more bespoke and had to be individually deployed and monitored to verify correctness.</p><h3>What did weÂ learn?</h3><h4>Customer partnership</h4><p>Early in the migration, we identified key pilot services that had large opportunities for impact and an appetite to invest in migrating to a new build system. For example, Viaduct had complex build logic leading to slow builds and reliability issues. In addition, many developers contributed to the service, so improving their builds had a large impact on Airbnbâ€™s developer experience.</p><p>Partnering with pilot teams was incredibly valuable. They were early adopters and made significant contributions in the form of reporting and debugging issues, profiling performance bottlenecks, and suggesting features. The pilot teams also became advocates and provided internal support, helping motivate the rest of the Airbnb developer community.</p><h4>Dangers of premature optimization</h4><p>This migration took 4.5 years. With the benefit of hindsight we think we could have drastically improved the migration timeline if we had <strong>migrated first, before improving</strong><em>.</em></p><p>Although increasing build granularity improved build times, it increased the time to migrate. Specifically, increased build granularity greatly increased the number of configuration files, making it much harder to manage configurations manually. This forced more functionality into automated build file generation, which increased its complexity.</p><p>If we had migrated first and <em>then</em> optimized the build granularity, we believe we could have migrated sooner, enabling users to get benefits from Bazel sooner and reducing the time spent maintaining two co-existing builds.</p><p>Similarly, build granularity also made it harder to match deploy jars between Gradle and Bazel. This led to spending more time testing deployments and fixing runtimeÂ issues.</p><p>On a more positive note, we accelerated the migration by deciding to support multiple third-party library versions and implementing version resolution. This enabled us to sync versions from Gradle to Bazel, which fixed a large number of build and runtimeÂ issues.</p><p>Towards the end, one major takeaway in the migration was, <strong>by default, we should try to imitate what was there before</strong><em>. </em>In our case, deviating from Gradle usually added technical risk, and should be carefully considered, especially its downstream consequences.</p><p>As engineers, we often want to improve things. However, during migrations, improvements can have non-obvious consequences and potentially significantly slow down the migration.</p><h3>ğŸ Conclusion</h3><p>After 4.5 years, we fully migrated Airbnbâ€™s biggest repo from Gradle to Bazel, achieving:</p><ul><li>Build CSAT: 38% â†’Â 68%</li><li><strong>3â€“5x </strong>faster local build and testÂ times</li><li><strong>2â€“3x</strong> faster IntelliJÂ syncs</li><li><strong>2â€“3x</strong> faster deploys to the development environment</li></ul><p>Finally, now that several Airbnb repos are on Bazel, weâ€™re able to share <a href=\"https://www.youtube.com/watch?v=RpSVBtyoYCY\">common infrastructure</a> such as remote build caching, remote build execution, affected targets calculation, andÂ more.</p><p>Interested in helping us solve problems like these at Airbnb? Learn more about our open engineering rolesÂ <a href=\"https://careers.airbnb.com/\">here</a>.</p><h3>Acknowledgments</h3><p>Additionally, thank you Janusz Kudelka, Kumail Hussain, Meghan Dow, Pawel Lipski, Peimin Liu, Tomasz Pacuszka, and various other internal and external partners.</p><img src=\"https://medium.com/_/stat?event=post.clientViewed&referrerSource=full_rss&postId=33f90eda51ec\" width=\"1\" height=\"1\" alt=\"\"><hr><p><a href=\"https://medium.com/airbnb-engineering/migrating-airbnbs-jvm-monorepo-to-bazel-33f90eda51ec\">Migrating Airbnbâ€™s JVM Monorepo to Bazel</a> was originally published in <a href=\"https://medium.com/airbnb-engineering\">The Airbnb Tech Blog</a> on Medium, where people are continuing the conversation by highlighting and responding to this story.</p>"
    },
    {
      "title": "å¤§è§„æ¨¡ Istio æ— ç¼å‡çº§ (åŸæ ‡é¢˜: Seamless Istio Upgrades at Scale)",
      "link": "https://medium.com/airbnb-engineering/seamless-istio-upgrades-at-scale-bcb0e49c5cf8?source=rss----53c7c27702d5---4",
      "pubDate": "Thu, 07 Aug 2025 17:01:42 GMT",
      "isoDate": "2025-08-07T17:01:42.000Z",
      "creator": "Rushy R. Panchal",
      "summary": "# å¤§è§„æ¨¡ Istio æ— ç¼å‡çº§\n\n## å¼•è¨€\n\nAirbnb è‡ª2019å¹´èµ·å¤§è§„æ¨¡è¿è¡Œ IstioÂ®ï¼Œæ”¯æŒæ•°ä¸‡ä¸ª Podã€æ•°åä¸ª Kubernetes é›†ç¾¤å’Œæ•°åƒä¸ªè™šæ‹Ÿæœº (VM)ï¼Œå³°å€¼æœŸé—´é€šè¿‡ Istio å¤„ç†æ•°åƒä¸‡ QPSã€‚Istio æ˜¯ Airbnb æ¶æ„çš„åŸºç¡€ç»„æˆéƒ¨åˆ†ï¼Œè¿™ä½¿å¾—å…¶æŒç»­ç»´æŠ¤å’Œå‡çº§æˆä¸ºä¸€é¡¹æŒ‘æˆ˜ã€‚å°½ç®¡å¦‚æ­¤ï¼ŒAirbnb å·²æˆåŠŸå‡çº§ Istio 14 æ¬¡ã€‚æœ¬æ–‡å°†æ¢è®¨ Airbnb æœåŠ¡ç½‘æ ¼å›¢é˜Ÿå¦‚ä½•åœ¨ä¿æŒé«˜å¯ç”¨æ€§çš„åŒæ—¶å®‰å…¨åœ°å‡çº§ Istioã€‚\n\n![å›¾ç‰‡ 1](https://cdn-images-1.medium.com/max/1024/1*44AVFDg8R66nWj4cAU8vCA.jpeg)\n\n## é¢ä¸´çš„æŒ‘æˆ˜ä¸å‡çº§ç›®æ ‡\n\nAirbnb å·¥ç¨‹å¸ˆè¿è¡Œç€æ•°åƒç§ä¸åŒçš„å·¥ä½œè´Ÿè½½ï¼Œæ— æ³•åˆç†åè°ƒæ¯ä¸ªå›¢é˜Ÿã€‚å› æ­¤ï¼Œå‡çº§è¿‡ç¨‹å¿…é¡»ç‹¬ç«‹äºå•ä¸ªå›¢é˜Ÿè¿è¡Œï¼Œä¸”ç”±äºæ— æ³•åŒæ—¶ç›‘æ§æ‰€æœ‰å·¥ä½œè´Ÿè½½ï¼Œå¿…é¡»é€šè¿‡æ¸è¿›å¼å‘å¸ƒå°†é£é™©é™è‡³æœ€ä½ã€‚\n\nåŸºäºæ­¤ï¼ŒAirbnb è®¾è®¡çš„å‡çº§æµç¨‹æ—¨åœ¨å®ç°ä»¥ä¸‹ç›®æ ‡ï¼š\n\n*   **å·¥ä½œè´Ÿè½½å’Œç”¨æˆ·é›¶åœæœº**ï¼šè¿™æ˜¯æ— ç¼å‡çº§çš„å…³é”®ï¼Œå·¥ä½œè´Ÿè½½æ‰€æœ‰è€…æ— éœ€å‚ä¸ Istio å‡çº§ã€‚\n*   **æ¸è¿›å¼å‘å¸ƒ**ï¼šèƒ½å¤Ÿæ§åˆ¶å“ªäº›å·¥ä½œè´Ÿè½½è¢«å‡çº§æˆ–å›æ»šã€‚\n*   **å…¨é¢å›æ»šèƒ½åŠ›**ï¼šæ— éœ€åè°ƒæ¯ä¸ªå·¥ä½œè´Ÿè½½å›¢é˜Ÿï¼Œå³å¯åœ¨æ‰€æœ‰å·¥ä½œè´Ÿè½½ä¸Šå›æ»šå‡çº§ã€‚\n*   **è§„å®šæ—¶é—´å†…å®Œæˆå‡çº§**ï¼šæ‰€æœ‰å·¥ä½œè´Ÿè½½åº”åœ¨å®šä¹‰çš„æ—¶é—´å†…å®Œæˆå‡çº§ã€‚\n\n## æ¶æ„æ¦‚è§ˆ\n\nAirbnb çš„ Istio éƒ¨ç½²åŒ…å«ä¸€ä¸ª**ç®¡ç†é›†ç¾¤**ï¼Œè¿è¡Œ Istiod å¹¶åŒ…å«æ‰€æœ‰ç½‘æ ¼çš„å·¥ä½œè´Ÿè½½é…ç½®ï¼ˆå¦‚ VirtualServicesã€DestinationRulesï¼‰ï¼Œä»¥åŠå¤šä¸ª**å·¥ä½œè´Ÿè½½é›†ç¾¤**ï¼Œè¿è¡Œç”¨æˆ·å·¥ä½œè´Ÿè½½ã€‚VM ç‹¬ç«‹è¿è¡Œï¼Œä½†å…¶ Istio Manifests ä»éƒ¨ç½²åˆ°ç®¡ç†é›†ç¾¤çš„ç‹¬ç«‹å‘½åç©ºé—´ä¸­ã€‚Airbnb ç‹¬å ä½¿ç”¨ **Sidecar æ¨¡å¼**ï¼Œå³æ¯ä¸ªå·¥ä½œè´Ÿè½½éƒ½è¿è¡Œ istio-proxyï¼Œå°šæœªè¿è¡Œ Ambient æ¨¡å¼ã€‚\n\n![Istio éƒ¨ç½²æ¶æ„å›¾](https://cdn-images-1.medium.com/max/1024/0*-qAuZZZxdsi-oJSO)\n\n## å‡çº§æµç¨‹\n\nAirbnb éµå¾ª Istio çš„ **Canary å‡çº§æ¨¡å‹**ï¼Œå³åŒæ—¶è¿è¡Œä¸¤ä¸ªç‰ˆæœ¬çš„ Istiodï¼ˆå½“å‰ç‰ˆæœ¬å’Œæ–°ç‰ˆæœ¬ï¼‰ã€‚è¿™ä¸¤ä¸ªç‰ˆæœ¬å…±åŒæ„æˆä¸€ä¸ªé€»è¾‘æœåŠ¡ç½‘æ ¼ï¼Œå…è®¸è¿æ¥åˆ°ä¸åŒ Istiod çš„å·¥ä½œè´Ÿè½½ç›¸äº’é€šä¿¡ã€‚Istiod ç‰ˆæœ¬é€šè¿‡ä¸åŒçš„ä¿®è®¢æ ‡ç­¾è¿›è¡Œç®¡ç†ï¼ˆä¾‹å¦‚ï¼Œ1-24-5 ç”¨äº Istio 1.24.5ï¼Œ1-25-2 ç”¨äº Istio 1.25.2ï¼‰ã€‚\n\nå‡çº§æ¶‰åŠæ§åˆ¶å¹³é¢ Istiod å’Œæ•°æ®å¹³é¢ Sidecar istio-proxyã€‚å°½ç®¡ Istio æ”¯æŒæ—§ç‰ˆ istio-proxy è¿æ¥æ–°ç‰ˆ Istiodï¼Œä½† Airbnb ä¸é‡‡ç”¨æ­¤æ–¹å¼ã€‚ç›¸åï¼Œä»–ä»¬åŸå­æ€§åœ°å°†æ–°ç‰ˆ istio-proxy åŠå…¶è¿æ¥çš„ Istiod é…ç½®ä¸€åŒå‘å¸ƒåˆ°å·¥ä½œè´Ÿè½½ã€‚ä¾‹å¦‚ï¼Œä¸º 1.24 ç‰ˆæœ¬æ„å»ºçš„ istio-proxy åªä¼šè¿æ¥åˆ° 1.24 çš„ Istiodï¼Œè¿™é™ä½äº†å‡çº§æœŸé—´çš„å¤æ‚æ€§ï¼ˆè·¨ç‰ˆæœ¬æ•°æ®å¹³é¢-æ§åˆ¶å¹³é¢å…¼å®¹æ€§ï¼‰ã€‚\n\nå‡çº§è¿‡ç¨‹çš„ç¬¬ä¸€æ­¥æ˜¯åœ¨ç®¡ç†é›†ç¾¤ä¸Šéƒ¨ç½²å¸¦æœ‰æ–°ä¿®è®¢æ ‡ç­¾çš„æ–°ç‰ˆ Istiodã€‚ç”±äºæ‰€æœ‰å·¥ä½œè´Ÿè½½éƒ½æ˜ç¡®ç»‘å®šåˆ°æŸä¸ªä¿®è®¢ç‰ˆï¼Œå› æ­¤æ²¡æœ‰å·¥ä½œè´Ÿè½½ä¼šè¿æ¥åˆ°è¿™ä¸ªæ–°çš„ Istiodï¼Œè¿™ä¸€æ­¥æ²¡æœ‰å½±å“ã€‚å‡çº§çš„å…¶ä½™éƒ¨åˆ†ï¼ˆä¹Ÿæ˜¯ä¸»è¦å·¥ä½œå’Œé£é™©æ‰€åœ¨ï¼‰æ˜¯é€æ­¥å°†å·¥ä½œè´Ÿè½½åˆ‡æ¢åˆ°è¿è¡Œæ–°ç‰ˆ istio-proxy å¹¶è¿æ¥åˆ°æ–°ç‰ˆ Istiodã€‚\n\n![å¤šä¿®è®¢ç‰ˆ Istio ç¤ºæ„å›¾](https://cdn-images-1.medium.com/max/1024/0*k7_eTtEPqBiDKM3t)\n\n## å‘å¸ƒè§„èŒƒ (`rollouts.yml`)\n\nAirbnb é€šè¿‡ä¸€ä¸ªåä¸º `rollouts.yml` çš„æ–‡ä»¶æ§åˆ¶å·¥ä½œè´Ÿè½½è¿è¡Œçš„ istio-proxy ç‰ˆæœ¬ã€‚è¯¥æ–‡ä»¶æŒ‡å®šäº†å·¥ä½œè´Ÿè½½å‘½åç©ºé—´ï¼ˆä½œä¸ºæ¨¡å¼ï¼‰å’Œ Istio ç‰ˆæœ¬çš„ç™¾åˆ†æ¯”åˆ†å¸ƒï¼Œä¾‹å¦‚ï¼š\n\n```yaml\n# \"production\" æ˜¯é»˜è®¤å€¼ï¼›ä»»ä½•ä¸åŒ¹é…å…¶ä»–æ¨¡å¼çš„éƒ½å°†åŒ¹é…æ­¤é¡¹ã€‚\nproduction: 1-24-5: 100\n\n\".*-staging\": 1-24-5: 75 1-25-2: 25\n\n# ä¸€ä¸ªå›ºå®šçš„å‘½åç©ºé—´ï¼›æˆ‘ä»¬çš„ç«¯åˆ°ç«¯éªŒè¯å·¥ä½œè´Ÿè½½ã€‚\nistio-e2e: 1-25-2: 100\n```\n\næ­¤è§„èŒƒè§„å®šäº†æ‰€æœ‰å‘½åç©ºé—´çš„æœŸæœ›çŠ¶æ€ã€‚ç»™å®šå‘½åç©ºé—´é¦–å…ˆæ˜ å°„åˆ°ä¸€ä¸ªæ¡¶ï¼ˆåŸºäºæœ€é•¿åŒ¹é…æ¨¡å¼ï¼‰ï¼Œç„¶åæ ¹æ®è¯¥æ¡¶çš„åˆ†å¸ƒé€‰æ‹©ä¸€ä¸ªç‰ˆæœ¬ã€‚è¿™ç§åˆ†å¸ƒåº”ç”¨äºå‘½åç©ºé—´çº§åˆ«ï¼Œè€Œé Pod æˆ– VM çº§åˆ«ï¼Œä¸”é€šè¿‡ä¸€è‡´æ€§å“ˆå¸Œå®ç°ç¡®å®šæ€§åˆ†é…ã€‚å¤§éƒ¨åˆ†å‡çº§è¿‡ç¨‹ä»…æ¶‰åŠæ›´æ–° `rollouts.yml` å¹¶è¿›è¡Œç›‘æ§ã€‚è¿™ç§æ–¹å¼å…è®¸é€‰æ‹©æ€§å‡çº§å·¥ä½œè´Ÿè½½ï¼Œå¹¶èƒ½ç‹¬ç«‹å‡çº§ç¯å¢ƒï¼Œç¡®ä¿åªæœ‰ä¸€å®šæ¯”ä¾‹çš„ç¯å¢ƒè¿è¡Œæ–°ç‰ˆæœ¬ï¼Œä»è€Œæœ‰æ—¶é—´è¿›è¡Œâ€œçƒ˜ç„™â€å¹¶å‘ç°æ½œåœ¨çš„å›å½’é—®é¢˜ã€‚\n\n## Kubernetes å·¥ä½œè´Ÿè½½å‡çº§æœºåˆ¶\n\næ¯ä¸ª Istio ä¿®è®¢ç‰ˆåœ¨æ¯ä¸ªå·¥ä½œè´Ÿè½½é›†ç¾¤ä¸Šéƒ½æœ‰ä¸€ä¸ªå¯¹åº”çš„ `MutatingAdmissionWebhook` ç”¨äº Sidecar æ³¨å…¥ã€‚æ­¤ Webhook é€‰æ‹©å¸¦æœ‰ `istio.io/rev=<revision>` æ ‡ç­¾çš„ Podï¼Œå¹¶å‘å…¶æ³¨å…¥ istio-proxy å’Œ istio-init å®¹å™¨ã€‚å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œistio-proxy å®¹å™¨åŒ…å« `PROXY_CONFIG` ç¯å¢ƒå˜é‡ï¼Œè¯¥å˜é‡å°† `discoveryAddress` è®¾ç½®ä¸ºç‰¹å®šçš„ Istiod ä¿®è®¢ç‰ˆã€‚è¿™ç¡®ä¿äº† istio-proxy ç‰ˆæœ¬å’Œå…¶è¿æ¥çš„ Istiod é…ç½®çš„åŸå­æ€§éƒ¨ç½²ï¼Œå®Œå…¨ç”± Sidecar æ³¨å…¥å™¨å®Œæˆã€‚\n\næ¯ä¸ªå·¥ä½œè´Ÿè½½çš„ Deployment éƒ½å¸¦æœ‰æ­¤ä¿®è®¢æ ‡ç­¾ã€‚ç„¶è€Œï¼Œä¼ ç»Ÿæ–¹æ³•è¦æ±‚æ¯ä¸ªå›¢é˜Ÿæ‰‹åŠ¨æ›´æ–°æ­¤æ ‡ç­¾å¹¶éƒ¨ç½²å…¶å·¥ä½œè´Ÿè½½ï¼Œè¿™ä½¿å¾—åœ¨æ‰€æœ‰å·¥ä½œè´Ÿè½½ä¸Šæ‰§è¡Œå›æ»šæˆ–ç¡®ä¿ 100% å®Œæˆå‡çº§å˜å¾—ä¸åˆ‡å®é™…ã€‚\n\n### Krisprï¼šå†…éƒ¨çªå˜æ¡†æ¶\n\nä¸ºé¿å…å•ç‹¬æ›´æ–°å·¥ä½œè´Ÿè½½ï¼ŒAirbnb ä½¿ç”¨å†…éƒ¨æ„å»ºçš„çªå˜æ¡†æ¶ **Krispr** æ¥æ³¨å…¥ä¿®è®¢æ ‡ç­¾ï¼Œä»è€Œå°†åŸºç¡€è®¾æ–½ç»„ä»¶å‡çº§ä¸å·¥ä½œè´Ÿè½½éƒ¨ç½²è§£è€¦ã€‚Airbnb åœ¨ Kubernetes ä¸Šè¿è¡Œçš„å·¥ä½œè´Ÿè½½ä½¿ç”¨å†…éƒ¨ API å®šä¹‰ï¼Œè€Œéç›´æ¥æŒ‡å®š Kubernetes Manifestsã€‚æ­¤æŠ½è±¡åœ¨ CI æœŸé—´ç¼–è¯‘ä¸º Kubernetes Manifestsï¼ŒKrispr ä½œä¸ºç¼–è¯‘è¿‡ç¨‹çš„ä¸€éƒ¨åˆ†è¿è¡Œï¼Œå¹¶çªå˜è¿™äº› Manifestsã€‚å…¶ä¸­ä¸€é¡¹çªå˜å°±æ˜¯æ ¹æ® `rollouts.yml` å†³å®šå¹¶æ³¨å…¥ Istio ä¿®è®¢æ ‡ç­¾åˆ°æ¯ä¸ª Deployment çš„ Pod è§„èŒƒä¸­ã€‚å¦‚æœå›¢é˜Ÿåœ¨éƒ¨ç½²æ—¶å‘ç°ä»»ä½•é—®é¢˜ï¼Œä»–ä»¬å¯ä»¥å›æ»šï¼Œä»è€Œä¹Ÿå›æ»š Istio å‡çº§ï¼Œè€Œæ— éœ€æœåŠ¡ç½‘æ ¼å›¢é˜Ÿçš„ä»‹å…¥ã€‚\n\næ­¤å¤–ï¼ŒKrispr è¿˜åœ¨ Pod å‡†å…¥é˜¶æ®µè¿è¡Œã€‚å¦‚æœä¸€ä¸ª Pod æ¥è‡ªè¶…è¿‡ä¸¤å‘¨çš„ Deploymentï¼ŒKrispr å°†é‡æ–°çªå˜è¯¥ Podï¼Œå¹¶åœ¨éœ€è¦æ—¶æ›´æ–°å…¶ä¿®è®¢æ ‡ç­¾ã€‚ç»“åˆ Kubernetes èŠ‚ç‚¹æœ€é•¿ä¸¤å‘¨çš„ç”Ÿå‘½å‘¨æœŸï¼ˆä»è€Œç¡®ä¿ä»»ä½•ç»™å®š Pod çš„æœ€é•¿ç”Ÿå‘½å‘¨æœŸä¹Ÿæ˜¯ä¸¤å‘¨ï¼‰ï¼ŒAirbnb å¯ä»¥ä¿è¯ Istio å‡çº§æœ€ç»ˆå®Œæˆã€‚å¤§å¤šæ•°å·¥ä½œè´Ÿè½½å°†åœ¨éƒ¨ç½²æ—¶ï¼ˆCI ä¸­çš„ Krispr è¿è¡ŒæœŸé—´ï¼‰å‡çº§ï¼Œå¯¹äºä¸å®šæœŸéƒ¨ç½²çš„å·¥ä½œè´Ÿè½½ï¼Œè‡ªç„¶çš„ Pod å¾ªç¯å’Œé‡æ–°çªå˜å°†ç¡®ä¿å®ƒä»¬åœ¨æœ€é•¿å››å‘¨å†…å®Œæˆå‡çº§ã€‚\n\n**æ€»ç»“ Kubernetes å·¥ä½œè´Ÿè½½å‡çº§æµç¨‹ï¼š**\n\n1.  **CI é˜¶æ®µ**ï¼šKrispr æ ¹æ® `rollouts.yml` çªå˜å·¥ä½œè´Ÿè½½çš„ Kubernetes Manifestsï¼Œæ·»åŠ  Istio ä¿®è®¢æ ‡ç­¾ã€‚\n2.  **Pod å‡†å…¥é˜¶æ®µ**ï¼šå¦‚æœ Pod çš„ Deployment è¶…è¿‡ä¸¤å‘¨ï¼ŒKrispr ä¼šé‡æ–°çªå˜ Podï¼Œå¹¶åœ¨éœ€è¦æ—¶æ›´æ–° Istio ä¿®è®¢æ ‡ç­¾ã€‚\n3.  **Webhook æ³¨å…¥**ï¼šç‰¹å®šä¿®è®¢ç‰ˆçš„ Istio `MutatingAdmissionWebhook` ä¼šæ³¨å…¥ Sidecar å’Œå…³è”çš„ `discoveryAddress`ã€‚\n\n## è™šæ‹Ÿæœº (VM) å·¥ä½œè´Ÿè½½å‡çº§æœºåˆ¶\n\nåœ¨ VM ä¸Šï¼ŒAirbnb éƒ¨ç½²ä¸€ä¸ªåŒ…å« istio-proxyã€è¿è¡Œ istio-iptables çš„è„šæœ¬ï¼ˆç±»ä¼¼äº istio-init å®¹å™¨ï¼‰å’Œ Istiod `discoveryAddress` çš„å·¥ä»¶ã€‚é€šè¿‡å°† istio-proxy å’Œ `discoveryAddress` æ‰“åŒ…åœ¨åŒä¸€å·¥ä»¶ä¸­ï¼Œå¯ä»¥åŸå­æ€§åœ°å‡çº§ä¸¤è€…ã€‚æ­¤å·¥ä»¶çš„å®‰è£…ç”±ä¸»æœºå®ˆæŠ¤è¿›ç¨‹ **mxagent** è´Ÿè´£ã€‚å®ƒé€šè¿‡è½®è¯¢ VM ä¸Šçš„é”®å€¼æ ‡ç­¾ï¼ˆå¦‚ AWS ä¸Šçš„ EC2 æ ‡ç­¾æˆ– GCP ä¸Šçš„èµ„æºæ ‡ç­¾ï¼Œè¿™äº›æ ‡ç­¾æ¨¡ä»¿ Kubernetes å·¥ä½œè´Ÿè½½çš„ `istio.io/rev` æ ‡ç­¾ï¼‰æ¥ç¡®å®šè¦å®‰è£…çš„ç‰ˆæœ¬ã€‚æ¯å½“è¿™äº›æ ‡ç­¾æ”¹å˜æ—¶ï¼Œmxagent å°±ä¼šä¸‹è½½å¹¶å®‰è£…å¯¹åº”ç‰ˆæœ¬çš„å·¥ä»¶ã€‚å› æ­¤ï¼Œå‡çº§ VM ä¸Šçš„ istio-proxy åªéœ€æ›´æ–°è¯¥ VM ä¸Šçš„è¿™äº›æ ‡ç­¾ï¼Œmxagent å°†å¤„ç†å…¶ä½™éƒ¨åˆ†ã€‚\n\nAirbnb çš„ VM å·¥ä½œè´Ÿè½½ä¸»è¦æ˜¯åŸºç¡€è®¾æ–½å¹³å°ï¼Œé€šå¸¸ä¸å®šæœŸéƒ¨ç½²ä»£ç ã€‚å› æ­¤ï¼ŒVM ä¸æ”¯æŒéƒ¨ç½²æ—¶å‡çº§ï¼ˆä¸åƒ Kubernetes å·¥ä½œè´Ÿè½½ï¼‰ã€‚åŒæ ·ï¼Œå›¢é˜Ÿæ— æ³•è‡ªè¡Œå›æ»šè¿™äº›å·¥ä½œè´Ÿè½½ï¼Œä½†è€ƒè™‘åˆ°æ­¤ç±»åŸºç¡€è®¾æ–½å¹³å°æ•°é‡æœ‰é™ï¼Œè¿™æ˜¯å¯ä»¥æ¥å—çš„ã€‚\n\næ ‡ç­¾æ›´æ–°ç”±ä¸­å¤®æ§åˆ¶å™¨ **mxrc** ç®¡ç†ï¼Œå®ƒæ‰«æè¿‡æ—¶çš„ VMã€‚å¦‚æœ `rollouts.yml` ä¼šå¯¼è‡´ VM çš„èµ„æºæ ‡ç­¾é›†å‘ç”Ÿå˜åŒ–ï¼Œæ§åˆ¶å™¨å°†ç›¸åº”åœ°æ›´æ–°æ ‡ç­¾ã€‚è¿™å¤§è‡´å¯¹åº”äº Krispr çš„ Pod å‡†å…¥æ—¶çªå˜ï¼Œä½†éœ€è¦æ³¨æ„çš„æ˜¯ï¼ŒVM æ˜¯å¯å˜çš„ä¸”ç”Ÿå‘½å‘¨æœŸé•¿ï¼Œå› æ­¤æ˜¯åŸåœ°å‡çº§ã€‚\n\nä¸ºäº†å®‰å…¨èµ·è§ï¼Œmxrc ä¼šè€ƒè™‘ VM çš„å¥åº·çŠ¶å†µï¼Œç‰¹åˆ«æ˜¯ WorkloadEntry ä¸Šçš„å°±ç»ªæ¢é’ˆçŠ¶æ€ã€‚ç±»ä¼¼äº Kubernetes çš„ `maxUnavailable` è¯­ä¹‰ï¼Œmxrc æ—¨åœ¨å°†ä¸å¯ç”¨ VM çš„æ•°é‡ï¼ˆå³ä¸å¥åº·çš„ VM åŠ ä¸Šæ­£åœ¨å‡çº§çš„ VMï¼‰ä¿æŒåœ¨å®šä¹‰çš„ç™¾åˆ†æ¯”ä»¥ä¸‹ã€‚å®ƒé€æ­¥æ‰§è¡Œè¿™äº›å‡çº§ï¼Œç›®æ ‡æ˜¯åœ¨ä¸¤å‘¨å†…å®Œæˆä¸€ä¸ªå·¥ä½œè´Ÿè½½æ‰€æœ‰ VM çš„å‡çº§ã€‚\n\n## ç»“è®º\n\nè·Ÿä¸Šå¼€æºè½¯ä»¶çš„æ›´æ–°æ­¥ä¼æ˜¯ä¸€é¡¹æŒ‘æˆ˜ï¼Œå°¤å…¶æ˜¯åœ¨å¤§è§„æ¨¡ç¯å¢ƒä¸‹ã€‚å‡çº§å’Œå…¶ä»– Day-2 æ“ä½œå¸¸å¸¸è¢«å¿½è§†ï¼Œè¿™åœ¨æœ€ç»ˆéœ€è¦å‡çº§æ—¶ï¼ˆä¸ºäº†å¼•å…¥å®‰å…¨è¡¥ä¸ã€ä¿æŒåœ¨æ”¯æŒçª—å£å†…ã€åˆ©ç”¨æ–°åŠŸèƒ½ç­‰ï¼‰å¢åŠ äº†è´Ÿæ‹…ã€‚å¯¹äº Istio è€Œè¨€å°¤å…¶å¦‚æ­¤ï¼Œå…¶ç‰ˆæœ¬å¾ˆå¿«å°±ä¼šè¾¾åˆ°ç”Ÿå‘½å‘¨æœŸç»“æŸã€‚\n\nå°½ç®¡æœåŠ¡ç½‘æ ¼çš„å¤æ‚æ€§å’Œè§„æ¨¡å·¨å¤§ï¼ŒAirbnb å·²æˆåŠŸå‡çº§ Istio 14 æ¬¡ã€‚è¿™å¾—ç›Šäºï¼š\n\n*   **å¯ç»´æŠ¤æ€§è®¾è®¡**\n*   **ç¡®ä¿é›¶åœæœºçš„æµç¨‹**\n*   **é€šè¿‡æ¸è¿›å¼å‘å¸ƒé™ä½é£é™©**\n\nç±»ä¼¼æµç¨‹ä¹Ÿåº”ç”¨äº Airbnb çš„å…¶ä»–å¤šä¸ªåŸºç¡€æ¶æ„ç³»ç»Ÿã€‚\n\n## æœªæ¥å·¥ä½œ\n\néšç€ Airbnb åŸºç¡€è®¾æ–½çš„ä¸æ–­å‘å±•å’Œå£®å¤§ï¼ŒæœåŠ¡ç½‘æ ¼å›¢é˜Ÿæ­£åœ¨å…³æ³¨å‡ ä¸ªå…³é”®é¡¹ç›®ï¼š\n\n*   **åˆ©ç”¨ Ambient æ¨¡å¼**ï¼šä½œä¸ºä¸€ç§æ›´å…·æˆæœ¬æ•ˆç›Šä¸”æ›´æ˜“äºç®¡ç†çš„ Istio éƒ¨ç½²æ¨¡å‹ã€‚ç‰¹åˆ«æ˜¯ï¼Œå®ƒé€šè¿‡å®Œå…¨æ— éœ€è§¦åŠå·¥ä½œè´Ÿè½½éƒ¨ç½²æ¥ç®€åŒ–å‡çº§ã€‚\n*   **å°†å•ä¸€ç”Ÿäº§ç½‘æ ¼æ‹†åˆ†ä¸ºå¤šä¸ªç½‘æ ¼**ï¼šä»¥åˆ†ç¦»æ•…éšœåŸŸã€æä¾›æ›´å¥½çš„å®‰å…¨éš”ç¦»è¾¹ç•Œå¹¶è¿›ä¸€æ­¥æ‰©å±• Istioã€‚å¯¹äºå‡çº§è€Œè¨€ï¼Œè¿™å°†è¿›ä¸€æ­¥ç¼©å°å½±å“èŒƒå›´ï¼Œå› ä¸ºä¸€äº›åªè¿è¡Œä½é£é™©å·¥ä½œè´Ÿè½½ï¼ˆå¦‚ stagingï¼‰çš„ç½‘æ ¼å¯ä»¥é¦–å…ˆå‡çº§ã€‚",
      "shortSummary": "Airbnb è¯¦ç»†ä»‹ç»äº†å…¶å¤§è§„æ¨¡ Istio æ— ç¼å‡çº§å®è·µã€‚é¢å¯¹æ•°ä¸‡ä¸ª Pod å’Œ VM çš„å¤æ‚ç¯å¢ƒï¼Œä»–ä»¬é€šè¿‡ Istio çš„ Canary å‡çº§æ¨¡å‹ï¼Œç»“åˆå†…éƒ¨å·¥å…· Krisprï¼ˆç”¨äº Kubernetesï¼‰å’Œ mxagent/mxrcï¼ˆç”¨äº VMï¼‰ï¼Œå®ç°äº†æ§åˆ¶å¹³é¢å’Œæ•°æ®å¹³é¢çš„åŸå­æ€§å‡çº§ã€‚è¿™å¥—ç³»ç»Ÿç¡®ä¿äº†é›¶åœæœºã€æ¸è¿›å¼å‘å¸ƒå’Œæ— éœ€äººå·¥åè°ƒçš„å…¨é¢å›æ»šèƒ½åŠ›ï¼Œä½¿æ‰€æœ‰å·¥ä½œè´Ÿè½½èƒ½åœ¨æ•°å‘¨å†…å®Œæˆå‡çº§ã€‚æœªæ¥è®¡åˆ’åŒ…æ‹¬é‡‡ç”¨ Ambient æ¨¡å¼å’Œæ‹†åˆ†æœåŠ¡ç½‘æ ¼ä»¥æå‡æ•ˆç‡å’Œå®‰å…¨æ€§ã€‚",
      "translated_title": "å¤§è§„æ¨¡ Istio æ— ç¼å‡çº§",
      "images": [
        {
          "url": "https://cdn-images-1.medium.com/max/1024/1*44AVFDg8R66nWj4cAU8vCA.jpeg",
          "alt": "",
          "title": "",
          "position": 1
        },
        {
          "url": "https://cdn-images-1.medium.com/max/1024/0*-qAuZZZxdsi-oJSO",
          "alt": "A diagram of Istio deployment architecture at Airbnb. There is a single configuration cluster containing Istio custom resources like VirtualServices, Istiod, and Istiodâ€™s ConfigMaps. There are two workload clusters, each running user workloads, and alongside those a number of VMs. Workloads and VMs communicate with each other.",
          "title": "",
          "position": 2
        },
        {
          "url": "https://cdn-images-1.medium.com/max/1024/0*k7_eTtEPqBiDKM3t",
          "alt": "Istio with multiple revisions. There is a config cluster with Istio custom resources like VirtualServices, multiple Istiod deployments, and the Istiod ConfigMaps for each of those. Workloads can connect to either Istiod.",
          "title": "",
          "position": 3
        },
        {
          "url": "https://medium.com/_/stat?event=post.clientViewed&referrerSource=full_rss&postId=bcb0e49c5cf8",
          "alt": "",
          "title": "",
          "position": 4
        }
      ],
      "contentSource": "RSS",
      "content": "<h4><strong>How Airbnb upgrades tens of thousands of pods on dozens of Kubernetes clusters to new IstioÂ versions</strong></h4><figure><img alt=\"\" src=\"https://cdn-images-1.medium.com/max/1024/1*44AVFDg8R66nWj4cAU8vCA.jpeg\" /></figure><p>Airbnb has been running IstioÂ® at scale since 2019. We support workloads running on both Kubernetes and virtual machines (using <a href=\"https://istio.io/latest/docs/ops/deployment/vm-architecture/\">Istioâ€™s mesh expansion</a>). Across these two environments, we run tens of thousands of pods, dozens of Kubernetes clusters, and thousands of VMs. These workloads send tens of millions of QPS at peak through Istio. Our <a href=\"https://www.youtube.com/watch?v=6kDiDQW5YXQ\">IstioCon 2021 talk</a> describes our journey onto Istio and our <a href=\"https://www.youtube.com/watch?v=1D8lg36ZNHs\">KubeCon 2021 talk</a> goes into further detail on our architecture.</p><p>Istio is a foundational piece of our architecture, which makes ongoing maintenance and upgrades a challenge. Despite that, we have upgraded Istio a total of 14 times. This blog post will explore how the Service Mesh team at Airbnb safely upgrades Istio while maintaining high availability.</p><h4>Challenges</h4><p>Airbnb engineers collectively run thousands of different workloads. We cannot reasonably coordinate the teams that own these, so our upgrades must function independently of individual teams. We also cannot monitor all of these at once, and so we must minimize risk through gradual rollouts.</p><p>With that in mind, we designed our upgrade process with the following goals:</p><ol><li>Zero downtime for workloads and users. This is the <em>seamless</em> part of the upgradeâ€Šâ€”â€Ša workload owner doesnâ€™t need to be in the loop for Istio upgrades.</li><li>Gradual rollouts with the ability to control which workloads are upgraded or reverted.</li><li>We must be able to roll back an upgrade across all workloads, without coordinating every workloadÂ team.</li><li>All workloads should be upgraded within some definedÂ time.</li></ol><h4>Architecture</h4><p>Our deployment consists of one management cluster, which runs Istiod and contains all workload configuration for the mesh (VirtualServices, DestinationRules, and so forth), and multiple workload clusters, which run user workloads. VMs run separately, but their Istio manifests are still deployed to the management cluster in their own namespaces. We use Sidecar mode exclusively, meaning that every workload runs istio-proxyâ€Šâ€”â€Šwe do not yet runÂ <a href=\"https://istio.io/latest/docs/ambient/overview/\">Ambient</a>.</p><figure><img alt=\"A diagram of Istio deployment architecture at Airbnb. There is a single configuration cluster containing Istio custom resources like VirtualServices, Istiod, and Istiodâ€™s ConfigMaps. There are two workload clusters, each running user workloads, and alongside those a number of VMs. Workloads and VMs communicate with each other.\" src=\"https://cdn-images-1.medium.com/max/1024/0*-qAuZZZxdsi-oJSO\" /></figure><h4>Upgrade Process</h4><p>At a high level, we follow <a href=\"https://istio.io/latest/docs/setup/upgrade/canary/\">Istioâ€™s canary upgrade model</a>. This involves running two versions (or Istio revisions) of Istiod simultaneously: the current version and the new version that we are upgrading to. Both form one logical service mesh, so workloads connected to one Istiod can communicate with workloads connected to another Istiod and vice versa. Istiod versions are managed using different revision labelsâ€Šâ€”â€Šfor example, 1â€“24â€“5 for Istio 1.24.5 and 1â€“25â€“2 for IstioÂ 1.25.2.</p><p>An upgrade involves both Istiod, the control plane, and istio-proxy, the data plane sidecar, running on all pods and VMs. While Istio supports connecting an <a href=\"https://istio.io/latest/docs/releases/supported-releases/#control-planedata-plane-skew\">older istio-proxy to a newer Istiod</a>, we do not use this. Instead, we atomically roll out the new istio-proxy version to a workload along with the configuration of which Istiod to connect to. For example, the istio-proxy built for version 1.24 will only connect to 1.24â€™s Istiod and the istio-proxy built for 1.25 will only connect to 1.25â€™s Istiod. This reduces a dimension of complexity during upgrades (cross-version data planeâ€Šâ€”â€Šcontrol plane compatibility).</p><p>The first step of our upgrade process is to deploy the new Istiod, with a new revision label, onto the management cluster. Because all workloads are explicitly pinned to a revision, no workload will connect to this new Istiod, so this first step has noÂ impact.</p><p>The rest of the upgrade comprises all of the effort and riskâ€Šâ€”â€Šworkloads are gradually shifted to run the new istio-proxy version and connect to the newÂ Istiod.</p><figure><img alt=\"Istio with multiple revisions. There is a config cluster with Istio custom resources like VirtualServices, multiple Istiod deployments, and the Istiod ConfigMaps for each of those. Workloads can connect to either Istiod.\" src=\"https://cdn-images-1.medium.com/max/1024/0*k7_eTtEPqBiDKM3t\" /><figcaption><em>Multiple Istio revisions, with some workloads connected to different revisions.</em></figcaption></figure><h3>Rollout specification</h3><p>We control what version of istio-proxy workloads run through a file called rollouts.yml. This file specifies workload namespaces (as patterns) and the percentage distribution of Istio versions:</p><pre># &quot;production&quot; is the default; anything not matching a different pattern will match this.<br>production:<br>  1-24-5: 100<br><br>&quot;.*-staging&quot;:<br>  1-24-5: 75<br>  1-25-2: 25<br><br># A pinned namespace; our end-to-end verification workload.<br>istio-e2e:<br>  1-25-2: 100</pre><p>This spec dictates the desired state of all namespaces. A given namespace is first mapped to a bucket (based on the longest pattern that matches) and then a version is chosen based on the distribution for that bucket. The distribution applies at the namespace level, not the pod (or VM) level. ForÂ example,</p><pre>&quot;.*-staging&quot;:<br>  1-24-5: 75<br>  1-25-2: 25</pre><p>means that 75% of the namespaces with the suffix -stagingwill be assigned to 1â€“24â€“5 and the remaining 25% will be assigned to 1â€“25â€“2. This assignment is deterministic, using consistent hashing. The majority of our upgrade process involves updating rollouts.yml and then monitoring.</p><p>This process allows us to selectively upgrade workloads. We can also upgrade environments separately and ensure that only a certain percentage of those environments are on the new version. This gives us time to bake an upgrade and learn of potential regressions.</p><p>The rest of this post will describe the mechanism through which a change to rollouts.yml is applied to thousands of workloads, for both Kubernetes andÂ VMs.</p><h3>Kubernetes</h3><p>Each Istio revision has a corresponding <a href=\"https://istio.io/latest/docs/setup/additional-setup/sidecar-injection/#automatic-sidecar-injection\">MutatingAdmissionWebhook for sidecar injection</a> on every workload cluster. This webhook selects pods specifying the label istio.io/rev=&lt;revision&gt; and injects the istio-proxy and istio-init containers into those pods. Notably, the istio-proxy container contains the PROXY_CONFIG environment variable, which sets the discoveryAddress to the Istiod revision. This is how the istio-proxyversion and the configuration for which Istiod to connect to are deployed atomicallyâ€Šâ€”â€Šentirely by the sidecar injector.</p><p>Every workloadâ€™s Deployment has this revision label. For example, a workload configured to use Istio 1.24.5 will have the label istio.io/rev=1â€“24â€“5in its pod template; thus pods for that Deployment will be mutated by the MutatingAdmissionWebhook for IstioÂ 1.24.5.</p><p>This setup is the standard method of upgrading Istio, but requires that every Deployment specifies a revision label. To perform an upgrade across thousands of workloads, every team would have to update this label and deploy their workload. We could neither perform a rollback across all workloads nor reasonably expect an upgrade to complete to 100%, both for the same reasonâ€Šâ€”â€Šrelying on every workload toÂ deploy.</p><h4>Krispr</h4><p>To avoid having to update workloads individually, a workloadâ€™s configuration never directly specifies the revision label in source code. Instead, we use <a href=\"https://medium.com/airbnb-engineering/a-krispr-approach-to-kubernetes-infrastructure-a0741cff4e0c\">Krispr, a mutation framework built in-house</a>, to inject the revision label. Krispr gives us the ability to decouple infrastructure component upgrades from workload deployments.</p><p>Airbnb workloads that run on Kubernetes use an internal API to define their workload, instead of specifying Kubernetes manifests. This abstraction is then compiled into Kubernetes manifests during CI. Krispr runs as part of this compilation and mutates those Kubernetes manifests. One of those mutations injects the Istio revision label into the pod specification of each Deployment, reading rollouts.ymlto decide which label to inject. If a team sees any issue with their workload when they deploy, they can roll back and thus also roll back the Istio upgradeâ€Šâ€”â€Šall without involving the Service MeshÂ team.</p><p>In addition, Krispr runs during pod admission. If a pod is being admitted from a Deployment that is more than two weeks old, Krispr will re-mutate the pod and accordingly update the podâ€™s revision label if needed. Combined with the fact that our Kubernetes nodes have a maximum lifetime of two weeks, thus ensuring that any given podâ€™s maximum lifetime is also two weeks, we can guarantee that an Istio upgrade completes. A majority of workloads will be upgraded when they deploy (during the Krispr run in CI) and for those that donâ€™t deploy regularly, the natural pod cycling and re-mutation will ensure they are upgraded in at most fourÂ weeks.</p><p>In summary, per workload:</p><ol><li>During CI, Krispr mutates the Kubernetes manifests of a workload to add the Istio revision label, based on rollouts.yml.</li><li>When a pod is admitted to a cluster, Krispr will re-mutate the pod if its Deployment is more than two weeks old and update the Istio revision label ifÂ needed.</li><li>The revision-specific Istio MutatingAdmissionWebhook will mutate the pod by injecting the sidecar and associated discoveryAddress.</li></ol><h3>Virtual machines</h3><p>On VMs, we deploy an artifact that contains istio-proxy, a script to run istio-iptables (similar to the istio-init container), and the Istiod discoveryAddress. By packaging istio-proxy and the discoveryAddress in the same artifact, we can atomically upgradeÂ both.</p><p>Installation of this artifact is the responsibility of an on-host daemon called mxagent. It determines what version to install by polling a set of key-value tags on the VM (such as <a href=\"https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/Using_Tags.html\">EC2 tags on AWS</a> or <a href=\"https://cloud.google.com/compute/docs/tag-resources\">resource tags on GCP</a>). These tags mimic the istio.io/rev label for Kubernetes-based workloads. Whenever they change, mxagent will download and install the artifact corresponding to that version. Thus, upgrading istio-proxy on a VM just involves updating these tags on that VM; mxagent will take care of theÂ rest.</p><p>Our VM workloads are largely infrastructure platforms that donâ€™t typically have code deployed at regular intervals. As such, VMs donâ€™t support a deploy-time upgrade (in the way that Kubernetes workloads can be upgraded when they deploy). Similarly, teams cannot roll back these workloads themselves, but this has been acceptable, given that there are just a handful of such infrastructure platforms.</p><p>The tag updates are managed by a central controller, mxrc, which scans for outdated VMs. If rollouts.yml would result in a different set of resource tags for a VM, the controller will update the tags accordingly. This roughly corresponds to Krisprâ€™s pod admission-time mutationâ€Šâ€”â€Šhowever, with the caveat that VMs are mutable and long-lived, and thus are upgraded in-place.</p><p>For safety, mxrc takes into account the health of the VM, namely in the form of the <a href=\"https://istio.io/latest/docs/reference/config/networking/workload-group/#ReadinessProbe\">readiness probe status on the WorkloadEntry</a>. Similar to Kubernetesâ€™ maxUnavailable semantics, mxrc aims to keep the number of unavailable VMs (that is, unhealthy VMs plus those with in-progress upgrades) below a defined percentage. It gradually performs these upgrades, aiming to upgrade all the VMs for a workload in twoÂ weeks.</p><p>At the end of two weeks, all VMs will match the desired state in rollouts.yml.</p><h3>Conclusion</h3><p>Keeping up-to-date with open-source software is a challenge, especially at scale. Upgrades and other Day-2 operations often become an afterthought, which furthers the burden when upgrades are eventually necessary (to bring in security patches, remain within support windows, utilize new features, and so forth). This is particularly true with Istio, where a version reaches end-of-life supportÂ rapidly.</p><p>Even with the complexity and scale of our service mesh, we have successfully upgraded Istio 14 times. This was made possible due to designing for maintainability, building a process that ensures zero downtime, and derisking through the use of gradual rollouts. Similar processes are in use for a number of other foundational infrastructure systems atÂ Airbnb.</p><h3>Future work</h3><p>As Airbnbâ€™s infrastructure continues to evolve and grow, weâ€™re looking at a few key projects to evolve our serviceÂ mesh:</p><ul><li>Utilizing <a href=\"https://istio.io/latest/docs/ambient/overview/\">Ambient mode</a> as a more cost-effective and easier-to-manage deployment model of Istio. In particular, this simplifies upgrades by not needing to touch workload deployments atÂ all.</li><li>Splitting our singular production mesh into multiple meshes in order to separate fault domains, provide better security isolation boundaries, and scale Istio further. For upgrades, this would further reduce the blast radius, as some meshes that only run low-risk workloads (such as staging) could be upgradedÂ first.</li></ul><p>If this type of work interests you, we encourage you to apply for an <a href=\"https://careers.airbnb.com/\">open position</a>Â today.</p><h3>Acknowledgements</h3><p>All of our work with Istio is thanks to many different people, including: Jungho Ahn, Stephen Chan, Weibo He, Douglas Jordan, Brian Wolfe, Edie Yang, Dasol Yoon, and YingÂ Zhu.</p><p><em>All product names, logos, and brands are property of their respective owners. All company, product and service names used in this website are for identification purposes only. Use of these names, logos, and brands does not imply endorsement.</em></p><img src=\"https://medium.com/_/stat?event=post.clientViewed&referrerSource=full_rss&postId=bcb0e49c5cf8\" width=\"1\" height=\"1\" alt=\"\"><hr><p><a href=\"https://medium.com/airbnb-engineering/seamless-istio-upgrades-at-scale-bcb0e49c5cf8\">Seamless Istio Upgrades at Scale</a> was originally published in <a href=\"https://medium.com/airbnb-engineering\">The Airbnb Tech Blog</a> on Medium, where people are continuing the conversation by highlighting and responding to this story.</p>"
    },
    {
      "title": "Airbnb åœ¨ Kubernetes ä¸Šé€šè¿‡åˆ†å¸ƒå¼æ•°æ®åº“å®ç°é«˜å¯ç”¨æ€§ (åŸæ ‡é¢˜: Achieving High Availability with distributed database on Kubernetes at Airbnb)",
      "link": "https://medium.com/airbnb-engineering/achieving-high-availability-with-distributed-database-on-kubernetes-at-airbnb-58cc2e9856f4?source=rss----53c7c27702d5---4",
      "pubDate": "Mon, 28 Jul 2025 17:57:46 GMT",
      "isoDate": "2025-07-28T17:57:46.000Z",
      "creator": "Artem Danilov",
      "summary": "## Airbnb åœ¨ Kubernetes ä¸Šå®ç°åˆ†å¸ƒå¼æ•°æ®åº“é«˜å¯ç”¨æ€§\n\n### å¼•è¨€\n\nä¼ ç»Ÿä¸Šï¼Œç»„ç»‡é€šè¿‡åˆ†ç‰‡ç­–ç•¥åœ¨é«˜æˆæœ¬çš„ç‹¬ç«‹æœåŠ¡å™¨ä¸Šéƒ¨ç½²æ•°æ®åº“ä»¥å®ç°æ‰©å±•ã€‚ç„¶è€Œï¼Œéšç€æ•°æ®éœ€æ±‚çš„å¢é•¿ï¼Œè¿™ç§ç­–ç•¥çš„å±€é™æ€§æ—¥ç›Šæ˜æ˜¾ï¼Œç»´æŠ¤é¡¹ç›®å˜å¾—è¶Šæ¥è¶Šé•¿å’Œå¤æ‚ã€‚åˆ†å¸ƒå¼æ¨ªå‘å¯æ‰©å±•æ•°æ®åº“å·²ä¸ç½•è§ï¼Œå…¶ä¸­è®¸å¤šæ˜¯å¼€æºçš„ã€‚ä½†åœ¨äº‘ç¯å¢ƒä¸­ä»¥é«˜å¯ç”¨æ€§ã€ä½å»¶è¿Ÿã€å¯æ‰©å±•æ€§ä¸”æˆæœ¬åˆç†çš„æ–¹å¼å¯é è¿è¡Œè¿™äº›æ•°æ®åº“ï¼Œæ˜¯è®¸å¤šå…¬å¸é¢ä¸´çš„æŒ‘æˆ˜ã€‚\n\nAirbnb é‡‡å–äº†ä¸€ç§åˆ›æ–°ç­–ç•¥ï¼šåœ¨äº‘ç¯å¢ƒä¸­è·¨å¤šä¸ª Kubernetes é›†ç¾¤éƒ¨ç½²åˆ†å¸ƒå¼æ•°æ®åº“é›†ç¾¤ã€‚å°½ç®¡è¿™ç§è®¾è®¡æ¨¡å¼å› å…¶å¤æ‚æ€§ç›®å‰å°šä¸å¸¸è§ï¼Œä½†å®ƒä½¿ Airbnb å®ç°äº†ç›®æ ‡ç³»ç»Ÿå¯é æ€§å’Œå¯æ“ä½œæ€§ã€‚æœ¬æ–‡åˆ†äº«äº† Airbnb å¦‚ä½•å…‹æœæŒ‘æˆ˜å¹¶å¼€å‘å‡ºé€‚ç”¨äºä»»ä½•å¼ºä¸€è‡´æ€§åˆ†å¸ƒå¼å­˜å‚¨ç³»ç»Ÿçš„æœ€ä½³å®è·µã€‚\n\n### åœ¨ Kubernetes ä¸Šç®¡ç†æ•°æ®åº“\n\nAirbnb å°†ä¸€ä¸ªå¼€æºçš„æ¨ªå‘å¯æ‰©å±•åˆ†å¸ƒå¼ SQL æ•°æ®åº“é›†æˆåˆ°å…¶åŸºç¡€è®¾æ–½ä¸­ã€‚è™½ç„¶ Kubernetes æ˜¯è¿è¡Œæ— çŠ¶æ€æœåŠ¡çš„ä¼˜ç§€å·¥å…·ï¼Œä½†å°†å…¶ç”¨äºæ•°æ®åº“ç­‰æœ‰çŠ¶æ€æœåŠ¡å…·æœ‰æŒ‘æˆ˜æ€§ï¼Œå°¤å…¶æ˜¯åœ¨èŠ‚ç‚¹æ›¿æ¢å’Œå‡çº§æ–¹é¢ã€‚\n\n*   **æ•°æ®å¤„ç†æŒ‘æˆ˜**ï¼šKubernetes ç¼ºä¹å¯¹èŠ‚ç‚¹é—´æ•°æ®åˆ†å¸ƒçš„äº†è§£ï¼Œå› æ­¤æ¯æ¬¡èŠ‚ç‚¹æ›¿æ¢éƒ½éœ€è¦ä»”ç»†çš„æ•°æ®å¤„ç†ï¼Œä»¥é˜²æ­¢æ•°æ®ä»²è£ä¸¢å¤±å’ŒæœåŠ¡ä¸­æ–­ï¼ŒåŒ…æ‹¬åœ¨æ›¿æ¢èŠ‚ç‚¹å‰å¤åˆ¶æ•°æ®ã€‚\n*   **å­˜å‚¨è§£å†³æ–¹æ¡ˆ**ï¼šAirbnb é€‰æ‹©ä½¿ç”¨ AWS EBS å°†å­˜å‚¨å·é™„åŠ åˆ°èŠ‚ç‚¹ï¼Œè¿™ä½¿å¾—åœ¨èŠ‚ç‚¹æ›¿æ¢æ—¶å¯ä»¥å¿«é€Ÿå°†å·é‡æ–°é™„åŠ åˆ°æ–°çš„è™šæ‹Ÿæœºã€‚å¾—ç›Šäº Kubernetes çš„æŒä¹…å·å£°æ˜ï¼ˆPVCï¼‰ï¼Œè¿™ç§é‡æ–°é™„åŠ æ˜¯è‡ªåŠ¨å‘ç”Ÿçš„ã€‚\n*   **è‡ªå®šä¹‰æ“ä½œç¬¦**ï¼šä¸ºäº†ç¡®ä¿æ–°çš„å­˜å‚¨èŠ‚ç‚¹æœ‰è¶³å¤Ÿæ—¶é—´èµ¶ä¸Šé›†ç¾¤çš„å½“å‰çŠ¶æ€ï¼ŒAirbnb ä¾èµ–äºè‡ªå®šä¹‰çš„ Kubernetes æ“ä½œç¬¦ï¼ˆk8s operatorï¼‰ï¼Œè¯¥æ“ä½œç¬¦å…è®¸æ ¹æ®åº”ç”¨ç¨‹åºçš„ç‰¹å®šéœ€æ±‚å®šåˆ¶å„ç§ Kubernetes æ“ä½œã€‚\n\n### åè°ƒèŠ‚ç‚¹æ›¿æ¢\n\nèŠ‚ç‚¹æ›¿æ¢çš„åŸå› å¤šç§å¤šæ ·ï¼ŒåŒ…æ‹¬ AWS å®ä¾‹é€€å½¹ã€Kubernetes å‡çº§æˆ–é…ç½®æ›´æ”¹ã€‚Airbnb å°†èŠ‚ç‚¹æ›¿æ¢äº‹ä»¶åˆ†ä¸ºä¸‰ç±»ï¼š\n\n1.  **æ•°æ®åº“å‘èµ·çš„äº‹ä»¶**ï¼šå¦‚é…ç½®æ›´æ”¹æˆ–ç‰ˆæœ¬å‡çº§ã€‚\n2.  **ä¸»åŠ¨åŸºç¡€è®¾æ–½äº‹ä»¶**ï¼šå¦‚å®ä¾‹é€€å½¹æˆ–èŠ‚ç‚¹å‡çº§ã€‚\n3.  **è®¡åˆ’å¤–åŸºç¡€è®¾æ–½æ•…éšœ**ï¼šå¦‚èŠ‚ç‚¹æ— å“åº”ã€‚\n\n*   **å®‰å…¨ç®¡ç†**ï¼š\n    *   å¯¹äºæ•°æ®åº“å‘èµ·çš„äº‹ä»¶ï¼Œk8s-operator ä¸­å®ç°äº†è‡ªå®šä¹‰æ£€æŸ¥ï¼Œä»¥åœ¨åˆ é™¤ä»»ä½• Pod ä¹‹å‰éªŒè¯æ‰€æœ‰èŠ‚ç‚¹æ˜¯å¦æ­£å¸¸è¿è¡Œã€‚\n    *   ä¸ºäº†ä¸åŸºç¡€è®¾æ–½å‘èµ·çš„äº‹ä»¶ä¸²è¡ŒåŒ–ï¼Œåœ¨ Kubernetes ä¸­å®ç°äº†ä¸€ä¸ªå‡†å…¥é’©å­ï¼ˆadmission hookï¼‰ï¼Œç”¨äºæ‹¦æˆª Pod é©±é€ã€‚è¯¥é’©å­æ‹’ç»ä»»ä½•é©±é€ Pod çš„å°è¯•ï¼Œä½†ä¼šåœ¨ Pod ä¸Šåˆ†é…ä¸€ä¸ªè‡ªå®šä¹‰æ³¨è§£ï¼Œè‡ªå®šä¹‰æ•°æ®åº“ k8s-operator ä¼šç›‘å¬å¹¶æ ¹æ®è¯¥æ³¨è§£å®‰å…¨åœ°åˆ é™¤ Podï¼Œä»è€Œä¸ä»»ä½•æ•°æ®åº“å‘èµ·çš„èŠ‚ç‚¹æ›¿æ¢ä¸²è¡ŒåŒ–ã€‚\n    *   å¯¹äºè®¡åˆ’å¤–åŸºç¡€è®¾æ–½æ•…éšœï¼ˆå¦‚ç¡¬ä»¶æ•…éšœï¼‰ï¼Œæ— æ³•åè°ƒã€‚ä½†å¯ä»¥é€šè¿‡ç¡®ä¿åœ¨æ•…éšœç¡¬ä»¶è¢«æ›¿æ¢ä¹‹å‰ï¼Œé˜»æ­¢å‰ä¸¤ç±»äº‹ä»¶çš„ä»»ä½•èŠ‚ç‚¹æ›¿æ¢æ¥æé«˜å¯ç”¨æ€§ã€‚\n*   **k8s æ“ä½œç¬¦çš„ä½œç”¨**ï¼šåœ¨ Airbnb çš„åŸºç¡€è®¾æ–½ä¸­ï¼Œk8s æ“ä½œç¬¦å¤„ç†ä¸»åŠ¨å’ŒåŸºç¡€è®¾æ–½è§¦å‘çš„èŠ‚ç‚¹æ›¿æ¢ï¼Œåœ¨èŠ‚ç‚¹æ›¿æ¢æ—¶ä¿æŒæ•°æ®ä¸€è‡´æ€§ï¼Œå¹¶ç¡®ä¿è®¡åˆ’å¤–äº‹ä»¶ä¸ä¼šå½±å“æ­£åœ¨è¿›è¡Œçš„ç»´æŠ¤ã€‚\n\n### Kubernetes å‡çº§\n\nå®šæœŸçš„ Kubernetes å‡çº§è‡³å…³é‡è¦ï¼Œä½†å¯èƒ½æ˜¯é«˜é£é™©æ“ä½œï¼Œç‰¹åˆ«æ˜¯å¯¹äºæ•°æ®åº“è€Œè¨€ã€‚äº‘æ‰˜ç®¡çš„ Kubernetes åœ¨æ§åˆ¶å¹³é¢å‡çº§åå¯èƒ½ä¸æä¾›å›æ»šåŠŸèƒ½ï¼Œå¦‚æœå‡ºç°é—®é¢˜ï¼Œä¼šå¸¦æ¥æ½œåœ¨çš„ç¾éš¾æ¢å¤æŒ‘æˆ˜ã€‚Airbnb é‡‡ç”¨è‡ªç®¡ç† Kubernetes é›†ç¾¤ï¼Œå…è®¸å›æ»šæ§åˆ¶å¹³é¢ï¼Œä½†ç³Ÿç³•çš„ Kubernetes å‡çº§ä»å¯èƒ½å¯¼è‡´æœåŠ¡ä¸­æ–­ï¼Œç›´åˆ°å›æ»šå®Œæˆã€‚\n\n### é€šè¿‡å¤š Kubernetes é›†ç¾¤ç¡®ä¿å®¹é”™æ€§\n\nAirbnb è®¤ä¸ºå®ç°é«˜åŒºåŸŸå¯ç”¨æ€§çš„æœ€ä½³æ–¹å¼æ˜¯å°†æ¯ä¸ªæ•°æ®åº“éƒ¨ç½²åœ¨ä¸‰ä¸ªç‹¬ç«‹çš„ Kubernetes é›†ç¾¤ä¸­ï¼Œæ¯ä¸ªé›†ç¾¤ä½äºä¸åŒçš„ AWS å¯ç”¨åŒºï¼ˆAZï¼‰ã€‚\n\n*   **éš”ç¦»æ€§**ï¼šAWS å¯ç”¨åŒºä¸ä»…æä¾›ç‹¬ç«‹çš„ç”µæºã€ç½‘ç»œå’Œè¿æ¥ï¼Œè¿˜è¿›è¡Œé€åŒºåŸŸçš„å‘å¸ƒã€‚Kubernetes é›†ç¾¤ä¸ AWS AZ çš„å¯¹é½æ„å‘³ç€ä»»ä½•åº•å±‚åŸºç¡€è®¾æ–½é—®é¢˜æˆ–é”™è¯¯éƒ¨ç½²çš„çˆ†ç‚¸åŠå¾„éƒ½æœ‰é™ï¼Œå› ä¸ºå®ƒä»¬ä»…é™äºå•ä¸ª AZã€‚\n*   **åˆ†é˜¶æ®µéƒ¨ç½²**ï¼šåœ¨å†…éƒ¨ï¼ŒAirbnb è¿˜ä¼šå°†æ–°é…ç½®æˆ–æ–°æ•°æ®åº“ç‰ˆæœ¬é¦–å…ˆéƒ¨ç½²åˆ°ä½äºå•ä¸ª Kubernetes é›†ç¾¤ä¸­ä¸€ä¸ª AZ å†…çš„é€»è¾‘é›†ç¾¤çš„ä¸€éƒ¨åˆ†ã€‚\n*   **å¯ç”¨æ€§æå‡**ï¼šå°½ç®¡è¿™ç§è®¾ç½®å¢åŠ äº†å¤æ‚æ€§ï¼Œä½†å®ƒé€šè¿‡é™åˆ¶æ¥è‡ªæ¯ä¸€å±‚ï¼ˆæ— è®ºæ˜¯æ•°æ®åº“ã€Kubernetes è¿˜æ˜¯ AWS åŸºç¡€è®¾æ–½ï¼‰çš„æ•…éšœéƒ¨ç½²æ‰€å¼•èµ·é—®é¢˜çš„çˆ†ç‚¸åŠå¾„ï¼Œæ˜¾è‘—æé«˜äº†å¯ç”¨æ€§ã€‚\n*   **å¼¹æ€§ç¤ºä¾‹**ï¼šæœ€è¿‘ï¼ŒåŸºç¡€è®¾æ–½ä¸­ä¸€æ¬¡é”™è¯¯çš„é…ç½®éƒ¨ç½²çªç„¶ç»ˆæ­¢äº†æš‚å­˜ Kubernetes é›†ç¾¤ä¸­ç‰¹å®šç±»å‹çš„æ‰€æœ‰è™šæ‹Ÿæœºï¼Œåˆ é™¤äº†å¤§éƒ¨åˆ†æŸ¥è¯¢å±‚ Podã€‚ç„¶è€Œï¼Œç”±äºä¸­æ–­è¢«éš”ç¦»åˆ°å•ä¸ª Kubernetes é›†ç¾¤ï¼Œä¸‰åˆ†ä¹‹äºŒçš„æŸ¥è¯¢å±‚èŠ‚ç‚¹ä¿æŒè¿è¡Œï¼Œä»è€Œé¿å…äº†ä»»ä½•å½±å“ã€‚\n*   **å®¹é‡å†—ä½™**ï¼šAirbnb è¿˜å¯¹æ•°æ®åº“é›†ç¾¤è¿›è¡Œè¿‡é‡é…ç½®ï¼Œä»¥ç¡®ä¿å³ä½¿æ•´ä¸ª AZã€Kubernetes é›†ç¾¤æˆ–åŒºåŸŸå†…çš„æ‰€æœ‰å­˜å‚¨èŠ‚ç‚¹å‘ç”Ÿæ•…éšœï¼Œä»æœ‰è¶³å¤Ÿçš„å®¹é‡æ¥å¤„ç†æµé‡ã€‚\n\n![å›¾ç‰‡ 1](https://cdn-images-1.medium.com/max/1024/0*X2h18kiTtfcbRXQo)\n\n![å›¾ç‰‡ 2](https://cdn-images-1.medium.com/max/1024/0*1hSoKkktPABPkTj)\n\n### åˆ©ç”¨ AWS EBS å®ç°å¯é æ€§å’Œå»¶è¿Ÿå¤„ç†\n\nEBS ä¸º Airbnb çš„éƒ¨ç½²æä¾›äº†ä¸¤ä¸ªå…³é”®ä¼˜åŠ¿ï¼š\n\n1.  **å¿«é€Ÿé‡æ–°é™„åŠ **ï¼šåœ¨èŠ‚ç‚¹æ›¿æ¢æœŸé—´èƒ½å¤Ÿå¿«é€Ÿé‡æ–°é™„åŠ ã€‚\n2.  **å“è¶Šçš„æŒä¹…æ€§**ï¼šä¸æœ¬åœ°ç£ç›˜ç›¸æ¯”å…·æœ‰æ›´å¼ºçš„æŒä¹…æ€§ã€‚\n\n*   **å‰¯æœ¬æ•°é‡**ï¼šå€ŸåŠ© EBSï¼ŒAirbnb ä»…ä½¿ç”¨ä¸‰ä¸ªå‰¯æœ¬å³å¯è‡ªä¿¡åœ°è¿è¡Œé«˜å¯ç”¨é›†ç¾¤ï¼Œæ— éœ€é¢å¤–å†—ä½™å³å¯ä¿æŒå¯é æ€§ã€‚\n*   **å»¶è¿Ÿç¼“è§£**ï¼šEBS å¶å°”ä¼šå‡ºç°å°¾éƒ¨å»¶è¿Ÿå³°å€¼ï¼Œp99 å»¶è¿Ÿå¯èƒ½è¾¾åˆ° 1 ç§’ã€‚ä¸ºç¼“è§£æ­¤é—®é¢˜ï¼ŒAirbnb å®æ–½äº†å­˜å‚¨è¯»å–è¶…æ—¶ä¼šè¯å˜é‡ï¼Œå…è®¸æŸ¥è¯¢åœ¨ EBS å»¶è¿Ÿå³°å€¼æœŸé—´é€æ˜åœ°é‡è¯•å…¶ä»–å­˜å‚¨èŠ‚ç‚¹ã€‚\n    *   **è¯»ç­–ç•¥ä¼˜åŒ–**ï¼šé»˜è®¤æƒ…å†µä¸‹ï¼Œæ‰€ä½¿ç”¨çš„æ•°æ®åº“å°†æ‰€æœ‰è¯·æ±‚å’Œé‡è¯•å‘é€ç»™é¢†å¯¼è€…ã€‚ä¸ºäº†åœ¨ EBS å¥åº·çš„å­˜å‚¨èŠ‚ç‚¹ä¸Šå¯ç”¨é‡è¯•ï¼Œå¿…é¡»å…è®¸ä»é¢†å¯¼è€…å’Œå‰¯æœ¬è¿›è¡Œè¯»å–ï¼Œä½†åŸå§‹è¯·æ±‚ä¼˜å…ˆé€‰æ‹©æœ€è¿‘çš„å‰¯æœ¬ã€‚è¿™å¸¦æ¥äº†é™ä½å»¶è¿Ÿå’Œé¿å…è·¨ AZ ç½‘ç»œæˆæœ¬çš„é¢å¤–å¥½å¤„ï¼Œå› ä¸ºæ¯ä¸ª AZ éƒ½æœ‰ä¸€ä¸ªå‰¯æœ¬ã€‚\n    *   **é™ˆæ—§è¯»å–**ï¼šå¯¹äºå…è®¸çš„ç”¨ä¾‹ï¼Œåˆ©ç”¨é™ˆæ—§è¯»å–åŠŸèƒ½ï¼Œä½¿å‰¯æœ¬èƒ½å¤Ÿç‹¬ç«‹æä¾›è¯»å–æœåŠ¡ï¼Œè€Œæ— éœ€å¯¹é¢†å¯¼è€…è¿›è¡ŒåŒæ­¥è°ƒç”¨ï¼ˆé¢†å¯¼è€…å¯èƒ½åœ¨è¯»å–æ—¶é‡åˆ° EBS å»¶è¿Ÿå³°å€¼ï¼‰ã€‚\n\n### ç»“è®ºï¼šæ¢ç´¢ Kubernetes ä¸Šçš„å¼€æºæ•°æ®åº“\n\nAirbnb åœ¨ Kubernetes ä¸Šè¿è¡Œåˆ†å¸ƒå¼æ•°æ®åº“çš„å®è·µä½¿å…¶å®ç°äº†é«˜å¯ç”¨æ€§ã€ä½å»¶è¿Ÿã€å¯æ‰©å±•æ€§å’Œæ›´ä½çš„ç»´æŠ¤æˆæœ¬ã€‚é€šè¿‡åˆ©ç”¨æ“ä½œç¬¦æ¨¡å¼ã€å¤šé›†ç¾¤éƒ¨ç½²ã€AWS EBS å’Œé™ˆæ—§è¯»å–ï¼ŒAirbnb è¯æ˜äº†å³ä½¿æ˜¯å¼€æºåˆ†å¸ƒå¼å­˜å‚¨ç³»ç»Ÿä¹Ÿèƒ½åœ¨äº‘ç¯å¢ƒä¸­è“¬å‹ƒå‘å±•ã€‚\n\nAirbnb å·²åœ¨ç”Ÿäº§ç¯å¢ƒä¸­è¿è¡Œå¤šä¸ªæ•°æ®åº“é›†ç¾¤ï¼Œå…¶ä¸­æœ€å¤§çš„ä¸€ä¸ªé›†ç¾¤åœ¨ 150 ä¸ªå­˜å‚¨èŠ‚ç‚¹ä¸Šå¤„ç† 300 ä¸‡ QPSï¼Œå­˜å‚¨è¶…è¿‡ 300TB æ•°æ®ï¼Œåˆ†å¸ƒåœ¨ 400 ä¸‡ä¸ªå†…éƒ¨åˆ†ç‰‡ä¸­ã€‚å¾—ç›Šäºæœ¬æ–‡æè¿°çš„æŠ€æœ¯ï¼Œæ‰€æœ‰è¿™äº›éƒ½å®ç°äº† 99.95% çš„å¯ç”¨æ€§ã€‚\n\nå¯¹äºå…¶ä»–è€ƒè™‘åœ¨ Kubernetes ä¸Šè¿è¡Œå¼€æºæ•°æ®åº“çš„å…¬å¸æ¥è¯´ï¼Œæœºé‡æ˜¯å·¨å¤§çš„ã€‚æ‹¥æŠ±æŒ‘æˆ˜ï¼Œè¿è¡Œå¼€æºæ•°æ®åº“ä»¥å¡‘é€ è¿™äº›å·¥å…·ä»¥ä¾›ä¼ä¸šä½¿ç”¨ã€‚äº‘ä¸­å¯æ‰©å±•ã€å¯é æ•°æ®ç®¡ç†çš„æœªæ¥åœ¨äºåä½œå’Œå¼€æºåˆ›æ–°ã€‚",
      "shortSummary": "Airbnb é€šè¿‡åœ¨å¤šä¸ª AWS å¯ç”¨åŒºå†…çš„ Kubernetes é›†ç¾¤ä¸Šéƒ¨ç½²åˆ†å¸ƒå¼æ•°æ®åº“ï¼Œå®ç°äº†é«˜å¯ç”¨æ€§ã€‚ä»–ä»¬åˆ©ç”¨è‡ªå®šä¹‰ Kubernetes æ“ä½œç¬¦ã€AWS EBS è¿›è¡Œå­˜å‚¨å’Œå¯é æ€§ï¼Œå¹¶åè°ƒèŠ‚ç‚¹æ›¿æ¢ï¼Œä»¥ç¡®ä¿æ•°æ®ä¸€è‡´æ€§å’Œæ•…éšœå®¹é”™ã€‚è¿™ç§ç­–ç•¥ä½¿ Airbnb çš„ç”Ÿäº§æ•°æ®åº“å®ç°äº† 99.95% çš„å¯ç”¨æ€§ã€ä½å»¶è¿Ÿã€é«˜å¯æ‰©å±•æ€§åŠæ›´ä½çš„ç»´æŠ¤æˆæœ¬ï¼Œè¯æ˜äº†å¼€æºåˆ†å¸ƒå¼å­˜å‚¨ç³»ç»Ÿåœ¨äº‘ç¯å¢ƒä¸­çš„å¯è¡Œæ€§ã€‚",
      "translated_title": "Airbnb åœ¨ Kubernetes ä¸Šé€šè¿‡åˆ†å¸ƒå¼æ•°æ®åº“å®ç°é«˜å¯ç”¨æ€§",
      "images": [
        {
          "url": "https://cdn-images-1.medium.com/max/1024/0*X2h18kiTtfcbRXQo",
          "alt": "",
          "title": "",
          "position": 1
        },
        {
          "url": "https://cdn-images-1.medium.com/max/1024/0*1hSoKkktmPABPkTj",
          "alt": "",
          "title": "",
          "position": 2
        },
        {
          "url": "https://medium.com/_/stat?event=post.clientViewed&referrerSource=full_rss&postId=58cc2e9856f4",
          "alt": "",
          "title": "",
          "position": 3
        }
      ],
      "contentSource": "RSS",
      "content": "<figure><img alt=\"\" src=\"https://cdn-images-1.medium.com/max/1024/0*X2h18kiTtfcbRXQo\" /></figure><h3>Introduction</h3><p>Traditionally, organizations have deployed databases on costly, high-end standalone servers using sharding for scaling as a strategy. As data demands grew, the limitations of this strategy became increasingly evident with increasingly longer and more complex maintenance projects.</p><p>Increasingly distributed horizontally scalable databases are not uncommon and many of them are open source. However, running these databases reliably in the cloud with high availability, low latency and scalability, all at a reasonable cost is a problem many companies are trying toÂ solve.</p><p>We chose an innovative strategy of deploying<strong> a distributed database cluster across multiple Kubernetes clusters in a cloud environment</strong>. Although currently an uncommon design pattern due to its complexity, this strategy allowed us to achieve target system reliability and operability.</p><p>In this post, weâ€™ll share how we overcame challenges and the best practices weâ€™ve developed for this strategy and we believe these best practices should be applicable to any other strongly consistent, distributed storageÂ systems.</p><h3>Managing Databases on Kubernetes</h3><p>Earlier this year, we integrated an open source horizontally scalable, distributed SQL database into our infrastructure.</p><p>While Kubernetes is a great tool for running stateless services, the use of Kubernetes for stateful servicesâ€Šâ€”â€Šlike databasesâ€Šâ€”â€Šis challenging, particularly around node replacement and upgrades.</p><p>Since Kubernetes lacks knowledge of data distribution across nodes, each node replacement requires careful data handling to prevent data quorum loss and service disruption, this includes copying the data before replacing aÂ node.</p><p>At Airbnb, we opted to attach storage volumes to nodes using AWS EBS, this allows quick volume reattachment to new virtual machines upon node replacement. Thanks to Kubernetesâ€™ Persistent Volume Claims (<a href=\"https://kubernetes.io/docs/concepts/storage/persistent-volumes/#binding\">PVC</a>), this reattachment happens automatically. In addition we need to allow time for a new storage node to catch up with the clusterâ€™s current state before moving to the next node replacement. For this, we rely on the custom <a href=\"https://kubernetes.io/docs/concepts/extend-kubernetes/operator/\">k8s operator</a><a href=\"https://github.com/pingcap/tidb-operator\">,</a> which allows us to customize various Kubernetes operations according to specifics of the application.</p><h3>Coordinating Node Replacement</h3><p>Node replacements occur for various reasons, from <a href=\"https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/instance-retirement.html\">AWS instance retirement</a> to Kubernetes upgrades or configuration changes. To address these cases, we categorize node replacement events into threeÂ groups:</p><ol><li><strong>Database-initiated events:</strong> Such as config changes or version upgrades.</li><li><strong>Proactive infrastructure events:</strong> Like instance retirements or node upgrades.</li><li><strong>Unplanned infrastructure failures:</strong> Such as a node becoming unresponsive.</li></ol><p>To safely manage node replacements for database-initiated events, we implemented a a custom check in the k8s-operator that verifies that all nodes are up and running before deleting anyÂ pod.</p><p>In order to serialize it with the second group initiated by infrastructure, we implemented <a href=\"https://kubernetes.io/docs/reference/access-authn-authz/extensible-admission-controllers/\">an admission hook</a> in k8s to intercept pod eviction. This admission hook rejects any attempt to evict the pod, but assigns a custom annotation on the pod which our customer database k8s-operator watches and acts on to safely delete the pod serializing it with any database-initiated node replacements described above.</p><p>Node replacements due to unplanned infrastructure failure events like hardware failure, canâ€™t be coordinated. But we can still improve availability by ensuring that any node replacement event from the first two groups will be blocked until the failed hardware is replaced.</p><p>In our infrastructure the k8s operator handles both proactive and infrastructure-triggered node replacements, maintaining data consistency in the presence of node replacements and ensuring that unplanned events donâ€™t impact ongoing maintenance.</p><h3>Kubernetes Upgrades</h3><p>Regular Kubernetes upgrades are essential but can be high-risk operations, especially for databases. Cloud managed Kubernetes might not offer rollbacks once the control plane is upgraded, posing a potential disaster recovery challenge if something goes wrong. While our approach involves using self-managed Kubernetes clusters, which does allow rolling back the control plane, a bad Kubernetes upgrade could still cause service disruption till rollback is completed.</p><h3>Ensuring Fault Tolerance with Multiple Kubernetes clusters</h3><p>At Airbnb, we think the best way to achieve high regional availability is to deploy each database across three independent Kubernetes clusters, each within a different AWS availability zone (<a href=\"https://docs.aws.amazon.com/whitepapers/latest/aws-fault-isolation-boundaries/availability-zones.htm\">AZ</a>). AWS uses availability zones not just for independent power, networking, and connectivity, but they also do rollouts zone by zone. Our Kubernetes cluster alignment with AWS AZ also means that any underlying infrastructure issues or bad deployments have a limited blast radius as they are restricted to a single AZ. Internally, we also deploy a new configuration or a new database version to a part of the logical cluster running in a single Kubernetes cluster in one AZÂ first.</p><p>While this setup adds complexity, it significantly boosts availability by limiting the blast radius of any issues stemming from faulty deployments at every layerâ€Šâ€”â€Šwhether database, Kubernetes, or AWS infrastructure.</p><p>For instance, recently, a faulty config deployment in our infrastructure abruptly terminated all VMs of a specific type in our staging Kubernetes cluster, deleting most of the query layer pods. However, since the disruption was isolated to a single Kubernetes cluster, two-thirds of our query layer nodes remained operational, preventing anyÂ impact.</p><p>We also overprovision our database clusters to ensure that, even if an entire AZ, Kubernetes cluster, or all storage nodes within a zone goes down, we still have sufficient capacity to handleÂ traffic.</p><figure><img alt=\"\" src=\"https://cdn-images-1.medium.com/max/1024/0*1hSoKkktmPABPkTj\" /></figure><h3>Leveraging AWS EBS for Reliability and LatencyÂ Handling</h3><p>EBS offers two key benefits for our deployment: rapid reattachment during node replacements and superior durability compared to local disks. With EBS, we confidently run a highly available cluster using only three replicas, maintaining reliability without needing additional redundancy.</p><p>However, EBS can occasionally experience tail latency spikes, with p99 latency reaching up to 1 second. To mitigate this, we implemented a storage read timeout session variable, allowing queries to transparently retry against other storage nodes during EBS latency spikes. By default the database we use sends all requests and retries to the leader. To enable retries on storage nodes with healthy EBS, we have to allow reads from both leader and replica reads, but prefer the closest one for the original request. This brings the added benefit of reduced latency and no cross-AZ network costs, as we have a replica in each AZ. Finally, for use cases that permit it, we leverage stale reads feature, enabling reads to be served independently by the replica without requiring synchronous calls to the leader, which may be experiencing an EBS latency spike at the time of theÂ read.</p><h3>Conclusion: Exploring Open Source Databases on Kubernetes</h3><p>Our journey running a distributed database on Kubernetes has empowered us to achieve high availability, low latency, scalability, and lower maintenance costs. By leveraging the operator pattern, multi-cluster deployments, AWS EBS, and stale reads, weâ€™ve demonstrated that even open source distributed storage systems can thrive in cloud environments.</p><p>We already operate several database clusters in production in the described setup, with the largest one handling 3M QPS across 150 storage nodes, storing over 300+ TB of data spread across 4M internal shards. All this with 99.95% availability thanks to techniques described in thisÂ post.</p><p>For other companies considering to run open-source databases on Kubernetes, the opportunities are immense. Embrace the challenge, run open-source databases to shape these tools for enterprise use. The future of scalable, reliable data management in the cloud lies in collaboration and open-source innovationâ€Šâ€”â€Šnow is the time to lead and participate.</p><h3>Acknowledgments</h3><p>Thanks to Abhishek Parmar, Brian Wolfe, Chen Ding, Daniel Low, Hao Luo, Xiaomou Wang for collaboration and Shylaja Ramachandra forÂ editing.</p><img src=\"https://medium.com/_/stat?event=post.clientViewed&referrerSource=full_rss&postId=58cc2e9856f4\" width=\"1\" height=\"1\" alt=\"\"><hr><p><a href=\"https://medium.com/airbnb-engineering/achieving-high-availability-with-distributed-database-on-kubernetes-at-airbnb-58cc2e9856f4\">Achieving High Availability with distributed database on Kubernetes at Airbnb</a> was originally published in <a href=\"https://medium.com/airbnb-engineering\">The Airbnb Tech Blog</a> on Medium, where people are continuing the conversation by highlighting and responding to this story.</p>"
    },
    {
      "title": "ç†è§£å’Œæ”¹è¿› SwiftUI æ€§èƒ½ (åŸæ ‡é¢˜: Understanding and Improving SwiftUI Performance)",
      "link": "https://medium.com/airbnb-engineering/understanding-and-improving-swiftui-performance-37b77ac61896?source=rss----53c7c27702d5---4",
      "pubDate": "Tue, 24 Jun 2025 16:43:07 GMT",
      "isoDate": "2025-06-24T16:43:07.000Z",
      "creator": "Cal Stephens",
      "summary": "## ç†è§£å’Œæ”¹è¿› SwiftUI æ€§èƒ½\n\n### å¼•è¨€\n\nAirbnb è‡ª2022å¹´èµ·é‡‡ç”¨ SwiftUIï¼Œæ˜¾è‘—æå‡äº†å·¥ç¨‹å¸ˆçš„ç”Ÿäº§åŠ›ã€‚ç„¶è€Œï¼Œå¤§è§„æ¨¡åº”ç”¨ SwiftUI ä¹Ÿå¸¦æ¥äº†æ€§èƒ½æŒ‘æˆ˜ï¼Œä¾‹å¦‚å¸¸è§çš„ä½æ•ˆä»£ç æ¨¡å¼å’Œç´¯ç§¯çš„æ€§èƒ½æŸè€—ã€‚ä¸ºè§£å†³è¿™äº›é—®é¢˜ï¼ŒAirbnb å¼€å‘äº†æ–°çš„å·¥å…·ï¼Œç”¨äºä¸»åŠ¨è¯†åˆ«å’Œé™æ€éªŒè¯ä»£ç çš„æ­£ç¡®æ€§ã€‚\n\n### Airbnb çš„ SwiftUI åŠŸèƒ½æ¶æ„\n\nAirbnb å¤šå¹´æ¥ä¸€ç›´ä½¿ç”¨åŸºäº UIKit çš„ Epoxy åº“å’Œå•å‘æ•°æ®æµç³»ç»Ÿã€‚åœ¨ SwiftUI å±å¹•å±‚ä¸­ï¼Œä»–ä»¬é€‰æ‹©ç»§ç»­æ²¿ç”¨ç°æœ‰çš„å•å‘æ•°æ®æµåº“ï¼Œè¿™ç®€åŒ–äº†åœ¨å¤§å‹ä»£ç åº“ä¸­é€æ­¥é‡‡ç”¨ SwiftUI çš„è¿‡ç¨‹ï¼Œå¹¶æé«˜äº†åŠŸèƒ½è´¨é‡å’Œå¯ç»´æŠ¤æ€§ã€‚ç„¶è€Œï¼Œä»–ä»¬å‘ç°ä½¿ç”¨è¯¥åº“çš„ SwiftUI åŠŸèƒ½æ€§èƒ½æœªè¾¾é¢„æœŸï¼Œä¸”é—®é¢˜åŸå› å¹¶ä¸æ˜æ˜¾ã€‚\n\n### ç†è§£ SwiftUI è§†å›¾å·®å¼‚åŒ–ï¼ˆDiffingï¼‰\n\nåœ¨ SwiftUI ç­‰å£°æ˜å¼ UI ç³»ç»Ÿä¸­ï¼Œç¡®ä¿æ¡†æ¶çŸ¥é“ä½•æ—¶éœ€è¦é‡æ–°è¯„ä¼°å’Œé‡æ–°æ¸²æŸ“è§†å›¾è‡³å…³é‡è¦ã€‚å½“çˆ¶è§†å›¾æ›´æ–°æ—¶ï¼ŒSwiftUI é€šè¿‡æ¯”è¾ƒè§†å›¾çš„å­˜å‚¨å±æ€§æ¥æ£€æµ‹å˜åŒ–ã€‚ç†æƒ³æƒ…å†µä¸‹ï¼Œè§†å›¾çš„ `body` ä»…åœ¨å…¶å±æ€§å®é™…æ”¹å˜æ—¶æ‰ä¼šè¢«é‡æ–°è¯„ä¼°ã€‚\n\n![å›¾ç‰‡ 1](https://cdn-images-1.medium.com/max/1024/1*qBYJ9abMpZyuODmbHkYD5Q.jpeg)\n\n![å›¾ç‰‡ 2: ç†æƒ³çš„è§†å›¾é‡æ–°è¯„ä¼°æµç¨‹](https://cdn-images-1.medium.com/max/1024/1*LvNBJSor0RDThlW3Oq7mWw.png)\n\nç„¶è€Œï¼Œå®é™…æƒ…å†µå¹¶éæ€»æ˜¯å¦‚æ­¤ï¼Œä¸å¿…è¦çš„è§†å›¾ `body` è¯„ä¼°ä¼šå› æ‰§è¡Œä¸å¿…è¦çš„å·¥ä½œè€ŒæŸå®³æ€§èƒ½ã€‚ä¸ºäº†å¯è§†åŒ–è§†å›¾ `body` åœ¨å®é™…åº”ç”¨ä¸­è¢«é‡æ–°è¯„ä¼°çš„é¢‘ç‡ï¼ŒAirbnb ä½¿ç”¨äº†ä¸€ä¸ªä¿®é¥°ç¬¦ï¼Œæ¯æ¬¡æ¸²æŸ“æ—¶ç»™è§†å›¾åº”ç”¨ä¸€ä¸ªéšæœºé¢œè‰²ã€‚æµ‹è¯•å‘ç°ï¼Œè®¸å¤šè§†å›¾è¢«ä¸å¿…è¦åœ°é‡æ–°è¯„ä¼°å’Œé‡æ–°æ¸²æŸ“ã€‚\n\n![å›¾ç‰‡ 3: ä¸å¿…è¦çš„è§†å›¾é‡æ–°è¯„ä¼°ç¤ºä¾‹](https://cdn-images-1.medium.com/max/1024/1*yNrr8e8yI9RcKg6Z-VUhEA.gif)\n\n### SwiftUI è§†å›¾å·®å¼‚åŒ–ç®—æ³•\n\nSwiftUI å†…ç½®çš„å·®å¼‚åŒ–ç®—æ³•è™½ç„¶æœªæ­£å¼æ–‡æ¡£åŒ–ï¼Œä½†å¯¹æ€§èƒ½å½±å“å·¨å¤§ã€‚å®ƒä½¿ç”¨åŸºäºåå°„çš„ç®—æ³•æ¥æ¯”è¾ƒè§†å›¾çš„æ¯ä¸ªå­˜å‚¨å±æ€§ï¼š\n\n*   **`Equatable` ç±»å‹ï¼š** SwiftUI ä½¿ç”¨å…¶ `Equatable` ä¸€è‡´æ€§æ¯”è¾ƒæ–°æ—§å€¼ã€‚\n*   **å€¼ç±»å‹ï¼ˆå¦‚ç»“æ„ä½“ï¼‰ï¼š** é€’å½’æ¯”è¾ƒæ¯ä¸ªå®ä¾‹å±æ€§ã€‚\n*   **å¼•ç”¨ç±»å‹ï¼ˆå¦‚ç±»ï¼‰ï¼š** ä½¿ç”¨å¼•ç”¨æ ‡è¯†è¿›è¡Œæ¯”è¾ƒã€‚\n*   **é—­åŒ…ï¼š** å°è¯•æŒ‰æ ‡è¯†æ¯”è¾ƒï¼Œä½†å¤§å¤šæ•°éç®€å•é—­åŒ…æ— æ³•å¯é æ¯”è¾ƒã€‚\n\nå¦‚æœè§†å›¾çš„æ‰€æœ‰å±æ€§ä¸å‰ä¸€ä¸ªå€¼æ¯”è¾ƒåéƒ½ç›¸ç­‰ï¼Œåˆ™ `body` ä¸ä¼šè¢«é‡æ–°è¯„ä¼°ï¼Œå†…å®¹ä¹Ÿä¸ä¼šé‡æ–°æ¸²æŸ“ã€‚ä½¿ç”¨ `@State` å’Œ `@Environment` ç­‰ SwiftUI å±æ€§åŒ…è£…å™¨ä¿®é¥°çš„å€¼ä¸å‚ä¸æ­¤å·®å¼‚åŒ–ç®—æ³•ï¼Œè€Œæ˜¯é€šè¿‡å…¶ä»–æœºåˆ¶è§¦å‘è§†å›¾æ›´æ–°ã€‚\n\nAirbnb åœ¨å…¶ä»£ç åº“ä¸­å‘ç°äº†å‡ ç§å¸¸è§çš„æ¨¡å¼ä¼šæ··æ·† SwiftUI çš„å·®å¼‚åŒ–ç®—æ³•ï¼š\n\n*   **é—­åŒ…ï¼š** æŸäº›ç±»å‹ï¼ˆå¦‚é—­åŒ…ï¼‰æœ¬è´¨ä¸Šä¸å—æ”¯æŒï¼Œå‡ ä¹æ€»æ˜¯æ¯”è¾ƒä¸ºä¸ç›¸ç­‰ï¼Œå¯¼è‡´ä¸å¿…è¦çš„ `body` è¯„ä¼°ã€‚\n*   **ç®€å•æ•°æ®ç±»å‹ï¼š** å­˜å‚¨åœ¨è§†å›¾ä¸Šçš„ç®€å•æ•°æ®ç±»å‹å¯èƒ½æ„å¤–åœ°æŒ‰å¼•ç”¨è€Œéå€¼è¿›è¡Œæ¯”è¾ƒï¼Œä¾‹å¦‚åŒ…è£…äº†å†…éƒ¨å¼•ç”¨ç±»å‹çš„å†™æ—¶å¤åˆ¶ï¼ˆcopy-on-writeï¼‰ç»“æ„ä½“ã€‚\n\nå¦‚æœè§†å›¾åŒ…å«ä»»ä½•ä¸å¯å·®å¼‚åŒ–çš„å€¼ï¼Œæ•´ä¸ªè§†å›¾å°†å˜å¾—ä¸å¯å·®å¼‚åŒ–ã€‚è¿™æ­ç¤ºäº† Airbnb å•å‘æ•°æ®æµåº“çš„æ€§èƒ½é—®é¢˜ï¼šå…¶åŠ¨ä½œå¤„ç†æ˜¯åŸºäºé—­åŒ…çš„ï¼Œè€Œ SwiftUI æ— æ³•å·®å¼‚åŒ–é—­åŒ…ã€‚åœ¨è®¸å¤šæƒ…å†µä¸‹ï¼Œä½¿å€¼å¯å·®å¼‚åŒ–éœ€è¦å¤§é‡ä¾µå…¥æ€§ä¸”å¯èƒ½ä¸ç†æƒ³çš„æ¶æ„æ›´æ”¹ï¼Œä¸”éš¾ä»¥é˜²æ­¢åç»­å›å½’ã€‚\n\n### æ§åˆ¶ SwiftUI è§†å›¾å·®å¼‚åŒ–\n\nå¹¸è¿çš„æ˜¯ï¼Œæœ‰å¦ä¸€ç§é€‰æ‹©ï¼šå¦‚æœè§†å›¾éµå¾ª `Equatable` åè®®ï¼ŒSwiftUI å°†ä½¿ç”¨å…¶ `Equatable` ä¸€è‡´æ€§è¿›è¡Œå·®å¼‚åŒ–ï¼Œè€Œéé»˜è®¤çš„åŸºäºåå°„çš„ç®—æ³•ã€‚è¿™å…è®¸å¼€å‘è€…é€‰æ‹©æ€§åœ°å†³å®šå“ªäº›å±æ€§åº”å‚ä¸æ¯”è¾ƒã€‚ä¾‹å¦‚ï¼Œå¯¹äºåŠ¨ä½œå¤„ç†ç¨‹åºï¼Œå¦‚æœå®ƒä¸å½±å“è§†å›¾å†…å®¹æˆ–æ ‡è¯†ï¼Œåˆ™å¯ä»¥å°†å…¶æ’é™¤åœ¨ `Equatable` æ¯”è¾ƒä¹‹å¤–ã€‚\n\nç„¶è€Œï¼Œæ‰‹åŠ¨ç¼–å†™å’Œç»´æŠ¤ `Equatable` ä¸€è‡´æ€§ä¼šå¸¦æ¥å¤§é‡æ ·æ¿ä»£ç ï¼Œä¸”å®¹æ˜“å‡ºé”™ï¼ˆä¾‹å¦‚ï¼Œæ·»åŠ æ–°å±æ€§æ—¶å¿˜è®°æ›´æ–° `Equatable`ï¼‰ã€‚\n\nä¸ºæ­¤ï¼ŒAirbnb åˆ›å»ºäº†ä¸€ä¸ªæ–°çš„ **`@Equatable` å®**ï¼Œè‡ªåŠ¨ç”Ÿæˆ `Equatable` ä¸€è‡´æ€§ã€‚è¯¥å®ä¼šæ¯”è¾ƒè§†å›¾çš„æ‰€æœ‰å­˜å‚¨å®ä¾‹å±æ€§ï¼ˆæ’é™¤ `@State` å’Œ `@Environment` ç­‰å±æ€§åŒ…è£…å™¨ï¼‰ã€‚ä¸å½±å“è§†å›¾ `body` è¾“å‡ºä¸”ä¸å¯ `Equatable` çš„å±æ€§å¯ä»¥ä½¿ç”¨ `@SkipEquatable` æ ‡è®°ï¼Œå°†å…¶æ’é™¤åœ¨ç”Ÿæˆçš„å®ç°ä¹‹å¤–ã€‚è¿™ä½¿å¾— Airbnb å¯ä»¥ç»§ç»­ä½¿ç”¨åŸºäºé—­åŒ…çš„åŠ¨ä½œå¤„ç†ç¨‹åºï¼Œè€Œä¸ä¼šå½±å“ SwiftUI çš„å·®å¼‚åŒ–è¿‡ç¨‹ã€‚\n\né‡‡ç”¨ `@Equatable` å®åï¼Œè§†å›¾ä¿è¯å¯å·®å¼‚åŒ–ã€‚å¦‚æœå·¥ç¨‹å¸ˆåç»­æ·»åŠ äº†ä¸å¯ `Equatable` çš„å±æ€§ï¼Œæ„å»ºå°†å¤±è´¥ï¼Œä»è€Œçªå‡ºæ½œåœ¨çš„å·®å¼‚åŒ–è¡Œä¸ºå›å½’ã€‚è¿™ä½¿å¾— `@Equatable` å®æˆä¸ºä¸€ä¸ªå¤æ‚çš„ä»£ç æ£€æŸ¥å·¥å…·ï¼ˆlinterï¼‰ï¼Œå¯¹äºåœ¨å¤§è§„æ¨¡ä»£ç åº“ä¸­æ‰©å±•æ€§èƒ½æ”¹è¿›éå¸¸æœ‰ä»·å€¼ã€‚\n\n### ç®¡ç†è§†å›¾ä½“ï¼ˆView Bodyï¼‰å¤§å°\n\nSwiftUI å·®å¼‚åŒ–çš„å¦ä¸€ä¸ªé‡è¦æ–¹é¢æ˜¯ç†è§£ SwiftUI åªèƒ½å·®å¼‚åŒ–çœŸæ­£çš„ `View` ç»“æ„ä½“ã€‚ä»»ä½•å…¶ä»–ä»£ç ï¼Œä¾‹å¦‚è®¡ç®—å±æ€§æˆ–ç”Ÿæˆ SwiftUI è§†å›¾çš„è¾…åŠ©å‡½æ•°ï¼Œéƒ½æ— æ³•è¢«å·®å¼‚åŒ–ã€‚\n\nä¾‹å¦‚ï¼Œå°†å¤æ‚çš„è§†å›¾ `body` æ‹†åˆ†ä¸ºå•ç‹¬çš„è®¡ç®—å±æ€§ï¼ˆå¦‚ `headerSection` å’Œ `actionCardSection`ï¼‰æ˜¯å¸¸è§çš„ç»„ç»‡æ–¹å¼ï¼Œä½†è¿è¡Œæ—¶ SwiftUI ä¼šå°†è¿™äº›è§†å›¾å†…è”åˆ°ä¸»è§†å›¾ `body` ä¸­ã€‚è¿™æ„å‘³ç€ï¼Œå½“å±å¹•çš„ä»»ä½•éƒ¨åˆ†çŠ¶æ€æ”¹å˜æ—¶ï¼Œæ•´ä¸ªè§†å›¾ `body` éƒ½ä¼šè¢«é‡æ–°è¯„ä¼°ï¼Œéšç€è§†å›¾å˜å¾—æ›´å¤§æ›´å¤æ‚ï¼Œè¿™å°†å¯¼è‡´å¤§é‡çš„éå¿…è¦å·¥ä½œï¼ŒæŸå®³æ€§èƒ½ã€‚\n\nä¸ºæé«˜æ€§èƒ½ï¼Œåº”å°†å¸ƒå±€ä»£ç å®ç°ä¸ºç‹¬ç«‹çš„ SwiftUI è§†å›¾ã€‚è¿™å…è®¸ SwiftUI æ­£ç¡®å·®å¼‚åŒ–æ¯ä¸ªå­è§†å›¾ï¼Œä»…åœ¨å¿…è¦æ—¶é‡æ–°è¯„ä¼°å…¶ `body`ã€‚ä¾‹å¦‚ï¼Œå°† `MyScreen` æ‹†åˆ†ä¸ºç‹¬ç«‹çš„ `HeaderSection` å’Œ `CardSection` è§†å›¾ï¼Œå¹¶ä¸ºå®ƒä»¬åº”ç”¨ `@Equatable`ï¼Œå¯ä»¥ç¡®ä¿ `HeaderSection` ä»…åœ¨ `title` æ”¹å˜æ—¶é‡æ–°è¯„ä¼°ï¼Œè€Œ `CardSection` ä»…åœ¨ `isCardSelected` æ”¹å˜æ—¶é‡æ–°è¯„ä¼°ã€‚é€šè¿‡å°†è§†å›¾åˆ†è§£ä¸ºæ›´å°ã€å¯å·®å¼‚åŒ–çš„éƒ¨åˆ†ï¼ŒSwiftUI å¯ä»¥é«˜æ•ˆåœ°ä»…æ›´æ–°å®é™…æ”¹å˜çš„éƒ¨åˆ†ã€‚\n\n### è§†å›¾ä½“å¤æ‚åº¦ Lint è§„åˆ™\n\nå¤§å‹ã€å¤æ‚çš„è§†å›¾åœ¨å¼€å‘è¿‡ç¨‹ä¸­å¹¶ä¸æ€»æ˜¯æ˜¾è€Œæ˜“è§çš„ã€‚ä¸ºäº†å¸®åŠ©å·¥ç¨‹å¸ˆäº†è§£ä½•æ—¶éœ€è¦å°†è§†å›¾é‡æ„ä¸ºæ›´å°ã€å¯å·®å¼‚åŒ–çš„éƒ¨åˆ†ï¼ŒAirbnb åˆ›å»ºäº†ä¸€ä¸ªè‡ªå®šä¹‰çš„ SwiftLint è§„åˆ™ã€‚è¯¥è§„åˆ™ä½¿ç”¨ SwiftSyntax è§£æè§†å›¾ `body` å¹¶æµ‹é‡å…¶å¤æ‚åº¦ã€‚å¤æ‚åº¦æŒ‡æ ‡å®šä¹‰ä¸ºæ¯æ¬¡ä½¿ç”¨è®¡ç®—å±æ€§ã€å‡½æ•°æˆ–é—­åŒ…ç»„åˆè§†å›¾æ—¶å¢åŠ çš„å€¼ã€‚å½“è§†å›¾å¤æ‚åº¦è¶…è¿‡å¯é…ç½®çš„é™åˆ¶ï¼ˆç›®å‰ä¸º10ï¼‰æ—¶ï¼Œè¯¥è§„åˆ™ä¼šåœ¨ Xcode ä¸­è‡ªåŠ¨è§¦å‘è­¦å‘Šã€‚\n\n![å›¾ç‰‡ 4: SwiftLint è§†å›¾å¤æ‚åº¦è­¦å‘Šç¤ºä¾‹](https://cdn-images-1.medium.com/max/1024/1*Tdo1L8qZf81FWFeJaNY6yQ.png)\n\n### ç»“è®º\n\né€šè¿‡ç†è§£ SwiftUI è§†å›¾å·®å¼‚åŒ–æœºåˆ¶ï¼ŒAirbnb è¿ç”¨äº†ä¸‰é¡¹å…³é”®æŠ€æœ¯ï¼š\n\n1.  **`@Equatable` å®ï¼š** ç¡®ä¿è§†å›¾ `body` ä»…åœ¨è§†å›¾å†…éƒ¨çš„å€¼å®é™…æ”¹å˜æ—¶æ‰è¢«é‡æ–°è¯„ä¼°ã€‚\n2.  **æ‹†åˆ†è§†å›¾ï¼š** å°†è§†å›¾åˆ†è§£ä¸ºæ›´å°çš„éƒ¨åˆ†ï¼Œä»¥å®ç°æ›´å¿«çš„é‡æ–°è¯„ä¼°ã€‚\n3.  **å¤æ‚åº¦ Lint è§„åˆ™ï¼š** é¼“åŠ±å¼€å‘è€…åœ¨è§†å›¾å˜å¾—è¿‡å¤§å’Œå¤æ‚ä¹‹å‰è¿›è¡Œé‡æ„ã€‚\n\nå°†è¿™äº›æŠ€æœ¯åº”ç”¨äº Airbnb åº”ç”¨ä¸­çš„ SwiftUI è§†å›¾ï¼Œæ˜¾è‘—å‡å°‘äº†ä¸å¿…è¦çš„è§†å›¾é‡æ–°è¯„ä¼°å’Œé‡æ–°æ¸²æŸ“ã€‚ä¾‹å¦‚ï¼Œåœ¨æœç´¢æ å’Œç­›é€‰é¢æ¿ä¸­ï¼Œé‡æ–°æ¸²æŸ“çš„æ¬¡æ•°æ˜æ˜¾å‡å°‘ã€‚\n\n![å›¾ç‰‡ 5: åº”ç”¨æŠ€æœ¯åå‡å°‘é‡æ–°æ¸²æŸ“çš„ç¤ºä¾‹](https://cdn-images-1.medium.com/max/1024/1*tWhEXK5kyFP5KYPCUSvp6Q.gif)\n\næ ¹æ®é¡µé¢æ€§èƒ½è¯„åˆ†ç³»ç»Ÿçš„æ•°æ®ï¼Œåœ¨æœ€å¤æ‚çš„ SwiftUI å±å¹•ä¸­é‡‡ç”¨è¿™äº›æŠ€æœ¯ç¡®å®æ”¹å–„äº†ç”¨æˆ·ä½“éªŒã€‚ä¾‹å¦‚ï¼Œé€šè¿‡åœ¨ä¸»è¦æœç´¢å±å¹•ä¸Šæœ€é‡è¦çš„è§†å›¾ä¸­é‡‡ç”¨ `@Equatable` å¹¶å°†å¤§å‹è§†å›¾ä½“æ‹†åˆ†ä¸ºæ›´å°çš„å¯å·®å¼‚åŒ–éƒ¨åˆ†ï¼Œæ»šåŠ¨å¡é¡¿å‡å°‘äº†15%ã€‚è¿™äº›æŠ€æœ¯è¿˜æä¾›äº†çµæ´»æ€§ï¼Œå…è®¸ Airbnb é‡‡ç”¨æœ€é€‚åˆå…¶éœ€æ±‚çš„åŠŸèƒ½æ¶æ„ï¼Œè€Œä¸ä¼šç‰ºç‰²æ€§èƒ½æˆ–æ–½åŠ ç¹é‡çš„é™åˆ¶ï¼ˆä¾‹å¦‚ï¼Œå®Œå…¨é¿å…åœ¨ SwiftUI è§†å›¾ä¸­ä½¿ç”¨é—­åŒ…ï¼‰ã€‚\n\nå½“ç„¶ï¼Œè¿™äº›æŠ€æœ¯å¹¶éä¸‡èƒ½è¯ï¼Œå¹¶éæ‰€æœ‰ SwiftUI åŠŸèƒ½éƒ½å¿…é¡»ä½¿ç”¨å®ƒä»¬ï¼Œå®ƒä»¬æœ¬èº«ä¹Ÿä¸è¶³ä»¥ä¿è¯å‡ºè‰²çš„æ€§èƒ½ã€‚ç„¶è€Œï¼Œç†è§£å®ƒä»¬çš„å·¥ä½œåŸç†å’ŒåŸå› ï¼Œä¸ºæ„å»ºé«˜æ€§èƒ½ SwiftUI åŠŸèƒ½å¥ å®šäº†å®è´µçš„åŸºç¡€ï¼Œå¹¶ä½¿å¾—åœ¨ä»£ç ä¸­å‘ç°å’Œé¿å…é—®é¢˜æ¨¡å¼å˜å¾—æ›´å®¹æ˜“ã€‚",
      "shortSummary": "Airbnb å›¢é˜Ÿä¸ºè§£å†³ SwiftUI æ€§èƒ½é—®é¢˜ï¼Œä¸»è¦èšç„¦äºä¼˜åŒ–è§†å›¾å·®å¼‚åŒ–ï¼ˆdiffingï¼‰å’Œç®¡ç†è§†å›¾ä½“å¤§å°ã€‚ä»–ä»¬å¼€å‘äº† `@Equatable` å®ï¼Œè‡ªåŠ¨ç”Ÿæˆ `Equatable` ä¸€è‡´æ€§ï¼Œç¡®ä¿è§†å›¾ä»…åœ¨å…³é”®å±æ€§å˜åŒ–æ—¶æ›´æ–°ï¼Œå¹¶å…è®¸è·³è¿‡ä¸å¯å·®å¼‚åŒ–çš„å±æ€§ï¼ˆå¦‚é—­åŒ…ï¼‰ã€‚åŒæ—¶ï¼Œä»–ä»¬æå€¡å°†å¤§å‹è§†å›¾æ‹†åˆ†ä¸ºæ›´å°çš„ç‹¬ç«‹ç»„ä»¶ï¼Œå¹¶åˆ›å»ºäº† SwiftLint è§„åˆ™æ¥æ£€æµ‹å¹¶é™åˆ¶è§†å›¾å¤æ‚åº¦ï¼Œé¼“åŠ±åŠæ—¶é‡æ„ã€‚è¿™äº›æªæ–½æ˜¾è‘—å‡å°‘äº†ä¸å¿…è¦çš„è§†å›¾é‡æ–°æ¸²æŸ“ï¼Œæå‡äº†åº”ç”¨æ€§èƒ½ï¼Œä¾‹å¦‚æœç´¢é¡µé¢æ»šåŠ¨å¡é¡¿å‡å°‘15%ã€‚",
      "translated_title": "ç†è§£å’Œæ”¹è¿› SwiftUI æ€§èƒ½",
      "images": [
        {
          "url": "https://cdn-images-1.medium.com/max/1024/1*qBYJ9abMpZyuODmbHkYD5Q.jpeg",
          "alt": "",
          "title": "",
          "position": 1
        },
        {
          "url": "https://cdn-images-1.medium.com/max/1024/1*LvNBJSor0RDThlW3Oq7mWw.png",
          "alt": "",
          "title": "",
          "position": 2
        },
        {
          "url": "https://cdn-images-1.medium.com/max/1024/1*yNrr8e8yI9RcKg6Z-VUhEA.gif",
          "alt": "",
          "title": "",
          "position": 3
        },
        {
          "url": "https://cdn-images-1.medium.com/max/1024/1*Tdo1L8qZf81FWFeJaNY6yQ.png",
          "alt": "",
          "title": "",
          "position": 4
        },
        {
          "url": "https://cdn-images-1.medium.com/max/1024/1*tWhEXK5kyFP5KYPCUSvp6Q.gif",
          "alt": "",
          "title": "",
          "position": 5
        }
      ],
      "contentSource": "RSS",
      "content": "<p>New techniques weâ€™re using at Airbnb to improve and maintain performance of SwiftUI features atÂ scale</p><p>By <a href=\"https://www.linkedin.com/in/calstephens/\">Cal Stephens</a>, <a href=\"https://www.linkedin.com/in/miguel-jimenez-b98216112\">MiguelÂ Jimenez</a></p><figure><img alt=\"\" src=\"https://cdn-images-1.medium.com/max/1024/1*qBYJ9abMpZyuODmbHkYD5Q.jpeg\" /></figure><p>Airbnb <a href=\"https://medium.com/airbnb-engineering/unlocking-swiftui-at-airbnb-ea58f50cde49\">first adopted SwiftUI in 2022</a>, starting with individual components and later expanding to entire screens and features. Weâ€™ve seen major improvements to engineersâ€™ productivity thanks to its declarative, flexible, and composable architecture. However, adopting SwiftUI has brought new challenges related to performance. For example, there are many common code patterns in SwiftUI that can be inefficient, and many small papercuts can add up to a large cumulative performance hit. To begin addressing some of these issues at scale, weâ€™ve created new tooling for proactively identifying these cases and statically validating correctness.</p><h3>SwiftUI feature architecture atÂ Airbnb</h3><p>Weâ€™ve been leveraging declarative UI patterns at Airbnb for many years, using our UIKit-based <a href=\"https://medium.com/airbnb-engineering/introducing-epoxy-for-ios-6bf062be1670\">Epoxy library</a> and <a href=\"https://medium.com/airbnb-engineering/introducing-epoxy-for-ios-6bf062be1670#fbe0\">unidirectional data flow</a> systems. When adopting SwiftUI in our screen layer, we decided to continue using our existing unidirectional data flow library. This simplified the process of incrementally adopting SwiftUI within our large codebase, and we find it improves the quality and maintainability of features.</p><p>However, we noticed that SwiftUI features using our unidirectional data flow library didnâ€™t perform as well as we expected, and it wasnâ€™t immediately obvious to us what the problem was. Understanding SwiftUIâ€™s performance characteristics is an important requirement for building performant features, especially when venturing outside of the â€œstandardâ€ SwiftUIÂ toolbox.</p><h3>Understanding SwiftUI viewÂ diffing</h3><p>When working with declarative UI systems like SwiftUI, itâ€™s important to ensure the framework knows which views need to be re-evaluated and re-rendered when the state of the screen changes. Changes are detected by diffing the viewâ€™s stored properties any time its parent is updated. Ideally the viewâ€™s body will only be re-evaluated when its properties actuallyÂ change:</p><figure><img alt=\"\" src=\"https://cdn-images-1.medium.com/max/1024/1*LvNBJSor0RDThlW3Oq7mWw.png\" /></figure><p>However, this behavior is not always the reality (more on why in a moment). Unnecessary view body evaluations hurt performance by performing unnecessary work.</p><p>How do you know how often a viewâ€™s body is re-evaluated in a real app? An easy way to visualize this is with a modifier that applies a random color to the view every time itâ€™s rendered. When testing this on various views in our appâ€™s most performance-sensitive screens, we quickly found that many views were re-evaluated and re-rendered more often than necessary:</p><figure><img alt=\"\" src=\"https://cdn-images-1.medium.com/max/1024/1*yNrr8e8yI9RcKg6Z-VUhEA.gif\" /></figure><h4>The SwiftUI view diffing algorithm</h4><p>SwiftUIâ€™s built-in diffing algorithm is often overlooked and not officially documented, but it has a huge impact on performance. To determine if a viewâ€™s body needs to be re-evaluated, SwiftUI uses a reflection-based diffing algorithm to compare each of the viewâ€™s stored properties:</p><ol><li>If a type is <em>Equatable</em>, SwiftUI compares the old and new values using the typeâ€™s <em>Equatable</em> conformance. Otherwise:</li><li>SwiftUI compares value types (e.g., structs) by recursively comparing each instance property.</li><li>SwiftUI compares reference types (e.g., classes) using reference identity.</li><li>SwiftUI attempts to compare closures by identity. However, most closures cannot be compared reliably.</li></ol><p>If all of the viewâ€™s properties compare as equal to the previous value, then the body isnâ€™t re-evalulated and the content isnâ€™t re-rendered. Values using SwiftUI property wrappers like<em> @State </em>and <em>@Environment</em> donâ€™t participate in this diffing algorithm, and instead trigger view updates through different mechanisms.</p><p>When reviewing different views in our codebase, we found several common patterns that confounded SwiftUIâ€™s diffing algorithm:</p><ol><li>Some types are inherently not supported, like closures.</li><li>Simple data types stored on the view may be unexpectedly compared by reference instead of byÂ value.</li></ol><p>Hereâ€™s an example SwiftUI view with properties that interact poorly with the diffing algorithm:</p><pre>struct MyView: View {<br>  /// A generated data model that is a struct with value semantics,<br>  /// but is copy-on-write and wraps an internal reference type.<br>  /// Compared by reference, not by value, which could cause unwanted body evaluations.<br>  let dataModel: CopyOnWriteDataModel<br><br>  /// Other miscellaneous properties used by the view. Typically structs, but sometimes a class.<br>  /// Unexpected comparisons by reference could cause unwanted body evaluations.<br>  let requestState: MyFeatureRequestState<br><br>  /// An action handler for this view, part of our unidirectional data flow library. <br>  /// Wraps a closure that routes the action to the screen&#39;s action handler.<br>  /// Closures almost always compare as not-equal, and typically cause unwanted body evaluations. <br>  let handler: Handler&lt;MyViewAction&gt;<br><br>  var body: some View { ... }<br>}</pre><p>If a view contains any value that isnâ€™t diffable, the entire view becomes non-diffable. Preventing this in a scalable way is almost impossible with existing tools. This finding also reveals the performance issue caused by our unidirectional data flow library: action handling is closure-based, but SwiftUI canâ€™t diff closures!</p><p>In some cases, like with the action handlers from our unidirectional data flow library, making the value diffable would require large, invasive, and potentially undesirable architecture changes. Even in simpler cases, this process is still time consuming, and thereâ€™s no easy way to prevent a regression from creeping in later on. This is a big obstacle when trying to improve and maintain performance at scale in large codebases with many different contributors.</p><h3>Controlling SwiftUI viewÂ diffing</h3><p>Fortunately, we have another option: If a view conforms to Equatable, SwiftUI will diff it using its Equatable conformance <em>instead</em> of using the default reflection-based diffing algorithm.</p><p>The advantage of this approach is that it lets us selectively decide which properties should be compared when diffing our view. In our case, we know that the handler object doesnâ€™t affect the content or identity of our view. We only want our view to be re-evalulated and re-rendered when the <em>dataModel</em> and <em>requestState</em> values are updated. We can express that with a custom <em>Equatable</em> implementation:</p><pre>// An Equatable conformance that makes the above SwiftUI view diffable.<br>extension MyView: Equatable {<br>  static func ==(lhs: MyView, rhs: MyView) -&gt; Bool {<br>    lhs.dataModel == rhs.dataModel<br>      &amp;&amp; lhs.requestState == rhs.requestState<br>      // Intentionally not comparing handler, which isn&#39;t Equatable.<br>  }<br>}</pre><p>However:</p><ol><li>This is a lot of additional boilerplate for engineers to write, especially for views with lots of properties.</li><li>Writing and maintaining a custom conformance is error-prone. You can easily forget to update the <em>Equatable</em> conformance when adding new properties later, which would causeÂ bugs.</li></ol><p>So, instead of manually writing and maintaining <em>Equatable</em> conformances, we created a new<em> @Equatable </em>macro that generates conformances forÂ us.</p><pre>// A sample SwiftUI view that has adopted @Equatable<br>// and is now guaranteed to be diffable.<br>@Equatable<br>struct MyView: View {<br>  // Simple data types must be Equatable, or the build will fail.<br>  let dataModel: CopyOnWriteDataModel<br>  let requestState: MyFeatureRequestState<br><br>  // Types that aren&#39;t Equatable can be excluded from the<br>  // generated Equatable conformance using @SkipEquatable,<br>  // as long as they donâ€™t affect the output of the view body.<br>  @SkipEquatable let handler: Handler&lt;MyViewAction&gt;<br><br>  var body: some View { ... }<br>}</pre><p>The <em>@Equatable</em> macro generates an <em>Equatable</em> implementation that compares all of the viewâ€™s stored instance properties, excluding properties with SwiftUI property wrappers like<em>@State </em>and <em>@Environment</em> that trigger view updates through other mechanisms. Properties that arenâ€™t <em>Equatable</em> and donâ€™t affect the output of the view body can be marked with <em>@SkipEquatable</em> to exclude them from the generated implementation. This allows us to continue using the closure-based action handlers from our unidirectional data flow library without impacting the SwiftUI diffingÂ process!</p><p>After adopting the <em>@Equatable</em> macro on a view, that view is guaranteed to be diffable. If an engineer adds a non-<em>Equatable</em> property later, the build will fail, highlighting a potential regression in the diffing behavior. This effectively makes the <em>@Equatable</em> macro a sophisticated linterâ€Šâ€”â€Šwhich is really valuable for scaling these performance improvements in a codebase with many components and many contributors, since it makes it less likely for regressions to slip inÂ later.</p><h3>Managing the size of viewÂ bodies</h3><p>Another essential aspect of SwiftUI diffing is understanding that SwiftUI can only diff proper View structs. Any other code, such as computed properties or helper functions that generate a SwiftUI view, cannot beÂ diffed.</p><p>Consider the following example:</p><pre>// Complex SwiftUI views are often simplified by<br>// splitting the view body into separate computed properties.<br>struct MyScreen: View {<br>  /// The unidirectional data flow state store for this feature.<br>  @ObservedObject var store: StateStore&lt;MyState, MyAction&gt;<br><br>  var body: some View {<br>    VStack {<br>      headerSection<br>      actionCardSection<br>    }<br>  }<br><br>  private var headerSection: some View {<br>    Text(store.state.titleString)<br>      .textStyle(.title)<br>  }<br><br>  private var actionCardSection: some View {<br>    VStack {<br>      Image(store.state.cardSelected ? &quot;enabled&quot; : &quot;disabled&quot;)<br>      Text(&quot;This is a selectable card&quot;)<br>    }<br>    .strokedCard(.roundedRect_mediumCornerRadius_12)<br>    .scaleEffectButton(action: {<br>      store.handle(.cardTapped) <br>    })<br>  }<br>}</pre><p>This is a common way to organize complex view bodies, since it makes the code easier to read and maintain. However, at runtime, SwiftUI effectively inlines the views returned from the properties into the main view body, as if we insteadÂ wrote:</p><pre>// At runtime, computed properties are no different<br>// from just having a single, large view body!<br>struct MyScreen: View {<br>  @ObservedObject var store: StateStore&lt;MyState, MyAction&gt;<br><br>  // Re-evaluated every time the state of the screen is updated.<br>  var body: some View {<br>    VStack {<br>      Text(store.state.titleString)<br>        .textStyle(.title)<br><br>      VStack {<br>        Image(store.state.cardSelected ? &quot;enabled&quot; : &quot;disabled&quot;)<br>        Text(&quot;This is a selectable card&quot;)<br>      }<br>      .strokedCard(.roundedRect_mediumCornerRadius_12)<br>      .scaleEffectButton(action: {<br>        store.handle(.cardTapped) <br>      })<br>    }<br>  }<br>}</pre><p>Since all of this code is part of the same view body, all of it will be re-evaluated when any part of the screenâ€™s state changes. While this specific example is simple, as the view grows larger and more complicated, re-evaluating it will become more expensive. Eventually there would be a large amount of unnecessary work happening on every screen update, hurting performance.</p><p>To improve performance, we can implement the layout code in separate SwiftUI views. This allows SwiftUI to properly diff each child view, only re-evaluating their bodies when necessary:</p><pre>struct MyScreen: View {<br>  @ObservedObject var store: StateStore&lt;MyState, MyAction&gt;<br><br>  var body: some View {<br>    VStack {<br>      HeaderSection(title: store.state.titleString)<br>      CardSection(<br>       isCardSelected: store.state.isCardSelected,<br>       handler: store.handler,<br>      )<br>    }<br>  }<br>}<br><br>/// Only re-evaluated and re-rendered when the title property changes.<br>@Equatable<br>struct HeaderSection: View {<br>  let title: String<br><br>  var body: some View {<br>    Text(title)<br>      .textStyle(.title)<br>  }<br>}<br><br>/// Only re-evaluated and re-rendered when the isCardSelected property changes.<br>@Equatable<br>struct CardSection: View {<br>  let isCardSelected: Bool<br>  @SkipEquatable let handler: Handler&lt;MyAction&gt;<br><br>  var body: some View {<br>    VStack {<br>      Image(store.state.isCardSelected ? &quot;enabled&quot; : &quot;disabled&quot;)<br>      Text(&quot;This is a selectable card&quot;)<br>    }<br>    .strokedCard(.roundedRect_mediumCornerRadius_12)<br>    .scaleEffectButton(action: {<br>      handler.handle(.cardTapped) <br>    })<br>  }<br>}</pre><p>By breaking the view into smaller, diffable pieces, SwiftUI can efficiently update only the parts of the view that actually changed. This approach helps maintain performance as a feature grows moreÂ complex.</p><h4>View body complexity lintÂ rule</h4><p>Large, complex views arenâ€™t always obvious during development. Easily available metrics like total line count arenâ€™t a good proxy for complexity. To help engineers know when itâ€™s time to refactor a view into smaller, diffable pieces, we created a custom <a href=\"https://github.com/realm/SwiftLint\">SwiftLint</a> rule that parses the view body using <a href=\"https://github.com/swiftlang/swift-syntax\">SwiftSyntax</a> and measures its complexity. We defined the view complexity metric as a value that increases every time you compose views using computed properties, functions, or closures. With this rule we automatically trigger an alert in Xcode when a view is getting too complex. (The complexity limit is configurable, and we currently allow a maximum complexity level ofÂ 10.)</p><figure><img alt=\"\" src=\"https://cdn-images-1.medium.com/max/1024/1*Tdo1L8qZf81FWFeJaNY6yQ.png\" /><figcaption>The rule shows as a warning during local Xcode builds alerting engineers as early as possible. In this screenshot, the complexity limit is set to 3, and this specific view has a complexity ofÂ 5.</figcaption></figure><h3>Conclusion</h3><p>With an understanding of how SwiftUI view diffing works, we can use an <em>@Equatable</em> macro to ensure view bodies are only re-evaluated when the values inside views actually change, break views into smaller parts for faster re-evaluation, and encourage developers to refactor views before they get too large andÂ complex.</p><p>Applying these three techniques to SwiftUI views in our app has led to a large reduction in unnecessary view re-evaluation and re-renders. Revisiting the examples from earlier, you see far fewer re-renders in the search bar and filterÂ panel:</p><figure><img alt=\"\" src=\"https://cdn-images-1.medium.com/max/1024/1*tWhEXK5kyFP5KYPCUSvp6Q.gif\" /></figure><p>Using results from our <a href=\"https://medium.com/airbnb-engineering/airbnbs-page-performance-score-on-ios-36d5f200bc73\">page performance score</a> system, weâ€™ve found that adopting these techniques in our most complicated SwiftUI screens really does improve performance for our users. For example, we reduced <a href=\"https://medium.com/airbnb-engineering/airbnbs-page-performance-score-on-ios-36d5f200bc73#4c63\">scroll hitches</a> by<strong> </strong>15% on our main Search screen by adopting <em>@Equatable</em> on its most important views, and breaking apart large view bodies into smaller diffable pieces. These techniques also give us the flexibility to use a feature architecture that best suits our needs without compromising performance or imposing burdensome limitations (e.g., completely avoiding closures in SwiftUIÂ views).</p><p>Of course, these techniques arenâ€™t a silver bullet. Itâ€™s not necessary for all SwiftUI features to use them, and these techniques by themselves arenâ€™t enough to guarantee great performance. However, understanding how and why they work serves as a valuable foundation for building performant SwiftUI features, and makes it easier to spot and avoid problematic patterns in your ownÂ code.</p><p>If youâ€™re interested in joining us on our quest to make the best iOS app in the App Store, please see our <a href=\"https://careers.airbnb.com/\">careers</a> page for open iOSÂ roles.</p><img src=\"https://medium.com/_/stat?event=post.clientViewed&referrerSource=full_rss&postId=37b77ac61896\" width=\"1\" height=\"1\" alt=\"\"><hr><p><a href=\"https://medium.com/airbnb-engineering/understanding-and-improving-swiftui-performance-37b77ac61896\">Understanding and Improving SwiftUI Performance</a> was originally published in <a href=\"https://medium.com/airbnb-engineering\">The Airbnb Tech Blog</a> on Medium, where people are continuing the conversation by highlighting and responding to this story.</p>"
    },
    {
      "title": "åœ¨ Airbnb ä½¿ç”¨ Impulse è¿›è¡Œè´Ÿè½½æµ‹è¯• (åŸæ ‡é¢˜: Load Testing with Impulse at Airbnb)",
      "link": "https://medium.com/airbnb-engineering/load-testing-with-impulse-at-airbnb-f466874d03d2?source=rss----53c7c27702d5---4",
      "pubDate": "Mon, 09 Jun 2025 17:45:39 GMT",
      "isoDate": "2025-06-09T17:45:39.000Z",
      "creator": "Chenhao Yang",
      "summary": "# Airbnb çš„ Impulse è´Ÿè½½æµ‹è¯•å®è·µ\n\n## å¼•è¨€\nç³»ç»Ÿçº§è´Ÿè½½æµ‹è¯•å¯¹äºç¡®ä¿ç³»ç»Ÿå¯é æ€§å’Œæ•ˆç‡è‡³å…³é‡è¦ï¼Œå®ƒèƒ½å¸®åŠ©è¯†åˆ«ç“¶é¢ˆã€è¯„ä¼°å³°å€¼æµé‡ä¸‹çš„å®¹é‡ã€å»ºç«‹æ€§èƒ½åŸºçº¿å¹¶æ£€æµ‹é”™è¯¯ã€‚åœ¨ Airbnb è¿™æ ·è§„æ¨¡å’Œå¤æ‚åº¦çš„å…¬å¸ï¼Œè´Ÿè½½æµ‹è¯•éœ€è¦å…·å¤‡å¥å£®æ€§ã€çµæ´»æ€§å’Œå»ä¸­å¿ƒåŒ–ç‰¹æ€§ï¼Œä»¥æ”¯æŒå·¥ç¨‹å›¢é˜Ÿè¿›è¡Œä¸ CI æ— ç¼é›†æˆçš„è‡ªåŠ©å¼è´Ÿè½½æµ‹è¯•ã€‚\n\nImpulse æ˜¯ Airbnb å†…éƒ¨çš„â€œè´Ÿè½½æµ‹è¯•å³æœåŠ¡â€æ¡†æ¶ä¹‹ä¸€ã€‚å®ƒæä¾›å·¥å…·æ¥ç”Ÿæˆåˆæˆè´Ÿè½½ã€æ¨¡æ‹Ÿä¾èµ–é¡¹ä»¥åŠä»ç”Ÿäº§ç¯å¢ƒä¸­æ”¶é›†æµé‡æ•°æ®ã€‚æœ¬æ–‡ä»‹ç»äº† Impulse çš„æ¶æ„ï¼Œä»¥åŠå®ƒå¦‚ä½•æœ€å¤§é™åº¦åœ°å‡å°‘æ‰‹åŠ¨å·¥ä½œã€æ— ç¼é›†æˆåˆ°å¯è§‚æµ‹æ€§å †æ ˆä¸­ï¼Œå¹¶èµ‹èƒ½å›¢é˜Ÿä¸»åŠ¨è§£å†³æ½œåœ¨é—®é¢˜ã€‚\n\n![å›¾ç‰‡ 1](https://cdn-images-1.medium.com/max/1024/1*3LijjQrJDLVA_ptfeRe83g.jpeg)\n\n## æ¶æ„\nImpulse æ˜¯ä¸€ä¸ªå…¨é¢çš„è´Ÿè½½æµ‹è¯•æ¡†æ¶ï¼Œå…è®¸æœåŠ¡æ‰€æœ‰è€…è¿›è¡Œä¸Šä¸‹æ–‡æ„ŸçŸ¥çš„è´Ÿè½½æµ‹è¯•ã€æ¨¡æ‹Ÿä¾èµ–é¡¹å¹¶æ”¶é›†æµé‡æ•°æ®ï¼Œä»¥ç¡®ä¿ç³»ç»Ÿåœ¨å„ç§æ¡ä»¶ä¸‹çš„æ€§èƒ½ã€‚å®ƒåŒ…å«ä»¥ä¸‹æ ¸å¿ƒç»„ä»¶ï¼š\n\n![å›¾ç‰‡ 2](https://cdn-images-1.medium.com/max/1024/1*SFDblGijyiLQfI7C5RpPXw.png)\n*å›¾ 1: Impulse æ¡†æ¶åŠå…¶å››ä¸ªä¸»è¦ç»„ä»¶*\n\n1.  **è´Ÿè½½ç”Ÿæˆå™¨ (Load Generator)**ï¼š\n    *   ç”¨äºæ ¹æ®åˆæˆæˆ–æ”¶é›†çš„æµé‡ï¼ŒåŠ¨æ€ç”Ÿæˆä¸Šä¸‹æ–‡æ„ŸçŸ¥çš„è¯·æ±‚ï¼Œä»¥æµ‹è¯•ä¸åŒåœºæ™¯ã€‚\n    *   **ä¸Šä¸‹æ–‡æ„ŸçŸ¥**ï¼šå…è®¸ç”¨æˆ·ä½¿ç”¨ Java æˆ– Kotlin ç¼–å†™ä»»æ„æµ‹è¯•é€»è¾‘ï¼Œå¹¶å¤§è§„æ¨¡å¯åŠ¨å®¹å™¨æ¥è¿è¡Œè¿™äº›æµ‹è¯•ã€‚é€‰æ‹©ä»£ç è€Œé DSL/é…ç½®çš„åŸå› åœ¨äºï¼š\n        *   **çµæ´»æ€§**ï¼šç¼–ç¨‹è¯­è¨€æ¯” DSL æ›´å…·è¡¨è¾¾åŠ›ï¼Œèƒ½æ›´å¥½åœ°æ”¯æŒå¤æ‚çš„ä¸Šä¸‹æ–‡åœºæ™¯ã€‚\n        *   **å¯é‡ç”¨æ€§**ï¼šç›¸åŒçš„æµ‹è¯•ä»£ç å¯ç”¨äºå…¶ä»–æµ‹è¯•ï¼ˆå¦‚é›†æˆæµ‹è¯•ï¼‰ã€‚\n        *   **å¼€å‘è€…ç†Ÿç»ƒåº¦**ï¼šå­¦ä¹ æ›²çº¿ä½ï¼Œæ— éœ€å­¦ä¹ æ–°çš„æµ‹è¯•é€»è¾‘ç¼–å†™æ–¹å¼ã€‚\n        *   **å¼€å‘è€…ä½“éªŒ**ï¼šæ”¯æŒ IDEã€æµ‹è¯•ã€è°ƒè¯•ç­‰ã€‚\n    *   **å»ä¸­å¿ƒåŒ–ä¸å®¹å™¨åŒ–**ï¼šæ¯æ¬¡è§¦å‘è´Ÿè½½æµ‹è¯•æ—¶ï¼Œéƒ½ä¼šåˆ›å»ºä¸€ç»„æ–°çš„å®¹å™¨æ¥è¿è¡Œæµ‹è¯•ï¼Œè¿™å¸¦æ¥äº†ï¼š\n        *   **éš”ç¦»æ€§**ï¼šä¸åŒæœåŠ¡é—´çš„è´Ÿè½½æµ‹è¯•ç›¸äº’éš”ç¦»ï¼Œæ¶ˆé™¤å¹²æ‰°ã€‚\n        *   **å¯ä¼¸ç¼©æ€§**ï¼šå®¹å™¨æ•°é‡å¯æ ¹æ®æµé‡éœ€æ±‚è¿›è¡Œä¼¸ç¼©ã€‚\n        *   **æˆæœ¬æ•ˆç›Š**ï¼šå®¹å™¨ç”Ÿå‘½å‘¨æœŸçŸ­ï¼Œä»…åœ¨è´Ÿè½½æµ‹è¯•è¿è¡ŒæœŸé—´å­˜åœ¨ã€‚\n    *   Impulse çš„è´Ÿè½½ç”Ÿæˆå™¨èƒ½å°†å·¥ä½œè´Ÿè½½å‡åŒ€åˆ†å¸ƒåˆ°æ‰€æœ‰æ•°æ®ä¸­å¿ƒï¼Œå¹¶ç¡®ä¿æ€»çš„æ¯ç§’è§¦å‘æ¬¡æ•° (TPS) ç¬¦åˆé…ç½®ï¼Œä»è€Œæ›´å¥½åœ°æ¨¡æ‹Ÿç”Ÿäº§ç¯å¢ƒä¸­çš„çœŸå®æµé‡åˆ†å¸ƒã€‚\n    *   **æ‰§è¡Œ**ï¼šè®¾è®¡ç”¨äºåœ¨ CI/CD æµæ°´çº¿ä¸­è‡ªåŠ¨è§¦å‘ã€‚å¼€å‘è€…å¯ä»¥é…ç½®å¤šä¸ªæµ‹è¯•é˜¶æ®µï¼ˆå¦‚é¢„çƒ­ã€ç¨³å®šã€å³°å€¼ï¼‰ï¼Œæ¯ä¸ªé˜¶æ®µå¯é…ç½®æµ‹è¯•ç”¨ä¾‹ã€TPS å’ŒæŒç»­æ—¶é—´ã€‚\n\n    ![å›¾ç‰‡ 3](https://cdn-images-1.medium.com/max/977/1*WD4EWyWHDQMf_7nDIGkAuA.png)\n    *å›¾ 2: å®¹å™¨åŒ–è´Ÿè½½ç”Ÿæˆå™¨*\n\n2.  **ä¾èµ–æ¨¡æ‹Ÿå™¨ (Dependency Mocker)**ï¼š\n    *   ç”¨äºæ¨¡æ‹Ÿä¸‹æ¸¸æœåŠ¡çš„å“åº”ï¼ŒåŒ…æ‹¬å»¶è¿Ÿï¼Œä»è€Œä½¿è¢«æµ‹æœåŠ¡ (SUT) çš„è´Ÿè½½æµ‹è¯•æ— éœ€æ¶‰åŠæŸäº›ä¾èµ–æœåŠ¡ã€‚è¿™å¯¹äºä¸æ”¯æŒè´Ÿè½½æµ‹è¯•çš„ä¾›åº”å•†æœåŠ¡æˆ–åœ¨æ—¥å¸¸éƒ¨ç½²ä¸­ä¸å½±å“ä¸‹æ¸¸æœåŠ¡è¿›è¡Œå›å½’æµ‹è¯•å°¤ä¸ºé‡è¦ã€‚\n    *   Impulse æ˜¯ä¸€ä¸ªå»ä¸­å¿ƒåŒ–æ¡†æ¶ï¼Œæ¯ä¸ªæœåŠ¡éƒ½æœ‰è‡ªå·±çš„ä¾èµ–æ¨¡æ‹Ÿå™¨ï¼Œä»¥æ¶ˆé™¤æœåŠ¡é—´çš„å¹²æ‰°å¹¶é™ä½é€šä¿¡æˆæœ¬ã€‚\n    *   æ¨¡æ‹Ÿå™¨æ˜¯è¿›ç¨‹å¤–æœåŠ¡ï¼Œç‹¬ç«‹è¿è¡Œï¼Œé¿å…å½±å“ SUT æ€§èƒ½ã€‚å®ƒä»¬æ˜¯çŸ­ç”Ÿå‘½å‘¨æœŸçš„ï¼Œä»…åœ¨æµ‹è¯•è¿è¡Œå‰å¯åŠ¨ï¼Œæµ‹è¯•ç»“æŸåå…³é—­ï¼Œä»¥èŠ‚çœæˆæœ¬å’Œç»´æŠ¤å·¥ä½œã€‚\n    *   å“åº”å»¶è¿Ÿå’Œå¼‚å¸¸å¯é…ç½®ï¼Œæ¨¡æ‹Ÿå™¨å®ä¾‹æ•°é‡å¯æŒ‰éœ€è°ƒæ•´ä»¥æ”¯æŒå¤§é‡æµé‡ã€‚\n    *   **å…¶ä»–å€¼å¾—æ³¨æ„çš„ç‰¹æ€§**ï¼š\n        *   å¯é€‰æ‹©æ€§åœ°æ¨¡æ‹Ÿéƒ¨åˆ†ä¾èµ–é¡¹ï¼Œç›®å‰æ”¯æŒ HTTP JSONã€Airbnb Thrift å’Œ Airbnb GraphQL ä¾èµ–ã€‚\n        *   æ”¯æŒè´Ÿè½½æµ‹è¯•ä¹‹å¤–çš„ç”¨ä¾‹ï¼Œå¦‚é›†æˆæµ‹è¯•ã€‚\n    *   **ä¸¤ç§æ¨¡æ‹Ÿå“åº”ç”Ÿæˆé€‰é¡¹**ï¼š\n        *   **åˆæˆå“åº” (Synthetic response)**ï¼šç”±ç”¨æˆ·é€»è¾‘ç”Ÿæˆï¼Œç±»ä¼¼äºé›†æˆæµ‹è¯•ï¼Œä½†å“åº”æ¥è‡ªè¿œç¨‹ï¼ˆè¿›ç¨‹å¤–ï¼‰æœåŠ¡å™¨ï¼Œå¹¶æ¨¡æ‹Ÿå»¶è¿Ÿã€‚\n        *   **é‡æ”¾å“åº” (Replay response)**ï¼šä»ç”Ÿäº§ä¸‹æ¸¸è®°å½•ä¸­é‡æ”¾å“åº”ï¼Œç”±æµé‡æ”¶é›†å™¨ç»„ä»¶æ”¯æŒã€‚\n\n    ![å›¾ç‰‡ 4](https://cdn-images-1.medium.com/max/1024/1*QXMa3Nj3-aSUE_EOvlv1xw.png)\n    *å›¾ 3: ä¾èµ–æ¨¡æ‹Ÿå™¨*\n\n3.  **æµé‡æ”¶é›†å™¨ (Traffic Collector)**ï¼š\n    *   æ—¨åœ¨æ•è·ç”Ÿäº§ç¯å¢ƒä¸­çš„ä¸Šæ¸¸å’Œä¸‹æ¸¸æµé‡åŠå…¶ä¹‹é—´çš„å…³ç³»ã€‚\n    *   é€šè¿‡å¤åˆ¶ä¸‹æ¸¸å“åº”ï¼ˆåŒ…æ‹¬ç”Ÿäº§ç¯å¢ƒèˆ¬çš„å»¶è¿Ÿå’Œé”™è¯¯ï¼‰ï¼ŒImpulse èƒ½å¤Ÿå‡†ç¡®åœ°é‡æ”¾ç”Ÿäº§æµé‡è¿›è¡Œè´Ÿè½½æµ‹è¯•ï¼Œé¿å…ä¸‹æ¸¸æ•°æ®æˆ–è¡Œä¸ºçš„ä¸ä¸€è‡´ã€‚\n    *   ç¡®ä¿æµ‹è¯•ç¯å¢ƒä¸­çš„æœåŠ¡è¡Œä¸ºä¸ç”Ÿäº§ç¯å¢ƒä¸­çš„æœåŠ¡è¡Œä¸ºä¸€è‡´ï¼Œä»è€Œå®ç°æ›´çœŸå®ã€æ›´å¯é çš„æ€§èƒ½è¯„ä¼°ã€‚\n\n    ![å›¾ç‰‡ 5](https://cdn-images-1.medium.com/max/1024/1*EImg3JUEGzbos5r3_6U-FQ.png)\n    *å›¾ 4: æµé‡æ”¶é›†å™¨*\n\n4.  **æµ‹è¯• API ç”Ÿæˆå™¨ (Testing API Generator)**ï¼š\n    *   è§£å†³äº‹ä»¶é©±åŠ¨ã€å¼‚æ­¥å·¥ä½œæµï¼ˆå¦‚æ¶ˆæ¯é˜Ÿåˆ—äº‹ä»¶ã€å»¶è¿Ÿä½œä¸šï¼‰çš„æµ‹è¯•éš¾é¢˜ã€‚\n    *   åœ¨ CI é˜¶æ®µæ ¹æ®äº‹ä»¶æˆ–ä½œä¸šæ¨¡å¼åˆ›å»º HTTP APIã€‚è¿™äº› API ä½œä¸ºåº•å±‚å¼‚æ­¥æµçš„åŒ…è£…å™¨ï¼Œå¹¶ä¸“é—¨æ³¨å†Œåœ¨æµ‹è¯•ç¯å¢ƒä¸­ã€‚\n    *   ä½¿è´Ÿè½½æµ‹è¯•å·¥å…·ï¼ˆå¦‚è´Ÿè½½ç”Ÿæˆå™¨ï¼‰èƒ½å¤Ÿå‘è¿™äº›åˆæˆ API å‘é€æµé‡ï¼Œä»è€Œä½¿å¼‚æ­¥æµåƒåŒæ­¥æµä¸€æ ·è¢«æ‰§è¡Œã€‚\n    *   ç›®æ ‡æ˜¯å¸®åŠ©å¼€å‘è€…è¯†åˆ«å¼‚æ­¥æµå®ç°ä¸­çš„æ€§èƒ½ç“¶é¢ˆå’Œæ½œåœ¨é—®é¢˜ï¼Œä»¥åŠåœ¨é«˜æµé‡æ¡ä»¶ä¸‹çš„è¡¨ç°ï¼Œé€šè¿‡ç»•è¿‡æ¶ˆæ¯é˜Ÿåˆ—ç­‰ä¸­é—´ä»¶ç»„ä»¶ï¼Œç®€åŒ–è´Ÿè½½æµ‹è¯•è¿‡ç¨‹ã€‚\n\n    ![å›¾ç‰‡ 6](https://cdn-images-1.medium.com/max/660/1*F3qllm7qqMu4N2k0bBFbdQ.png)\n    *å›¾ 5: å¼‚æ­¥æµçš„æµ‹è¯• API ç”Ÿæˆå™¨*\n\n## ä¸å…¶ä»–æµ‹è¯•æ¡†æ¶çš„é›†æˆ\nImpulse çš„æ¨¡å—åŒ–è®¾è®¡ä¿ƒè¿›äº†å…¶ä¸å…¶ä»–å†…éƒ¨æµ‹è¯•æ¡†æ¶ï¼ˆå¦‚é›†æˆæµ‹è¯•å’Œ API æµ‹è¯•ï¼‰çš„é›†æˆï¼Œä¸ºç³»ç»ŸæœåŠ¡æµ‹è¯•æä¾›äº†ç³»ç»ŸåŒ–çš„æ–¹æ³•ã€‚\n\n![å›¾ç‰‡ 7](https://cdn-images-1.medium.com/max/1024/1*649CFxbpASxHotVVbqdQkQ.png)\n*å›¾ 6: Impulse å¦‚ä½•ä¸ Airbnb å…¶ä»–å†…éƒ¨æµ‹è¯•æ¡†æ¶äº¤äº’*\n\n## ç»“è®º\nImpulse åŠå…¶å››ä¸ªæ ¸å¿ƒç»„ä»¶å¸®åŠ© Airbnb çš„å¼€å‘è€…è¿›è¡Œè‡ªåŠ©å¼è´Ÿè½½æµ‹è¯•ã€‚å®ƒå·²åœ¨å¤šä¸ªå®¢æˆ·æ”¯æŒåç«¯æœåŠ¡ä¸­å®æ–½ï¼Œå¹¶è·å¾—äº†ç§¯æåé¦ˆï¼Œä¾‹å¦‚ï¼šå®ƒå¸®åŠ©è¯†åˆ«å¹¶è§£å†³äº†çº¿ç¨‹æ± å‹åŠ›å¯¼è‡´çš„ `ApiClientThreadToolExhaustionException`ã€å®¢æˆ·ç«¯ API è°ƒç”¨ä¸­çš„å¶å‘è¶…æ—¶é”™è¯¯ä»¥åŠä¸»æœåŠ¡å®¹å™¨ä¸­çš„é«˜å†…å­˜ä½¿ç”¨é—®é¢˜ï¼Œä»è€Œä¼˜åŒ–äº†èµ„æºåˆ†é…ã€‚Impulse è¢«é«˜åº¦æ¨èä½œä¸ºå¼€å‘å’Œæµ‹è¯•æµç¨‹ä¸å¯æˆ–ç¼ºçš„ä¸€éƒ¨åˆ†ã€‚",
      "shortSummary": "Airbnb å¼€å‘äº† Impulseï¼Œä¸€ä¸ªå†…éƒ¨çš„â€œè´Ÿè½½æµ‹è¯•å³æœåŠ¡â€æ¡†æ¶ï¼Œæ—¨åœ¨å®ç°å¥å£®ã€çµæ´»å’Œå»ä¸­å¿ƒåŒ–çš„è‡ªåŠ©å¼è´Ÿè½½æµ‹è¯•ã€‚å®ƒåŒ…å«è´Ÿè½½ç”Ÿæˆå™¨ã€ä¾èµ–æ¨¡æ‹Ÿå™¨ã€æµé‡æ”¶é›†å™¨å’Œæµ‹è¯• API ç”Ÿæˆå™¨å››ä¸ªæ ¸å¿ƒç»„ä»¶ã€‚Impulse èƒ½å¤Ÿç”Ÿæˆä¸Šä¸‹æ–‡æ„ŸçŸ¥è´Ÿè½½ã€æ¨¡æ‹Ÿä¾èµ–ã€é‡æ”¾ç”Ÿäº§æµé‡å¹¶æµ‹è¯•å¼‚æ­¥å·¥ä½œæµã€‚é€šè¿‡ä¸ CI/CD æ— ç¼é›†æˆï¼ŒImpulse å¸®åŠ©å›¢é˜Ÿä¸»åŠ¨è¯†åˆ«å¹¶è§£å†³æ€§èƒ½ç“¶é¢ˆã€è¯„ä¼°ç³»ç»Ÿå®¹é‡ï¼Œä»è€Œæé«˜æœåŠ¡å¯é æ€§å’Œæ•ˆç‡ï¼Œå¹¶æœ€å¤§é™åº¦åœ°å‡å°‘æ‰‹åŠ¨å·¥ä½œã€‚",
      "translated_title": "åœ¨ Airbnb ä½¿ç”¨ Impulse è¿›è¡Œè´Ÿè½½æµ‹è¯•",
      "images": [
        {
          "url": "https://cdn-images-1.medium.com/max/1024/1*3LijjQrJDLVA_ptfeRe83g.jpeg",
          "alt": "",
          "title": "",
          "position": 1
        },
        {
          "url": "https://cdn-images-1.medium.com/max/1024/1*SFDblGijyiLQfI7C5RpPXw.png",
          "alt": "",
          "title": "",
          "position": 2
        },
        {
          "url": "https://cdn-images-1.medium.com/max/977/1*WD4EWyWHDQMf_7nDIGkAuA.png",
          "alt": "",
          "title": "",
          "position": 3
        },
        {
          "url": "https://cdn-images-1.medium.com/max/1024/1*QXMa3Nj3-aSUE_EOvlv1xw.png",
          "alt": "",
          "title": "",
          "position": 4
        },
        {
          "url": "https://cdn-images-1.medium.com/max/1024/1*EImg3JUEGzbos5r3_6U-FQ.png",
          "alt": "",
          "title": "",
          "position": 5
        }
      ],
      "contentSource": "RSS",
      "content": "<p>Comprehensive Load Testing with Load Generator, Dependency Mocker, Traffic Collector, andÂ More</p><figure><img alt=\"\" src=\"https://cdn-images-1.medium.com/max/1024/1*3LijjQrJDLVA_ptfeRe83g.jpeg\" /></figure><p>Authors: <a href=\"https://www.linkedin.com/in/chenhao-yang-9799b022/\">Chenhao Yang</a>, <a href=\"https://www.linkedin.com/in/haoyue-wang-a722509a/\">Haoyue Wang</a>, <a href=\"https://www.linkedin.com/in/xiaoyawei/\">Xiaoya Wei</a>, <a href=\"https://www.linkedin.com/in/zhijie-guan/\">Zay Guan</a>, <a href=\"https://www.linkedin.com/in/yaolin-chen-591a31339/\">Yaolin Chen</a> and <a href=\"https://www.linkedin.com/in/fei-yuan/\">FeiÂ Yuan</a></p><p>System-level load testing is crucial for reliability and efficiency. It identifies bottlenecks, evaluates capacity for peak traffic, establishes performance baselines, and detects errors. At a company of Airbnbâ€™s size and complexity, weâ€™ve learned that load testing needs to be robust, flexible, and decentralized. This requires the right set of tools to enable engineering teams to do self-service load tests that integrate seamlessly withÂ CI.</p><p>Impulse is one of our internal load-testing-as-a-service frameworks. It provides tools that can generate synthetic loads, mock dependencies, and collect traffic data from production environments. In this blog post, weâ€™ll share how Impulse is architected to minimize manual effort, seamlessly integrate with our observability stack, and empower teams to proactively address potential issues.</p><h3>Architecture</h3><p>Impulse is a comprehensive load testing framework that allows service owners to conduct context-aware load tests, mock dependencies, and collect traffic data to ensure the systemâ€™s performance under various conditions. It includes the following components:</p><ol><li><strong>Load generator</strong> to generate context-aware requests on the fly, for testing different scenarios with synthetic or collected traffic.</li><li><strong>Dependency mocker</strong> to mock the downstream responses with latency, so that the load testing on the service under test (SUT) doesnâ€™t need to involve certain dependent services. This is especially crucial when the dependencies are vendor services that donâ€™t support load testing, or if the team wants to regression load test their service during day-to-day deployment without affecting downstreams.</li><li><strong>Traffic collector</strong> to collect both the upstream and downstream traffic from the production environment, and then apply the resulting data to the test environment.</li><li><strong>Testing API generator</strong> to wrap asynchronous workflows into synchronous API calls for loadÂ testing.</li></ol><figure><img alt=\"\" src=\"https://cdn-images-1.medium.com/max/1024/1*SFDblGijyiLQfI7C5RpPXw.png\" /><figcaption>Figure 1: The Impulse framework and its four main components</figcaption></figure><p>Each of these four tools are independent, allowing service owners the flexibility to select one or more components for their load testingÂ needs.</p><h4>Load generator</h4><figure><img alt=\"\" src=\"https://cdn-images-1.medium.com/max/977/1*WD4EWyWHDQMf_7nDIGkAuA.png\" /><figcaption>Figure 2: Containerized load generator</figcaption></figure><p><em>Context aware</em></p><p>When load testing, requests made to the SUT often require some information from the previous response or need to be sent in a specific order. For example, if an update API needs to provide an <em>entity_id</em> to update, we must ensure the entity already exists in the testing environment context.</p><p>Our load generator tool allows users to write arbitrary testing logic in Java or Kotlin and launch containers to run these tests at scale against the SUT. Why write code instead of DSL/configuration logic?</p><ul><li>Flexibility: Programming languages are more expressive than DSL and can better support complex contextual scenarios.</li><li>Reusability: The same testing code can be used in other tests, e.g., integration tests.</li><li>Developer proficiency: Low/no learning curve to onboard, donâ€™t need to learn how to write testingÂ logic.</li><li>Developer experience: IDE support, testing, debugging, etc.</li></ul><p>Here is an example of synthetic context-aware testÂ case:</p><pre>class HelloWorldLoadGenerator : LoadGenerator {<br>   override suspend fun run() {<br>       val createdEntity = sutApiClient.create(CreateRequest(name=&quot;foo&quot;, ...)).data<br><br>       // request with id from previous response (context)<br>       val updateResponse = sutApiClient.update(UpdateRequest(id=createdEntity.id, name=&quot;bar&quot;))<br>       <br>       // ... other operations<br>       <br>       // clean up<br>       sutApiClient.delete(DeleteRequest(id=createdEntity.id))<br>   }<br>}</pre><p><em>Decentralized</em></p><p>The load generator is decentralized and containerized, which means each time a load test is triggered, a set of new containers will be created to run the test. This design has several benefits:</p><ul><li>Isolation: Load testing runs between different services are isolated from each other, eliminating any interference.</li><li>Scalability: The number of containers can be scaled up or down according to the traffic requirements.</li><li>Cost efficiency: The containers are short-lived, as they only exist during the load testingÂ run.</li></ul><p>Whatâ€™s more, as our services are cloud based, a subtle point is that the Impulse framework will evenly distribute the workers among all our data centers, and the load will be emitted evenly from all the workers. Impulseâ€™s load generator ensures the overall trigger per second (TPS) is as configured. Based on this, we can better leverage the locality settings in load balancers, which can better mimic the real traffic distribution in production.</p><p><em>Execution</em></p><p>The load generator is designed to be executed in the CI/CD pipeline, which means we can trigger load testing automatically. Developers can configure the testing spec in multiple phases, e.g., a warm up phase, a steady state phase, a peak phase, etc. Each phase can be configured with:</p><ul><li>Test cases toÂ run</li><li>TPS (trigger per second) of each testÂ case</li><li>Test duration</li></ul><h4>Dependency mocker</h4><figure><img alt=\"\" src=\"https://cdn-images-1.medium.com/max/1024/1*QXMa3Nj3-aSUE_EOvlv1xw.png\" /><figcaption>Figure 3: Dependency mocker</figcaption></figure><p>Impulse is a decentralized framework where each service has its own dependency mocker. This can eliminate interference between services and reduce communication costs. Each dependency mocker is an out-of-process service, which means the SUT behaves just as it does in production. We run the mockers in separate instances to avoid any impact on the performance of the SUT. The mock servers are all short livedâ€Šâ€”â€Šthey only start before tests run and shut down afterwards to save costs and maintenance effort. The response latency and exceptions are configurable and the number of mocker instances can be adjusted on demand to support large amounts ofÂ traffic.</p><p>Other noteworthy features:</p><ul><li>You can selectively stub some of the dependencies. Currently, stubbing is supported for HTTP JSON, Airbnb Thrift, and Airbnb GraphQL dependencies.</li><li>The dependency mockers support use cases beyond load testing. For instance, integration tests often rely on other services or third-party API calls, which may not guarantee a stable testing environment or might only support ideal scenarios. Dependency mockers can address this by offering predefined responses or exceptions to fully test thoseÂ flows.</li></ul><p>Impulse supports two options for generating mock responses:</p><ol><li>Synthetic response: The response is generated by user logic, as in integration testing; the difference is that the response comes from a remote (out-of-process) server with simulated latency.<br>- Similar to the load generator, the logic is written in Java/Kotlin code and contains request matching and response generation.<br>- Latency can be simulated using p95/p99Â metrics.</li><li>Replay response: The response is replayed from the production downstream recording, supported by the traffic collector component.</li></ol><p>Here is an example of a synthetic response with latency inÂ Kotlin:</p><pre>downstreamsMocking.every(<br>      thriftRequest&lt;FooRequest&gt;().having { it.message == &quot;hello&quot; }<br>    ).returns { request -&gt;<br>      ThriftDownstream.Response.thriftEncoded(<br>        HttpStatus.OK,<br>        FooResponse.builder.reply(&quot;${request.message} world&quot;).build()<br>      )<br>    }.with {<br>      delay = latencyFromP95(p95=500.miliseconds, min=200.miliseconds, max=2000.miliseconds)<br>    }</pre><h4>Traffic collector</h4><figure><img alt=\"\" src=\"https://cdn-images-1.medium.com/max/1024/1*EImg3JUEGzbos5r3_6U-FQ.png\" /><figcaption>Figure 4: Traffic collector</figcaption></figure><p>The traffic collector component is designed to capture both upstream and downstream traffic, along with the relationships between them. This approach allows Impulse to accurately replay production traffic during load testing, avoiding inconsistencies in downstream data or behavior. By replicating downstream responsesâ€Šâ€”â€Šincluding production-like latency and errorsâ€Šâ€”â€Švia the dependency mocker, the system ensures high-fidelity load testing. As a result, services in the testing environment behave identically to those in production, enabling more realistic and reliable performance evaluations.</p><h4>Testing API generator</h4><p>We rely heavily on event-driven, asynchronous workflows that are critical to our business operations. These include processing events from a message queue (MQ) and executing delayed jobs. Most of the MQ events/jobs are emitted from synchronous flows (e.g., API calls), so theoretically they can be covered by API load testing. However, the real world is more complex. These asynchronous flows often involve long chains of event and job emissions originating from various sources, making it difficult to replicate and test them accurately using only API-based methods.</p><p>To address this, the testing API generator component creates HTTP APIs during the CI stage according to the event or job schema. These APIs act as wrappers around the underlying asynchronous flows and are registered exclusively in the testing environment. This setup enables load testing toolsâ€Šâ€”â€Šsuch as load generatorsâ€Šâ€”â€Što send traffic to these synthetic APIs, allowing asynchronous flows to be exercised as if they were synchronous. As a result, itâ€™s possible to perform targeted, realistic load testing on asynchronous logic that would otherwise be hard to simulate.</p><figure><img alt=\"\" src=\"https://cdn-images-1.medium.com/max/660/1*F3qllm7qqMu4N2k0bBFbdQ.png\" /><figcaption>Figure 5: Testing API generator for asyncÂ flows</figcaption></figure><p>The goal of the testing API generator is to help developers identify performance bottlenecks and potential issues in their async flow implementations and under high traffic conditions. It does this by enabling direct load testing of async flows without involving middleware components like MQs. The rationale is that developers typically aim to evaluate the behavior of their own logic, not the middleware, which is usually already well-tested. By bypassing these components, this approach simplifies the load testing process and empowers developers to independently manage and execute their ownÂ tests.</p><h4>Integration with other testing frameworks</h4><p>Airbnb emphasizes product quality, utilizing versatile testing frameworks that cover integration and API tests across development, staging, and production environments, and integrate smoothly into CI/CD pipelines. The modular design of Impulse facilitates its integration with these frameworks, offering systematic serviceÂ testing.</p><figure><img alt=\"\" src=\"https://cdn-images-1.medium.com/max/1024/1*649CFxbpASxHotVVbqdQkQ.png\" /><figcaption>Figure 6: How Impulse interfaces with other internal testing frameworks</figcaption></figure><h3>Conclusion</h3><p>In this blog post, we shared how Impulse and its four core components help developers perform self-service load testing at Airbnb. As of this writing, Impulse has been implemented in several customer support backend services and is currently under review with different teams across the company who are planning to leverage Impulse to conduct loadÂ testing.</p><p>Weâ€™ve received a lot of good feedback in the process. For example: â€œ<em>Impulse helps us to identify and address potential issues in our service. During testing, it detected an ApiClientThreadToolExhaustionException caused by thread pool pressure. Additionally, it alerted us about occasional timeout errors in client API calls during service deployments. Impulse helped us identify high memory usage in the main service container, enabling us to fine-tune the memory allocation and optimize our serviceâ€™s resource usage. Highly recommend utilizing Impulse as an integral part of the development and testing processes.</em>â€</p><h3>Acknowledgments</h3><p>Thanks to Jeremy Werner, Yashar Mehdad, Raj Rajagopal, Claire Cheng, Tim L., Wei Ji, Jay Wu, Brian Wallace for support on the ImpulseÂ project.</p><p>Does this type of work interest you? Check out our open rolesÂ <a href=\"https://careers.airbnb.com/\">here</a>.</p><img src=\"https://medium.com/_/stat?event=post.clientViewed&referrerSource=full_rss&postId=f466874d03d2\" width=\"1\" height=\"1\" alt=\"\"><hr><p><a href=\"https://medium.com/airbnb-engineering/load-testing-with-impulse-at-airbnb-f466874d03d2\">Load Testing with Impulse at Airbnb</a> was originally published in <a href=\"https://medium.com/airbnb-engineering\">The Airbnb Tech Blog</a> on Medium, where people are continuing the conversation by highlighting and responding to this story.</p>"
    },
    {
      "title": "å¤§è§„æ¨¡å€¾å¬ã€å­¦ä¹ ä¸å¸®åŠ©ï¼šæœºå™¨å­¦ä¹ å¦‚ä½•æ”¹å˜çˆ±å½¼è¿çš„è¯­éŸ³æ”¯æŒä½“éªŒ (åŸæ ‡é¢˜: Listening, Learning, and Helping at Scale: How Machine Learning Transforms Airbnbâ€™s Voice Supportâ€¦)",
      "link": "https://medium.com/airbnb-engineering/listening-learning-and-helping-at-scale-how-machine-learning-transforms-airbnbs-voice-support-b71f912d4760?source=rss----53c7c27702d5---4",
      "pubDate": "Thu, 29 May 2025 17:29:46 GMT",
      "isoDate": "2025-05-29T17:29:46.000Z",
      "creator": "Yuanpei Cao",
      "summary": "# å¤§è§„æ¨¡å€¾å¬ã€å­¦ä¹ ä¸å¸®åŠ©ï¼šæœºå™¨å­¦ä¹ å¦‚ä½•æ”¹å˜çˆ±å½¼è¿çš„è¯­éŸ³æ”¯æŒä½“éªŒ\n\nçˆ±å½¼è¿è‡´åŠ›äºæä¾›æµç•…ã€ç›´è§‚ä¸”æœ‰å¸®åŠ©çš„ç¤¾åŒºæ”¯æŒä½“éªŒï¼Œæ— è®ºæ˜¯ååŠ©æˆ¿å®¢å¤„ç†é¢„è®¢å˜æ›´ï¼Œè¿˜æ˜¯å¸®åŠ©æˆ¿ä¸œè§£å†³æˆ¿æºé—®é¢˜ã€‚å°½ç®¡å¸®åŠ©ä¸­å¿ƒå’Œå®¢æœèŠå¤©æœºå™¨äººèƒ½é«˜æ•ˆè§£å†³è®¸å¤šå’¨è¯¢ï¼Œä½†éƒ¨åˆ†ç”¨æˆ·æ›´å€¾å‘äºä¸æ”¯æŒä»£è¡¨è¿›è¡Œå³æ—¶è¯­éŸ³å¯¹è¯ã€‚ä¸ºäº†ä½¿è¿™äº›äº’åŠ¨æ›´å¿«ã€æ›´æœ‰æ•ˆï¼Œçˆ±å½¼è¿é€šè¿‡æœºå™¨å­¦ä¹ æ˜¾è‘—æ”¹è¿›äº†å…¶äº¤äº’å¼è¯­éŸ³åº”ç­”ï¼ˆIVRï¼‰ç³»ç»Ÿã€‚\n\n## é‡æ–°æ„æƒ³è¯­éŸ³æ”¯æŒæ—…ç¨‹\n\nä¼ ç»Ÿçš„IVRç³»ç»Ÿé€šå¸¸ä¾èµ–äºåƒµç¡¬çš„èœå•æ ‘ï¼Œè¦æ±‚å‘¼å«è€…æŒ‰é”®å¹¶å¯¼èˆªé¢„è®¾è·¯å¾„ã€‚çˆ±å½¼è¿è®¾è®¡äº†ä¸€ä¸ªè‡ªé€‚åº”ã€ä¼šè¯å¼çš„IVRç³»ç»Ÿï¼Œèƒ½å¤Ÿå®æ—¶å€¾å¬ã€ç†è§£å’Œå“åº”ã€‚å½“å‘¼å«è€…è”ç³»çˆ±å½¼è¿æ”¯æŒæ—¶ï¼Œé€šå¸¸ä¼šå‘ç”Ÿä»¥ä¸‹æµç¨‹ï¼š\n\n1.  **å‘¼å«ä¸é—®å€™**ï¼šIVRæ¥å¬å¹¶æç¤ºï¼šâ€œè¯·ç”¨å‡ å¥è¯å‘Šè¯‰æˆ‘æ‚¨ä»Šå¤©è‡´ç”µçš„åŸå› ã€‚â€\n2.  **è‡ªåŠ¨è¯­éŸ³è¯†åˆ«ï¼ˆASRï¼‰**ï¼šå‘¼å«è€…çš„å›ç­”é€šè¿‡çˆ±å½¼è¿ä¸“ç”¨çš„ASRç³»ç»Ÿè½¬å½•æˆæ–‡æœ¬ï¼Œä¿ç•™å…³é”®çš„é¢†åŸŸç‰¹å®šæœ¯è¯­ã€‚\n3.  **ç†è§£æ„å›¾**ï¼šä¸€ä¸ªâ€œè”ç³»åŸå› æ£€æµ‹â€æ¨¡å‹å°†é—®é¢˜åˆ†ç±»ä¸ºå–æ¶ˆã€é€€æ¬¾ã€è´¦æˆ·é—®é¢˜ç­‰ç±»åˆ«ã€‚\n4.  **å†³ç­–åˆ¶å®š**ï¼š\n    *   å¦‚æœå¯ä»¥è‡ªåŠ©æœåŠ¡ï¼Œç³»ç»Ÿä¼šé€šè¿‡çŸ­ä¿¡æˆ–åº”ç”¨é€šçŸ¥å‘é€ç›¸å…³çš„å¸®åŠ©æ–‡ç« æˆ–æ™ºèƒ½å·¥ä½œæµç¨‹ã€‚\n    *   å¦‚æœå‘¼å«è€…æ˜ç¡®è¯·æ±‚ä»£ç†æ”¯æŒæˆ–é—®é¢˜éœ€è¦äººå·¥å¹²é¢„ï¼Œå‘¼å«å°†è·¯ç”±åˆ°å®¢æˆ·æ”¯æŒä»£ç†ï¼Œå¹¶é™„å¸¦ç›¸å…³è¯¦ç»†ä¿¡æ¯ã€‚\n5.  **æ¾„æ¸…å“åº”**ï¼šä¸€ä¸ªâ€œé‡Šä¹‰æ¨¡å‹â€ç”Ÿæˆç”¨æˆ·æ„å›¾çš„æ‘˜è¦ï¼ŒIVRåœ¨æä¾›è§£å†³æ–¹æ¡ˆä¹‹å‰ä¸ç”¨æˆ·åˆ†äº«ã€‚è¿™ç¡®ä¿ç”¨æˆ·ç†è§£ä»–ä»¬æ”¶åˆ°çš„èµ„æºçš„ä¸Šä¸‹æ–‡ã€‚\n6.  **è§£å†³æˆ–å‡çº§**ï¼šå‘¼å«è€…æ”¶åˆ°åŒ…å«ç›¸å…³çˆ±å½¼è¿å¸®åŠ©ä¸­å¿ƒæ–‡ç« é“¾æ¥çš„çŸ­ä¿¡æˆ–åº”ç”¨é€šçŸ¥ã€‚å¦‚æœéœ€è¦è¿›ä¸€æ­¥å¸®åŠ©ï¼Œä»–ä»¬å¯ä»¥æŒ‰0è¿æ¥å®¢æˆ·æœåŠ¡ä»£è¡¨ã€‚\n\né€šè¿‡ä»åƒµç¡¬çš„èœå•è½¬å‘è‡ªç„¶è¯­è¨€ç†è§£ï¼Œçˆ±å½¼è¿å…è®¸æˆ¿å®¢å’Œæˆ¿ä¸œç”¨è‡ªå·±çš„è¯è¡¨è¾¾é—®é¢˜ï¼Œä»è€Œæé«˜æ»¡æ„åº¦å’Œè§£å†³æ•ˆç‡ã€‚\n\n![çˆ±å½¼è¿IVRæ ¸å¿ƒæœåŠ¡ä¸æœºå™¨å­¦ä¹ ç»„ä»¶äº¤äº’çš„é«˜çº§æ¶æ„](https://cdn-images-1.medium.com/max/1024/1*4MMPeZJDlFDELNNSZ8dGPA.png)\n*å›¾1ï¼šçˆ±å½¼è¿IVRæ ¸å¿ƒæœåŠ¡å¦‚ä½•ä¸æ ¸å¿ƒæœºå™¨å­¦ä¹ ç»„ä»¶äº¤äº’ä»¥é€šè¿‡ç”µè¯è§£å†³ç”¨æˆ·é—®é¢˜çš„é«˜çº§æ¶æ„ã€‚*\n\n## æœºå™¨å­¦ä¹ é©±åŠ¨çš„IVRç³»ç»Ÿæ ¸å¿ƒç»„ä»¶\n\nçˆ±å½¼è¿çš„IVRç³»ç»Ÿç”±ä»¥ä¸‹å…³é”®æœºå™¨å­¦ä¹ ç»„ä»¶é©±åŠ¨ï¼š\n\n### 1. è‡ªåŠ¨è¯­éŸ³è¯†åˆ«ï¼ˆASRï¼‰ï¼šç²¾å‡†è½¬å½•\n\nåœ¨è¯­éŸ³é©±åŠ¨çš„æ”¯æŒç³»ç»Ÿä¸­ï¼Œå®ç°é«˜è½¬å½•å‡†ç¡®æ€§è‡³å…³é‡è¦ï¼Œå°¤å…¶æ˜¯åœ¨å˜ˆæ‚çš„ç”µè¯ç¯å¢ƒä¸­ã€‚é€šç”¨è¯­éŸ³è¯†åˆ«æ¨¡å‹åœ¨å¤„ç†çˆ±å½¼è¿ç‰¹å®šæœ¯è¯­æ—¶å¸¸é‡åˆ°å›°éš¾ã€‚ä¸ºäº†æé«˜ASRå‡†ç¡®æ€§ï¼Œçˆ±å½¼è¿ï¼š\n\n*   ä»é€šç”¨é¢„è®­ç»ƒæ¨¡å‹è½¬å‘ä¸“é—¨ä¸ºå˜ˆæ‚ç”µè¯éŸ³é¢‘è°ƒæ•´çš„æ¨¡å‹ã€‚\n*   å¼•å…¥äº†é¢†åŸŸç‰¹å®šçŸ­è¯­åˆ—è¡¨ä¼˜åŒ–ï¼Œç¡®ä¿çˆ±å½¼è¿æœ¯è¯­è¢«æ­£ç¡®è¯†åˆ«ã€‚\n*   ç»“æœï¼šè¯é”™è¯¯ç‡ï¼ˆWERï¼‰ä»33%æ˜¾è‘—é™ä½åˆ°çº¦10%ã€‚è¿™æé«˜äº†ä¸‹æ¸¸å¸®åŠ©æ–‡ç« æ¨èçš„å‡†ç¡®æ€§ï¼Œå¢åŠ äº†ç”¨æˆ·å‚ä¸åº¦ï¼Œæ”¹å–„äº†ä¸ASRèœå•äº¤äº’ç”¨æˆ·çš„å®¢æˆ·NPSï¼ŒåŒæ—¶å‡å°‘äº†å¯¹äººå·¥ä»£ç†çš„ä¾èµ–å¹¶ç¼©çŸ­äº†å®¢æˆ·æœåŠ¡å¤„ç†æ—¶é—´ã€‚\n\n### 2. è”ç³»åŸå› é¢„æµ‹ï¼šç†è§£â€œä¸ºä»€ä¹ˆâ€\n\nè½¬å½•å‘¼å«è€…é™ˆè¿°åï¼Œä¸‹ä¸€æ­¥æ˜¯è¯†åˆ«å…¶æ„å›¾ã€‚çˆ±å½¼è¿é€šè¿‡åˆ›å»ºè¯¦ç»†çš„â€œè”ç³»åŸå› åˆ†ç±»æ³•â€æ¥å®ç°è¿™ä¸€ç‚¹ï¼Œè¯¥åˆ†ç±»æ³•æ¶µç›–äº†æ‰€æœ‰æ½œåœ¨çš„çˆ±å½¼è¿å’¨è¯¢ã€‚ä¸€ä¸ªæ„å›¾æ£€æµ‹æ¨¡å‹å°†å‘¼å«åˆ†ç±»åˆ°ç›¸åº”çš„â€œè”ç³»åŸå› â€ç±»åˆ«ã€‚\n\n*   **éƒ¨ç½²**ï¼šåœ¨ç”Ÿäº§ç¯å¢ƒä¸­ï¼Œçˆ±å½¼è¿éƒ¨ç½²äº†â€œé—®é¢˜æ£€æµ‹æœåŠ¡â€æ¥æ‰˜ç®¡æ„å›¾æ£€æµ‹æ¨¡å‹ï¼Œå¹¶è¡Œè¿è¡Œä»¥å®ç°æœ€ä½³çš„å¯æ‰©å±•æ€§ã€çµæ´»æ€§å’Œæ•ˆç‡ã€‚å¹³å‡æ„å›¾æ£€æµ‹å»¶è¿Ÿä¿æŒåœ¨50æ¯«ç§’ä»¥ä¸‹ï¼Œç¡®ä¿äº†æ— ç¼çš„å®æ—¶ä½“éªŒã€‚\n*   **ç‰¹æ®Šæƒ…å†µ**ï¼šå¯¹äºå‘¼å«è€…æ˜ç¡®è¦æ±‚ä¸äººå·¥ä»£ç†é€šè¯çš„æƒ…å†µï¼Œç³»ç»Ÿä½¿ç”¨ä¸åŒçš„æ„å›¾æ£€æµ‹æ¨¡å‹æ¥è¯†åˆ«æ­¤æ„å›¾ï¼Œå¹¶å°†å‘¼å«è·¯ç”±åˆ°åˆé€‚çš„å›¢é˜Ÿã€‚\n\n![æ„å›¾æ£€æµ‹æ¶æ„å’Œé—®é¢˜æ£€æµ‹æœåŠ¡](https://cdn-images-1.medium.com/max/1024/0*oj7NCOlBGYOnNBOx)\n*å›¾2ï¼šæ„å›¾æ£€æµ‹æ¶æ„å’Œé—®é¢˜æ£€æµ‹æœåŠ¡ã€‚*\n\n### 3. å¸®åŠ©æ–‡ç« æ£€ç´¢ï¼šæä¾›æ­£ç¡®ä¿¡æ¯\n\nè®¸å¤šå¸¸è§çš„çˆ±å½¼è¿é—®é¢˜å¯ä»¥é€šè¿‡æä¾›æ¸…æ™°ã€ç›¸å…³çš„æ•™è‚²ä¿¡æ¯å¿«é€Ÿè§£å†³ã€‚çˆ±å½¼è¿ä½¿ç”¨â€œå¸®åŠ©æ–‡ç« æ£€ç´¢å’Œæ’åç³»ç»Ÿâ€æ¥è‡ªåŠ¨è¯†åˆ«ç”¨æˆ·æŸ¥è¯¢ä¸­çš„é—®é¢˜ï¼Œå¹¶é€šè¿‡çŸ­ä¿¡å’Œçˆ±å½¼è¿åº”ç”¨é€šçŸ¥å‘é€æœ€ç›¸å…³çš„å¸®åŠ©æ–‡ç« é“¾æ¥ã€‚è¯¥è¿‡ç¨‹åŒ…å«ä¸¤ä¸ªæœºå™¨å­¦ä¹ é˜¶æ®µï¼š\n\n*   **è¯­ä¹‰æ£€ç´¢å’Œæ’å**ï¼šå°†çˆ±å½¼è¿å¸®åŠ©æ–‡ç« åµŒå…¥ç´¢å¼•åˆ°å‘é‡æ•°æ®åº“ä¸­ï¼Œä½¿ç”¨ä½™å¼¦ç›¸ä¼¼åº¦é«˜æ•ˆæ£€ç´¢å¤šè¾¾30ç¯‡ç›¸å…³æ–‡ç« ï¼ˆé€šå¸¸åœ¨60æ¯«ç§’å†…ï¼‰ã€‚ä¸€ä¸ªåŸºäºLLMçš„æ’åæ¨¡å‹éšåå¯¹è¿™äº›æ£€ç´¢åˆ°çš„æ–‡ç« è¿›è¡Œé‡æ–°æ’åï¼Œå°†æ’åæœ€é«˜çš„æ–‡ç« ç›´æ¥å‘ˆç°ç»™ç”¨æˆ·ã€‚\n*   **æ•ˆæœ**ï¼šè¯¥åŒé˜¶æ®µç³»ç»Ÿä¸ä»…æ”¯æŒIVRäº’åŠ¨ï¼Œè¿˜æ”¯æŒå®¢æˆ·æ”¯æŒèŠå¤©æœºå™¨äººå’Œå¸®åŠ©ä¸­å¿ƒæœç´¢ã€‚å…¶æœ‰æ•ˆæ€§é€šè¿‡Precision@Nç­‰æŒ‡æ ‡æŒç»­è¯„ä¼°ã€‚\n\n![å¸®åŠ©æ–‡ç« æ£€ç´¢å’Œæ’åç³»ç»Ÿæ¶æ„å›¾](https://cdn-images-1.medium.com/max/1024/1*wlkl-CT0czyGqNdKx-ffIw.png)\n*å›¾3ï¼šå¸®åŠ©æ–‡ç« æ£€ç´¢å’Œæ’åç³»ç»Ÿæ¶æ„å›¾ã€‚*\n\n### 4. é‡Šä¹‰æ¨¡å‹ï¼šå¢å¼ºç”¨æˆ·ç†è§£\n\nIVRå®¢æˆ·æ”¯æŒçš„ä¸€ä¸ªå…³é”®æŒ‘æˆ˜æ˜¯ç¡®ä¿ç”¨æˆ·åœ¨æ¥æ”¶å¸®åŠ©æ–‡ç« é“¾æ¥ä¹‹å‰æ¸…æ¥šç†è§£è§£å†³æ–¹æ¡ˆã€‚ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œçˆ±å½¼è¿å®æ–½äº†ä¸€ç§è½»é‡çº§çš„é‡Šä¹‰æ–¹æ³•ï¼Œåˆ©ç”¨ä¸€ç»„ç²¾é€‰çš„æ ‡å‡†åŒ–æ‘˜è¦ã€‚\n\n*   **å®ç°**ï¼šUXæ’°ç¨¿äººåˆ›å»ºäº†å¸¸è§çˆ±å½¼è¿åœºæ™¯çš„ç®€æ´æ˜äº†çš„é‡Šä¹‰ã€‚åœ¨çº¿æœåŠ¡æ—¶ï¼Œç”¨æˆ·æŸ¥è¯¢é€šè¿‡åŸºäºæ–‡æœ¬åµŒå…¥ç›¸ä¼¼åº¦çš„æœ€è¿‘é‚»åŒ¹é…æ˜ å°„åˆ°è¿™äº›ç²¾é€‰æ‘˜è¦ã€‚\n*   **æ•ˆæœ**ï¼šæ‰‹åŠ¨è¯„ä¼°ç«¯åˆ°ç«¯æ¨¡å‹è¾“å‡ºè¯å®ç²¾åº¦è¶…è¿‡90%ã€‚åœ¨é’ˆå¯¹è”ç³»å®¢æˆ·æ”¯æŒçš„è‹±è¯­æˆ¿ä¸œè¿›è¡Œçš„å®éªŒä¸­ï¼Œåœ¨å‘é€æ–‡ç« é“¾æ¥å‰å‘ˆç°é‡Šä¹‰æ‘˜è¦å¢åŠ äº†ç”¨æˆ·å¯¹æ–‡ç« å†…å®¹çš„å‚ä¸åº¦ï¼Œä»è€Œæé«˜äº†è‡ªåŠ©è§£å†³ç‡ï¼Œå‡å°‘äº†å¯¹ç›´æ¥å®¢æˆ·æ”¯æŒååŠ©çš„éœ€æ±‚ã€‚\n\n## ç»“è®º\n\né€šè¿‡ç»“åˆè‡ªåŠ¨è¯­éŸ³è¯†åˆ«ã€è”ç³»åŸå› æ£€æµ‹ç³»ç»Ÿã€å¸®åŠ©æ–‡ç« æ£€ç´¢ç³»ç»Ÿå’Œé‡Šä¹‰æ¨¡å‹ï¼Œçˆ±å½¼è¿åˆ›å»ºäº†ä¸€ä¸ªIVRç³»ç»Ÿï¼Œè¯¥ç³»ç»Ÿç®€åŒ–äº†æ”¯æŒäº’åŠ¨å¹¶æé«˜äº†ç”¨æˆ·æ»¡æ„åº¦ã€‚è¯¥è§£å†³æ–¹æ¡ˆä½¿å‘¼å«è€…èƒ½å¤Ÿè‡ªç„¶åœ°æè¿°é—®é¢˜ï¼Œå‡å°‘äº†å¸¸è§æŸ¥è¯¢å¯¹äººå·¥ä»£ç†çš„ä¾èµ–ï¼Œå¹¶é€šè¿‡è‡ªåŠ©æœåŠ¡æä¾›å³æ—¶ã€ç›¸å…³çš„æ”¯æŒã€‚å½“éœ€è¦äººå·¥ååŠ©æ—¶ï¼Œç³»ç»Ÿé€šè¿‡å°†ç”¨æˆ·è·¯ç”±åˆ°åˆé€‚çš„ä»£ç†å¹¶æä¾›å¿…è¦çš„ä¸Šä¸‹æ–‡ï¼Œç¡®ä¿äº†å¹³ç¨³çš„è¿‡æ¸¡ã€‚\n\n![å›¾ç‰‡ 1](https://cdn-images-1.medium.com/max/1024/1*zyT9hDwGkSCvZ-wKEx669w.jpeg)",
      "shortSummary": "çˆ±å½¼è¿åˆ©ç”¨æœºå™¨å­¦ä¹ å½»åº•æ”¹é€ å…¶è¯­éŸ³æ”¯æŒï¼ˆIVRï¼‰ç³»ç»Ÿã€‚é€šè¿‡æ™ºèƒ½IVRï¼Œç”¨æˆ·å¯ä»¥è‡ªç„¶è¡¨è¾¾é—®é¢˜ï¼Œç³»ç»Ÿé€šè¿‡è‡ªåŠ¨è¯­éŸ³è¯†åˆ«ï¼ˆASRï¼‰ã€æ„å›¾æ£€æµ‹ã€å¸®åŠ©æ–‡ç« æ£€ç´¢å’Œé‡Šä¹‰æ¨¡å‹æä¾›è‡ªåŠ©æœåŠ¡æˆ–æ™ºèƒ½è·¯ç”±ã€‚è¿™æ˜¾è‘—æé«˜äº†æ”¯æŒæ•ˆç‡å’Œç”¨æˆ·æ»¡æ„åº¦ï¼Œå‡å°‘äº†å¯¹äººå·¥ä»£ç†çš„ä¾èµ–ï¼Œå¹¶ç¡®ä¿äº†éœ€è¦æ—¶ä¸åˆé€‚ä»£ç†çš„æ— ç¼è¿æ¥ã€‚",
      "translated_title": "å¤§è§„æ¨¡å€¾å¬ã€å­¦ä¹ ä¸å¸®åŠ©ï¼šæœºå™¨å­¦ä¹ å¦‚ä½•æ”¹å˜çˆ±å½¼è¿çš„è¯­éŸ³æ”¯æŒä½“éªŒ",
      "images": [
        {
          "url": "https://cdn-images-1.medium.com/max/1024/1*zyT9hDwGkSCvZ-wKEx669w.jpeg",
          "alt": "",
          "title": "",
          "position": 1
        },
        {
          "url": "https://cdn-images-1.medium.com/max/1024/1*4MMPeZJDlFDELNNSZ8dGPA.png",
          "alt": "",
          "title": "",
          "position": 2
        },
        {
          "url": "https://cdn-images-1.medium.com/max/1024/0*oj7NCOlBGYOnNBOx",
          "alt": "",
          "title": "",
          "position": 3
        },
        {
          "url": "https://cdn-images-1.medium.com/max/1024/1*wlkl-CT0czyGqNdKx-ffIw.png",
          "alt": "",
          "title": "",
          "position": 4
        },
        {
          "url": "https://medium.com/_/stat?event=post.clientViewed&referrerSource=full_rss&postId=b71f912d4760",
          "alt": "",
          "title": "",
          "position": 5
        }
      ],
      "contentSource": "RSS",
      "content": "<h3><strong>Listening, Learning, and Helping at Scale: How Machine Learning Transforms Airbnbâ€™s Voice Support Experience</strong></h3><p>A look into how Airbnb uses speech recognition, intent detection, and language models to understand users and assist agents more effectively.</p><p><em>By </em><a href=\"https://www.linkedin.com/in/yuanpei-cao-792b103b/\"><em>Yuanpei Cao</em></a><em>, </em><a href=\"https://www.linkedin.com/in/heng-j-1a44a711/\"><em>H</em>eng Ji</a><em>, </em><a href=\"https://www.linkedin.com/in/elaineliu5/\"><em>Elaine Liu</em></a><em>, </em><a href=\"https://www.linkedin.com/in/peng-wang-13117371/\"><em>Peng Wang</em></a><em>, and </em><a href=\"https://www.linkedin.com/in/tiantian-zhang-a4208726/\"><em>TiantianÂ Zhang</em></a></p><figure><img alt=\"\" src=\"https://cdn-images-1.medium.com/max/1024/1*zyT9hDwGkSCvZ-wKEx669w.jpeg\" /></figure><p>At Airbnb, we aim to provide a smooth, intuitive, and helpful community support experience, whether itâ€™s helping a guest navigate a booking change or helping a host with a listing issue. While our Help Center and customer support chatbot helps resolve many inquiries efficiently, some users prefer the immediacy of a voice conversation with a support representative. To make these interactions faster and more effective, weâ€™ve significantly improved our Interactive Voice Response (IVR) system via machine learning.</p><p>Over the years, Airbnb has invested in conversational AI to enhance customer support. In our previous blog posts <a href=\"https://medium.com/airbnb-engineering/task-oriented-conversational-ai-in-airbnb-customer-support-5ebf49169eaa\"><em>Task-Oriented Conversational AI in Airbnb Customer Support</em></a> and<a href=\"https://medium.com/airbnb-engineering/using-chatbots-to-provide-faster-covid-19-community-support-567c97c5c1c9\"> <em>Using Chatbots to Provide Faster COVID-19 Community Support</em></a>, we explored how AI-driven chatbots streamline guest and host interactions through automated messaging. This post explains how we extend that work to voice-based support, leveraging machine learning to improve real-time phone interactions with our intelligent IVRÂ system.</p><p>Weâ€™ll take you through the end-to-end IVR journey, the key machine learning components that power it, and how we designed a system that delivers faster, more human-like, and more intuitive voice support for our community.</p><h3>Reimagining the voice supportÂ journey</h3><p>Traditional IVR systems often rely on rigid menu trees, requiring callers to press buttons and navigate pre-set paths. Instead, we designed an adaptive, conversational IVR that listens, understands, and responds in real time. Hereâ€™s normally what happens when a caller reaches out to AirbnbÂ support:</p><ol><li><strong>Call and greeting: </strong>IVR picks up and prompts, <em>â€œIn a few sentences, please tell us why youâ€™re callingÂ today.â€</em></li><li><strong>Automated speech recognition (ASR):</strong> The callerâ€™s response is transcribed with Airbnb-specific ASR. For example, if a caller says, <em>â€œI need to request a refund for my reservation,â€</em> ASR accurately converts this speech into text, preserving key domain-specific terms.</li><li><strong>Understanding intent:</strong> A Contact Reason Detection model classifies the issue into a category like cancellations, refunds, account issues,Â etc.</li><li><strong>Decision-making:</strong> If self-service is possible, the system retrieves and sends a relevant help article or an intelligent workflow via SMS or app notification. If the caller explicitly requests agent support or the issue requires human intervention, the call is routed to a customer support agent with relevant details attached.</li><li><strong>Clarifying response:</strong> A Paraphrasing model generates a summary of the user intent, which IVR shares with the user before delivering the solution. This ensures that users understand the context of the resource they receive. Continuing our example, the system would respond, â€œ<em>I understand your issue is regarding a refund request.</em> <em>We have sent you a link to resources about this topic. Follow the instructions to find answers. If you need to speak with an agent, press 0 to be connected to our customer service representative.</em>â€ The underscored Paraphrasing component enhances engagement by bridging the gap between system-generated responses and user comprehension, making the self-service experience more intuitive.</li><li><strong>Resolution or escalation:</strong> The caller receives an SMS or app notification with a direct link to a relevant <a href=\"https://www.airbnb.com/help\">Airbnb Help Center</a> article. If further assistance is needed, they can press 0 to connect with a customer service representative.</li></ol><p>By moving away from rigid menus to natural language understanding, we allow guests and hosts to express their issues in their own words, helping to increase satisfaction and resolution efficiency.</p><figure><img alt=\"\" src=\"https://cdn-images-1.medium.com/max/1024/1*BNyYIWtMRorDGJ935DcQJw.png\" /><figcaption>Figure 1: High-level architecture of how Airbnb IVR Core Service interacts with core machine learning components to resolve user issues over theÂ phone.</figcaption></figure><h3>Breaking down our ML-powered IVRÂ system</h3><h4>1. Automated speech recognition (ASR): transcribing with precision</h4><p>In a voice-driven support system, achieving high transcription accuracy is essential, particularly in noisy phone environments where speech can be unclear. General speech recognition models often struggle with Airbnb-specific terminology, leading to errors like misinterpreting â€œlistingâ€ as â€œliftingâ€ or â€œhelp with my stayâ€ as â€œhappy Christmas Day.â€ These inaccuracies create challenges in understanding user intent and impact downstream processes.</p><p>To enhance ASR accuracy, we transitioned from a generic high-quality pretrained model to one specifically adapted for noisy phone audio. Additionally, we introduced a domain-specific phrase list optimization that ensures Airbnb terms are properly recognized. Based on a sample of hundreds of clips, this significantly <strong>reduced the word error rate (WER) from 33% to approximately 10%</strong>. The reduced WER significantly enhanced the accuracy of downstream help article recommendations, increasing user engagement, improving customer NPS among users who interacted with the ASR menu, while reducing reliance on human agents and lowering customer service handlingÂ time.</p><h4>2. Contact Reason prediction: understanding theÂ why</h4><p>After transcribing the callerâ€™s statements, the next step involves identifying their intent. We accomplished this by creating a detailed Contact Reason taxonomy that categorizes all potential Airbnb inquiries, as elaborated in â€œ<a href=\"https://medium.com/airbnb-engineering/t-leaf-taxonomy-learning-and-evaluation-framework-30ae19ce8c52\">T-LEAF: Taxonomy Learning and EvaluAtion Framework</a>.â€ We then use an intent detection model to classify calls into a Contact Reason category, ensuring each inquiry is handled appropriately. For example, if a caller mentions â€œI havenâ€™t received my refund yet,â€ the model predicts the Contact Reason as Missing Refund and forwards it to the relevant downstream components.</p><p>In production, we deploy the Issue Detection Service to host the intent detection models, running them in parallel to achieve optimal scalability, flexibility, and efficiency. Parallel computing ensures that intent detection <strong>latency remains under 50ms on average</strong>, making the process imperceptible to IVR users and ensuring a seamless real-time experience. The detected intent is then analyzed within the IVR workflow to determine the next action, whether itâ€™s guiding the user through a self-service resolution or escalating directly to a humanÂ agent.</p><p>Occasionally, callers prefer to speak directly with a human agent instead of describing their issues, using terms like â€œagentâ€ or â€œescalation.â€ For such scenarios, we use a different intent detection model to recognize when a caller wants to escalate to a human agent. If this intent is detected, the IVR system honors the callerâ€™s request and routes the call to the suitable supportÂ team.</p><figure><img alt=\"\" src=\"https://cdn-images-1.medium.com/max/1024/1*Q7LxFhZitCrNdqKAy_ffOw.png\" /><figcaption>Figure 2. Intent detection architecture and Issue Detection Service.</figcaption></figure><h4>3. Help article retrieval: delivering the right information</h4><p>Many common Airbnb issues can be quickly resolved by providing clear and relevant educational information. To help provide useful information to users and minimize the need for human customer support, we use the Help Article Retrieval and Ranking system. This advanced system automatically identifies the issue in a userâ€™s inquiry and delivers the most relevant help article link via SMS text message and Airbnb app notification. Our process incorporates two machine learningÂ stages.</p><p><strong>Semantic retrieval and ranking:</strong> We index Airbnb Help Article embeddings into a vector database, enabling efficient retrieval of up to 30 relevant articles per user query using cosine similarity, typically within 60ms. An LLM-based ranking model then re-ranks these retrieved articles, with the top-ranked article directly presented to users via IVR channels. This dual-stage system not only powers IVR interactions but also supports our customer support chatbot and Help Center search. Across these platforms, its effectiveness is continuously evaluated using metrics like Precision@N, facilitating ongoing improvements and refinements.</p><figure><img alt=\"\" src=\"https://cdn-images-1.medium.com/max/1024/1*wlkl-CT0czyGqNdKx-ffIw.png\" /><figcaption>Figure 3. Architecture diagram for the Help Article Retrieval and RankingÂ system.</figcaption></figure><h4>4. Paraphrasing model: enhancing user understanding</h4><p>A key challenge in IVR-based customer support is ensuring users clearly understand the resolution before receiving help article links, as they typically lack visibility into the articleâ€™s contents or title. To address this, we implemented a lightweight paraphrasing approach leveraging a curated set of standardized summaries.</p><p>UX writers created concise and clear paraphrases for common Airbnb scenarios. During online serving, user inquiries are mapped to these curated summaries via nearest-neighbor matching based on text embedding similarity. We calibrated a similarity threshold to ensure high-quality matches. Manual evaluation of end-to-end model outputs confirmed precision exceeding 90%.</p><p>The outcome was a finite-state solution delivering the most appropriate paraphrased IVR prompt before presenting a help article link. For example, if a caller states, â€œI need to cancel my reservation and request a refund,â€ the model generates a response like â€œI understand your issue is about a refund requestâ€ before sending the retrieved help articleÂ link.</p><p>Integrating this model ensures users receive clear, contextually relevant summaries prior to accessing help articles. In an experiment targeting English hosts who contacted customer support, we found that presenting a paraphrased summary before sending the article link increases user engagement with article content, resulting in improvement in self-resolution rates, helping to reduce the need for direct customer support assistance.</p><h3>Conclusion</h3><p>By combining Automated Speech Recognition and Contact Reason Detection systems with a help article retrieval system, and a paraphrasing model, we have created an IVR system that streamlines support interactions and improves user satisfaction. Our solution enables callers to describe issues naturally, reduces dependency on human agents for common inquiries, and provides instant, relevant support through self-service. When human assistance is necessary, the system ensures a smooth transition by routing users to the right agent with essential context.</p><p>Interested in working at Airbnb? Check out our <a href=\"https://careers.airbnb.com/\">openÂ roles</a>.</p><h3><strong>Acknowledgements</strong></h3><p>Thanks to Zhenyu Zhao, Mia Zhao, Wayne Zhang, Lucca Siaudzionis, Lulu Chen, Sukey Xu, Floria Wan, Michael Zhou, Can Yang, Yaolin Chen, Shuaihu Wang, Huifan Qu, Ming Shang,Yu Jiang, Wanting Chen, Elena Zhao, Shanna Su, Cassie Cao, Hao Wang, Haoran Zhu, Xirui Liu, Ying Tan, Xiaohan Zeng, Xiaoyu Meng, Gavin Li, Gaurav Rai, Hemanth Kolla, Ihor Hordiienko, Matheus Scharf, and Stepan Sydoruk who helped bring this vision to life. Also thanks to Paige Schwartz, Stephanie Chu, Neal Cohen, Becky Ajuonuma, Iman Saleh, Dani Normanm, Javier Salido, and Lauren Mackevich for the review andÂ editing.</p><p>Thanks to Jeremy Werner, Joy Zhang, Claire Cheng, Yashar Mehdad, Shuohao Zhang, Shawn Yan, Kelvin Xiong, Michael Lubavin, Teng Wang, Wei Ji, and Chenhao Yangâ€™s leadership support on building conversational AI products atÂ Airbnb.</p><img src=\"https://medium.com/_/stat?event=post.clientViewed&referrerSource=full_rss&postId=b71f912d4760\" width=\"1\" height=\"1\" alt=\"\"><hr><p><a href=\"https://medium.com/airbnb-engineering/listening-learning-and-helping-at-scale-how-machine-learning-transforms-airbnbs-voice-support-b71f912d4760\">Listening, Learning, and Helping at Scale: How Machine Learning Transforms Airbnbâ€™s Voice Supportâ€¦</a> was originally published in <a href=\"https://medium.com/airbnb-engineering\">The Airbnb Tech Blog</a> on Medium, where people are continuing the conversation by highlighting and responding to this story.</p>"
    }
  ],
  "lastUpdated": "2025-10-15T04:33:34.271Z"
}