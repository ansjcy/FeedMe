{
  "sourceUrl": "https://medium.com/feed/airbnb-engineering",
  "title": "The Airbnb Tech Blog - Medium",
  "description": "Creative engineers and data scientists building a world where you can belong anywhere. http://airbnb.io - Medium",
  "link": "https://medium.com/airbnb-engineering?source=rss----53c7c27702d5---4",
  "items": [
    {
      "title": "å°†Airbnbçš„JVMå•ä½“ä»“åº“è¿ç§»åˆ°Bazel (åŸæ ‡é¢˜: Migrating Airbnbâ€™s JVM Monorepo to Bazel)",
      "link": "https://medium.com/airbnb-engineering/migrating-airbnbs-jvm-monorepo-to-bazel-33f90eda51ec?source=rss----53c7c27702d5---4",
      "pubDate": "Wed, 13 Aug 2025 17:01:58 GMT",
      "isoDate": "2025-08-13T17:01:58.000Z",
      "creator": "Thomas Bao",
      "summary": "# å°†Airbnbçš„JVMå•ä½“ä»“åº“è¿ç§»åˆ°Bazel\n\nAirbnbè¿‘æœŸæˆåŠŸå°†å…¶æœ€å¤§çš„ä»£ç ä»“åº“â€”â€”JVMå•ä½“ä»“åº“è¿ç§»åˆ°äº†Bazelæ„å»ºç³»ç»Ÿã€‚è¯¥ä»“åº“åŒ…å«æ•°åƒä¸‡è¡ŒJavaã€Kotlinå’ŒScalaä»£ç ï¼Œä¸ºairbnb.comèƒŒåçš„ä¼—å¤šåç«¯æœåŠ¡å’Œæ•°æ®ç®¡é“æä¾›æ”¯æŒã€‚\n\n![å›¾ç‰‡ 1](https://cdn-images-1.medium.com/max/1024/1*rSkIrKYhc8Bwcv2xLE1mxA.jpeg)\n\n**è¿ç§»æˆæœæ¦‚è§ˆï¼ˆå†æ—¶4.5å¹´ï¼‰ï¼š**\n*   æ„å»ºCSATï¼ˆå®¢æˆ·æ»¡æ„åº¦ï¼‰ï¼šä»38%æå‡è‡³68%\n*   æœ¬åœ°æ„å»ºå’Œæµ‹è¯•æ—¶é—´ï¼šæé€Ÿ3-5å€\n*   IntelliJåŒæ­¥æ—¶é—´ï¼šæé€Ÿ2-3å€\n*   éƒ¨ç½²åˆ°å¼€å‘ç¯å¢ƒæ—¶é—´ï¼šæé€Ÿ2-3å€\n\næœ¬æ–‡å°†æ¢è®¨è¿ç§»çš„åŸå› ã€åˆ†äº«å…³é”®çš„å®æ–½äº®ç‚¹ï¼Œå¹¶æ€»ç»“ä¸»è¦ç»éªŒæ•™è®­ã€‚\n\n## ä¸ºä»€ä¹ˆé€‰æ‹©Bazelï¼Ÿ\n\nåœ¨è¿ç§»ä¹‹å‰ï¼ŒJVMå•ä½“ä»“åº“ä½¿ç”¨Gradleä½œä¸ºæ„å»ºç³»ç»Ÿã€‚é€‰æ‹©è¿ç§»åˆ°Bazelæ˜¯å› ä¸ºå®ƒæä¾›äº†ä¸‰å¤§æ ¸å¿ƒä¼˜åŠ¿ï¼šé€Ÿåº¦ã€å¯é æ€§å’Œç»Ÿä¸€çš„æ„å»ºåŸºç¡€è®¾æ–½å±‚ã€‚\n\n### 1. é€Ÿåº¦\n\nBazelçš„å¯ç¼“å­˜ã€å¯ç§»æ¤æ“ä½œå…è®¸é€šè¿‡è¿œç¨‹æ‰§è¡Œæ‰©å±•æ€§èƒ½ã€‚\n*   **Gradleçš„å±€é™æ€§ï¼š** 2021å¹´ï¼Œå¤§å‹æœåŠ¡çš„æœ¬åœ°æ„å»ºé€šå¸¸éœ€è¦20å¤šåˆ†é’Ÿï¼Œé¢„åˆå¹¶CIçš„p90æ—¶é—´ä¸º35åˆ†é’Ÿã€‚Gradleæ„å»ºå·²æ¥è¿‘æé™ï¼Œå³ä½¿åœ¨CIä¸Šå‚ç›´æ‰©å±•åˆ°é«˜ç«¯AWSæœºå™¨å¹¶ä½¿ç”¨å¯å‘å¼æ–¹æ³•æ‹†åˆ†é¡¹ç›®æ„å»ºå’Œæµ‹è¯•ï¼Œæ•ˆç‡ä¾ç„¶ä½ä¸‹ï¼Œå­˜åœ¨æœºå™¨åˆ©ç”¨ç‡ä¸è¶³å’Œå…±äº«ä»»åŠ¡é‡å¤çš„é—®é¢˜ã€‚\n*   **Bazelçš„ä¼˜åŠ¿ï¼š**\n    *   **è¿œç¨‹æ‰§è¡Œï¼ˆRBEï¼‰ï¼š** å…è®¸æ‰©å±•åˆ°æ•°åƒä¸ªå¹¶è¡Œæ“ä½œï¼Œæ¯”Gradleçš„åˆ†ç‰‡å¯å‘å¼æ–¹æ³•æ•ˆç‡æ›´é«˜ã€‚RBEå·¥ä½œèŠ‚ç‚¹æ˜¯çŸ­ç”Ÿå‘½å‘¨æœŸçš„ï¼Œæé«˜äº†æœºå™¨åˆ©ç”¨ç‡å’Œæˆæœ¬æ•ˆç›Šã€‚\n    *   **â€œæ— å­—èŠ‚æ„å»ºâ€ï¼ˆBuild without the Bytesï¼‰ï¼š** åªä¸‹è½½æ–‡ä»¶å­é›†ï¼Œå¤§å¹…å‡å°‘ä¸‹è½½é‡ï¼ˆGradleä¸­æ¯ä¸ªç¼“å­˜çš„å·¥ä»¶éƒ½éœ€è¦ä¸‹è½½ï¼‰ã€‚\n    *   **æœ¬åœ°æ„å»ºåŠ é€Ÿï¼š** RBEæ˜¾è‘—åŠ å¿«äº†æœ¬åœ°æ„å»ºé€Ÿåº¦ã€‚\n    ![å›¾ç‰‡ 2](https://cdn-images-1.medium.com/max/1024/0*y__bh8jYeKCNGmCW)\n    ![å›¾ç‰‡ 3](https://cdn-images-1.medium.com/max/1024/0*qEJJw_dqvH--5nS1)\n    *   **å¹¶è¡Œåˆ†æï¼š** Gradleå¤§å‹é¡¹ç›®çš„é…ç½®é€šå¸¸éœ€è¦æ•°åˆ†é’Ÿï¼Œå› ä¸ºå®ƒå•çº¿ç¨‹è¿è¡Œã€‚Bazelçš„åˆ†æé˜¶æ®µå¹¶è¡Œè¿è¡Œï¼Œéƒ¨åˆ†åŸå› æ˜¯å…¶é…ç½®è¯­è¨€Starlarkè¢«é™åˆ¶ä¸ºæ— å‰¯ä½œç”¨ã€‚\n\n### 2. å¯é æ€§\n\nBazelçš„å¯†å°æ€§ç¡®ä¿äº†å¯é ã€å¯é‡å¤çš„æ„å»ºã€‚\n*   **Gradleçš„é—®é¢˜ï¼š** Gradleä»»åŠ¡å¯ä»¥è®¿é—®å®Œæ•´çš„æ–‡ä»¶ç³»ç»Ÿï¼Œè¿™åœ¨å¤§è§„æ¨¡åº”ç”¨ä¸­å¯èƒ½å¯¼è‡´ä¸¥é‡çš„æ„å¤–åæœã€‚ä¾‹å¦‚ï¼Œå¼€å‘è€…æ›´æ–°ä»»åŠ¡æ¸…ç†`/tmp/`ç›®å½•ä¸­çš„æ–‡ä»¶ï¼Œå¯èƒ½ä¸å…¶ä»–ä½¿ç”¨è¯¥ç›®å½•çš„Gradleä»»åŠ¡äº§ç”Ÿç«æ€æ¡ä»¶ï¼Œå¯¼è‡´CIå¤±è´¥ã€‚\n*   **Bazelçš„è§£å†³æ–¹æ¡ˆï¼š**\n    *   **æ²™ç®±æœºåˆ¶ï¼š** Bazelé€šè¿‡æ²™ç®±è§£å†³æ­¤é—®é¢˜ï¼Œç¡®ä¿æ„å»ºæ“ä½œåªèƒ½è®¿é—®æŒ‡å®šçš„è¾“å…¥ã€‚æœªå£°æ˜ä¸ºè¾“å…¥çš„ä»»ä½•æ–‡ä»¶åœ¨æ²™ç®±ç¯å¢ƒä¸­å‡ä¸å­˜åœ¨ã€‚\n    *   **èµ„æºéš”ç¦»ï¼š** Gradleä»»åŠ¡éšå¼ä¾èµ–äºæœºå™¨èµ„æºï¼Œåœ¨ä¸åŒå¤§å°çš„æœºå™¨ä¸Šè¿è¡Œå¯èƒ½å¯¼è‡´èµ„æºäº‰ç”¨ã€‚RBEé€šè¿‡åœ¨å…·æœ‰ä¸¥æ ¼èµ„æºé™åˆ¶çš„ç›¸åŒå®¹å™¨ä¸­è¿è¡Œæ“ä½œæ¥è§£å†³æ­¤é—®é¢˜ã€‚æœ¬åœ°å’ŒCIæ„å»ºéƒ½é…ç½®ä¸ºä½¿ç”¨RBEï¼Œå¤§å¤§å‡å°‘äº†ç¯å¢ƒå·®å¼‚ã€‚\n\n### 3. å…±äº«åŸºç¡€è®¾æ–½\n\nAirbnbç›®å‰æ‹¥æœ‰å¤šä¸ªç‰¹å®šè¯­è¨€å’Œå¹³å°çš„ä»£ç ä»“åº“ï¼ˆå¦‚webã€iOSã€Pythonã€Goï¼‰ï¼Œæ‰€æœ‰è¿™äº›ç°åœ¨éƒ½å·²è¿ç§»åˆ°Bazelã€‚ç»Ÿä¸€ä½¿ç”¨Bazelå¯ä»¥åœ¨æ‰€æœ‰ä»“åº“ä¹‹é—´å®ç°ç»Ÿä¸€çš„æ„å»ºåŸºç¡€è®¾æ–½å±‚ï¼ŒåŒ…æ‹¬ï¼š\n*   è¿œç¨‹ç¼“å­˜\n*   è¿œç¨‹æ„å»ºæ‰§è¡Œ\n*   å—å½±å“ç›®æ ‡è®¡ç®—\n*   é€šè¿‡æ„å»ºäº‹ä»¶åè®®è¿›è¡Œæ£€æµ‹å’Œæ—¥å¿—è®°å½•\n\n## æˆ‘ä»¬å¦‚ä½•è¿ç§»ï¼Ÿ\n\n### 1. æ¦‚å¿µéªŒè¯\n\né¦–ä¸ªé‡Œç¨‹ç¢‘æ˜¯è¯æ˜å¯ä»¥åœ¨Bazelä¸­æ„å»ºæœåŠ¡å¹¶è¿è¡Œå…¶å•å…ƒæµ‹è¯•ã€‚ä¸ºäº†æœ€å¤§ç¨‹åº¦åœ°å‡å°‘å¯¹å·¥ç¨‹å¸ˆçš„å¹²æ‰°ï¼ŒBazelæ„å»ºä¸Gradleå¹¶è¡Œå­˜åœ¨ï¼Œå¼€å‘è€…å¯ä»¥é€‰æ‹©ä½¿ç”¨Gradleæˆ–Bazelã€‚\n*   **é€‰æ‹©ViaductæœåŠ¡ï¼š** é€‰æ‹©äº†Airbnbçš„GraphQLå•ä½“å¹³å°Viaductè¿›è¡Œæ¦‚å¿µéªŒè¯ï¼Œå› ä¸ºå®ƒï¼š\n    *   æ˜¯Airbnbæœ€å¤§ã€æœ€å¤æ‚çš„æœåŠ¡ä¹‹ä¸€ï¼Œå…¶æˆåŠŸè¿ç§»é¢„ç¤ºç€æ•´ä¸ªå•ä½“ä»“åº“çš„è¿ç§»å¯è¡Œæ€§ã€‚\n    *   æ„å»ºé€Ÿåº¦æ…¢æ˜¯ä¸»è¦ç—›ç‚¹ï¼ŒBazelèƒ½äº§ç”Ÿå·¨å¤§å½±å“ã€‚\n    *   æ¯æœˆæœ‰300åäº§å“å·¥ç¨‹å¸ˆä¿®æ”¹å…¶ä»£ç ï¼Œæé«˜æ„å»ºé€Ÿåº¦èƒ½æ˜¾è‘—æå‡ç”Ÿäº§åŠ›ã€‚\n    *   Viaductçš„æ ¸å¿ƒåŸºç¡€è®¾æ–½å›¢é˜Ÿæ¸´æœ›åˆä½œã€‚\n*   **å®ç°æ–¹å¼ï¼š**\n    *   å°†Viaductçš„å¤§éƒ¨åˆ†æ„å»ºé€»è¾‘ä»Gradleç§»æ¤åˆ°Bazelã€‚\n    *   æ„å»ºäº†ä¸€ä¸ªè‡ªåŠ¨åŒ–æ„å»ºæ–‡ä»¶ç”Ÿæˆå™¨ï¼Œä»¥åº”å¯¹Gradleæ„å»ºå›¾çš„æŒç»­å˜åŒ–å’Œå…±å­˜éœ€æ±‚ã€‚\n    ![å›¾ç‰‡ 4](https://cdn-images-1.medium.com/max/1024/0*sleFOnx1XS43xzAI)\n*   **åˆæœŸæŒ‘æˆ˜ä¸è§£å†³ï¼š** å°½ç®¡Bazelæœ¬åœ°æ„å»ºé€Ÿåº¦æå‡äº†2-4å€ï¼Œä½†è®¸å¤šå¼€å‘è€…æœ€åˆä¸æ„¿åˆ‡æ¢ã€‚ç»è¿‡ä¸æœåŠ¡æ‰€æœ‰è€…æ²Ÿé€šï¼Œå‘ç°äº†è®¸å¤šç¼ºå¤±çš„é›†æˆå’Œé”™è¯¯ã€‚åˆèŠ±äº†å‡ ä¸ªæœˆæ—¶é—´è§£å†³è¿™äº›ç—›ç‚¹åï¼ŒViaductå¼€å‘è€…æ‰è‡ªæ„¿åˆ‡æ¢åˆ°Bazelã€‚\n\n### 2. ä½¿ç”¨Bazelæ‰©å±•æ„å»ºå’Œæµ‹è¯•\n\næ¦‚å¿µéªŒè¯æˆåŠŸåï¼Œå›¢é˜Ÿå¼€å§‹å°†Bazelæ‰©å±•åˆ°JVMå•ä½“ä»“åº“çš„å…¶ä½™éƒ¨åˆ†ã€‚\n*   **å¹¿åº¦ä¼˜å…ˆç­–ç•¥ï¼š** é¦–å…ˆè®©æ‰€æœ‰ä»“åº“åœ¨Bazelä¸­ç¼–è¯‘å’Œæµ‹è¯•ã€‚\n*   **å…±å­˜çš„å¥½å¤„ï¼š**\n    *   å¼€å‘è€…ä»å¯ä½¿ç”¨Bazelè¿›è¡Œæœ¬åœ°å¼€å‘ï¼Œå³ä½¿éƒ¨ç½²ä»ä½¿ç”¨Gradleæ„å»ºã€‚\n    *   åœ¨BazelåŸºç¡€è®¾æ–½å‡ºç°é—®é¢˜æ—¶ï¼Œå¯ä»¥ç¦ç”¨Bazelï¼Œè®©ç”¨æˆ·å›é€€åˆ°Gradleã€‚\n*   **å…±å­˜çš„ç¼ºç‚¹ï¼š** å¿…é¡»ç»´æŠ¤Gradleå’ŒBazelä¸¤ä¸ªæ„å»ºå›¾ã€‚æ‰‹åŠ¨ç»´æŠ¤Bazelæ„å»ºå›¾ä¼šé™ä½å¼€å‘ä½“éªŒï¼Œå› æ­¤å›¢é˜Ÿè¿›ä¸€æ­¥æŠ•å…¥è‡ªåŠ¨åŒ–æ„å»ºæ–‡ä»¶ç”Ÿæˆã€‚\n\n### 3. è‡ªåŠ¨åŒ–æ„å»ºæ–‡ä»¶ç”Ÿæˆ\n\nå›¢é˜Ÿå—åˆ°Gazelleçš„å¯å‘ï¼ŒGazelleé€šè¿‡è§£ææºæ–‡ä»¶ç”ŸæˆBazelæ„å»ºæ–‡ä»¶ã€‚\n*   **è‡ªç ”ç”Ÿæˆå™¨ï¼š** è€ƒè™‘åˆ°ä¸¥æ ¼çš„æ€§èƒ½è¦æ±‚å’Œå¤„ç†ä¾èµ–å¾ªç¯çš„éœ€æ±‚ï¼Œå›¢é˜Ÿå†³å®šæ„å»ºè‡ªå·±çš„è‡ªåŠ¨åŒ–æ„å»ºæ–‡ä»¶ç”Ÿæˆå™¨ã€‚\n*   **æ€§èƒ½ä¼˜åŒ–ï¼š** ä¸ºäº†ä¸æ˜¾è‘—é™ä½å¼€å‘è€…ä½“éªŒï¼Œç”Ÿæˆå™¨å¿…é¡»åœ¨æ¯æ¬¡æäº¤åˆå¹¶åˆ°ä¸»çº¿å‰å¿«é€Ÿè¿è¡Œã€‚é€šè¿‡å®ç°å¤–éƒ¨ç¼“å­˜æ¥åŠ é€Ÿç”Ÿæˆè¿‡ç¨‹ã€‚\n*   **å·¥ä½œåŸç†ï¼š** ç±»ä¼¼Gazelleï¼Œç”Ÿæˆå™¨è§£æJavaã€Kotlinå’ŒScalaæºæ–‡ä»¶ä¸­çš„åŒ…ã€å¯¼å…¥è¯­å¥å’Œç¬¦å·å£°æ˜ï¼Œæ„å»ºæ–‡ä»¶çº§ä¾èµ–å›¾ã€‚\n*   **CIé›†æˆï¼š** åœ¨CIä¸­ï¼Œæ¯ä¸ªä¸»çº¿æäº¤éƒ½ä¼šå‘å¸ƒä¸€ä¸ªä»“åº“çš„ç¼“å­˜ç´¢å¼•ã€‚ç”¨æˆ·è¿è¡Œ`sync-configs`æ—¶ï¼Œä¼šä¸‹è½½æ­¤ç¼“å­˜ï¼Œå¹¶ä»…é‡æ–°æ‰«æè‡ªåˆå¹¶åŸºç¡€ä»¥æ¥æ›´æ”¹çš„ç›®å½•ï¼Œå¤§å¤§æé«˜äº†å¸¸è§æƒ…å†µä¸‹çš„æ€§èƒ½ã€‚\n*   **æ›´ç»†ç²’åº¦çš„æ„å»ºå›¾ï¼š** ç”Ÿæˆå™¨æ”¯æŒæ›´ç»†ç²’åº¦çš„æ„å»ºå›¾ï¼ŒBazelç›®æ ‡æ•°é‡æ˜¯Gradleé¡¹ç›®çš„10å€ä»¥ä¸Šï¼Œé€šè¿‡æ›´å¤šå¹¶è¡Œæ„å»ºå’Œæ›´å°‘ç¼“å­˜å¤±æ•ˆå®ç°æ›´å¿«çš„æ„å»ºã€‚å®ƒè¿˜èƒ½è‡ªåŠ¨æ£€æµ‹ç¼–è¯‘å¾ªç¯å¹¶åœ¨å¿…è¦æ—¶åˆå¹¶ç¼–è¯‘å•å…ƒã€‚\n![å›¾ç‰‡ 5](https://cdn-images-1.medium.com/max/1024/0*zmnMMjLRC2a-XCO0)\n*   **æŒç»­ä»·å€¼ï¼š** å³ä½¿åœ¨è¿ç§»åï¼Œæ„å»ºæ–‡ä»¶ç”Ÿæˆå™¨ä»åœ¨ä½¿ç”¨ï¼Œé€šè¿‡è‡ªåŠ¨ä¿®å¤æ„å»ºæ–‡ä»¶é…ç½®å’Œç§»é™¤æœªä½¿ç”¨çš„ä¾èµ–é¡¹æ¥æ”¹å–„å¼€å‘è€…ä½“éªŒã€‚ç›¸æ¯”ä¹‹ä¸‹ï¼ŒGradleæ—¶ä»£ç”¨æˆ·æ‰‹åŠ¨ç»´æŠ¤çº¦4500ä¸ªGradleæ–‡ä»¶ï¼Œå¯¼è‡´æœªä½¿ç”¨çš„ä¾èµ–é¡¹ã€è‡ƒè‚¿çš„ä¾èµ–å›¾å’Œæ›´æ…¢çš„æ„å»ºã€‚\n\n### 4. ç§»æ¤æ„å»ºé€»è¾‘\n\né™¤äº†JVMæºæ–‡ä»¶ï¼Œä»“åº“è¿˜æœ‰å¤§é‡ç”±å¤šä¸ªå›¢é˜Ÿæ‹¥æœ‰çš„æ„å»ºé€»è¾‘ï¼ˆå¦‚ä»£ç ç”Ÿæˆï¼‰ï¼Œé€šå¸¸ä»¥Gradleæ’ä»¶çš„å½¢å¼å­˜åœ¨ã€‚\n*   **ä¸ç”Ÿæˆå™¨é›†æˆï¼š** ç§»æ¤æ„å»ºé€»è¾‘æ—¶ï¼Œå¿…é¡»å°†å…¶ä¸æ„å»ºæ–‡ä»¶ç”Ÿæˆå™¨é›†æˆã€‚ç”±äºç›®æ ‡æ›´ç»†ç²’åº¦ï¼ŒGradleä¸­çš„ä¸€è¡Œé…ç½®å¯èƒ½éœ€è¦åº”ç”¨äº10å¤šä¸ªBazelæ„å»ºæ–‡ä»¶ã€‚\n*   **æ’ä»¶å’ŒæŒ‡ä»¤ï¼š** æ„å»ºæ–‡ä»¶ç”Ÿæˆå™¨æ¶æ„æ”¯æŒç±»ä¼¼äºGazelleæ‰©å±•çš„æ’ä»¶ï¼Œè¿™äº›æ’ä»¶ç”±ç‰¹å®šæ–‡ä»¶ï¼ˆå¦‚Thriftæˆ–GraphQLæ–‡ä»¶ï¼‰çš„å­˜åœ¨è§¦å‘ï¼Œå¹¶èƒ½ç”Ÿæˆæ–°çš„æ„å»ºç›®æ ‡ï¼ˆå¦‚ä»£ç ç”Ÿæˆæ“ä½œï¼‰ã€‚å¯¹äºæ‰‹åŠ¨æ·»åŠ æˆ–ä¸æ˜“ä»æ–‡ä»¶ç»“æ„æ¨æ–­çš„Gradleé€»è¾‘ï¼Œæ”¯æŒç±»ä¼¼äºGazelleçš„ç”Ÿæˆå™¨æŒ‡ä»¤ï¼ˆå¦‚æ·»åŠ ä¾èµ–é¡¹æˆ–è®¾ç½®å±æ€§ï¼‰ã€‚\n*   **å›¢é˜Ÿåä½œï¼š** æœ€åˆç”±æ ¸å¿ƒå›¢é˜Ÿç§»æ¤å¤§éƒ¨åˆ†æ„å»ºé€»è¾‘ã€‚éšç€Bazelçš„æ™®åŠï¼Œå¤æ‚æ„å»ºé€»è¾‘çš„æ‰€æœ‰è€…è¢«æ¿€åŠ±è¿ç§»åˆ°Bazelï¼Œå› ä¸ºå…¶æ›´å¿«ã€æ›´å¯é ï¼Œä»–ä»¬ä¹Ÿå¸¸ç¼–å†™è‡ªå·±çš„æ„å»ºæ–‡ä»¶ç”Ÿæˆå™¨æ’ä»¶ï¼Œä½“ç°äº†ç”Ÿæˆå™¨çš„å¯æ‰©å±•æ€§ã€‚\n\n### 5. ç¬¬ä¸‰æ–¹åº“å¤šç‰ˆæœ¬æ”¯æŒ\n\nè¿ç§»è¿‡ç¨‹ä¸­é‡åˆ°çš„ä¸€ä¸ªä¸»è¦é—®é¢˜æ˜¯åŒä¸€ç¬¬ä¸‰æ–¹åº“çš„å¤šä¸ªç‰ˆæœ¬ã€‚\n*   **é—®é¢˜ï¼š** æœ€åˆåªæŒ‡å®šæ¯ä¸ªåº“çš„å•ä¸€ç‰ˆæœ¬ï¼Œä½†Gradleä¸­æ¯ä¸ªå­é¡¹ç›®å¯ä»¥ä½¿ç”¨ä¸åŒç‰ˆæœ¬çš„ç¬¬ä¸‰æ–¹åº“ã€‚è¿™å¯¼è‡´åœ¨é’ˆå¯¹å•ä¸€ç‰ˆæœ¬ç¼–è¯‘æ—¶ï¼Œå¯èƒ½å› ç¼ºå°‘ç¬¦å·è€Œç¼–è¯‘æˆ–æµ‹è¯•å¤±è´¥ã€‚\n*   **è§£å†³æ–¹æ¡ˆï¼š** æ„å»ºäº†å·¥å…·æ¥ç”Ÿæˆå¤šä¸ª`maven_install`è§„åˆ™ï¼Œå¹¶æ·»åŠ äº†è‡ªå®šä¹‰æ–¹é¢æ¥åœ¨ç›®æ ‡çº§åˆ«è§£å†³å†²çªã€‚\n![å›¾ç‰‡ 6](https://cdn-images-1.medium.com/max/1024/0*_U1LAeex52squvmt)\n*   **åç»­æ”¹è¿›ï¼š** å°†å†²çªè§£å†³ç§»è‡³åˆ†ææ—¶ä»¥è·å¾—æ›´å¥½çš„IDEæ”¯æŒï¼Œå¹¶æ·»åŠ äº†æ›´å‹å¥½çš„åº“æ›´æ–°å·¥å…·ã€‚\n\n### 6. è¿ç§»éƒ¨ç½²\n\nåœ¨ç»å¤§å¤šæ•°é¡¹ç›®åœ¨CIä¸­é€šè¿‡Bazelæ„å»ºå¹¶å•å…ƒæµ‹è¯•é€šè¿‡åï¼Œå›¢é˜Ÿå¼€å§‹ä¸“æ³¨äºè¿ç§»éƒ¨ç½²ã€‚Bazelæ„å»ºçš„`.jar`ä¸Gradleæ„å»ºçš„`.jar`ä¸å®Œå…¨ç›¸åŒï¼Œå› æ­¤éœ€è¦ç­–ç•¥ç¡®ä¿éƒ¨ç½²å®‰å…¨ã€‚\n\n#### æœåŠ¡\n*   **éªŒè¯ï¼š** ä½¿ç”¨å¯åŠ¨å’Œé›†æˆæµ‹è¯•éªŒè¯æœåŠ¡çš„éƒ¨ç½²æ­£ç¡®æ€§ã€‚çº¦700ä¸ªæœåŠ¡ä¸­ï¼Œçº¦100ä¸ªé‡åˆ°å¯åŠ¨æˆ–é›†æˆæµ‹è¯•å¤±è´¥ã€‚\n*   **ä¸»è¦é—®é¢˜åŠè§£å†³ï¼š**\n    *   **ç¼ºå¤±ä¾èµ–ï¼š** å¤§å¤šæ•°å¤±è´¥æ˜¯ç”±äºJavaåå°„åŠ è½½çš„ç¼ºå¤±ä¾èµ–ï¼ˆé€šå¸¸æ¥è‡ªé…ç½®æ–‡ä»¶æˆ–å…¶ä»–æ–‡ä»¶ï¼‰ã€‚é€šè¿‡è§£ææ–‡ä»¶ä»¥æŸ¥æ‰¾å°†é€šè¿‡åå°„åŠ è½½çš„ç±»ï¼Œç„¶åæ·»åŠ æ‰€éœ€ä¾èµ–æ¥è§£å†³ã€‚\n    *   **åº“ç‰ˆæœ¬å·®å¼‚ï¼š** å¦ä¸€ä¸ªä¸»è¦é”™è¯¯æºæ˜¯åº“ç‰ˆæœ¬ä¸åŒï¼Œå¯èƒ½å¯¼è‡´è¿è¡Œæ—¶ç¼ºå°‘ç¬¦å·é”™è¯¯ã€‚Gradleä¸­ç”¨æˆ·æ‰‹åŠ¨æŒ‡å®šä¾èµ–å’Œç‰ˆæœ¬ï¼Œè€ŒBazelä¸­æ„å»ºæ–‡ä»¶ä»æºç”Ÿæˆï¼Œä¾èµ–ä»å¯¼å…¥è¯­å¥æ¨æ–­ï¼ˆä¸æŒ‡å®šç‰ˆæœ¬ï¼‰ã€‚é€šè¿‡å¼ºåˆ¶ç¬¬ä¸‰æ–¹åº“ç‰ˆæœ¬ä¸Gradleé¡¹ç›®åŒ¹é…æ¥è§£å†³ã€‚\n*   **ç»“æœï¼š** è€ƒè™‘åˆ°åå°„ç±»å’Œç‰ˆæœ¬åŒæ­¥åï¼Œåªæœ‰ä¸ªä½æ•°ç™¾åˆ†æ¯”çš„æœåŠ¡åœ¨ç”Ÿäº§ç¯å¢ƒä¸­é‡åˆ°è¿è¡Œæ—¶é—®é¢˜ï¼Œéœ€è¦æ›´æ·±å…¥çš„æ‰‹åŠ¨ä¿®å¤ã€‚\n\n#### æ•°æ®ç®¡é“å’Œå…¶ä»–é¡¹ç›®\n*   **è§„æ¨¡ï¼š** é™¤äº†æœåŠ¡ï¼Œè¿˜æœ‰450ä¸ªæ•°æ®ç®¡é“å’Œçº¦50ä¸ªå…¶ä»–é¡¹ç›®éƒ¨ç½²åˆ°Sparké›†ç¾¤æˆ–Flinkè¿è¡Œæ—¶ã€‚\n*   **éªŒè¯ï¼š** ç±»ä¼¼æœåŠ¡ï¼Œé€šè¿‡æµ‹è¯•æ•è·äº†è®¸å¤šé—®é¢˜ã€‚Airbnbæ•°æ®å·¥ç¨‹çš„â€œé“ºè·¯â€æ•°æ®ç®¡é“æœ‰CIæµ‹è¯•ï¼Œå¯åœ¨æœ¬åœ°è¿è¡Œå°ç‰ˆæœ¬Sparkç®¡é“ã€‚\n*   **ç»“æœï¼š** å¯¹äºçº¦400ä¸ªâ€œé“ºè·¯â€ç®¡é“ï¼Œé€šè¿‡CIæµ‹è¯•åï¼Œåªæœ‰çº¦3%åœ¨ç”Ÿäº§ç¯å¢ƒä¸­å‡ºç°è¿è¡Œæ—¶é—®é¢˜ï¼Œå› æ­¤å¯ä»¥éå¸¸å¿«é€Ÿåœ°è¿ç§»ã€‚\n*   **å‰©ä½™æŒ‘æˆ˜ï¼š** å°‘æ•°æ›´å®šåˆ¶åŒ–çš„å¯éƒ¨ç½²é¡¹ç›®éœ€è¦å•ç‹¬éƒ¨ç½²å’Œç›‘æ§ä»¥éªŒè¯æ­£ç¡®æ€§ã€‚\n\n## æˆ‘ä»¬å­¦åˆ°äº†ä»€ä¹ˆï¼Ÿ\n\n### 1. å®¢æˆ·åˆä½œ\n\nåœ¨è¿ç§»æ—©æœŸï¼Œå›¢é˜Ÿç¡®å®šäº†å…·æœ‰å·¨å¤§å½±å“æ½œåŠ›å’Œæ„¿æ„æŠ•èµ„æ–°æ„å»ºç³»ç»Ÿçš„å…³é”®è¯•ç‚¹æœåŠ¡ã€‚ä¾‹å¦‚ï¼ŒViaductå…·æœ‰å¤æ‚çš„æ„å»ºé€»è¾‘ï¼Œå¯¼è‡´æ„å»ºç¼“æ…¢å’Œå¯é æ€§é—®é¢˜ï¼Œä¸”è®¸å¤šå¼€å‘è€…è´¡çŒ®è¯¥æœåŠ¡ï¼Œæ”¹è¿›å…¶æ„å»ºå¯¹Airbnbçš„å¼€å‘è€…ä½“éªŒå½±å“å·¨å¤§ã€‚\n*   ä¸è¯•ç‚¹å›¢é˜Ÿçš„åˆä½œéå¸¸æœ‰ä»·å€¼ã€‚ä»–ä»¬æ˜¯æ—©æœŸé‡‡ç”¨è€…ï¼Œåœ¨æŠ¥å‘Šå’Œè°ƒè¯•é—®é¢˜ã€åˆ†ææ€§èƒ½ç“¶é¢ˆå’Œæå‡ºåŠŸèƒ½æ–¹é¢åšå‡ºäº†é‡å¤§è´¡çŒ®ã€‚è¯•ç‚¹å›¢é˜Ÿä¹Ÿæˆä¸ºäº†å€¡å¯¼è€…ï¼Œæä¾›å†…éƒ¨æ”¯æŒï¼Œå¸®åŠ©æ¿€åŠ±Airbnbå…¶ä»–å¼€å‘è€…ç¤¾åŒºã€‚\n\n### 2. è¿‡æ—©ä¼˜åŒ–çš„å±é™©\n\nè¿™æ¬¡è¿ç§»å†æ—¶4.5å¹´ã€‚äº‹åçœ‹æ¥ï¼Œå¦‚æœå›¢é˜Ÿå…ˆè¿ç§»å†ä¼˜åŒ–ï¼Œå¯ä»¥å¤§å¹…ç¼©çŸ­è¿ç§»æ—¶é—´ã€‚\n*   è™½ç„¶å¢åŠ æ„å»ºç²’åº¦ç¼©çŸ­äº†æ„å»ºæ—¶é—´ï¼Œä½†å´å¢åŠ äº†è¿ç§»æ—¶é—´ã€‚å…·ä½“æ¥è¯´ï¼Œå¢åŠ æ„å»ºç²’åº¦å¤§å¤§å¢åŠ äº†é…ç½®æ–‡ä»¶æ•°é‡ï¼Œä½¿å¾—æ‰‹åŠ¨ç®¡ç†é…ç½®å˜å¾—æ›´åŠ å›°éš¾ã€‚è¿™è¿«ä½¿æ›´å¤šåŠŸèƒ½é›†æˆåˆ°è‡ªåŠ¨åŒ–æ„å»ºä¸­ã€‚",
      "shortSummary": "Airbnbå†æ—¶4.5å¹´æˆåŠŸå°†å…¶åºå¤§çš„JVMå•ä½“ä»“åº“ä»Gradleè¿ç§»åˆ°Bazelã€‚æ­¤æ¬¡è¿ç§»æ˜¾è‘—æå‡äº†æ„å»ºCSATã€æœ¬åœ°æ„å»ºå’Œæµ‹è¯•é€Ÿåº¦ï¼ˆ3-5å€ï¼‰ã€IntelliJåŒæ­¥é€Ÿåº¦ï¼ˆ2-3å€ï¼‰åŠéƒ¨ç½²é€Ÿåº¦ï¼ˆ2-3å€ï¼‰ã€‚é€‰æ‹©Bazelæ˜¯å› å…¶å“è¶Šçš„é€Ÿåº¦ã€å¯é æ€§å’Œç»Ÿä¸€çš„æ„å»ºåŸºç¡€è®¾æ–½ã€‚è¿ç§»è¿‡ç¨‹æ¶‰åŠæ¦‚å¿µéªŒè¯ã€è‡ªåŠ¨åŒ–æ„å»ºæ–‡ä»¶ç”Ÿæˆã€æ„å»ºé€»è¾‘ç§»æ¤åŠç¬¬ä¸‰æ–¹åº“å¤šç‰ˆæœ¬æ”¯æŒï¼Œæœ€ç»ˆæˆåŠŸè¿ç§»äº†æœåŠ¡å’Œæ•°æ®ç®¡é“çš„éƒ¨ç½²ã€‚å…³é”®ç»éªŒæ˜¯å®¢æˆ·åˆä½œçš„é‡è¦æ€§ï¼Œä»¥åŠé¿å…è¿‡æ—©ä¼˜åŒ–å¯èƒ½å¸¦æ¥çš„è¿ç§»æ—¶é—´å»¶é•¿ã€‚",
      "translated_title": "å°†Airbnbçš„JVMå•ä½“ä»“åº“è¿ç§»åˆ°Bazel",
      "images": [
        {
          "url": "https://cdn-images-1.medium.com/max/1024/1*rSkIrKYhc8Bwcv2xLE1mxA.jpeg",
          "alt": "",
          "title": "",
          "position": 1
        },
        {
          "url": "https://cdn-images-1.medium.com/max/1024/0*y__bh8jYeKCNGmCW",
          "alt": "",
          "title": "",
          "position": 2
        },
        {
          "url": "https://cdn-images-1.medium.com/max/1024/0*qEJJw_dqvH--5nS1",
          "alt": "",
          "title": "",
          "position": 3
        },
        {
          "url": "https://cdn-images-1.medium.com/max/1024/0*sleFOnx1XS43xzAI",
          "alt": "",
          "title": "",
          "position": 4
        },
        {
          "url": "https://cdn-images-1.medium.com/max/1024/0*zmnMMjLRC2a-XCO0",
          "alt": "",
          "title": "",
          "position": 5
        }
      ],
      "contentSource": "RSS",
      "content": "<figure><img alt=\"\" src=\"https://cdn-images-1.medium.com/max/1024/1*rSkIrKYhc8Bwcv2xLE1mxA.jpeg\" /></figure><p><strong>By: </strong>Jack Dai, Howard Ho, Loc Dinh, Stepan Goncharov, Ted Tenedorio, and ThomasÂ Bao</p><p>At Airbnb, we recently completed migrating our largest repo, the JVM monorepo, to Bazel. This repo contains <strong>tens of millions of lines</strong> of Java, Kotlin, and Scala code that power the vast array of backend services and data pipelines behind airbnb.com.</p><p><strong>Migration in numbers (4.5 years ofÂ work):</strong></p><ul><li>Build CSAT: 38% â†’Â 68%</li><li><strong>3â€“5x </strong>faster local build and testÂ times</li><li><strong>2â€“3x </strong>faster IntelliJÂ syncs</li><li><strong>2â€“3x</strong> faster deploys to the development environment</li></ul><p>In this blog post, weâ€™ll discuss the <strong>why</strong>, share some highlights on the <strong>how</strong>, and finish off with <strong>key learnings</strong>.</p><h3>Why Bazel?</h3><p>Before the migration, our JVM monorepo used Gradle as its build system. We decided to migrate to<strong> </strong>Bazel because it offered three key advantages: speed, reliability, and a uniform build infrastructure layer.</p><h4>Speed</h4><p><em>Bazelâ€™s cacheable, portable actions allow us to scale performance with remote execution</em></p><p>In 2021, builds of large services often took &gt;20 minutes locally and pre-merge CI p90 was 35Â minutes.</p><p>Building with Gradle was near its limit. We had already vertically scaled to high-end AWS machines on CI and remote development machines for developers of large services. In CI, we also used heuristics to split project builds and tests across multiple machines. However, this was inefficient, because of machine underutilization and duplication of sharedÂ tasks.</p><figure><img alt=\"\" src=\"https://cdn-images-1.medium.com/max/1024/0*y__bh8jYeKCNGmCW\" /></figure><p>Bazel remote execution allowed us to scale to thousands of parallel actions. This was far more efficient than our sharding heuristics. Remote build execution (RBE) workers are also short-lived, which results in better machine utilization and cost efficiency. In addition, <a href=\"https://blog.bazel.build/2021/04/07/build-without-the-bytes.html\">Build without the Bytes</a> allows downloading only a subset of files, greatly reducing download volume (in Gradle, every cached artifact needs to be downloaded). Finally and most importantly, local builds are significantly faster thanks toÂ RBE.</p><figure><img alt=\"\" src=\"https://cdn-images-1.medium.com/max/1024/0*qEJJw_dqvH--5nS1\" /></figure><p>In addition, <a href=\"https://docs.gradle.org/current/userguide/build_lifecycle.html#sec:configuration\">Gradle configuration</a> of some large projects often took minutes due to it being single-threaded. Bazel analysis, in contrast, runs in parallel, in part because its configuration language, Starlark, is constrained to be side-effect-free.</p><h4>Reliability</h4><p><em>Bazelâ€™s hermeticity ensures reliable, repeatable builds</em></p><p>Gradle tasks have access to the full file system, which can lead to serious unintended consequences at scale. One example we ran into was when a developer updated a task to clean up recent files in the /tmp/ directory. This created a race condition with other Gradle tasks that used the /tmp/ directory and caused CI to fail when thousands of Gradle tasks had to beÂ rerun.</p><p>Bazel solves this issue with sandboxing, which ensures that only specified inputs are available to a build action. If a file isnâ€™t declared as an input, it simply doesnâ€™t exist in the sandboxed environment.</p><p>Gradle tasks also implicitly depend on the machineâ€™s resources. Gradle builds run on local machines and CI machines of different sizes. This can lead to resource contention when a task is run on a smaller machine or when the cache is cold and thousands of tasks are run on the sameÂ machine.</p><p>Remote build execution (RBE) solves this by running actions in identical containers with strict resource limits. We also configured both local and CI builds to use RBE, which greatly reduces environment differences.</p><h4>Shared infrastructure</h4><p>Airbnb currently has a collection of language- and platform-specific repos, such as <a href=\"https://medium.com/airbnb-engineering/adopting-bazel-for-web-at-scale-a784b2dbe325\">web</a>, <a href=\"https://medium.com/airbnb-engineering/migrating-our-ios-build-system-from-buck-to-bazel-ddd6f3f25aa3\">iOS</a>, Python, and Go, all of which are now on Bazel. Unifying on Bazel enables a uniform build infrastructure layer across repos, which includes:</p><ul><li>Remote caching</li><li>Remote build execution</li><li>Affected targets calculation</li><li>Instrumentation &amp; logging from the <a href=\"https://bazel.build/docs/build-event-protocol\">Build EventÂ Protocol</a></li></ul><h3>How did weÂ migrate?</h3><h4>Proof ofÂ concept</h4><p>As a first milestone, we wanted to show that we could build a service and run its unit tests in Bazel. Because this was a proof of concept, we wanted to <strong>minimize disruption to engineers</strong>. Therefore, the Bazel build <em>co-existed </em>with Gradle<strong>. </strong>As a result, developers could choose between using Gradle or BazelÂ locally<em>.</em></p><p>We needed to prove that developers would <em>choose</em> to opt in to using Bazel over Gradle. It wasnâ€™t enough for Bazel to be faster, developers had to willingly opt in to usingÂ Bazel.</p><p>For this proof of concept, we chose Airbnbâ€™s GraphQL monolith platform, <a href=\"https://medium.com/airbnb-engineering/taming-service-oriented-architecture-using-a-data-oriented-service-mesh-da771a841344\">Viaduct</a>, which had the following important properties:</p><ol><li>It was one of Airbnbâ€™s largest and most complex services. If we could migrate Viaduct to Bazel, then we could likely migrate the rest of the monorepo.</li><li>Slow builds were a major pain point, so Bazel could have a largeÂ impact.</li><li>Viaduct has 300 product engineers modifying its code every month, so improving Viaductâ€™s build speed would be a substantial productivity win.</li><li>Because of (2) and (3) above, Viaductâ€™s core infrastructure team was eager to partner withÂ us.</li></ol><p>To achieve a working Viaduct build with Bazel, we did two things. First, we had to port much of Viaductâ€™s build logic from Gradle to Bazel. Second, because we decided to maintain co-existing builds and the Gradle build graph was still changing, we decided to build an automated build file generator (which weâ€™ll cover in detail in a separate section).</p><figure><img alt=\"\" src=\"https://cdn-images-1.medium.com/max/1024/1*8d_f127RDGo6fHBHcqmN3g.png\" /></figure><p>Importantly, even though we were able to locally build the service 2â€“4x faster with Bazel, many developers did not yet want toÂ switch.</p><p>In talking with the serviceâ€™s owners, we discovered a number of missing integrations and bugs. It took us an additional few months to address these pain points, after which Viaduct developers willingly switched from Gradle toÂ Bazel.</p><h4>Scaling builds and tests withÂ Bazel</h4><p>The proof of concept showed that Bazel was superior to Gradle for one of Airbnbâ€™s largest services and a large audience of developers. Now we wanted to scale it to the rest of Airbnbâ€™s JVM monorepo.</p><p>We decided to scale breadth-first, getting all of the repo compiling and testing in Bazel. Again, to minimize disruption, Bazel builds co-existed with Gradle, which had two important benefits.</p><p>First, developers could still use Bazel for local development and get most of its benefits even though their code was still built with Gradle for deployment. Second, we could always disable Bazel if it was negatively impacting developers. For example, when Bazel infrastructure like the remote cache or remote execution cluster experienced an incident, we could and did disable Bazel, letting users fall back toÂ Gradle.</p><p>However, a major downside was that both Gradle and Bazel build graphs had to be maintained. Manually maintaining a Bazel build graph would have degraded the developer experience. As a result, we invested further in automated build file generation, so that developers didnâ€™t need to manually maintain Bazel buildÂ files.</p><h4>Automated build file generation</h4><p>For our build file generator, we were heavily inspired by <a href=\"https://github.com/bazel-contrib/bazel-gazelle\">Gazelle</a>, which generates Bazel build files by parsing source files to build a dependency graph.</p><p>Although we considered extending Gazelle to support JVM languages, we had very strict performance requirements and needed to handle dependency cycles. This ultimately led us to build our own automated build file generator.</p><p>Because we had to maintain <em>co-existing build graphs</em>, we needed to run the build file generator on every commit before merging into mainline. This meant it had to run as fast as possible to not significantly degrade the developer experience. To achieve this, we implemented external caching to speed up the automated build file generation.</p><p>Similar to Gazelle, the build file generator parses Java, Kotlin, and Scala source files for package and import statements and symbol declarations to build a file-level dependency graph.</p><p>In CI, we publish a cached index of the repository at each mainline commit. When a user runs sync-configs, it downloads this cache and only re-scans directories which have changed since the merge base. This greatly improves performance for the common case where users only modify a small set ofÂ files.</p><p>In addition, with this build file generator, we were able to support a more fine-grained build graph, which resulted in &gt;10x more Bazel targets than Gradle projects. This enabled faster builds through more parallel builds and less cache invalidation. However, one challenge of moving to a more fine-grained build graph is the possibility of introducing compilation cycles; sync-configs is able to detect this automatically and merge compilation units when necessary.</p><figure><img alt=\"\" src=\"https://cdn-images-1.medium.com/max/1024/1*UnuZOwRc8X-lT3onIEYHiA.png\" /></figure><p>Even after the migration, the build file generator remains in use. It improves the developer experience by automatically fixing build file configurations and removing unused dependencies. In contrast, when we were on Gradle, users manually maintained ~4,500 Gradle files, which led to unused dependencies, a bloated dependency graph, and slower builds with fewer cacheÂ hits.</p><h4>Porting buildÂ logic</h4><p>In addition to JVM source files, our repo has a large amount of build logic such as code generation owned by multiple teams. These often took the form of GradleÂ plugins.</p><p>Because we now had automated build file generation, when porting the build logic, we also had to integrate it with the build file generator. Also, because we had more granular targets, a single line of Gradle config now might need to apply to 10+ Bazel buildÂ files.</p><p>As a result, our build file generator architecture supported plugins similar to Gazelle extensions. These plugins were triggered by the presence of specific files such as Thrift or GraphQL files. These plugins could also generate new build targets such as codegenÂ actions.</p><p>In some cases, the Gradle logic was manually added as a one-off or not easily inferred from the file structure. As a result, we also supported generator <em>directives</em> similar to Gazelle, such as adding dependencies or setting attributes.</p><p>Initially, our team ported much of this build logic ourselves with minimal help from service owners. As Bazel adoption grew, owners of complex build logic were incentivized to migrate to Bazel, because it was faster and more reliable than Gradle. In the process, they often wrote their own build file generator plugins, highlighting the extensibility of our generator.</p><h4>Third-party library multi-version support</h4><p>Another major issue we hit on the road to 100% compilation and testing with Bazel was multiple versions of the same third-party library.</p><p>Initially, we specified a single version of each library. The build file generator would add dependencies from this universe.</p><p>However, in Gradle, each sub-project within the monorepo could use different versions of third-party libraries. As a result, when compiling against a single version, compilation or testing could fail with a missingÂ symbol.</p><p>To bring multi-version support to our Bazel system, we built tooling to generate multiple maven_install rules and added a custom <a href=\"https://bazel.build/extending/aspects\">aspect</a> to resolve conflicts at the targetÂ level.</p><figure><img alt=\"\" src=\"https://cdn-images-1.medium.com/max/1024/0*_U1LAeex52squvmt\" /></figure><p><em>Multiple versions of Guava in Bazel before we added conflict resolution</em></p><p>Once we had this capability, we systematically synced library versions from Gradle so that each build targetâ€™s classpath more closely matched its Gradle counterpart.</p><p>To learn more about our approach, see our <a href=\"https://www.youtube.com/watch?v=Ui4YtqWhqYU\">BazelCon 2022 talk</a>. Since giving this talk, we have made improvements like moving the resolution to analysis-time for better IDE support and adding more user-friendly tooling for updating libraries.</p><h4>Migrating theÂ deploys</h4><p>As we got the vast majority of projects building and passing unit tests with Bazel in CI, we began to focus on migrating deployments. The Bazel-built jars were not identical to the Gradle-built jars. As a result, we needed a strategy to ensure the deployments were safe. We started with services.</p><h4>Services</h4><p>To verify the correctness of deploying services with Bazel, we used startup and integration tests. Of ~700 services, ~100 encountered startup or integration test failures. The majority of failures were missing dependencies that were loaded via Java reflection, usually from config files or other files. As a result, we were able to fix a number of these issues by parsing files for classes that would be loaded via reflection, and then adding the required dependency.</p><p>Another major source of errors was differing library versions, which could lead to missing symbol errors at runtime. In Gradle, users manually specified dependencies and their versions. However, in Bazel, build files were generated from source and dependencies were inferred from import statements, which didnâ€™t specify the version. We solved many of these errors forcing third-party library versions to match those of the GradleÂ project.</p><p>After taking into account reflected classes and syncing versions, only a single-digit percentage of services hit production runtime issues that required more in-depth manual work toÂ fix.</p><h4>Data pipelines and otherÂ projects</h4><p>In addition to services, we had 450 data pipelines and ~50 other projects that were deployed to either a Spark cluster or a FlinkÂ runtime.</p><p>Similar to services, we were able to catch a number of issues using tests. In particular, data pipelines on Airbnbâ€™s data engineering paved path have CI tests that run a small version of the Spark pipeline locally. For these ~400 paved-path pipelines, after passing CI tests, only about 3% had production issues at runtime. As a result, we were able to very quickly migrate the paved-path pipelines.</p><p>As with services, we had a few remaining deployables that were a bit more bespoke and had to be individually deployed and monitored to verify correctness.</p><h3>What did weÂ learn?</h3><h4>Customer partnership</h4><p>Early in the migration, we identified key pilot services that had large opportunities for impact and an appetite to invest in migrating to a new build system. For example, Viaduct had complex build logic leading to slow builds and reliability issues. In addition, many developers contributed to the service, so improving their builds had a large impact on Airbnbâ€™s developer experience.</p><p>Partnering with pilot teams was incredibly valuable. They were early adopters and made significant contributions in the form of reporting and debugging issues, profiling performance bottlenecks, and suggesting features. The pilot teams also became advocates and provided internal support, helping motivate the rest of the Airbnb developer community.</p><h4>Dangers of premature optimization</h4><p>This migration took 4.5 years. With the benefit of hindsight we think we could have drastically improved the migration timeline if we had <strong>migrated first, before improving</strong><em>.</em></p><p>Although increasing build granularity improved build times, it increased the time to migrate. Specifically, increased build granularity greatly increased the number of configuration files, making it much harder to manage configurations manually. This forced more functionality into automated build file generation, which increased its complexity.</p><p>If we had migrated first and <em>then</em> optimized the build granularity, we believe we could have migrated sooner, enabling users to get benefits from Bazel sooner and reducing the time spent maintaining two co-existing builds.</p><p>Similarly, build granularity also made it harder to match deploy jars between Gradle and Bazel. This led to spending more time testing deployments and fixing runtimeÂ issues.</p><p>On a more positive note, we accelerated the migration by deciding to support multiple third-party library versions and implementing version resolution. This enabled us to sync versions from Gradle to Bazel, which fixed a large number of build and runtimeÂ issues.</p><p>Towards the end, one major takeaway in the migration was, <strong>by default, we should try to imitate what was there before</strong><em>. </em>In our case, deviating from Gradle usually added technical risk, and should be carefully considered, especially its downstream consequences.</p><p>As engineers, we often want to improve things. However, during migrations, improvements can have non-obvious consequences and potentially significantly slow down the migration.</p><h3>ğŸ Conclusion</h3><p>After 4.5 years, we fully migrated Airbnbâ€™s biggest repo from Gradle to Bazel, achieving:</p><ul><li>Build CSAT: 38% â†’Â 68%</li><li><strong>3â€“5x </strong>faster local build and testÂ times</li><li><strong>2â€“3x</strong> faster IntelliJÂ syncs</li><li><strong>2â€“3x</strong> faster deploys to the development environment</li></ul><p>Finally, now that several Airbnb repos are on Bazel, weâ€™re able to share <a href=\"https://www.youtube.com/watch?v=RpSVBtyoYCY\">common infrastructure</a> such as remote build caching, remote build execution, affected targets calculation, andÂ more.</p><p>Interested in helping us solve problems like these at Airbnb? Learn more about our open engineering rolesÂ <a href=\"https://careers.airbnb.com/\">here</a>.</p><h3>Acknowledgments</h3><p>Additionally, thank you Janusz Kudelka, Kumail Hussain, Meghan Dow, Pawel Lipski, Peimin Liu, Tomasz Pacuszka, and various other internal and external partners.</p><img src=\"https://medium.com/_/stat?event=post.clientViewed&referrerSource=full_rss&postId=33f90eda51ec\" width=\"1\" height=\"1\" alt=\"\"><hr><p><a href=\"https://medium.com/airbnb-engineering/migrating-airbnbs-jvm-monorepo-to-bazel-33f90eda51ec\">Migrating Airbnbâ€™s JVM Monorepo to Bazel</a> was originally published in <a href=\"https://medium.com/airbnb-engineering\">The Airbnb Tech Blog</a> on Medium, where people are continuing the conversation by highlighting and responding to this story.</p>"
    },
    {
      "title": "å¤§è§„æ¨¡ Istio æ— ç¼å‡çº§ (åŸæ ‡é¢˜: Seamless Istio Upgrades at Scale)",
      "link": "https://medium.com/airbnb-engineering/seamless-istio-upgrades-at-scale-bcb0e49c5cf8?source=rss----53c7c27702d5---4",
      "pubDate": "Thu, 07 Aug 2025 17:01:42 GMT",
      "isoDate": "2025-08-07T17:01:42.000Z",
      "creator": "Rushy R. Panchal",
      "summary": "# å¤§è§„æ¨¡ Istio æ— ç¼å‡çº§\n\n## å¼•è¨€\n\nAirbnb è‡ª2019å¹´èµ·å¤§è§„æ¨¡è¿è¡Œ IstioÂ®ï¼Œæ”¯æŒæ•°ä¸‡ä¸ª Podã€æ•°åä¸ª Kubernetes é›†ç¾¤å’Œæ•°åƒä¸ªè™šæ‹Ÿæœº (VM)ï¼Œå³°å€¼æœŸé—´é€šè¿‡ Istio å¤„ç†æ•°åƒä¸‡ QPSã€‚Istio æ˜¯ Airbnb æ¶æ„çš„åŸºç¡€ç»„æˆéƒ¨åˆ†ï¼Œè¿™ä½¿å¾—å…¶æŒç»­ç»´æŠ¤å’Œå‡çº§æˆä¸ºä¸€é¡¹æŒ‘æˆ˜ã€‚å°½ç®¡å¦‚æ­¤ï¼ŒAirbnb å·²æˆåŠŸå‡çº§ Istio 14 æ¬¡ã€‚æœ¬æ–‡å°†æ¢è®¨ Airbnb æœåŠ¡ç½‘æ ¼å›¢é˜Ÿå¦‚ä½•åœ¨ä¿æŒé«˜å¯ç”¨æ€§çš„åŒæ—¶å®‰å…¨åœ°å‡çº§ Istioã€‚\n\n![å›¾ç‰‡ 1](https://cdn-images-1.medium.com/max/1024/1*44AVFDg8R66nWj4cAU8vCA.jpeg)\n\n## é¢ä¸´çš„æŒ‘æˆ˜ä¸å‡çº§ç›®æ ‡\n\nAirbnb å·¥ç¨‹å¸ˆè¿è¡Œç€æ•°åƒç§ä¸åŒçš„å·¥ä½œè´Ÿè½½ï¼Œæ— æ³•åˆç†åè°ƒæ¯ä¸ªå›¢é˜Ÿã€‚å› æ­¤ï¼Œå‡çº§è¿‡ç¨‹å¿…é¡»ç‹¬ç«‹äºå•ä¸ªå›¢é˜Ÿè¿è¡Œï¼Œä¸”ç”±äºæ— æ³•åŒæ—¶ç›‘æ§æ‰€æœ‰å·¥ä½œè´Ÿè½½ï¼Œå¿…é¡»é€šè¿‡æ¸è¿›å¼å‘å¸ƒå°†é£é™©é™è‡³æœ€ä½ã€‚\n\nåŸºäºæ­¤ï¼ŒAirbnb è®¾è®¡çš„å‡çº§æµç¨‹æ—¨åœ¨å®ç°ä»¥ä¸‹ç›®æ ‡ï¼š\n\n*   **å·¥ä½œè´Ÿè½½å’Œç”¨æˆ·é›¶åœæœº**ï¼šè¿™æ˜¯æ— ç¼å‡çº§çš„å…³é”®ï¼Œå·¥ä½œè´Ÿè½½æ‰€æœ‰è€…æ— éœ€å‚ä¸ Istio å‡çº§ã€‚\n*   **æ¸è¿›å¼å‘å¸ƒ**ï¼šèƒ½å¤Ÿæ§åˆ¶å“ªäº›å·¥ä½œè´Ÿè½½è¢«å‡çº§æˆ–å›æ»šã€‚\n*   **å…¨é¢å›æ»šèƒ½åŠ›**ï¼šæ— éœ€åè°ƒæ¯ä¸ªå·¥ä½œè´Ÿè½½å›¢é˜Ÿï¼Œå³å¯åœ¨æ‰€æœ‰å·¥ä½œè´Ÿè½½ä¸Šå›æ»šå‡çº§ã€‚\n*   **è§„å®šæ—¶é—´å†…å®Œæˆå‡çº§**ï¼šæ‰€æœ‰å·¥ä½œè´Ÿè½½åº”åœ¨å®šä¹‰çš„æ—¶é—´å†…å®Œæˆå‡çº§ã€‚\n\n## æ¶æ„æ¦‚è§ˆ\n\nAirbnb çš„ Istio éƒ¨ç½²åŒ…å«ä¸€ä¸ª**ç®¡ç†é›†ç¾¤**ï¼Œè¿è¡Œ Istiod å¹¶åŒ…å«æ‰€æœ‰ç½‘æ ¼çš„å·¥ä½œè´Ÿè½½é…ç½®ï¼ˆå¦‚ VirtualServicesã€DestinationRulesï¼‰ï¼Œä»¥åŠå¤šä¸ª**å·¥ä½œè´Ÿè½½é›†ç¾¤**ï¼Œè¿è¡Œç”¨æˆ·å·¥ä½œè´Ÿè½½ã€‚VM ç‹¬ç«‹è¿è¡Œï¼Œä½†å…¶ Istio Manifests ä»éƒ¨ç½²åˆ°ç®¡ç†é›†ç¾¤çš„ç‹¬ç«‹å‘½åç©ºé—´ä¸­ã€‚Airbnb ç‹¬å ä½¿ç”¨ **Sidecar æ¨¡å¼**ï¼Œå³æ¯ä¸ªå·¥ä½œè´Ÿè½½éƒ½è¿è¡Œ istio-proxyï¼Œå°šæœªè¿è¡Œ Ambient æ¨¡å¼ã€‚\n\n![Istio éƒ¨ç½²æ¶æ„å›¾](https://cdn-images-1.medium.com/max/1024/0*-qAuZZZxdsi-oJSO)\n\n## å‡çº§æµç¨‹\n\nAirbnb éµå¾ª Istio çš„ **Canary å‡çº§æ¨¡å‹**ï¼Œå³åŒæ—¶è¿è¡Œä¸¤ä¸ªç‰ˆæœ¬çš„ Istiodï¼ˆå½“å‰ç‰ˆæœ¬å’Œæ–°ç‰ˆæœ¬ï¼‰ã€‚è¿™ä¸¤ä¸ªç‰ˆæœ¬å…±åŒæ„æˆä¸€ä¸ªé€»è¾‘æœåŠ¡ç½‘æ ¼ï¼Œå…è®¸è¿æ¥åˆ°ä¸åŒ Istiod çš„å·¥ä½œè´Ÿè½½ç›¸äº’é€šä¿¡ã€‚Istiod ç‰ˆæœ¬é€šè¿‡ä¸åŒçš„ä¿®è®¢æ ‡ç­¾è¿›è¡Œç®¡ç†ï¼ˆä¾‹å¦‚ï¼Œ1-24-5 ç”¨äº Istio 1.24.5ï¼Œ1-25-2 ç”¨äº Istio 1.25.2ï¼‰ã€‚\n\nå‡çº§æ¶‰åŠæ§åˆ¶å¹³é¢ Istiod å’Œæ•°æ®å¹³é¢ Sidecar istio-proxyã€‚å°½ç®¡ Istio æ”¯æŒæ—§ç‰ˆ istio-proxy è¿æ¥æ–°ç‰ˆ Istiodï¼Œä½† Airbnb ä¸é‡‡ç”¨æ­¤æ–¹å¼ã€‚ç›¸åï¼Œä»–ä»¬åŸå­æ€§åœ°å°†æ–°ç‰ˆ istio-proxy åŠå…¶è¿æ¥çš„ Istiod é…ç½®ä¸€åŒå‘å¸ƒåˆ°å·¥ä½œè´Ÿè½½ã€‚ä¾‹å¦‚ï¼Œä¸º 1.24 ç‰ˆæœ¬æ„å»ºçš„ istio-proxy åªä¼šè¿æ¥åˆ° 1.24 çš„ Istiodï¼Œè¿™é™ä½äº†å‡çº§æœŸé—´çš„å¤æ‚æ€§ï¼ˆè·¨ç‰ˆæœ¬æ•°æ®å¹³é¢-æ§åˆ¶å¹³é¢å…¼å®¹æ€§ï¼‰ã€‚\n\nå‡çº§è¿‡ç¨‹çš„ç¬¬ä¸€æ­¥æ˜¯åœ¨ç®¡ç†é›†ç¾¤ä¸Šéƒ¨ç½²å¸¦æœ‰æ–°ä¿®è®¢æ ‡ç­¾çš„æ–°ç‰ˆ Istiodã€‚ç”±äºæ‰€æœ‰å·¥ä½œè´Ÿè½½éƒ½æ˜ç¡®ç»‘å®šåˆ°æŸä¸ªä¿®è®¢ç‰ˆï¼Œå› æ­¤æ²¡æœ‰å·¥ä½œè´Ÿè½½ä¼šè¿æ¥åˆ°è¿™ä¸ªæ–°çš„ Istiodï¼Œè¿™ä¸€æ­¥æ²¡æœ‰å½±å“ã€‚å‡çº§çš„å…¶ä½™éƒ¨åˆ†ï¼ˆä¹Ÿæ˜¯ä¸»è¦å·¥ä½œå’Œé£é™©æ‰€åœ¨ï¼‰æ˜¯é€æ­¥å°†å·¥ä½œè´Ÿè½½åˆ‡æ¢åˆ°è¿è¡Œæ–°ç‰ˆ istio-proxy å¹¶è¿æ¥åˆ°æ–°ç‰ˆ Istiodã€‚\n\n![å¤šä¿®è®¢ç‰ˆ Istio ç¤ºæ„å›¾](https://cdn-images-1.medium.com/max/1024/0*k7_eTtEPqBiDKM3t)\n\n## å‘å¸ƒè§„èŒƒ (`rollouts.yml`)\n\nAirbnb é€šè¿‡ä¸€ä¸ªåä¸º `rollouts.yml` çš„æ–‡ä»¶æ§åˆ¶å·¥ä½œè´Ÿè½½è¿è¡Œçš„ istio-proxy ç‰ˆæœ¬ã€‚è¯¥æ–‡ä»¶æŒ‡å®šäº†å·¥ä½œè´Ÿè½½å‘½åç©ºé—´ï¼ˆä½œä¸ºæ¨¡å¼ï¼‰å’Œ Istio ç‰ˆæœ¬çš„ç™¾åˆ†æ¯”åˆ†å¸ƒï¼Œä¾‹å¦‚ï¼š\n\n```yaml\n# \"production\" æ˜¯é»˜è®¤å€¼ï¼›ä»»ä½•ä¸åŒ¹é…å…¶ä»–æ¨¡å¼çš„éƒ½å°†åŒ¹é…æ­¤é¡¹ã€‚\nproduction: 1-24-5: 100\n\n\".*-staging\": 1-24-5: 75 1-25-2: 25\n\n# ä¸€ä¸ªå›ºå®šçš„å‘½åç©ºé—´ï¼›æˆ‘ä»¬çš„ç«¯åˆ°ç«¯éªŒè¯å·¥ä½œè´Ÿè½½ã€‚\nistio-e2e: 1-25-2: 100\n```\n\næ­¤è§„èŒƒè§„å®šäº†æ‰€æœ‰å‘½åç©ºé—´çš„æœŸæœ›çŠ¶æ€ã€‚ç»™å®šå‘½åç©ºé—´é¦–å…ˆæ˜ å°„åˆ°ä¸€ä¸ªæ¡¶ï¼ˆåŸºäºæœ€é•¿åŒ¹é…æ¨¡å¼ï¼‰ï¼Œç„¶åæ ¹æ®è¯¥æ¡¶çš„åˆ†å¸ƒé€‰æ‹©ä¸€ä¸ªç‰ˆæœ¬ã€‚è¿™ç§åˆ†å¸ƒåº”ç”¨äºå‘½åç©ºé—´çº§åˆ«ï¼Œè€Œé Pod æˆ– VM çº§åˆ«ï¼Œä¸”é€šè¿‡ä¸€è‡´æ€§å“ˆå¸Œå®ç°ç¡®å®šæ€§åˆ†é…ã€‚å¤§éƒ¨åˆ†å‡çº§è¿‡ç¨‹ä»…æ¶‰åŠæ›´æ–° `rollouts.yml` å¹¶è¿›è¡Œç›‘æ§ã€‚è¿™ç§æ–¹å¼å…è®¸é€‰æ‹©æ€§å‡çº§å·¥ä½œè´Ÿè½½ï¼Œå¹¶èƒ½ç‹¬ç«‹å‡çº§ç¯å¢ƒï¼Œç¡®ä¿åªæœ‰ä¸€å®šæ¯”ä¾‹çš„ç¯å¢ƒè¿è¡Œæ–°ç‰ˆæœ¬ï¼Œä»è€Œæœ‰æ—¶é—´è¿›è¡Œâ€œçƒ˜ç„™â€å¹¶å‘ç°æ½œåœ¨çš„å›å½’é—®é¢˜ã€‚\n\n## Kubernetes å·¥ä½œè´Ÿè½½å‡çº§æœºåˆ¶\n\næ¯ä¸ª Istio ä¿®è®¢ç‰ˆåœ¨æ¯ä¸ªå·¥ä½œè´Ÿè½½é›†ç¾¤ä¸Šéƒ½æœ‰ä¸€ä¸ªå¯¹åº”çš„ `MutatingAdmissionWebhook` ç”¨äº Sidecar æ³¨å…¥ã€‚æ­¤ Webhook é€‰æ‹©å¸¦æœ‰ `istio.io/rev=<revision>` æ ‡ç­¾çš„ Podï¼Œå¹¶å‘å…¶æ³¨å…¥ istio-proxy å’Œ istio-init å®¹å™¨ã€‚å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œistio-proxy å®¹å™¨åŒ…å« `PROXY_CONFIG` ç¯å¢ƒå˜é‡ï¼Œè¯¥å˜é‡å°† `discoveryAddress` è®¾ç½®ä¸ºç‰¹å®šçš„ Istiod ä¿®è®¢ç‰ˆã€‚è¿™ç¡®ä¿äº† istio-proxy ç‰ˆæœ¬å’Œå…¶è¿æ¥çš„ Istiod é…ç½®çš„åŸå­æ€§éƒ¨ç½²ï¼Œå®Œå…¨ç”± Sidecar æ³¨å…¥å™¨å®Œæˆã€‚\n\næ¯ä¸ªå·¥ä½œè´Ÿè½½çš„ Deployment éƒ½å¸¦æœ‰æ­¤ä¿®è®¢æ ‡ç­¾ã€‚ç„¶è€Œï¼Œä¼ ç»Ÿæ–¹æ³•è¦æ±‚æ¯ä¸ªå›¢é˜Ÿæ‰‹åŠ¨æ›´æ–°æ­¤æ ‡ç­¾å¹¶éƒ¨ç½²å…¶å·¥ä½œè´Ÿè½½ï¼Œè¿™ä½¿å¾—åœ¨æ‰€æœ‰å·¥ä½œè´Ÿè½½ä¸Šæ‰§è¡Œå›æ»šæˆ–ç¡®ä¿ 100% å®Œæˆå‡çº§å˜å¾—ä¸åˆ‡å®é™…ã€‚\n\n### Krisprï¼šå†…éƒ¨çªå˜æ¡†æ¶\n\nä¸ºé¿å…å•ç‹¬æ›´æ–°å·¥ä½œè´Ÿè½½ï¼ŒAirbnb ä½¿ç”¨å†…éƒ¨æ„å»ºçš„çªå˜æ¡†æ¶ **Krispr** æ¥æ³¨å…¥ä¿®è®¢æ ‡ç­¾ï¼Œä»è€Œå°†åŸºç¡€è®¾æ–½ç»„ä»¶å‡çº§ä¸å·¥ä½œè´Ÿè½½éƒ¨ç½²è§£è€¦ã€‚Airbnb åœ¨ Kubernetes ä¸Šè¿è¡Œçš„å·¥ä½œè´Ÿè½½ä½¿ç”¨å†…éƒ¨ API å®šä¹‰ï¼Œè€Œéç›´æ¥æŒ‡å®š Kubernetes Manifestsã€‚æ­¤æŠ½è±¡åœ¨ CI æœŸé—´ç¼–è¯‘ä¸º Kubernetes Manifestsï¼ŒKrispr ä½œä¸ºç¼–è¯‘è¿‡ç¨‹çš„ä¸€éƒ¨åˆ†è¿è¡Œï¼Œå¹¶çªå˜è¿™äº› Manifestsã€‚å…¶ä¸­ä¸€é¡¹çªå˜å°±æ˜¯æ ¹æ® `rollouts.yml` å†³å®šå¹¶æ³¨å…¥ Istio ä¿®è®¢æ ‡ç­¾åˆ°æ¯ä¸ª Deployment çš„ Pod è§„èŒƒä¸­ã€‚å¦‚æœå›¢é˜Ÿåœ¨éƒ¨ç½²æ—¶å‘ç°ä»»ä½•é—®é¢˜ï¼Œä»–ä»¬å¯ä»¥å›æ»šï¼Œä»è€Œä¹Ÿå›æ»š Istio å‡çº§ï¼Œè€Œæ— éœ€æœåŠ¡ç½‘æ ¼å›¢é˜Ÿçš„ä»‹å…¥ã€‚\n\næ­¤å¤–ï¼ŒKrispr è¿˜åœ¨ Pod å‡†å…¥é˜¶æ®µè¿è¡Œã€‚å¦‚æœä¸€ä¸ª Pod æ¥è‡ªè¶…è¿‡ä¸¤å‘¨çš„ Deploymentï¼ŒKrispr å°†é‡æ–°çªå˜è¯¥ Podï¼Œå¹¶åœ¨éœ€è¦æ—¶æ›´æ–°å…¶ä¿®è®¢æ ‡ç­¾ã€‚ç»“åˆ Kubernetes èŠ‚ç‚¹æœ€é•¿ä¸¤å‘¨çš„ç”Ÿå‘½å‘¨æœŸï¼ˆä»è€Œç¡®ä¿ä»»ä½•ç»™å®š Pod çš„æœ€é•¿ç”Ÿå‘½å‘¨æœŸä¹Ÿæ˜¯ä¸¤å‘¨ï¼‰ï¼ŒAirbnb å¯ä»¥ä¿è¯ Istio å‡çº§æœ€ç»ˆå®Œæˆã€‚å¤§å¤šæ•°å·¥ä½œè´Ÿè½½å°†åœ¨éƒ¨ç½²æ—¶ï¼ˆCI ä¸­çš„ Krispr è¿è¡ŒæœŸé—´ï¼‰å‡çº§ï¼Œå¯¹äºä¸å®šæœŸéƒ¨ç½²çš„å·¥ä½œè´Ÿè½½ï¼Œè‡ªç„¶çš„ Pod å¾ªç¯å’Œé‡æ–°çªå˜å°†ç¡®ä¿å®ƒä»¬åœ¨æœ€é•¿å››å‘¨å†…å®Œæˆå‡çº§ã€‚\n\n**æ€»ç»“ Kubernetes å·¥ä½œè´Ÿè½½å‡çº§æµç¨‹ï¼š**\n\n1.  **CI é˜¶æ®µ**ï¼šKrispr æ ¹æ® `rollouts.yml` çªå˜å·¥ä½œè´Ÿè½½çš„ Kubernetes Manifestsï¼Œæ·»åŠ  Istio ä¿®è®¢æ ‡ç­¾ã€‚\n2.  **Pod å‡†å…¥é˜¶æ®µ**ï¼šå¦‚æœ Pod çš„ Deployment è¶…è¿‡ä¸¤å‘¨ï¼ŒKrispr ä¼šé‡æ–°çªå˜ Podï¼Œå¹¶åœ¨éœ€è¦æ—¶æ›´æ–° Istio ä¿®è®¢æ ‡ç­¾ã€‚\n3.  **Webhook æ³¨å…¥**ï¼šç‰¹å®šä¿®è®¢ç‰ˆçš„ Istio `MutatingAdmissionWebhook` ä¼šæ³¨å…¥ Sidecar å’Œå…³è”çš„ `discoveryAddress`ã€‚\n\n## è™šæ‹Ÿæœº (VM) å·¥ä½œè´Ÿè½½å‡çº§æœºåˆ¶\n\nåœ¨ VM ä¸Šï¼ŒAirbnb éƒ¨ç½²ä¸€ä¸ªåŒ…å« istio-proxyã€è¿è¡Œ istio-iptables çš„è„šæœ¬ï¼ˆç±»ä¼¼äº istio-init å®¹å™¨ï¼‰å’Œ Istiod `discoveryAddress` çš„å·¥ä»¶ã€‚é€šè¿‡å°† istio-proxy å’Œ `discoveryAddress` æ‰“åŒ…åœ¨åŒä¸€å·¥ä»¶ä¸­ï¼Œå¯ä»¥åŸå­æ€§åœ°å‡çº§ä¸¤è€…ã€‚æ­¤å·¥ä»¶çš„å®‰è£…ç”±ä¸»æœºå®ˆæŠ¤è¿›ç¨‹ **mxagent** è´Ÿè´£ã€‚å®ƒé€šè¿‡è½®è¯¢ VM ä¸Šçš„é”®å€¼æ ‡ç­¾ï¼ˆå¦‚ AWS ä¸Šçš„ EC2 æ ‡ç­¾æˆ– GCP ä¸Šçš„èµ„æºæ ‡ç­¾ï¼Œè¿™äº›æ ‡ç­¾æ¨¡ä»¿ Kubernetes å·¥ä½œè´Ÿè½½çš„ `istio.io/rev` æ ‡ç­¾ï¼‰æ¥ç¡®å®šè¦å®‰è£…çš„ç‰ˆæœ¬ã€‚æ¯å½“è¿™äº›æ ‡ç­¾æ”¹å˜æ—¶ï¼Œmxagent å°±ä¼šä¸‹è½½å¹¶å®‰è£…å¯¹åº”ç‰ˆæœ¬çš„å·¥ä»¶ã€‚å› æ­¤ï¼Œå‡çº§ VM ä¸Šçš„ istio-proxy åªéœ€æ›´æ–°è¯¥ VM ä¸Šçš„è¿™äº›æ ‡ç­¾ï¼Œmxagent å°†å¤„ç†å…¶ä½™éƒ¨åˆ†ã€‚\n\nAirbnb çš„ VM å·¥ä½œè´Ÿè½½ä¸»è¦æ˜¯åŸºç¡€è®¾æ–½å¹³å°ï¼Œé€šå¸¸ä¸å®šæœŸéƒ¨ç½²ä»£ç ã€‚å› æ­¤ï¼ŒVM ä¸æ”¯æŒéƒ¨ç½²æ—¶å‡çº§ï¼ˆä¸åƒ Kubernetes å·¥ä½œè´Ÿè½½ï¼‰ã€‚åŒæ ·ï¼Œå›¢é˜Ÿæ— æ³•è‡ªè¡Œå›æ»šè¿™äº›å·¥ä½œè´Ÿè½½ï¼Œä½†è€ƒè™‘åˆ°æ­¤ç±»åŸºç¡€è®¾æ–½å¹³å°æ•°é‡æœ‰é™ï¼Œè¿™æ˜¯å¯ä»¥æ¥å—çš„ã€‚\n\næ ‡ç­¾æ›´æ–°ç”±ä¸­å¤®æ§åˆ¶å™¨ **mxrc** ç®¡ç†ï¼Œå®ƒæ‰«æè¿‡æ—¶çš„ VMã€‚å¦‚æœ `rollouts.yml` ä¼šå¯¼è‡´ VM çš„èµ„æºæ ‡ç­¾é›†å‘ç”Ÿå˜åŒ–ï¼Œæ§åˆ¶å™¨å°†ç›¸åº”åœ°æ›´æ–°æ ‡ç­¾ã€‚è¿™å¤§è‡´å¯¹åº”äº Krispr çš„ Pod å‡†å…¥æ—¶çªå˜ï¼Œä½†éœ€è¦æ³¨æ„çš„æ˜¯ï¼ŒVM æ˜¯å¯å˜çš„ä¸”ç”Ÿå‘½å‘¨æœŸé•¿ï¼Œå› æ­¤æ˜¯åŸåœ°å‡çº§ã€‚\n\nä¸ºäº†å®‰å…¨èµ·è§ï¼Œmxrc ä¼šè€ƒè™‘ VM çš„å¥åº·çŠ¶å†µï¼Œç‰¹åˆ«æ˜¯ WorkloadEntry ä¸Šçš„å°±ç»ªæ¢é’ˆçŠ¶æ€ã€‚ç±»ä¼¼äº Kubernetes çš„ `maxUnavailable` è¯­ä¹‰ï¼Œmxrc æ—¨åœ¨å°†ä¸å¯ç”¨ VM çš„æ•°é‡ï¼ˆå³ä¸å¥åº·çš„ VM åŠ ä¸Šæ­£åœ¨å‡çº§çš„ VMï¼‰ä¿æŒåœ¨å®šä¹‰çš„ç™¾åˆ†æ¯”ä»¥ä¸‹ã€‚å®ƒé€æ­¥æ‰§è¡Œè¿™äº›å‡çº§ï¼Œç›®æ ‡æ˜¯åœ¨ä¸¤å‘¨å†…å®Œæˆä¸€ä¸ªå·¥ä½œè´Ÿè½½æ‰€æœ‰ VM çš„å‡çº§ã€‚\n\n## ç»“è®º\n\nè·Ÿä¸Šå¼€æºè½¯ä»¶çš„æ›´æ–°æ­¥ä¼æ˜¯ä¸€é¡¹æŒ‘æˆ˜ï¼Œå°¤å…¶æ˜¯åœ¨å¤§è§„æ¨¡ç¯å¢ƒä¸‹ã€‚å‡çº§å’Œå…¶ä»– Day-2 æ“ä½œå¸¸å¸¸è¢«å¿½è§†ï¼Œè¿™åœ¨æœ€ç»ˆéœ€è¦å‡çº§æ—¶ï¼ˆä¸ºäº†å¼•å…¥å®‰å…¨è¡¥ä¸ã€ä¿æŒåœ¨æ”¯æŒçª—å£å†…ã€åˆ©ç”¨æ–°åŠŸèƒ½ç­‰ï¼‰å¢åŠ äº†è´Ÿæ‹…ã€‚å¯¹äº Istio è€Œè¨€å°¤å…¶å¦‚æ­¤ï¼Œå…¶ç‰ˆæœ¬å¾ˆå¿«å°±ä¼šè¾¾åˆ°ç”Ÿå‘½å‘¨æœŸç»“æŸã€‚\n\nå°½ç®¡æœåŠ¡ç½‘æ ¼çš„å¤æ‚æ€§å’Œè§„æ¨¡å·¨å¤§ï¼ŒAirbnb å·²æˆåŠŸå‡çº§ Istio 14 æ¬¡ã€‚è¿™å¾—ç›Šäºï¼š\n\n*   **å¯ç»´æŠ¤æ€§è®¾è®¡**\n*   **ç¡®ä¿é›¶åœæœºçš„æµç¨‹**\n*   **é€šè¿‡æ¸è¿›å¼å‘å¸ƒé™ä½é£é™©**\n\nç±»ä¼¼æµç¨‹ä¹Ÿåº”ç”¨äº Airbnb çš„å…¶ä»–å¤šä¸ªåŸºç¡€æ¶æ„ç³»ç»Ÿã€‚\n\n## æœªæ¥å·¥ä½œ\n\néšç€ Airbnb åŸºç¡€è®¾æ–½çš„ä¸æ–­å‘å±•å’Œå£®å¤§ï¼ŒæœåŠ¡ç½‘æ ¼å›¢é˜Ÿæ­£åœ¨å…³æ³¨å‡ ä¸ªå…³é”®é¡¹ç›®ï¼š\n\n*   **åˆ©ç”¨ Ambient æ¨¡å¼**ï¼šä½œä¸ºä¸€ç§æ›´å…·æˆæœ¬æ•ˆç›Šä¸”æ›´æ˜“äºç®¡ç†çš„ Istio éƒ¨ç½²æ¨¡å‹ã€‚ç‰¹åˆ«æ˜¯ï¼Œå®ƒé€šè¿‡å®Œå…¨æ— éœ€è§¦åŠå·¥ä½œè´Ÿè½½éƒ¨ç½²æ¥ç®€åŒ–å‡çº§ã€‚\n*   **å°†å•ä¸€ç”Ÿäº§ç½‘æ ¼æ‹†åˆ†ä¸ºå¤šä¸ªç½‘æ ¼**ï¼šä»¥åˆ†ç¦»æ•…éšœåŸŸã€æä¾›æ›´å¥½çš„å®‰å…¨éš”ç¦»è¾¹ç•Œå¹¶è¿›ä¸€æ­¥æ‰©å±• Istioã€‚å¯¹äºå‡çº§è€Œè¨€ï¼Œè¿™å°†è¿›ä¸€æ­¥ç¼©å°å½±å“èŒƒå›´ï¼Œå› ä¸ºä¸€äº›åªè¿è¡Œä½é£é™©å·¥ä½œè´Ÿè½½ï¼ˆå¦‚ stagingï¼‰çš„ç½‘æ ¼å¯ä»¥é¦–å…ˆå‡çº§ã€‚",
      "shortSummary": "Airbnb è¯¦ç»†ä»‹ç»äº†å…¶å¤§è§„æ¨¡ Istio æ— ç¼å‡çº§å®è·µã€‚é¢å¯¹æ•°ä¸‡ä¸ª Pod å’Œ VM çš„å¤æ‚ç¯å¢ƒï¼Œä»–ä»¬é€šè¿‡ Istio çš„ Canary å‡çº§æ¨¡å‹ï¼Œç»“åˆå†…éƒ¨å·¥å…· Krisprï¼ˆç”¨äº Kubernetesï¼‰å’Œ mxagent/mxrcï¼ˆç”¨äº VMï¼‰ï¼Œå®ç°äº†æ§åˆ¶å¹³é¢å’Œæ•°æ®å¹³é¢çš„åŸå­æ€§å‡çº§ã€‚è¿™å¥—ç³»ç»Ÿç¡®ä¿äº†é›¶åœæœºã€æ¸è¿›å¼å‘å¸ƒå’Œæ— éœ€äººå·¥åè°ƒçš„å…¨é¢å›æ»šèƒ½åŠ›ï¼Œä½¿æ‰€æœ‰å·¥ä½œè´Ÿè½½èƒ½åœ¨æ•°å‘¨å†…å®Œæˆå‡çº§ã€‚æœªæ¥è®¡åˆ’åŒ…æ‹¬é‡‡ç”¨ Ambient æ¨¡å¼å’Œæ‹†åˆ†æœåŠ¡ç½‘æ ¼ä»¥æå‡æ•ˆç‡å’Œå®‰å…¨æ€§ã€‚",
      "translated_title": "å¤§è§„æ¨¡ Istio æ— ç¼å‡çº§",
      "images": [
        {
          "url": "https://cdn-images-1.medium.com/max/1024/1*44AVFDg8R66nWj4cAU8vCA.jpeg",
          "alt": "",
          "title": "",
          "position": 1
        },
        {
          "url": "https://cdn-images-1.medium.com/max/1024/0*-qAuZZZxdsi-oJSO",
          "alt": "A diagram of Istio deployment architecture at Airbnb. There is a single configuration cluster containing Istio custom resources like VirtualServices, Istiod, and Istiodâ€™s ConfigMaps. There are two workload clusters, each running user workloads, and alongside those a number of VMs. Workloads and VMs communicate with each other.",
          "title": "",
          "position": 2
        },
        {
          "url": "https://cdn-images-1.medium.com/max/1024/0*k7_eTtEPqBiDKM3t",
          "alt": "Istio with multiple revisions. There is a config cluster with Istio custom resources like VirtualServices, multiple Istiod deployments, and the Istiod ConfigMaps for each of those. Workloads can connect to either Istiod.",
          "title": "",
          "position": 3
        },
        {
          "url": "https://medium.com/_/stat?event=post.clientViewed&referrerSource=full_rss&postId=bcb0e49c5cf8",
          "alt": "",
          "title": "",
          "position": 4
        }
      ],
      "contentSource": "RSS",
      "content": "<h4><strong>How Airbnb upgrades tens of thousands of pods on dozens of Kubernetes clusters to new IstioÂ versions</strong></h4><figure><img alt=\"\" src=\"https://cdn-images-1.medium.com/max/1024/1*44AVFDg8R66nWj4cAU8vCA.jpeg\" /></figure><p>Airbnb has been running IstioÂ® at scale since 2019. We support workloads running on both Kubernetes and virtual machines (using <a href=\"https://istio.io/latest/docs/ops/deployment/vm-architecture/\">Istioâ€™s mesh expansion</a>). Across these two environments, we run tens of thousands of pods, dozens of Kubernetes clusters, and thousands of VMs. These workloads send tens of millions of QPS at peak through Istio. Our <a href=\"https://www.youtube.com/watch?v=6kDiDQW5YXQ\">IstioCon 2021 talk</a> describes our journey onto Istio and our <a href=\"https://www.youtube.com/watch?v=1D8lg36ZNHs\">KubeCon 2021 talk</a> goes into further detail on our architecture.</p><p>Istio is a foundational piece of our architecture, which makes ongoing maintenance and upgrades a challenge. Despite that, we have upgraded Istio a total of 14 times. This blog post will explore how the Service Mesh team at Airbnb safely upgrades Istio while maintaining high availability.</p><h4>Challenges</h4><p>Airbnb engineers collectively run thousands of different workloads. We cannot reasonably coordinate the teams that own these, so our upgrades must function independently of individual teams. We also cannot monitor all of these at once, and so we must minimize risk through gradual rollouts.</p><p>With that in mind, we designed our upgrade process with the following goals:</p><ol><li>Zero downtime for workloads and users. This is the <em>seamless</em> part of the upgradeâ€Šâ€”â€Ša workload owner doesnâ€™t need to be in the loop for Istio upgrades.</li><li>Gradual rollouts with the ability to control which workloads are upgraded or reverted.</li><li>We must be able to roll back an upgrade across all workloads, without coordinating every workloadÂ team.</li><li>All workloads should be upgraded within some definedÂ time.</li></ol><h4>Architecture</h4><p>Our deployment consists of one management cluster, which runs Istiod and contains all workload configuration for the mesh (VirtualServices, DestinationRules, and so forth), and multiple workload clusters, which run user workloads. VMs run separately, but their Istio manifests are still deployed to the management cluster in their own namespaces. We use Sidecar mode exclusively, meaning that every workload runs istio-proxyâ€Šâ€”â€Šwe do not yet runÂ <a href=\"https://istio.io/latest/docs/ambient/overview/\">Ambient</a>.</p><figure><img alt=\"A diagram of Istio deployment architecture at Airbnb. There is a single configuration cluster containing Istio custom resources like VirtualServices, Istiod, and Istiodâ€™s ConfigMaps. There are two workload clusters, each running user workloads, and alongside those a number of VMs. Workloads and VMs communicate with each other.\" src=\"https://cdn-images-1.medium.com/max/1024/0*-qAuZZZxdsi-oJSO\" /></figure><h4>Upgrade Process</h4><p>At a high level, we follow <a href=\"https://istio.io/latest/docs/setup/upgrade/canary/\">Istioâ€™s canary upgrade model</a>. This involves running two versions (or Istio revisions) of Istiod simultaneously: the current version and the new version that we are upgrading to. Both form one logical service mesh, so workloads connected to one Istiod can communicate with workloads connected to another Istiod and vice versa. Istiod versions are managed using different revision labelsâ€Šâ€”â€Šfor example, 1â€“24â€“5 for Istio 1.24.5 and 1â€“25â€“2 for IstioÂ 1.25.2.</p><p>An upgrade involves both Istiod, the control plane, and istio-proxy, the data plane sidecar, running on all pods and VMs. While Istio supports connecting an <a href=\"https://istio.io/latest/docs/releases/supported-releases/#control-planedata-plane-skew\">older istio-proxy to a newer Istiod</a>, we do not use this. Instead, we atomically roll out the new istio-proxy version to a workload along with the configuration of which Istiod to connect to. For example, the istio-proxy built for version 1.24 will only connect to 1.24â€™s Istiod and the istio-proxy built for 1.25 will only connect to 1.25â€™s Istiod. This reduces a dimension of complexity during upgrades (cross-version data planeâ€Šâ€”â€Šcontrol plane compatibility).</p><p>The first step of our upgrade process is to deploy the new Istiod, with a new revision label, onto the management cluster. Because all workloads are explicitly pinned to a revision, no workload will connect to this new Istiod, so this first step has noÂ impact.</p><p>The rest of the upgrade comprises all of the effort and riskâ€Šâ€”â€Šworkloads are gradually shifted to run the new istio-proxy version and connect to the newÂ Istiod.</p><figure><img alt=\"Istio with multiple revisions. There is a config cluster with Istio custom resources like VirtualServices, multiple Istiod deployments, and the Istiod ConfigMaps for each of those. Workloads can connect to either Istiod.\" src=\"https://cdn-images-1.medium.com/max/1024/0*k7_eTtEPqBiDKM3t\" /><figcaption><em>Multiple Istio revisions, with some workloads connected to different revisions.</em></figcaption></figure><h3>Rollout specification</h3><p>We control what version of istio-proxy workloads run through a file called rollouts.yml. This file specifies workload namespaces (as patterns) and the percentage distribution of Istio versions:</p><pre># &quot;production&quot; is the default; anything not matching a different pattern will match this.<br>production:<br>  1-24-5: 100<br><br>&quot;.*-staging&quot;:<br>  1-24-5: 75<br>  1-25-2: 25<br><br># A pinned namespace; our end-to-end verification workload.<br>istio-e2e:<br>  1-25-2: 100</pre><p>This spec dictates the desired state of all namespaces. A given namespace is first mapped to a bucket (based on the longest pattern that matches) and then a version is chosen based on the distribution for that bucket. The distribution applies at the namespace level, not the pod (or VM) level. ForÂ example,</p><pre>&quot;.*-staging&quot;:<br>  1-24-5: 75<br>  1-25-2: 25</pre><p>means that 75% of the namespaces with the suffix -stagingwill be assigned to 1â€“24â€“5 and the remaining 25% will be assigned to 1â€“25â€“2. This assignment is deterministic, using consistent hashing. The majority of our upgrade process involves updating rollouts.yml and then monitoring.</p><p>This process allows us to selectively upgrade workloads. We can also upgrade environments separately and ensure that only a certain percentage of those environments are on the new version. This gives us time to bake an upgrade and learn of potential regressions.</p><p>The rest of this post will describe the mechanism through which a change to rollouts.yml is applied to thousands of workloads, for both Kubernetes andÂ VMs.</p><h3>Kubernetes</h3><p>Each Istio revision has a corresponding <a href=\"https://istio.io/latest/docs/setup/additional-setup/sidecar-injection/#automatic-sidecar-injection\">MutatingAdmissionWebhook for sidecar injection</a> on every workload cluster. This webhook selects pods specifying the label istio.io/rev=&lt;revision&gt; and injects the istio-proxy and istio-init containers into those pods. Notably, the istio-proxy container contains the PROXY_CONFIG environment variable, which sets the discoveryAddress to the Istiod revision. This is how the istio-proxyversion and the configuration for which Istiod to connect to are deployed atomicallyâ€Šâ€”â€Šentirely by the sidecar injector.</p><p>Every workloadâ€™s Deployment has this revision label. For example, a workload configured to use Istio 1.24.5 will have the label istio.io/rev=1â€“24â€“5in its pod template; thus pods for that Deployment will be mutated by the MutatingAdmissionWebhook for IstioÂ 1.24.5.</p><p>This setup is the standard method of upgrading Istio, but requires that every Deployment specifies a revision label. To perform an upgrade across thousands of workloads, every team would have to update this label and deploy their workload. We could neither perform a rollback across all workloads nor reasonably expect an upgrade to complete to 100%, both for the same reasonâ€Šâ€”â€Šrelying on every workload toÂ deploy.</p><h4>Krispr</h4><p>To avoid having to update workloads individually, a workloadâ€™s configuration never directly specifies the revision label in source code. Instead, we use <a href=\"https://medium.com/airbnb-engineering/a-krispr-approach-to-kubernetes-infrastructure-a0741cff4e0c\">Krispr, a mutation framework built in-house</a>, to inject the revision label. Krispr gives us the ability to decouple infrastructure component upgrades from workload deployments.</p><p>Airbnb workloads that run on Kubernetes use an internal API to define their workload, instead of specifying Kubernetes manifests. This abstraction is then compiled into Kubernetes manifests during CI. Krispr runs as part of this compilation and mutates those Kubernetes manifests. One of those mutations injects the Istio revision label into the pod specification of each Deployment, reading rollouts.ymlto decide which label to inject. If a team sees any issue with their workload when they deploy, they can roll back and thus also roll back the Istio upgradeâ€Šâ€”â€Šall without involving the Service MeshÂ team.</p><p>In addition, Krispr runs during pod admission. If a pod is being admitted from a Deployment that is more than two weeks old, Krispr will re-mutate the pod and accordingly update the podâ€™s revision label if needed. Combined with the fact that our Kubernetes nodes have a maximum lifetime of two weeks, thus ensuring that any given podâ€™s maximum lifetime is also two weeks, we can guarantee that an Istio upgrade completes. A majority of workloads will be upgraded when they deploy (during the Krispr run in CI) and for those that donâ€™t deploy regularly, the natural pod cycling and re-mutation will ensure they are upgraded in at most fourÂ weeks.</p><p>In summary, per workload:</p><ol><li>During CI, Krispr mutates the Kubernetes manifests of a workload to add the Istio revision label, based on rollouts.yml.</li><li>When a pod is admitted to a cluster, Krispr will re-mutate the pod if its Deployment is more than two weeks old and update the Istio revision label ifÂ needed.</li><li>The revision-specific Istio MutatingAdmissionWebhook will mutate the pod by injecting the sidecar and associated discoveryAddress.</li></ol><h3>Virtual machines</h3><p>On VMs, we deploy an artifact that contains istio-proxy, a script to run istio-iptables (similar to the istio-init container), and the Istiod discoveryAddress. By packaging istio-proxy and the discoveryAddress in the same artifact, we can atomically upgradeÂ both.</p><p>Installation of this artifact is the responsibility of an on-host daemon called mxagent. It determines what version to install by polling a set of key-value tags on the VM (such as <a href=\"https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/Using_Tags.html\">EC2 tags on AWS</a> or <a href=\"https://cloud.google.com/compute/docs/tag-resources\">resource tags on GCP</a>). These tags mimic the istio.io/rev label for Kubernetes-based workloads. Whenever they change, mxagent will download and install the artifact corresponding to that version. Thus, upgrading istio-proxy on a VM just involves updating these tags on that VM; mxagent will take care of theÂ rest.</p><p>Our VM workloads are largely infrastructure platforms that donâ€™t typically have code deployed at regular intervals. As such, VMs donâ€™t support a deploy-time upgrade (in the way that Kubernetes workloads can be upgraded when they deploy). Similarly, teams cannot roll back these workloads themselves, but this has been acceptable, given that there are just a handful of such infrastructure platforms.</p><p>The tag updates are managed by a central controller, mxrc, which scans for outdated VMs. If rollouts.yml would result in a different set of resource tags for a VM, the controller will update the tags accordingly. This roughly corresponds to Krisprâ€™s pod admission-time mutationâ€Šâ€”â€Šhowever, with the caveat that VMs are mutable and long-lived, and thus are upgraded in-place.</p><p>For safety, mxrc takes into account the health of the VM, namely in the form of the <a href=\"https://istio.io/latest/docs/reference/config/networking/workload-group/#ReadinessProbe\">readiness probe status on the WorkloadEntry</a>. Similar to Kubernetesâ€™ maxUnavailable semantics, mxrc aims to keep the number of unavailable VMs (that is, unhealthy VMs plus those with in-progress upgrades) below a defined percentage. It gradually performs these upgrades, aiming to upgrade all the VMs for a workload in twoÂ weeks.</p><p>At the end of two weeks, all VMs will match the desired state in rollouts.yml.</p><h3>Conclusion</h3><p>Keeping up-to-date with open-source software is a challenge, especially at scale. Upgrades and other Day-2 operations often become an afterthought, which furthers the burden when upgrades are eventually necessary (to bring in security patches, remain within support windows, utilize new features, and so forth). This is particularly true with Istio, where a version reaches end-of-life supportÂ rapidly.</p><p>Even with the complexity and scale of our service mesh, we have successfully upgraded Istio 14 times. This was made possible due to designing for maintainability, building a process that ensures zero downtime, and derisking through the use of gradual rollouts. Similar processes are in use for a number of other foundational infrastructure systems atÂ Airbnb.</p><h3>Future work</h3><p>As Airbnbâ€™s infrastructure continues to evolve and grow, weâ€™re looking at a few key projects to evolve our serviceÂ mesh:</p><ul><li>Utilizing <a href=\"https://istio.io/latest/docs/ambient/overview/\">Ambient mode</a> as a more cost-effective and easier-to-manage deployment model of Istio. In particular, this simplifies upgrades by not needing to touch workload deployments atÂ all.</li><li>Splitting our singular production mesh into multiple meshes in order to separate fault domains, provide better security isolation boundaries, and scale Istio further. For upgrades, this would further reduce the blast radius, as some meshes that only run low-risk workloads (such as staging) could be upgradedÂ first.</li></ul><p>If this type of work interests you, we encourage you to apply for an <a href=\"https://careers.airbnb.com/\">open position</a>Â today.</p><h3>Acknowledgements</h3><p>All of our work with Istio is thanks to many different people, including: Jungho Ahn, Stephen Chan, Weibo He, Douglas Jordan, Brian Wolfe, Edie Yang, Dasol Yoon, and YingÂ Zhu.</p><p><em>All product names, logos, and brands are property of their respective owners. All company, product and service names used in this website are for identification purposes only. Use of these names, logos, and brands does not imply endorsement.</em></p><img src=\"https://medium.com/_/stat?event=post.clientViewed&referrerSource=full_rss&postId=bcb0e49c5cf8\" width=\"1\" height=\"1\" alt=\"\"><hr><p><a href=\"https://medium.com/airbnb-engineering/seamless-istio-upgrades-at-scale-bcb0e49c5cf8\">Seamless Istio Upgrades at Scale</a> was originally published in <a href=\"https://medium.com/airbnb-engineering\">The Airbnb Tech Blog</a> on Medium, where people are continuing the conversation by highlighting and responding to this story.</p>"
    },
    {
      "title": "Airbnb åœ¨ Kubernetes ä¸Šé€šè¿‡åˆ†å¸ƒå¼æ•°æ®åº“å®ç°é«˜å¯ç”¨æ€§ (åŸæ ‡é¢˜: Achieving High Availability with distributed database on Kubernetes at Airbnb)",
      "link": "https://medium.com/airbnb-engineering/achieving-high-availability-with-distributed-database-on-kubernetes-at-airbnb-58cc2e9856f4?source=rss----53c7c27702d5---4",
      "pubDate": "Mon, 28 Jul 2025 17:57:46 GMT",
      "isoDate": "2025-07-28T17:57:46.000Z",
      "creator": "Artem Danilov",
      "summary": "## Airbnb åœ¨ Kubernetes ä¸Šå®ç°åˆ†å¸ƒå¼æ•°æ®åº“é«˜å¯ç”¨æ€§\n\n### å¼•è¨€\n\nä¼ ç»Ÿä¸Šï¼Œç»„ç»‡é€šè¿‡åˆ†ç‰‡ç­–ç•¥åœ¨é«˜æˆæœ¬çš„ç‹¬ç«‹æœåŠ¡å™¨ä¸Šéƒ¨ç½²æ•°æ®åº“ä»¥å®ç°æ‰©å±•ã€‚ç„¶è€Œï¼Œéšç€æ•°æ®éœ€æ±‚çš„å¢é•¿ï¼Œè¿™ç§ç­–ç•¥çš„å±€é™æ€§æ—¥ç›Šæ˜æ˜¾ï¼Œç»´æŠ¤é¡¹ç›®å˜å¾—è¶Šæ¥è¶Šé•¿å’Œå¤æ‚ã€‚åˆ†å¸ƒå¼æ¨ªå‘å¯æ‰©å±•æ•°æ®åº“å·²ä¸ç½•è§ï¼Œå…¶ä¸­è®¸å¤šæ˜¯å¼€æºçš„ã€‚ä½†åœ¨äº‘ç¯å¢ƒä¸­ä»¥é«˜å¯ç”¨æ€§ã€ä½å»¶è¿Ÿã€å¯æ‰©å±•æ€§ä¸”æˆæœ¬åˆç†çš„æ–¹å¼å¯é è¿è¡Œè¿™äº›æ•°æ®åº“ï¼Œæ˜¯è®¸å¤šå…¬å¸é¢ä¸´çš„æŒ‘æˆ˜ã€‚\n\nAirbnb é‡‡å–äº†ä¸€ç§åˆ›æ–°ç­–ç•¥ï¼šåœ¨äº‘ç¯å¢ƒä¸­è·¨å¤šä¸ª Kubernetes é›†ç¾¤éƒ¨ç½²åˆ†å¸ƒå¼æ•°æ®åº“é›†ç¾¤ã€‚å°½ç®¡è¿™ç§è®¾è®¡æ¨¡å¼å› å…¶å¤æ‚æ€§ç›®å‰å°šä¸å¸¸è§ï¼Œä½†å®ƒä½¿ Airbnb å®ç°äº†ç›®æ ‡ç³»ç»Ÿå¯é æ€§å’Œå¯æ“ä½œæ€§ã€‚æœ¬æ–‡åˆ†äº«äº† Airbnb å¦‚ä½•å…‹æœæŒ‘æˆ˜å¹¶å¼€å‘å‡ºé€‚ç”¨äºä»»ä½•å¼ºä¸€è‡´æ€§åˆ†å¸ƒå¼å­˜å‚¨ç³»ç»Ÿçš„æœ€ä½³å®è·µã€‚\n\n### åœ¨ Kubernetes ä¸Šç®¡ç†æ•°æ®åº“\n\nAirbnb å°†ä¸€ä¸ªå¼€æºçš„æ¨ªå‘å¯æ‰©å±•åˆ†å¸ƒå¼ SQL æ•°æ®åº“é›†æˆåˆ°å…¶åŸºç¡€è®¾æ–½ä¸­ã€‚è™½ç„¶ Kubernetes æ˜¯è¿è¡Œæ— çŠ¶æ€æœåŠ¡çš„ä¼˜ç§€å·¥å…·ï¼Œä½†å°†å…¶ç”¨äºæ•°æ®åº“ç­‰æœ‰çŠ¶æ€æœåŠ¡å…·æœ‰æŒ‘æˆ˜æ€§ï¼Œå°¤å…¶æ˜¯åœ¨èŠ‚ç‚¹æ›¿æ¢å’Œå‡çº§æ–¹é¢ã€‚\n\n*   **æ•°æ®å¤„ç†æŒ‘æˆ˜**ï¼šKubernetes ç¼ºä¹å¯¹èŠ‚ç‚¹é—´æ•°æ®åˆ†å¸ƒçš„äº†è§£ï¼Œå› æ­¤æ¯æ¬¡èŠ‚ç‚¹æ›¿æ¢éƒ½éœ€è¦ä»”ç»†çš„æ•°æ®å¤„ç†ï¼Œä»¥é˜²æ­¢æ•°æ®ä»²è£ä¸¢å¤±å’ŒæœåŠ¡ä¸­æ–­ï¼ŒåŒ…æ‹¬åœ¨æ›¿æ¢èŠ‚ç‚¹å‰å¤åˆ¶æ•°æ®ã€‚\n*   **å­˜å‚¨è§£å†³æ–¹æ¡ˆ**ï¼šAirbnb é€‰æ‹©ä½¿ç”¨ AWS EBS å°†å­˜å‚¨å·é™„åŠ åˆ°èŠ‚ç‚¹ï¼Œè¿™ä½¿å¾—åœ¨èŠ‚ç‚¹æ›¿æ¢æ—¶å¯ä»¥å¿«é€Ÿå°†å·é‡æ–°é™„åŠ åˆ°æ–°çš„è™šæ‹Ÿæœºã€‚å¾—ç›Šäº Kubernetes çš„æŒä¹…å·å£°æ˜ï¼ˆPVCï¼‰ï¼Œè¿™ç§é‡æ–°é™„åŠ æ˜¯è‡ªåŠ¨å‘ç”Ÿçš„ã€‚\n*   **è‡ªå®šä¹‰æ“ä½œç¬¦**ï¼šä¸ºäº†ç¡®ä¿æ–°çš„å­˜å‚¨èŠ‚ç‚¹æœ‰è¶³å¤Ÿæ—¶é—´èµ¶ä¸Šé›†ç¾¤çš„å½“å‰çŠ¶æ€ï¼ŒAirbnb ä¾èµ–äºè‡ªå®šä¹‰çš„ Kubernetes æ“ä½œç¬¦ï¼ˆk8s operatorï¼‰ï¼Œè¯¥æ“ä½œç¬¦å…è®¸æ ¹æ®åº”ç”¨ç¨‹åºçš„ç‰¹å®šéœ€æ±‚å®šåˆ¶å„ç§ Kubernetes æ“ä½œã€‚\n\n### åè°ƒèŠ‚ç‚¹æ›¿æ¢\n\nèŠ‚ç‚¹æ›¿æ¢çš„åŸå› å¤šç§å¤šæ ·ï¼ŒåŒ…æ‹¬ AWS å®ä¾‹é€€å½¹ã€Kubernetes å‡çº§æˆ–é…ç½®æ›´æ”¹ã€‚Airbnb å°†èŠ‚ç‚¹æ›¿æ¢äº‹ä»¶åˆ†ä¸ºä¸‰ç±»ï¼š\n\n1.  **æ•°æ®åº“å‘èµ·çš„äº‹ä»¶**ï¼šå¦‚é…ç½®æ›´æ”¹æˆ–ç‰ˆæœ¬å‡çº§ã€‚\n2.  **ä¸»åŠ¨åŸºç¡€è®¾æ–½äº‹ä»¶**ï¼šå¦‚å®ä¾‹é€€å½¹æˆ–èŠ‚ç‚¹å‡çº§ã€‚\n3.  **è®¡åˆ’å¤–åŸºç¡€è®¾æ–½æ•…éšœ**ï¼šå¦‚èŠ‚ç‚¹æ— å“åº”ã€‚\n\n*   **å®‰å…¨ç®¡ç†**ï¼š\n    *   å¯¹äºæ•°æ®åº“å‘èµ·çš„äº‹ä»¶ï¼Œk8s-operator ä¸­å®ç°äº†è‡ªå®šä¹‰æ£€æŸ¥ï¼Œä»¥åœ¨åˆ é™¤ä»»ä½• Pod ä¹‹å‰éªŒè¯æ‰€æœ‰èŠ‚ç‚¹æ˜¯å¦æ­£å¸¸è¿è¡Œã€‚\n    *   ä¸ºäº†ä¸åŸºç¡€è®¾æ–½å‘èµ·çš„äº‹ä»¶ä¸²è¡ŒåŒ–ï¼Œåœ¨ Kubernetes ä¸­å®ç°äº†ä¸€ä¸ªå‡†å…¥é’©å­ï¼ˆadmission hookï¼‰ï¼Œç”¨äºæ‹¦æˆª Pod é©±é€ã€‚è¯¥é’©å­æ‹’ç»ä»»ä½•é©±é€ Pod çš„å°è¯•ï¼Œä½†ä¼šåœ¨ Pod ä¸Šåˆ†é…ä¸€ä¸ªè‡ªå®šä¹‰æ³¨è§£ï¼Œè‡ªå®šä¹‰æ•°æ®åº“ k8s-operator ä¼šç›‘å¬å¹¶æ ¹æ®è¯¥æ³¨è§£å®‰å…¨åœ°åˆ é™¤ Podï¼Œä»è€Œä¸ä»»ä½•æ•°æ®åº“å‘èµ·çš„èŠ‚ç‚¹æ›¿æ¢ä¸²è¡ŒåŒ–ã€‚\n    *   å¯¹äºè®¡åˆ’å¤–åŸºç¡€è®¾æ–½æ•…éšœï¼ˆå¦‚ç¡¬ä»¶æ•…éšœï¼‰ï¼Œæ— æ³•åè°ƒã€‚ä½†å¯ä»¥é€šè¿‡ç¡®ä¿åœ¨æ•…éšœç¡¬ä»¶è¢«æ›¿æ¢ä¹‹å‰ï¼Œé˜»æ­¢å‰ä¸¤ç±»äº‹ä»¶çš„ä»»ä½•èŠ‚ç‚¹æ›¿æ¢æ¥æé«˜å¯ç”¨æ€§ã€‚\n*   **k8s æ“ä½œç¬¦çš„ä½œç”¨**ï¼šåœ¨ Airbnb çš„åŸºç¡€è®¾æ–½ä¸­ï¼Œk8s æ“ä½œç¬¦å¤„ç†ä¸»åŠ¨å’ŒåŸºç¡€è®¾æ–½è§¦å‘çš„èŠ‚ç‚¹æ›¿æ¢ï¼Œåœ¨èŠ‚ç‚¹æ›¿æ¢æ—¶ä¿æŒæ•°æ®ä¸€è‡´æ€§ï¼Œå¹¶ç¡®ä¿è®¡åˆ’å¤–äº‹ä»¶ä¸ä¼šå½±å“æ­£åœ¨è¿›è¡Œçš„ç»´æŠ¤ã€‚\n\n### Kubernetes å‡çº§\n\nå®šæœŸçš„ Kubernetes å‡çº§è‡³å…³é‡è¦ï¼Œä½†å¯èƒ½æ˜¯é«˜é£é™©æ“ä½œï¼Œç‰¹åˆ«æ˜¯å¯¹äºæ•°æ®åº“è€Œè¨€ã€‚äº‘æ‰˜ç®¡çš„ Kubernetes åœ¨æ§åˆ¶å¹³é¢å‡çº§åå¯èƒ½ä¸æä¾›å›æ»šåŠŸèƒ½ï¼Œå¦‚æœå‡ºç°é—®é¢˜ï¼Œä¼šå¸¦æ¥æ½œåœ¨çš„ç¾éš¾æ¢å¤æŒ‘æˆ˜ã€‚Airbnb é‡‡ç”¨è‡ªç®¡ç† Kubernetes é›†ç¾¤ï¼Œå…è®¸å›æ»šæ§åˆ¶å¹³é¢ï¼Œä½†ç³Ÿç³•çš„ Kubernetes å‡çº§ä»å¯èƒ½å¯¼è‡´æœåŠ¡ä¸­æ–­ï¼Œç›´åˆ°å›æ»šå®Œæˆã€‚\n\n### é€šè¿‡å¤š Kubernetes é›†ç¾¤ç¡®ä¿å®¹é”™æ€§\n\nAirbnb è®¤ä¸ºå®ç°é«˜åŒºåŸŸå¯ç”¨æ€§çš„æœ€ä½³æ–¹å¼æ˜¯å°†æ¯ä¸ªæ•°æ®åº“éƒ¨ç½²åœ¨ä¸‰ä¸ªç‹¬ç«‹çš„ Kubernetes é›†ç¾¤ä¸­ï¼Œæ¯ä¸ªé›†ç¾¤ä½äºä¸åŒçš„ AWS å¯ç”¨åŒºï¼ˆAZï¼‰ã€‚\n\n*   **éš”ç¦»æ€§**ï¼šAWS å¯ç”¨åŒºä¸ä»…æä¾›ç‹¬ç«‹çš„ç”µæºã€ç½‘ç»œå’Œè¿æ¥ï¼Œè¿˜è¿›è¡Œé€åŒºåŸŸçš„å‘å¸ƒã€‚Kubernetes é›†ç¾¤ä¸ AWS AZ çš„å¯¹é½æ„å‘³ç€ä»»ä½•åº•å±‚åŸºç¡€è®¾æ–½é—®é¢˜æˆ–é”™è¯¯éƒ¨ç½²çš„çˆ†ç‚¸åŠå¾„éƒ½æœ‰é™ï¼Œå› ä¸ºå®ƒä»¬ä»…é™äºå•ä¸ª AZã€‚\n*   **åˆ†é˜¶æ®µéƒ¨ç½²**ï¼šåœ¨å†…éƒ¨ï¼ŒAirbnb è¿˜ä¼šå°†æ–°é…ç½®æˆ–æ–°æ•°æ®åº“ç‰ˆæœ¬é¦–å…ˆéƒ¨ç½²åˆ°ä½äºå•ä¸ª Kubernetes é›†ç¾¤ä¸­ä¸€ä¸ª AZ å†…çš„é€»è¾‘é›†ç¾¤çš„ä¸€éƒ¨åˆ†ã€‚\n*   **å¯ç”¨æ€§æå‡**ï¼šå°½ç®¡è¿™ç§è®¾ç½®å¢åŠ äº†å¤æ‚æ€§ï¼Œä½†å®ƒé€šè¿‡é™åˆ¶æ¥è‡ªæ¯ä¸€å±‚ï¼ˆæ— è®ºæ˜¯æ•°æ®åº“ã€Kubernetes è¿˜æ˜¯ AWS åŸºç¡€è®¾æ–½ï¼‰çš„æ•…éšœéƒ¨ç½²æ‰€å¼•èµ·é—®é¢˜çš„çˆ†ç‚¸åŠå¾„ï¼Œæ˜¾è‘—æé«˜äº†å¯ç”¨æ€§ã€‚\n*   **å¼¹æ€§ç¤ºä¾‹**ï¼šæœ€è¿‘ï¼ŒåŸºç¡€è®¾æ–½ä¸­ä¸€æ¬¡é”™è¯¯çš„é…ç½®éƒ¨ç½²çªç„¶ç»ˆæ­¢äº†æš‚å­˜ Kubernetes é›†ç¾¤ä¸­ç‰¹å®šç±»å‹çš„æ‰€æœ‰è™šæ‹Ÿæœºï¼Œåˆ é™¤äº†å¤§éƒ¨åˆ†æŸ¥è¯¢å±‚ Podã€‚ç„¶è€Œï¼Œç”±äºä¸­æ–­è¢«éš”ç¦»åˆ°å•ä¸ª Kubernetes é›†ç¾¤ï¼Œä¸‰åˆ†ä¹‹äºŒçš„æŸ¥è¯¢å±‚èŠ‚ç‚¹ä¿æŒè¿è¡Œï¼Œä»è€Œé¿å…äº†ä»»ä½•å½±å“ã€‚\n*   **å®¹é‡å†—ä½™**ï¼šAirbnb è¿˜å¯¹æ•°æ®åº“é›†ç¾¤è¿›è¡Œè¿‡é‡é…ç½®ï¼Œä»¥ç¡®ä¿å³ä½¿æ•´ä¸ª AZã€Kubernetes é›†ç¾¤æˆ–åŒºåŸŸå†…çš„æ‰€æœ‰å­˜å‚¨èŠ‚ç‚¹å‘ç”Ÿæ•…éšœï¼Œä»æœ‰è¶³å¤Ÿçš„å®¹é‡æ¥å¤„ç†æµé‡ã€‚\n\n![å›¾ç‰‡ 1](https://cdn-images-1.medium.com/max/1024/0*X2h18kiTtfcbRXQo)\n\n![å›¾ç‰‡ 2](https://cdn-images-1.medium.com/max/1024/0*1hSoKkktPABPkTj)\n\n### åˆ©ç”¨ AWS EBS å®ç°å¯é æ€§å’Œå»¶è¿Ÿå¤„ç†\n\nEBS ä¸º Airbnb çš„éƒ¨ç½²æä¾›äº†ä¸¤ä¸ªå…³é”®ä¼˜åŠ¿ï¼š\n\n1.  **å¿«é€Ÿé‡æ–°é™„åŠ **ï¼šåœ¨èŠ‚ç‚¹æ›¿æ¢æœŸé—´èƒ½å¤Ÿå¿«é€Ÿé‡æ–°é™„åŠ ã€‚\n2.  **å“è¶Šçš„æŒä¹…æ€§**ï¼šä¸æœ¬åœ°ç£ç›˜ç›¸æ¯”å…·æœ‰æ›´å¼ºçš„æŒä¹…æ€§ã€‚\n\n*   **å‰¯æœ¬æ•°é‡**ï¼šå€ŸåŠ© EBSï¼ŒAirbnb ä»…ä½¿ç”¨ä¸‰ä¸ªå‰¯æœ¬å³å¯è‡ªä¿¡åœ°è¿è¡Œé«˜å¯ç”¨é›†ç¾¤ï¼Œæ— éœ€é¢å¤–å†—ä½™å³å¯ä¿æŒå¯é æ€§ã€‚\n*   **å»¶è¿Ÿç¼“è§£**ï¼šEBS å¶å°”ä¼šå‡ºç°å°¾éƒ¨å»¶è¿Ÿå³°å€¼ï¼Œp99 å»¶è¿Ÿå¯èƒ½è¾¾åˆ° 1 ç§’ã€‚ä¸ºç¼“è§£æ­¤é—®é¢˜ï¼ŒAirbnb å®æ–½äº†å­˜å‚¨è¯»å–è¶…æ—¶ä¼šè¯å˜é‡ï¼Œå…è®¸æŸ¥è¯¢åœ¨ EBS å»¶è¿Ÿå³°å€¼æœŸé—´é€æ˜åœ°é‡è¯•å…¶ä»–å­˜å‚¨èŠ‚ç‚¹ã€‚\n    *   **è¯»ç­–ç•¥ä¼˜åŒ–**ï¼šé»˜è®¤æƒ…å†µä¸‹ï¼Œæ‰€ä½¿ç”¨çš„æ•°æ®åº“å°†æ‰€æœ‰è¯·æ±‚å’Œé‡è¯•å‘é€ç»™é¢†å¯¼è€…ã€‚ä¸ºäº†åœ¨ EBS å¥åº·çš„å­˜å‚¨èŠ‚ç‚¹ä¸Šå¯ç”¨é‡è¯•ï¼Œå¿…é¡»å…è®¸ä»é¢†å¯¼è€…å’Œå‰¯æœ¬è¿›è¡Œè¯»å–ï¼Œä½†åŸå§‹è¯·æ±‚ä¼˜å…ˆé€‰æ‹©æœ€è¿‘çš„å‰¯æœ¬ã€‚è¿™å¸¦æ¥äº†é™ä½å»¶è¿Ÿå’Œé¿å…è·¨ AZ ç½‘ç»œæˆæœ¬çš„é¢å¤–å¥½å¤„ï¼Œå› ä¸ºæ¯ä¸ª AZ éƒ½æœ‰ä¸€ä¸ªå‰¯æœ¬ã€‚\n    *   **é™ˆæ—§è¯»å–**ï¼šå¯¹äºå…è®¸çš„ç”¨ä¾‹ï¼Œåˆ©ç”¨é™ˆæ—§è¯»å–åŠŸèƒ½ï¼Œä½¿å‰¯æœ¬èƒ½å¤Ÿç‹¬ç«‹æä¾›è¯»å–æœåŠ¡ï¼Œè€Œæ— éœ€å¯¹é¢†å¯¼è€…è¿›è¡ŒåŒæ­¥è°ƒç”¨ï¼ˆé¢†å¯¼è€…å¯èƒ½åœ¨è¯»å–æ—¶é‡åˆ° EBS å»¶è¿Ÿå³°å€¼ï¼‰ã€‚\n\n### ç»“è®ºï¼šæ¢ç´¢ Kubernetes ä¸Šçš„å¼€æºæ•°æ®åº“\n\nAirbnb åœ¨ Kubernetes ä¸Šè¿è¡Œåˆ†å¸ƒå¼æ•°æ®åº“çš„å®è·µä½¿å…¶å®ç°äº†é«˜å¯ç”¨æ€§ã€ä½å»¶è¿Ÿã€å¯æ‰©å±•æ€§å’Œæ›´ä½çš„ç»´æŠ¤æˆæœ¬ã€‚é€šè¿‡åˆ©ç”¨æ“ä½œç¬¦æ¨¡å¼ã€å¤šé›†ç¾¤éƒ¨ç½²ã€AWS EBS å’Œé™ˆæ—§è¯»å–ï¼ŒAirbnb è¯æ˜äº†å³ä½¿æ˜¯å¼€æºåˆ†å¸ƒå¼å­˜å‚¨ç³»ç»Ÿä¹Ÿèƒ½åœ¨äº‘ç¯å¢ƒä¸­è“¬å‹ƒå‘å±•ã€‚\n\nAirbnb å·²åœ¨ç”Ÿäº§ç¯å¢ƒä¸­è¿è¡Œå¤šä¸ªæ•°æ®åº“é›†ç¾¤ï¼Œå…¶ä¸­æœ€å¤§çš„ä¸€ä¸ªé›†ç¾¤åœ¨ 150 ä¸ªå­˜å‚¨èŠ‚ç‚¹ä¸Šå¤„ç† 300 ä¸‡ QPSï¼Œå­˜å‚¨è¶…è¿‡ 300TB æ•°æ®ï¼Œåˆ†å¸ƒåœ¨ 400 ä¸‡ä¸ªå†…éƒ¨åˆ†ç‰‡ä¸­ã€‚å¾—ç›Šäºæœ¬æ–‡æè¿°çš„æŠ€æœ¯ï¼Œæ‰€æœ‰è¿™äº›éƒ½å®ç°äº† 99.95% çš„å¯ç”¨æ€§ã€‚\n\nå¯¹äºå…¶ä»–è€ƒè™‘åœ¨ Kubernetes ä¸Šè¿è¡Œå¼€æºæ•°æ®åº“çš„å…¬å¸æ¥è¯´ï¼Œæœºé‡æ˜¯å·¨å¤§çš„ã€‚æ‹¥æŠ±æŒ‘æˆ˜ï¼Œè¿è¡Œå¼€æºæ•°æ®åº“ä»¥å¡‘é€ è¿™äº›å·¥å…·ä»¥ä¾›ä¼ä¸šä½¿ç”¨ã€‚äº‘ä¸­å¯æ‰©å±•ã€å¯é æ•°æ®ç®¡ç†çš„æœªæ¥åœ¨äºåä½œå’Œå¼€æºåˆ›æ–°ã€‚",
      "shortSummary": "Airbnb é€šè¿‡åœ¨å¤šä¸ª AWS å¯ç”¨åŒºå†…çš„ Kubernetes é›†ç¾¤ä¸Šéƒ¨ç½²åˆ†å¸ƒå¼æ•°æ®åº“ï¼Œå®ç°äº†é«˜å¯ç”¨æ€§ã€‚ä»–ä»¬åˆ©ç”¨è‡ªå®šä¹‰ Kubernetes æ“ä½œç¬¦ã€AWS EBS è¿›è¡Œå­˜å‚¨å’Œå¯é æ€§ï¼Œå¹¶åè°ƒèŠ‚ç‚¹æ›¿æ¢ï¼Œä»¥ç¡®ä¿æ•°æ®ä¸€è‡´æ€§å’Œæ•…éšœå®¹é”™ã€‚è¿™ç§ç­–ç•¥ä½¿ Airbnb çš„ç”Ÿäº§æ•°æ®åº“å®ç°äº† 99.95% çš„å¯ç”¨æ€§ã€ä½å»¶è¿Ÿã€é«˜å¯æ‰©å±•æ€§åŠæ›´ä½çš„ç»´æŠ¤æˆæœ¬ï¼Œè¯æ˜äº†å¼€æºåˆ†å¸ƒå¼å­˜å‚¨ç³»ç»Ÿåœ¨äº‘ç¯å¢ƒä¸­çš„å¯è¡Œæ€§ã€‚",
      "translated_title": "Airbnb åœ¨ Kubernetes ä¸Šé€šè¿‡åˆ†å¸ƒå¼æ•°æ®åº“å®ç°é«˜å¯ç”¨æ€§",
      "images": [
        {
          "url": "https://cdn-images-1.medium.com/max/1024/0*X2h18kiTtfcbRXQo",
          "alt": "",
          "title": "",
          "position": 1
        },
        {
          "url": "https://cdn-images-1.medium.com/max/1024/0*1hSoKkktmPABPkTj",
          "alt": "",
          "title": "",
          "position": 2
        },
        {
          "url": "https://medium.com/_/stat?event=post.clientViewed&referrerSource=full_rss&postId=58cc2e9856f4",
          "alt": "",
          "title": "",
          "position": 3
        }
      ],
      "contentSource": "RSS",
      "content": "<figure><img alt=\"\" src=\"https://cdn-images-1.medium.com/max/1024/0*X2h18kiTtfcbRXQo\" /></figure><h3>Introduction</h3><p>Traditionally, organizations have deployed databases on costly, high-end standalone servers using sharding for scaling as a strategy. As data demands grew, the limitations of this strategy became increasingly evident with increasingly longer and more complex maintenance projects.</p><p>Increasingly distributed horizontally scalable databases are not uncommon and many of them are open source. However, running these databases reliably in the cloud with high availability, low latency and scalability, all at a reasonable cost is a problem many companies are trying toÂ solve.</p><p>We chose an innovative strategy of deploying<strong> a distributed database cluster across multiple Kubernetes clusters in a cloud environment</strong>. Although currently an uncommon design pattern due to its complexity, this strategy allowed us to achieve target system reliability and operability.</p><p>In this post, weâ€™ll share how we overcame challenges and the best practices weâ€™ve developed for this strategy and we believe these best practices should be applicable to any other strongly consistent, distributed storageÂ systems.</p><h3>Managing Databases on Kubernetes</h3><p>Earlier this year, we integrated an open source horizontally scalable, distributed SQL database into our infrastructure.</p><p>While Kubernetes is a great tool for running stateless services, the use of Kubernetes for stateful servicesâ€Šâ€”â€Šlike databasesâ€Šâ€”â€Šis challenging, particularly around node replacement and upgrades.</p><p>Since Kubernetes lacks knowledge of data distribution across nodes, each node replacement requires careful data handling to prevent data quorum loss and service disruption, this includes copying the data before replacing aÂ node.</p><p>At Airbnb, we opted to attach storage volumes to nodes using AWS EBS, this allows quick volume reattachment to new virtual machines upon node replacement. Thanks to Kubernetesâ€™ Persistent Volume Claims (<a href=\"https://kubernetes.io/docs/concepts/storage/persistent-volumes/#binding\">PVC</a>), this reattachment happens automatically. In addition we need to allow time for a new storage node to catch up with the clusterâ€™s current state before moving to the next node replacement. For this, we rely on the custom <a href=\"https://kubernetes.io/docs/concepts/extend-kubernetes/operator/\">k8s operator</a><a href=\"https://github.com/pingcap/tidb-operator\">,</a> which allows us to customize various Kubernetes operations according to specifics of the application.</p><h3>Coordinating Node Replacement</h3><p>Node replacements occur for various reasons, from <a href=\"https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/instance-retirement.html\">AWS instance retirement</a> to Kubernetes upgrades or configuration changes. To address these cases, we categorize node replacement events into threeÂ groups:</p><ol><li><strong>Database-initiated events:</strong> Such as config changes or version upgrades.</li><li><strong>Proactive infrastructure events:</strong> Like instance retirements or node upgrades.</li><li><strong>Unplanned infrastructure failures:</strong> Such as a node becoming unresponsive.</li></ol><p>To safely manage node replacements for database-initiated events, we implemented a a custom check in the k8s-operator that verifies that all nodes are up and running before deleting anyÂ pod.</p><p>In order to serialize it with the second group initiated by infrastructure, we implemented <a href=\"https://kubernetes.io/docs/reference/access-authn-authz/extensible-admission-controllers/\">an admission hook</a> in k8s to intercept pod eviction. This admission hook rejects any attempt to evict the pod, but assigns a custom annotation on the pod which our customer database k8s-operator watches and acts on to safely delete the pod serializing it with any database-initiated node replacements described above.</p><p>Node replacements due to unplanned infrastructure failure events like hardware failure, canâ€™t be coordinated. But we can still improve availability by ensuring that any node replacement event from the first two groups will be blocked until the failed hardware is replaced.</p><p>In our infrastructure the k8s operator handles both proactive and infrastructure-triggered node replacements, maintaining data consistency in the presence of node replacements and ensuring that unplanned events donâ€™t impact ongoing maintenance.</p><h3>Kubernetes Upgrades</h3><p>Regular Kubernetes upgrades are essential but can be high-risk operations, especially for databases. Cloud managed Kubernetes might not offer rollbacks once the control plane is upgraded, posing a potential disaster recovery challenge if something goes wrong. While our approach involves using self-managed Kubernetes clusters, which does allow rolling back the control plane, a bad Kubernetes upgrade could still cause service disruption till rollback is completed.</p><h3>Ensuring Fault Tolerance with Multiple Kubernetes clusters</h3><p>At Airbnb, we think the best way to achieve high regional availability is to deploy each database across three independent Kubernetes clusters, each within a different AWS availability zone (<a href=\"https://docs.aws.amazon.com/whitepapers/latest/aws-fault-isolation-boundaries/availability-zones.htm\">AZ</a>). AWS uses availability zones not just for independent power, networking, and connectivity, but they also do rollouts zone by zone. Our Kubernetes cluster alignment with AWS AZ also means that any underlying infrastructure issues or bad deployments have a limited blast radius as they are restricted to a single AZ. Internally, we also deploy a new configuration or a new database version to a part of the logical cluster running in a single Kubernetes cluster in one AZÂ first.</p><p>While this setup adds complexity, it significantly boosts availability by limiting the blast radius of any issues stemming from faulty deployments at every layerâ€Šâ€”â€Šwhether database, Kubernetes, or AWS infrastructure.</p><p>For instance, recently, a faulty config deployment in our infrastructure abruptly terminated all VMs of a specific type in our staging Kubernetes cluster, deleting most of the query layer pods. However, since the disruption was isolated to a single Kubernetes cluster, two-thirds of our query layer nodes remained operational, preventing anyÂ impact.</p><p>We also overprovision our database clusters to ensure that, even if an entire AZ, Kubernetes cluster, or all storage nodes within a zone goes down, we still have sufficient capacity to handleÂ traffic.</p><figure><img alt=\"\" src=\"https://cdn-images-1.medium.com/max/1024/0*1hSoKkktmPABPkTj\" /></figure><h3>Leveraging AWS EBS for Reliability and LatencyÂ Handling</h3><p>EBS offers two key benefits for our deployment: rapid reattachment during node replacements and superior durability compared to local disks. With EBS, we confidently run a highly available cluster using only three replicas, maintaining reliability without needing additional redundancy.</p><p>However, EBS can occasionally experience tail latency spikes, with p99 latency reaching up to 1 second. To mitigate this, we implemented a storage read timeout session variable, allowing queries to transparently retry against other storage nodes during EBS latency spikes. By default the database we use sends all requests and retries to the leader. To enable retries on storage nodes with healthy EBS, we have to allow reads from both leader and replica reads, but prefer the closest one for the original request. This brings the added benefit of reduced latency and no cross-AZ network costs, as we have a replica in each AZ. Finally, for use cases that permit it, we leverage stale reads feature, enabling reads to be served independently by the replica without requiring synchronous calls to the leader, which may be experiencing an EBS latency spike at the time of theÂ read.</p><h3>Conclusion: Exploring Open Source Databases on Kubernetes</h3><p>Our journey running a distributed database on Kubernetes has empowered us to achieve high availability, low latency, scalability, and lower maintenance costs. By leveraging the operator pattern, multi-cluster deployments, AWS EBS, and stale reads, weâ€™ve demonstrated that even open source distributed storage systems can thrive in cloud environments.</p><p>We already operate several database clusters in production in the described setup, with the largest one handling 3M QPS across 150 storage nodes, storing over 300+ TB of data spread across 4M internal shards. All this with 99.95% availability thanks to techniques described in thisÂ post.</p><p>For other companies considering to run open-source databases on Kubernetes, the opportunities are immense. Embrace the challenge, run open-source databases to shape these tools for enterprise use. The future of scalable, reliable data management in the cloud lies in collaboration and open-source innovationâ€Šâ€”â€Šnow is the time to lead and participate.</p><h3>Acknowledgments</h3><p>Thanks to Abhishek Parmar, Brian Wolfe, Chen Ding, Daniel Low, Hao Luo, Xiaomou Wang for collaboration and Shylaja Ramachandra forÂ editing.</p><img src=\"https://medium.com/_/stat?event=post.clientViewed&referrerSource=full_rss&postId=58cc2e9856f4\" width=\"1\" height=\"1\" alt=\"\"><hr><p><a href=\"https://medium.com/airbnb-engineering/achieving-high-availability-with-distributed-database-on-kubernetes-at-airbnb-58cc2e9856f4\">Achieving High Availability with distributed database on Kubernetes at Airbnb</a> was originally published in <a href=\"https://medium.com/airbnb-engineering\">The Airbnb Tech Blog</a> on Medium, where people are continuing the conversation by highlighting and responding to this story.</p>"
    },
    {
      "title": "ç†è§£å’Œæ”¹è¿› SwiftUI æ€§èƒ½ (åŸæ ‡é¢˜: Understanding and Improving SwiftUI Performance)",
      "link": "https://medium.com/airbnb-engineering/understanding-and-improving-swiftui-performance-37b77ac61896?source=rss----53c7c27702d5---4",
      "pubDate": "Tue, 24 Jun 2025 16:43:07 GMT",
      "isoDate": "2025-06-24T16:43:07.000Z",
      "creator": "Cal Stephens",
      "summary": "## ç†è§£å’Œæ”¹è¿› SwiftUI æ€§èƒ½\n\n### å¼•è¨€\n\nAirbnb è‡ª2022å¹´èµ·é‡‡ç”¨ SwiftUIï¼Œæ˜¾è‘—æå‡äº†å·¥ç¨‹å¸ˆçš„ç”Ÿäº§åŠ›ã€‚ç„¶è€Œï¼Œå¤§è§„æ¨¡åº”ç”¨ SwiftUI ä¹Ÿå¸¦æ¥äº†æ€§èƒ½æŒ‘æˆ˜ï¼Œä¾‹å¦‚å¸¸è§çš„ä½æ•ˆä»£ç æ¨¡å¼å’Œç´¯ç§¯çš„æ€§èƒ½æŸè€—ã€‚ä¸ºè§£å†³è¿™äº›é—®é¢˜ï¼ŒAirbnb å¼€å‘äº†æ–°çš„å·¥å…·ï¼Œç”¨äºä¸»åŠ¨è¯†åˆ«å’Œé™æ€éªŒè¯ä»£ç çš„æ­£ç¡®æ€§ã€‚\n\n### Airbnb çš„ SwiftUI åŠŸèƒ½æ¶æ„\n\nAirbnb å¤šå¹´æ¥ä¸€ç›´ä½¿ç”¨åŸºäº UIKit çš„ Epoxy åº“å’Œå•å‘æ•°æ®æµç³»ç»Ÿã€‚åœ¨ SwiftUI å±å¹•å±‚ä¸­ï¼Œä»–ä»¬é€‰æ‹©ç»§ç»­æ²¿ç”¨ç°æœ‰çš„å•å‘æ•°æ®æµåº“ï¼Œè¿™ç®€åŒ–äº†åœ¨å¤§å‹ä»£ç åº“ä¸­é€æ­¥é‡‡ç”¨ SwiftUI çš„è¿‡ç¨‹ï¼Œå¹¶æé«˜äº†åŠŸèƒ½è´¨é‡å’Œå¯ç»´æŠ¤æ€§ã€‚ç„¶è€Œï¼Œä»–ä»¬å‘ç°ä½¿ç”¨è¯¥åº“çš„ SwiftUI åŠŸèƒ½æ€§èƒ½æœªè¾¾é¢„æœŸï¼Œä¸”é—®é¢˜åŸå› å¹¶ä¸æ˜æ˜¾ã€‚\n\n### ç†è§£ SwiftUI è§†å›¾å·®å¼‚åŒ–ï¼ˆDiffingï¼‰\n\nåœ¨ SwiftUI ç­‰å£°æ˜å¼ UI ç³»ç»Ÿä¸­ï¼Œç¡®ä¿æ¡†æ¶çŸ¥é“ä½•æ—¶éœ€è¦é‡æ–°è¯„ä¼°å’Œé‡æ–°æ¸²æŸ“è§†å›¾è‡³å…³é‡è¦ã€‚å½“çˆ¶è§†å›¾æ›´æ–°æ—¶ï¼ŒSwiftUI é€šè¿‡æ¯”è¾ƒè§†å›¾çš„å­˜å‚¨å±æ€§æ¥æ£€æµ‹å˜åŒ–ã€‚ç†æƒ³æƒ…å†µä¸‹ï¼Œè§†å›¾çš„ `body` ä»…åœ¨å…¶å±æ€§å®é™…æ”¹å˜æ—¶æ‰ä¼šè¢«é‡æ–°è¯„ä¼°ã€‚\n\n![å›¾ç‰‡ 1](https://cdn-images-1.medium.com/max/1024/1*qBYJ9abMpZyuODmbHkYD5Q.jpeg)\n\n![å›¾ç‰‡ 2: ç†æƒ³çš„è§†å›¾é‡æ–°è¯„ä¼°æµç¨‹](https://cdn-images-1.medium.com/max/1024/1*LvNBJSor0RDThlW3Oq7mWw.png)\n\nç„¶è€Œï¼Œå®é™…æƒ…å†µå¹¶éæ€»æ˜¯å¦‚æ­¤ï¼Œä¸å¿…è¦çš„è§†å›¾ `body` è¯„ä¼°ä¼šå› æ‰§è¡Œä¸å¿…è¦çš„å·¥ä½œè€ŒæŸå®³æ€§èƒ½ã€‚ä¸ºäº†å¯è§†åŒ–è§†å›¾ `body` åœ¨å®é™…åº”ç”¨ä¸­è¢«é‡æ–°è¯„ä¼°çš„é¢‘ç‡ï¼ŒAirbnb ä½¿ç”¨äº†ä¸€ä¸ªä¿®é¥°ç¬¦ï¼Œæ¯æ¬¡æ¸²æŸ“æ—¶ç»™è§†å›¾åº”ç”¨ä¸€ä¸ªéšæœºé¢œè‰²ã€‚æµ‹è¯•å‘ç°ï¼Œè®¸å¤šè§†å›¾è¢«ä¸å¿…è¦åœ°é‡æ–°è¯„ä¼°å’Œé‡æ–°æ¸²æŸ“ã€‚\n\n![å›¾ç‰‡ 3: ä¸å¿…è¦çš„è§†å›¾é‡æ–°è¯„ä¼°ç¤ºä¾‹](https://cdn-images-1.medium.com/max/1024/1*yNrr8e8yI9RcKg6Z-VUhEA.gif)\n\n### SwiftUI è§†å›¾å·®å¼‚åŒ–ç®—æ³•\n\nSwiftUI å†…ç½®çš„å·®å¼‚åŒ–ç®—æ³•è™½ç„¶æœªæ­£å¼æ–‡æ¡£åŒ–ï¼Œä½†å¯¹æ€§èƒ½å½±å“å·¨å¤§ã€‚å®ƒä½¿ç”¨åŸºäºåå°„çš„ç®—æ³•æ¥æ¯”è¾ƒè§†å›¾çš„æ¯ä¸ªå­˜å‚¨å±æ€§ï¼š\n\n*   **`Equatable` ç±»å‹ï¼š** SwiftUI ä½¿ç”¨å…¶ `Equatable` ä¸€è‡´æ€§æ¯”è¾ƒæ–°æ—§å€¼ã€‚\n*   **å€¼ç±»å‹ï¼ˆå¦‚ç»“æ„ä½“ï¼‰ï¼š** é€’å½’æ¯”è¾ƒæ¯ä¸ªå®ä¾‹å±æ€§ã€‚\n*   **å¼•ç”¨ç±»å‹ï¼ˆå¦‚ç±»ï¼‰ï¼š** ä½¿ç”¨å¼•ç”¨æ ‡è¯†è¿›è¡Œæ¯”è¾ƒã€‚\n*   **é—­åŒ…ï¼š** å°è¯•æŒ‰æ ‡è¯†æ¯”è¾ƒï¼Œä½†å¤§å¤šæ•°éç®€å•é—­åŒ…æ— æ³•å¯é æ¯”è¾ƒã€‚\n\nå¦‚æœè§†å›¾çš„æ‰€æœ‰å±æ€§ä¸å‰ä¸€ä¸ªå€¼æ¯”è¾ƒåéƒ½ç›¸ç­‰ï¼Œåˆ™ `body` ä¸ä¼šè¢«é‡æ–°è¯„ä¼°ï¼Œå†…å®¹ä¹Ÿä¸ä¼šé‡æ–°æ¸²æŸ“ã€‚ä½¿ç”¨ `@State` å’Œ `@Environment` ç­‰ SwiftUI å±æ€§åŒ…è£…å™¨ä¿®é¥°çš„å€¼ä¸å‚ä¸æ­¤å·®å¼‚åŒ–ç®—æ³•ï¼Œè€Œæ˜¯é€šè¿‡å…¶ä»–æœºåˆ¶è§¦å‘è§†å›¾æ›´æ–°ã€‚\n\nAirbnb åœ¨å…¶ä»£ç åº“ä¸­å‘ç°äº†å‡ ç§å¸¸è§çš„æ¨¡å¼ä¼šæ··æ·† SwiftUI çš„å·®å¼‚åŒ–ç®—æ³•ï¼š\n\n*   **é—­åŒ…ï¼š** æŸäº›ç±»å‹ï¼ˆå¦‚é—­åŒ…ï¼‰æœ¬è´¨ä¸Šä¸å—æ”¯æŒï¼Œå‡ ä¹æ€»æ˜¯æ¯”è¾ƒä¸ºä¸ç›¸ç­‰ï¼Œå¯¼è‡´ä¸å¿…è¦çš„ `body` è¯„ä¼°ã€‚\n*   **ç®€å•æ•°æ®ç±»å‹ï¼š** å­˜å‚¨åœ¨è§†å›¾ä¸Šçš„ç®€å•æ•°æ®ç±»å‹å¯èƒ½æ„å¤–åœ°æŒ‰å¼•ç”¨è€Œéå€¼è¿›è¡Œæ¯”è¾ƒï¼Œä¾‹å¦‚åŒ…è£…äº†å†…éƒ¨å¼•ç”¨ç±»å‹çš„å†™æ—¶å¤åˆ¶ï¼ˆcopy-on-writeï¼‰ç»“æ„ä½“ã€‚\n\nå¦‚æœè§†å›¾åŒ…å«ä»»ä½•ä¸å¯å·®å¼‚åŒ–çš„å€¼ï¼Œæ•´ä¸ªè§†å›¾å°†å˜å¾—ä¸å¯å·®å¼‚åŒ–ã€‚è¿™æ­ç¤ºäº† Airbnb å•å‘æ•°æ®æµåº“çš„æ€§èƒ½é—®é¢˜ï¼šå…¶åŠ¨ä½œå¤„ç†æ˜¯åŸºäºé—­åŒ…çš„ï¼Œè€Œ SwiftUI æ— æ³•å·®å¼‚åŒ–é—­åŒ…ã€‚åœ¨è®¸å¤šæƒ…å†µä¸‹ï¼Œä½¿å€¼å¯å·®å¼‚åŒ–éœ€è¦å¤§é‡ä¾µå…¥æ€§ä¸”å¯èƒ½ä¸ç†æƒ³çš„æ¶æ„æ›´æ”¹ï¼Œä¸”éš¾ä»¥é˜²æ­¢åç»­å›å½’ã€‚\n\n### æ§åˆ¶ SwiftUI è§†å›¾å·®å¼‚åŒ–\n\nå¹¸è¿çš„æ˜¯ï¼Œæœ‰å¦ä¸€ç§é€‰æ‹©ï¼šå¦‚æœè§†å›¾éµå¾ª `Equatable` åè®®ï¼ŒSwiftUI å°†ä½¿ç”¨å…¶ `Equatable` ä¸€è‡´æ€§è¿›è¡Œå·®å¼‚åŒ–ï¼Œè€Œéé»˜è®¤çš„åŸºäºåå°„çš„ç®—æ³•ã€‚è¿™å…è®¸å¼€å‘è€…é€‰æ‹©æ€§åœ°å†³å®šå“ªäº›å±æ€§åº”å‚ä¸æ¯”è¾ƒã€‚ä¾‹å¦‚ï¼Œå¯¹äºåŠ¨ä½œå¤„ç†ç¨‹åºï¼Œå¦‚æœå®ƒä¸å½±å“è§†å›¾å†…å®¹æˆ–æ ‡è¯†ï¼Œåˆ™å¯ä»¥å°†å…¶æ’é™¤åœ¨ `Equatable` æ¯”è¾ƒä¹‹å¤–ã€‚\n\nç„¶è€Œï¼Œæ‰‹åŠ¨ç¼–å†™å’Œç»´æŠ¤ `Equatable` ä¸€è‡´æ€§ä¼šå¸¦æ¥å¤§é‡æ ·æ¿ä»£ç ï¼Œä¸”å®¹æ˜“å‡ºé”™ï¼ˆä¾‹å¦‚ï¼Œæ·»åŠ æ–°å±æ€§æ—¶å¿˜è®°æ›´æ–° `Equatable`ï¼‰ã€‚\n\nä¸ºæ­¤ï¼ŒAirbnb åˆ›å»ºäº†ä¸€ä¸ªæ–°çš„ **`@Equatable` å®**ï¼Œè‡ªåŠ¨ç”Ÿæˆ `Equatable` ä¸€è‡´æ€§ã€‚è¯¥å®ä¼šæ¯”è¾ƒè§†å›¾çš„æ‰€æœ‰å­˜å‚¨å®ä¾‹å±æ€§ï¼ˆæ’é™¤ `@State` å’Œ `@Environment` ç­‰å±æ€§åŒ…è£…å™¨ï¼‰ã€‚ä¸å½±å“è§†å›¾ `body` è¾“å‡ºä¸”ä¸å¯ `Equatable` çš„å±æ€§å¯ä»¥ä½¿ç”¨ `@SkipEquatable` æ ‡è®°ï¼Œå°†å…¶æ’é™¤åœ¨ç”Ÿæˆçš„å®ç°ä¹‹å¤–ã€‚è¿™ä½¿å¾— Airbnb å¯ä»¥ç»§ç»­ä½¿ç”¨åŸºäºé—­åŒ…çš„åŠ¨ä½œå¤„ç†ç¨‹åºï¼Œè€Œä¸ä¼šå½±å“ SwiftUI çš„å·®å¼‚åŒ–è¿‡ç¨‹ã€‚\n\né‡‡ç”¨ `@Equatable` å®åï¼Œè§†å›¾ä¿è¯å¯å·®å¼‚åŒ–ã€‚å¦‚æœå·¥ç¨‹å¸ˆåç»­æ·»åŠ äº†ä¸å¯ `Equatable` çš„å±æ€§ï¼Œæ„å»ºå°†å¤±è´¥ï¼Œä»è€Œçªå‡ºæ½œåœ¨çš„å·®å¼‚åŒ–è¡Œä¸ºå›å½’ã€‚è¿™ä½¿å¾— `@Equatable` å®æˆä¸ºä¸€ä¸ªå¤æ‚çš„ä»£ç æ£€æŸ¥å·¥å…·ï¼ˆlinterï¼‰ï¼Œå¯¹äºåœ¨å¤§è§„æ¨¡ä»£ç åº“ä¸­æ‰©å±•æ€§èƒ½æ”¹è¿›éå¸¸æœ‰ä»·å€¼ã€‚\n\n### ç®¡ç†è§†å›¾ä½“ï¼ˆView Bodyï¼‰å¤§å°\n\nSwiftUI å·®å¼‚åŒ–çš„å¦ä¸€ä¸ªé‡è¦æ–¹é¢æ˜¯ç†è§£ SwiftUI åªèƒ½å·®å¼‚åŒ–çœŸæ­£çš„ `View` ç»“æ„ä½“ã€‚ä»»ä½•å…¶ä»–ä»£ç ï¼Œä¾‹å¦‚è®¡ç®—å±æ€§æˆ–ç”Ÿæˆ SwiftUI è§†å›¾çš„è¾…åŠ©å‡½æ•°ï¼Œéƒ½æ— æ³•è¢«å·®å¼‚åŒ–ã€‚\n\nä¾‹å¦‚ï¼Œå°†å¤æ‚çš„è§†å›¾ `body` æ‹†åˆ†ä¸ºå•ç‹¬çš„è®¡ç®—å±æ€§ï¼ˆå¦‚ `headerSection` å’Œ `actionCardSection`ï¼‰æ˜¯å¸¸è§çš„ç»„ç»‡æ–¹å¼ï¼Œä½†è¿è¡Œæ—¶ SwiftUI ä¼šå°†è¿™äº›è§†å›¾å†…è”åˆ°ä¸»è§†å›¾ `body` ä¸­ã€‚è¿™æ„å‘³ç€ï¼Œå½“å±å¹•çš„ä»»ä½•éƒ¨åˆ†çŠ¶æ€æ”¹å˜æ—¶ï¼Œæ•´ä¸ªè§†å›¾ `body` éƒ½ä¼šè¢«é‡æ–°è¯„ä¼°ï¼Œéšç€è§†å›¾å˜å¾—æ›´å¤§æ›´å¤æ‚ï¼Œè¿™å°†å¯¼è‡´å¤§é‡çš„éå¿…è¦å·¥ä½œï¼ŒæŸå®³æ€§èƒ½ã€‚\n\nä¸ºæé«˜æ€§èƒ½ï¼Œåº”å°†å¸ƒå±€ä»£ç å®ç°ä¸ºç‹¬ç«‹çš„ SwiftUI è§†å›¾ã€‚è¿™å…è®¸ SwiftUI æ­£ç¡®å·®å¼‚åŒ–æ¯ä¸ªå­è§†å›¾ï¼Œä»…åœ¨å¿…è¦æ—¶é‡æ–°è¯„ä¼°å…¶ `body`ã€‚ä¾‹å¦‚ï¼Œå°† `MyScreen` æ‹†åˆ†ä¸ºç‹¬ç«‹çš„ `HeaderSection` å’Œ `CardSection` è§†å›¾ï¼Œå¹¶ä¸ºå®ƒä»¬åº”ç”¨ `@Equatable`ï¼Œå¯ä»¥ç¡®ä¿ `HeaderSection` ä»…åœ¨ `title` æ”¹å˜æ—¶é‡æ–°è¯„ä¼°ï¼Œè€Œ `CardSection` ä»…åœ¨ `isCardSelected` æ”¹å˜æ—¶é‡æ–°è¯„ä¼°ã€‚é€šè¿‡å°†è§†å›¾åˆ†è§£ä¸ºæ›´å°ã€å¯å·®å¼‚åŒ–çš„éƒ¨åˆ†ï¼ŒSwiftUI å¯ä»¥é«˜æ•ˆåœ°ä»…æ›´æ–°å®é™…æ”¹å˜çš„éƒ¨åˆ†ã€‚\n\n### è§†å›¾ä½“å¤æ‚åº¦ Lint è§„åˆ™\n\nå¤§å‹ã€å¤æ‚çš„è§†å›¾åœ¨å¼€å‘è¿‡ç¨‹ä¸­å¹¶ä¸æ€»æ˜¯æ˜¾è€Œæ˜“è§çš„ã€‚ä¸ºäº†å¸®åŠ©å·¥ç¨‹å¸ˆäº†è§£ä½•æ—¶éœ€è¦å°†è§†å›¾é‡æ„ä¸ºæ›´å°ã€å¯å·®å¼‚åŒ–çš„éƒ¨åˆ†ï¼ŒAirbnb åˆ›å»ºäº†ä¸€ä¸ªè‡ªå®šä¹‰çš„ SwiftLint è§„åˆ™ã€‚è¯¥è§„åˆ™ä½¿ç”¨ SwiftSyntax è§£æè§†å›¾ `body` å¹¶æµ‹é‡å…¶å¤æ‚åº¦ã€‚å¤æ‚åº¦æŒ‡æ ‡å®šä¹‰ä¸ºæ¯æ¬¡ä½¿ç”¨è®¡ç®—å±æ€§ã€å‡½æ•°æˆ–é—­åŒ…ç»„åˆè§†å›¾æ—¶å¢åŠ çš„å€¼ã€‚å½“è§†å›¾å¤æ‚åº¦è¶…è¿‡å¯é…ç½®çš„é™åˆ¶ï¼ˆç›®å‰ä¸º10ï¼‰æ—¶ï¼Œè¯¥è§„åˆ™ä¼šåœ¨ Xcode ä¸­è‡ªåŠ¨è§¦å‘è­¦å‘Šã€‚\n\n![å›¾ç‰‡ 4: SwiftLint è§†å›¾å¤æ‚åº¦è­¦å‘Šç¤ºä¾‹](https://cdn-images-1.medium.com/max/1024/1*Tdo1L8qZf81FWFeJaNY6yQ.png)\n\n### ç»“è®º\n\né€šè¿‡ç†è§£ SwiftUI è§†å›¾å·®å¼‚åŒ–æœºåˆ¶ï¼ŒAirbnb è¿ç”¨äº†ä¸‰é¡¹å…³é”®æŠ€æœ¯ï¼š\n\n1.  **`@Equatable` å®ï¼š** ç¡®ä¿è§†å›¾ `body` ä»…åœ¨è§†å›¾å†…éƒ¨çš„å€¼å®é™…æ”¹å˜æ—¶æ‰è¢«é‡æ–°è¯„ä¼°ã€‚\n2.  **æ‹†åˆ†è§†å›¾ï¼š** å°†è§†å›¾åˆ†è§£ä¸ºæ›´å°çš„éƒ¨åˆ†ï¼Œä»¥å®ç°æ›´å¿«çš„é‡æ–°è¯„ä¼°ã€‚\n3.  **å¤æ‚åº¦ Lint è§„åˆ™ï¼š** é¼“åŠ±å¼€å‘è€…åœ¨è§†å›¾å˜å¾—è¿‡å¤§å’Œå¤æ‚ä¹‹å‰è¿›è¡Œé‡æ„ã€‚\n\nå°†è¿™äº›æŠ€æœ¯åº”ç”¨äº Airbnb åº”ç”¨ä¸­çš„ SwiftUI è§†å›¾ï¼Œæ˜¾è‘—å‡å°‘äº†ä¸å¿…è¦çš„è§†å›¾é‡æ–°è¯„ä¼°å’Œé‡æ–°æ¸²æŸ“ã€‚ä¾‹å¦‚ï¼Œåœ¨æœç´¢æ å’Œç­›é€‰é¢æ¿ä¸­ï¼Œé‡æ–°æ¸²æŸ“çš„æ¬¡æ•°æ˜æ˜¾å‡å°‘ã€‚\n\n![å›¾ç‰‡ 5: åº”ç”¨æŠ€æœ¯åå‡å°‘é‡æ–°æ¸²æŸ“çš„ç¤ºä¾‹](https://cdn-images-1.medium.com/max/1024/1*tWhEXK5kyFP5KYPCUSvp6Q.gif)\n\næ ¹æ®é¡µé¢æ€§èƒ½è¯„åˆ†ç³»ç»Ÿçš„æ•°æ®ï¼Œåœ¨æœ€å¤æ‚çš„ SwiftUI å±å¹•ä¸­é‡‡ç”¨è¿™äº›æŠ€æœ¯ç¡®å®æ”¹å–„äº†ç”¨æˆ·ä½“éªŒã€‚ä¾‹å¦‚ï¼Œé€šè¿‡åœ¨ä¸»è¦æœç´¢å±å¹•ä¸Šæœ€é‡è¦çš„è§†å›¾ä¸­é‡‡ç”¨ `@Equatable` å¹¶å°†å¤§å‹è§†å›¾ä½“æ‹†åˆ†ä¸ºæ›´å°çš„å¯å·®å¼‚åŒ–éƒ¨åˆ†ï¼Œæ»šåŠ¨å¡é¡¿å‡å°‘äº†15%ã€‚è¿™äº›æŠ€æœ¯è¿˜æä¾›äº†çµæ´»æ€§ï¼Œå…è®¸ Airbnb é‡‡ç”¨æœ€é€‚åˆå…¶éœ€æ±‚çš„åŠŸèƒ½æ¶æ„ï¼Œè€Œä¸ä¼šç‰ºç‰²æ€§èƒ½æˆ–æ–½åŠ ç¹é‡çš„é™åˆ¶ï¼ˆä¾‹å¦‚ï¼Œå®Œå…¨é¿å…åœ¨ SwiftUI è§†å›¾ä¸­ä½¿ç”¨é—­åŒ…ï¼‰ã€‚\n\nå½“ç„¶ï¼Œè¿™äº›æŠ€æœ¯å¹¶éä¸‡èƒ½è¯ï¼Œå¹¶éæ‰€æœ‰ SwiftUI åŠŸèƒ½éƒ½å¿…é¡»ä½¿ç”¨å®ƒä»¬ï¼Œå®ƒä»¬æœ¬èº«ä¹Ÿä¸è¶³ä»¥ä¿è¯å‡ºè‰²çš„æ€§èƒ½ã€‚ç„¶è€Œï¼Œç†è§£å®ƒä»¬çš„å·¥ä½œåŸç†å’ŒåŸå› ï¼Œä¸ºæ„å»ºé«˜æ€§èƒ½ SwiftUI åŠŸèƒ½å¥ å®šäº†å®è´µçš„åŸºç¡€ï¼Œå¹¶ä½¿å¾—åœ¨ä»£ç ä¸­å‘ç°å’Œé¿å…é—®é¢˜æ¨¡å¼å˜å¾—æ›´å®¹æ˜“ã€‚",
      "shortSummary": "Airbnb å›¢é˜Ÿä¸ºè§£å†³ SwiftUI æ€§èƒ½é—®é¢˜ï¼Œä¸»è¦èšç„¦äºä¼˜åŒ–è§†å›¾å·®å¼‚åŒ–ï¼ˆdiffingï¼‰å’Œç®¡ç†è§†å›¾ä½“å¤§å°ã€‚ä»–ä»¬å¼€å‘äº† `@Equatable` å®ï¼Œè‡ªåŠ¨ç”Ÿæˆ `Equatable` ä¸€è‡´æ€§ï¼Œç¡®ä¿è§†å›¾ä»…åœ¨å…³é”®å±æ€§å˜åŒ–æ—¶æ›´æ–°ï¼Œå¹¶å…è®¸è·³è¿‡ä¸å¯å·®å¼‚åŒ–çš„å±æ€§ï¼ˆå¦‚é—­åŒ…ï¼‰ã€‚åŒæ—¶ï¼Œä»–ä»¬æå€¡å°†å¤§å‹è§†å›¾æ‹†åˆ†ä¸ºæ›´å°çš„ç‹¬ç«‹ç»„ä»¶ï¼Œå¹¶åˆ›å»ºäº† SwiftLint è§„åˆ™æ¥æ£€æµ‹å¹¶é™åˆ¶è§†å›¾å¤æ‚åº¦ï¼Œé¼“åŠ±åŠæ—¶é‡æ„ã€‚è¿™äº›æªæ–½æ˜¾è‘—å‡å°‘äº†ä¸å¿…è¦çš„è§†å›¾é‡æ–°æ¸²æŸ“ï¼Œæå‡äº†åº”ç”¨æ€§èƒ½ï¼Œä¾‹å¦‚æœç´¢é¡µé¢æ»šåŠ¨å¡é¡¿å‡å°‘15%ã€‚",
      "translated_title": "ç†è§£å’Œæ”¹è¿› SwiftUI æ€§èƒ½",
      "images": [
        {
          "url": "https://cdn-images-1.medium.com/max/1024/1*qBYJ9abMpZyuODmbHkYD5Q.jpeg",
          "alt": "",
          "title": "",
          "position": 1
        },
        {
          "url": "https://cdn-images-1.medium.com/max/1024/1*LvNBJSor0RDThlW3Oq7mWw.png",
          "alt": "",
          "title": "",
          "position": 2
        },
        {
          "url": "https://cdn-images-1.medium.com/max/1024/1*yNrr8e8yI9RcKg6Z-VUhEA.gif",
          "alt": "",
          "title": "",
          "position": 3
        },
        {
          "url": "https://cdn-images-1.medium.com/max/1024/1*Tdo1L8qZf81FWFeJaNY6yQ.png",
          "alt": "",
          "title": "",
          "position": 4
        },
        {
          "url": "https://cdn-images-1.medium.com/max/1024/1*tWhEXK5kyFP5KYPCUSvp6Q.gif",
          "alt": "",
          "title": "",
          "position": 5
        }
      ],
      "contentSource": "RSS",
      "content": "<p>New techniques weâ€™re using at Airbnb to improve and maintain performance of SwiftUI features atÂ scale</p><p>By <a href=\"https://www.linkedin.com/in/calstephens/\">Cal Stephens</a>, <a href=\"https://www.linkedin.com/in/miguel-jimenez-b98216112\">MiguelÂ Jimenez</a></p><figure><img alt=\"\" src=\"https://cdn-images-1.medium.com/max/1024/1*qBYJ9abMpZyuODmbHkYD5Q.jpeg\" /></figure><p>Airbnb <a href=\"https://medium.com/airbnb-engineering/unlocking-swiftui-at-airbnb-ea58f50cde49\">first adopted SwiftUI in 2022</a>, starting with individual components and later expanding to entire screens and features. Weâ€™ve seen major improvements to engineersâ€™ productivity thanks to its declarative, flexible, and composable architecture. However, adopting SwiftUI has brought new challenges related to performance. For example, there are many common code patterns in SwiftUI that can be inefficient, and many small papercuts can add up to a large cumulative performance hit. To begin addressing some of these issues at scale, weâ€™ve created new tooling for proactively identifying these cases and statically validating correctness.</p><h3>SwiftUI feature architecture atÂ Airbnb</h3><p>Weâ€™ve been leveraging declarative UI patterns at Airbnb for many years, using our UIKit-based <a href=\"https://medium.com/airbnb-engineering/introducing-epoxy-for-ios-6bf062be1670\">Epoxy library</a> and <a href=\"https://medium.com/airbnb-engineering/introducing-epoxy-for-ios-6bf062be1670#fbe0\">unidirectional data flow</a> systems. When adopting SwiftUI in our screen layer, we decided to continue using our existing unidirectional data flow library. This simplified the process of incrementally adopting SwiftUI within our large codebase, and we find it improves the quality and maintainability of features.</p><p>However, we noticed that SwiftUI features using our unidirectional data flow library didnâ€™t perform as well as we expected, and it wasnâ€™t immediately obvious to us what the problem was. Understanding SwiftUIâ€™s performance characteristics is an important requirement for building performant and outside of the â€œstandardâ€ SwiftUIÂ toolbox.</p><h3>Understanding SwiftUI viewÂ diffing</h3><p>When working with declarative UI systems like SwiftUI, itâ€™s important to ensure the framework knows which views need to be re-evaluated and re-rendered when the state of the screen changes. Changes are detected by diffing the viewâ€™s stored properties any time its parent is updated. Ideally the viewâ€™s body will only be re-evaluated when its properties actuallyÂ change:</p><figure><img alt=\"\" src=\"https://cdn-images-1.medium.com/max/1024/1*LvNBJSor0RDThlW3Oq7mWw.png\" /></figure><p>However, this behavior is not always the reality (more on why in a moment). Unnecessary view body evaluations hurt performance by performing unnecessary work.</p><p>How do you know how often a viewâ€™s body is re-evaluated in a real app? An easy way to visualize this is with a modifier that applies a random color to the view every time itâ€™s rendered. When testing this on various views in our appâ€™s most performance-sensitive screens, we quickly found that many views were re-evaluated and re-rendered more often than necessary:</p><figure><img alt=\"\" src=\"https://cdn-images-1.medium.com/max/1024/1*yNrr8e8yI9RcKg6Z-VUhEA.gif\" /></figure><h4>The SwiftUI view diffing algorithm</h4><p>SwiftUIâ€™s built-in diffing algorithm is often overlooked and not officially documented, but it has a huge impact on performance. To determine if a viewâ€™s body needs to be re-evaluated, SwiftUI uses a reflection-based diffing algorithm to compare each of the viewâ€™s stored properties:</p><ol><li>If a type is <em>Equatable</em>, SwiftUI compares the old and new values using the typeâ€™s <em>Equatable</em> conformance. Otherwise:</li><li>SwiftUI compares value types (e.g., structs) by recursively comparing each instance property.</li><li>SwiftUI compares reference types (e.g., classes) using reference identity.</li><li>SwiftUI attempts to compare closures by identity. However, most non-trivial closures cannot be compared reliably.</li></ol><p>If all of the viewâ€™s properties compare as equal to the previous value, then the body isnâ€™t re-evalulated and the content isnâ€™t re-rendered. Values using SwiftUI property wrappers like<em> @State </em>and <em>@Environment</em> donâ€™t participate in this diffing algorithm, and instead trigger view updates through different mechanisms.</p><p>When reviewing different views in our codebase, we found several common patterns that confounded SwiftUIâ€™s diffing algorithm:</p><ol><li>Some types are inherently not supported, like closures.</li><li>Simple data types stored on the view may be unexpectedly compared by reference instead of byÂ value.</li></ol><p>Hereâ€™s an example SwiftUI view with properties that interact poorly with the diffing algorithm:</p><pre>struct MyView: View {<br>  /// A generated data model that is a struct with value semantics,<br>  /// but is copy-on-write and wraps an internal reference type.<br>  /// Compared by reference, not by value, which could cause unwanted body evaluations.<br>  let dataModel: CopyOnWriteDataModel<br><br>  /// Other miscellaneous properties used by the view. Typically structs, but sometimes a class.<br>  /// Unexpected comparisons by reference could cause unwanted body evaluations.<br>  let requestState: MyFeatureRequestState<br><br>  /// An action handler for this view, part of our unidirectional data flow library. <br>  /// Wraps a closure that routes the action to the screen&#39;s action handler.<br>  /// Closures almost always compare as not-equal, and typically cause unwanted body evaluations. <br>  let handler: Handler&lt;MyViewAction&gt;<br><br>  var body: some View { ... }<br>}</pre><p>If a view contains any value that isnâ€™t diffable, the entire view becomes non-diffable. Preventing this in a scalable way is almost impossible with existing tools. This finding also reveals the performance issue caused by our unidirectional data flow library: action handling is closure-based, but SwiftUI canâ€™t diff closures!</p><p>In some cases, like with the action handlers from our unidirectional data flow library, making the value diffable would require large, invasive, and potentially undesirable architecture changes. Even in simpler cases, this process is still time consuming, and thereâ€™s no easy way to prevent a regression from creeping in later on. This is a big obstacle when trying to improve and maintain performance at scale in large codebases with many different contributors.</p><h3>Controlling SwiftUI viewÂ diffing</h3><p>Fortunately, we have another option: If a view conforms to Equatable, SwiftUI will diff it using its Equatable conformance <em>instead</em> of using the default reflection-based diffing algorithm.</p><p>The advantage of this approach is that it lets us selectively decide which properties should be compared when diffing our view. In our case, we know that the handler object doesnâ€™t affect the content or identity of our view. We only want our view to be re-evalulated and re-rendered when the <em>dataModel</em> and <em>requestState</em> values are updated. We can express that with a custom <em>Equatable</em> implementation:</p><pre>// An Equatable conformance that makes the above SwiftUI view diffable.<br>extension MyView: Equatable {<br>  static func ==(lhs: MyView, rhs: MyView) -&gt; Bool {<br>    lhs.dataModel == rhs.dataModel<br>      &amp;&amp; lhs.requestState == rhs.requestState<br>      // Intentionally not comparing handler, which isn&#39;t Equatable.<br>  }<br>}</pre><p>However:</p><ol><li>This is a lot of additional boilerplate for engineers to write, especially for views with lots of properties.</li><li>Writing and maintaining a custom conformance is error-prone. You can easily forget to update the <em>Equatable</em> conformance when adding new properties later, which would causeÂ bugs.</li></ol><p>So, instead of manually writing and maintaining <em>Equatable</em> conformances, we created a new<em> @Equatable </em>macro that generates conformances forÂ us.</p><pre>// A sample SwiftUI view that has adopted @Equatable<br>// and is now guaranteed to be diffable.<br>@Equatable<br>struct MyView: View {<br>  // Simple data types must be Equatable, or the build will fail.<br>  let dataModel: CopyOnWriteDataModel<br>  let requestState: MyFeatureRequestState<br><br>  // Types that aren&#39;t Equatable can be excluded from the<br>  // generated Equatable conformance using @SkipEquatable,<br>  // as long as they donâ€™t affect the output of the view body.<br>  @SkipEquatable let handler: Handler&lt;MyViewAction&gt;<br><br>  var body: some View { ... }<br>}</pre><p>The <em>@Equatable</em> macro generates an <em>Equatable</em> implementation that compares all of the viewâ€™s stored instance properties, excluding properties with SwiftUI property wrappers like<em>@State </em>and <em>@Environment</em> that trigger view updates through other mechanisms. Properties that arenâ€™t <em>Equatable</em> and donâ€™t affect the output of the view body can be marked with <em>@SkipEquatable</em> to exclude them from the generated implementation. This allows us to continue using the closure-based action handlers from our unidirectional data flow library without impacting the SwiftUI diffingÂ process!</p><p>After adopting the <em>@Equatable</em> macro on a view, that view is guaranteed to be diffable. If an engineer adds a non-<em>Equatable</em> property later, the build will fail, highlighting a potential regression in the diffing behavior. This effectively makes the <em>@Equatable</em> macro a sophisticated linterâ€Šâ€”â€Šwhich is really valuable for scaling these performance improvements in a codebase with many components and many contributors, since it makes it less likely for regressions to slip inÂ later.</p><h3>Managing the size of viewÂ bodies</h3><p>Another essential aspect of SwiftUI diffing is understanding that SwiftUI can only diff proper View structs. Any other code, such as computed properties or helper functions that generate a SwiftUI view, cannot beÂ diffed.</p><p>Consider the following example:</p><pre>// Complex SwiftUI views are often simplified by<br>// splitting the view body into separate computed properties.<br>struct MyScreen: View {<br>  /// The unidirectional data flow state store for this feature.<br>  @ObservedObject var store: StateStore&lt;MyState, MyAction&gt;<br><br>  var body: some View {<br>    VStack {<br>      headerSection<br>      actionCardSection<br>    }<br>  }<br><br>  private var headerSection: some View {<br>    Text(store.state.titleString)<br>      .textStyle(.title)<br>  }<br><br>  private var actionCardSection: some View {<br>    VStack {<br>      Image(store.state.cardSelected ? &quot;enabled&quot; : &quot;disabled&quot;)<br>      Text(&quot;This is a selectable card&quot;)<br>    }<br>    .strokedCard(.roundedRect_mediumCornerRadius_12)<br>    .scaleEffectButton(action: {<br>      store.handle(.cardTapped) <br>    })<br>  }<br>}</pre><p>This is a common way to organize complex view bodies, since it makes the code easier to read and maintain. However, at runtime, SwiftUI effectively inlines the views returned from the properties into the main view body, as if we insteadÂ wrote:</p><pre>// At runtime, computed properties are no different<br>// from just having a single, large view body!<br>struct MyScreen: View {<br>  @ObservedObject var store: StateStore&lt;MyState, MyAction&gt;<br><br>  // Re-evaluated every time the state of the screen is updated.<br>  var body: some View {<br>    Text(store.state.titleString)<br>      .textStyle(.title)<br><br>    VStack {<br>      Image(store.state.cardSelected ? &quot;enabled&quot; : &quot;disabled&quot;)<br>      Text(&quot;This is a selectable card&quot;)<br>    }<br>    .strokedCard(.roundedRect_mediumCornerRadius_12)<br>    .scaleEffectButton(action: {<br>      store.handle(.cardTapped) <br>    })<br>  }<br>}</pre><p>Since all of this code is part of the same view body, all of it will be re-evaluated when any part of the screenâ€™s state changes. While this specific example is simple, as the view grows larger and more complicated, re-evaluating it will become more expensive. Eventually there would be a large amount of unnecessary work happening on every screen update, hurting performance.</p><p>To improve performance, we can implement the layout code in separate SwiftUI views. This allows SwiftUI to properly diff each child view, only re-evaluating their bodies when necessary:</p><pre>struct MyScreen: View {<br>  @ObservedObject var store: StateStore&lt;MyState, MyAction&gt;<br><br>  var body: some View {<br>    VStack {<br>      HeaderSection(title: store.state.titleString)<br>      CardSection(<br>       isCardSelected: store.state.isCardSelected,<br>       handler: store.handler,<br>      )<br>    }<br>  }<br>}<br><br>/// Only re-evaluated and re-rendered when the title property changes.<br>@Equatable<br>struct HeaderSection: View {<br>  let title: String<br><br>  var body: some View {<br>    Text(title)<br>      .textStyle(.title)<br>  }<br>}<br><br>/// Only re-evaluated and re-rendered when the isCardSelected property changes.<br>@Equatable<br>struct CardSection: View {<br>  let isCardSelected: Bool<br>  @SkipEquatable let handler: Handler&lt;MyAction&gt;<br><br>  var body: some View {<br>    VStack {<br>      Image(store.state.isCardSelected ? &quot;enabled&quot; : &quot;disabled&quot;)<br>      Text(&quot;This is a selectable card&quot;)<br>    }<br>    .strokedCard(.roundedRect_mediumCornerRadius_12)<br>    .scaleEffectButton(action: {<br>      handler.handle(.cardTapped) <br>    })<br>  }<br>}</pre><p>By breaking the view into smaller, diffable pieces, SwiftUI can efficiently update only the parts of the view that actually changed. This approach helps maintain performance as a feature grows moreÂ complex.</p><h4>View body complexity lintÂ rule</h4><p>Large, complex views arenâ€™t always obvious during development. Easily available metrics like total line count arenâ€™t a good proxy for complexity. To help engineers know when itâ€™s time to refactor a view into smaller, diffable pieces, we created a custom <a href=\"https://github.com/realm/SwiftLint\">SwiftLint</a> rule that parses the view body using <a href=\"https://github.com/swiftlang/swift-syntax\">SwiftSyntax</a> and measures its complexity. We defined the view complexity metric as a value that increases every time you compose views using computed properties, functions, or closures. With this rule we automatically trigger an alert in Xcode when a view is getting too complex. (The complexity limit is configurable, and we currently allow a maximum complexity level ofÂ 10.)</p><figure><img alt=\"\" src=\"https://cdn-images-1.medium.com/max/1024/1*Tdo1L8qZf81FWFeJaNY6yQ.png\" /><figcaption>The rule shows as a warning during local Xcode builds alerting engineers as early as possible. In this screenshot, the complexity limit is set to 3, and this specific view has a complexity ofÂ 5.</figcaption></figure><h3>Conclusion</h3><p>With an understanding of how SwiftUI view diffing works, we can use an <em>@Equatable</em> macro to ensure view bodies are only re-evaluated when the values inside views actually change, break views into smaller parts for faster re-evaluation, and encourage developers to refactor views before they get too large andÂ complex.</p><p>Applying these three techniques to SwiftUI views in our app has led to a large reduction in unnecessary view re-evaluation and re-renders. Revisiting the examples from earlier, you see far fewer re-renders in the search bar and filterÂ panel:</p><figure><img alt=\"\" src=\"https://cdn-images-1.medium.com/max/1024/1*tWhEXK5kyFP5KYPCUSvp6Q.gif\" /></figure><p>Using results from our <a href=\"https://medium.com/airbnb-engineering/airbnbs-page-performance-score-on-ios-36d5f200bc73\">page performance score</a> system, weâ€™ve found that adopting these techniques in our most complicated SwiftUI screens really does improve performance for our users. For example, we reduced <a href=\"https://medium.com/airbnb-engineering/airbnbs-page-performance-score-on-ios-36d5f200bc73#4c63\">scroll hitches</a> by<strong> </strong>15% on our main Search screen by adopting <em>@Equatable</em> on its most important views, and breaking apart large view bodies into smaller diffable pieces. These techniques also give us the flexibility to use a feature architecture that best suits our needs without compromising performance or imposing burdensome limitations (e.g., completely avoiding closures in SwiftUIÂ views).</p><p>Of course, these techniques arenâ€™t a silver bullet. Itâ€™s not necessary for all SwiftUI features to use them, and these techniques by themselves arenâ€™t enough to guarantee great performance. However, understanding how and why they work serves as a valuable foundation for building performant SwiftUI features, and makes it easier to spot and avoid problematic patterns in your ownÂ code.</p><p>If youâ€™re interested in joining us on our quest to make the best iOS app in the App Store, please see our <a href=\"https://careers.airbnb.com/\">careers</a> page for open iOSÂ roles.</p><img src=\"https://medium.com/_/stat?event=post.clientViewed&referrerSource=full_rss&postId=37b77ac61896\" width=\"1\" height=\"1\" alt=\"\"><hr><p><a href=\"https://medium.com/airbnb-engineering/understanding-and-improving-swiftui-performance-37b77ac61896\">Understanding and Improving SwiftUI Performance</a> was originally published in <a href=\"https://medium.com/airbnb-engineering\">The Airbnb Tech Blog</a> on Medium, where people are continuing the conversation by highlighting and responding to this story.</p>"
    },
    {
      "title": "åœ¨ Airbnb ä½¿ç”¨ Impulse è¿›è¡Œè´Ÿè½½æµ‹è¯• (åŸæ ‡é¢˜: Load Testing with Impulse at Airbnb)",
      "link": "https://medium.com/airbnb-engineering/load-testing-with-impulse-at-airbnb-f466874d03d2?source=rss----53c7c27702d5---4",
      "pubDate": "Mon, 09 Jun 2025 17:45:39 GMT",
      "isoDate": "2025-06-09T17:45:39.000Z",
      "creator": "Chenhao Yang",
      "summary": "# Airbnb çš„ Impulse è´Ÿè½½æµ‹è¯•å®è·µ\n\n## å¼•è¨€\nç³»ç»Ÿçº§è´Ÿè½½æµ‹è¯•å¯¹äºç¡®ä¿ç³»ç»Ÿå¯é æ€§å’Œæ•ˆç‡è‡³å…³é‡è¦ï¼Œå®ƒèƒ½å¸®åŠ©è¯†åˆ«ç“¶é¢ˆã€è¯„ä¼°å³°å€¼æµé‡ä¸‹çš„å®¹é‡ã€å»ºç«‹æ€§èƒ½åŸºçº¿å¹¶æ£€æµ‹é”™è¯¯ã€‚åœ¨ Airbnb è¿™æ ·è§„æ¨¡å’Œå¤æ‚åº¦çš„å…¬å¸ï¼Œè´Ÿè½½æµ‹è¯•éœ€è¦å…·å¤‡å¥å£®æ€§ã€çµæ´»æ€§å’Œå»ä¸­å¿ƒåŒ–ç‰¹æ€§ï¼Œä»¥æ”¯æŒå·¥ç¨‹å›¢é˜Ÿè¿›è¡Œä¸ CI æ— ç¼é›†æˆçš„è‡ªåŠ©å¼è´Ÿè½½æµ‹è¯•ã€‚\n\nImpulse æ˜¯ Airbnb å†…éƒ¨çš„â€œè´Ÿè½½æµ‹è¯•å³æœåŠ¡â€æ¡†æ¶ä¹‹ä¸€ã€‚å®ƒæä¾›å·¥å…·æ¥ç”Ÿæˆåˆæˆè´Ÿè½½ã€æ¨¡æ‹Ÿä¾èµ–é¡¹ä»¥åŠä»ç”Ÿäº§ç¯å¢ƒä¸­æ”¶é›†æµé‡æ•°æ®ã€‚æœ¬æ–‡ä»‹ç»äº† Impulse çš„æ¶æ„ï¼Œä»¥åŠå®ƒå¦‚ä½•æœ€å¤§é™åº¦åœ°å‡å°‘æ‰‹åŠ¨å·¥ä½œã€æ— ç¼é›†æˆåˆ°å¯è§‚æµ‹æ€§å †æ ˆä¸­ï¼Œå¹¶èµ‹èƒ½å›¢é˜Ÿä¸»åŠ¨è§£å†³æ½œåœ¨é—®é¢˜ã€‚\n\n![å›¾ç‰‡ 1](https://cdn-images-1.medium.com/max/1024/1*3LijjQrJDLVA_ptfeRe83g.jpeg)\n\n## æ¶æ„\nImpulse æ˜¯ä¸€ä¸ªå…¨é¢çš„è´Ÿè½½æµ‹è¯•æ¡†æ¶ï¼Œå…è®¸æœåŠ¡æ‰€æœ‰è€…è¿›è¡Œä¸Šä¸‹æ–‡æ„ŸçŸ¥çš„è´Ÿè½½æµ‹è¯•ã€æ¨¡æ‹Ÿä¾èµ–é¡¹å¹¶æ”¶é›†æµé‡æ•°æ®ï¼Œä»¥ç¡®ä¿ç³»ç»Ÿåœ¨å„ç§æ¡ä»¶ä¸‹çš„æ€§èƒ½ã€‚å®ƒåŒ…å«ä»¥ä¸‹æ ¸å¿ƒç»„ä»¶ï¼š\n\n![å›¾ç‰‡ 2](https://cdn-images-1.medium.com/max/1024/1*SFDblGijyiLQfI7C5RpPXw.png)\n*å›¾ 1: Impulse æ¡†æ¶åŠå…¶å››ä¸ªä¸»è¦ç»„ä»¶*\n\n1.  **è´Ÿè½½ç”Ÿæˆå™¨ (Load Generator)**ï¼š\n    *   ç”¨äºæ ¹æ®åˆæˆæˆ–æ”¶é›†çš„æµé‡ï¼ŒåŠ¨æ€ç”Ÿæˆä¸Šä¸‹æ–‡æ„ŸçŸ¥çš„è¯·æ±‚ï¼Œä»¥æµ‹è¯•ä¸åŒåœºæ™¯ã€‚\n    *   **ä¸Šä¸‹æ–‡æ„ŸçŸ¥**ï¼šå…è®¸ç”¨æˆ·ä½¿ç”¨ Java æˆ– Kotlin ç¼–å†™ä»»æ„æµ‹è¯•é€»è¾‘ï¼Œå¹¶å¤§è§„æ¨¡å¯åŠ¨å®¹å™¨æ¥è¿è¡Œè¿™äº›æµ‹è¯•ã€‚é€‰æ‹©ä»£ç è€Œé DSL/é…ç½®çš„åŸå› åœ¨äºï¼š\n        *   **çµæ´»æ€§**ï¼šç¼–ç¨‹è¯­è¨€æ¯” DSL æ›´å…·è¡¨è¾¾åŠ›ï¼Œèƒ½æ›´å¥½åœ°æ”¯æŒå¤æ‚çš„ä¸Šä¸‹æ–‡åœºæ™¯ã€‚\n        *   **å¯é‡ç”¨æ€§**ï¼šç›¸åŒçš„æµ‹è¯•ä»£ç å¯ç”¨äºå…¶ä»–æµ‹è¯•ï¼ˆå¦‚é›†æˆæµ‹è¯•ï¼‰ã€‚\n        *   **å¼€å‘è€…ç†Ÿç»ƒåº¦**ï¼šå­¦ä¹ æ›²çº¿ä½ï¼Œæ— éœ€å­¦ä¹ æ–°çš„æµ‹è¯•é€»è¾‘ç¼–å†™æ–¹å¼ã€‚\n        *   **å¼€å‘è€…ä½“éªŒ**ï¼šæ”¯æŒ IDEã€æµ‹è¯•ã€è°ƒè¯•ç­‰ã€‚\n    *   **å»ä¸­å¿ƒåŒ–ä¸å®¹å™¨åŒ–**ï¼šæ¯æ¬¡è§¦å‘è´Ÿè½½æµ‹è¯•æ—¶ï¼Œéƒ½ä¼šåˆ›å»ºä¸€ç»„æ–°çš„å®¹å™¨æ¥è¿è¡Œæµ‹è¯•ï¼Œè¿™å¸¦æ¥äº†ï¼š\n        *   **éš”ç¦»æ€§**ï¼šä¸åŒæœåŠ¡é—´çš„è´Ÿè½½æµ‹è¯•ç›¸äº’éš”ç¦»ï¼Œæ¶ˆé™¤å¹²æ‰°ã€‚\n        *   **å¯ä¼¸ç¼©æ€§**ï¼šå®¹å™¨æ•°é‡å¯æ ¹æ®æµé‡éœ€æ±‚è¿›è¡Œä¼¸ç¼©ã€‚\n        *   **æˆæœ¬æ•ˆç›Š**ï¼šå®¹å™¨ç”Ÿå‘½å‘¨æœŸçŸ­ï¼Œä»…åœ¨è´Ÿè½½æµ‹è¯•è¿è¡ŒæœŸé—´å­˜åœ¨ã€‚\n    *   Impulse çš„è´Ÿè½½ç”Ÿæˆå™¨èƒ½å°†å·¥ä½œè´Ÿè½½å‡åŒ€åˆ†å¸ƒåˆ°æ‰€æœ‰æ•°æ®ä¸­å¿ƒï¼Œå¹¶ç¡®ä¿æ€»çš„æ¯ç§’è§¦å‘æ¬¡æ•° (TPS) ç¬¦åˆé…ç½®ï¼Œä»è€Œæ›´å¥½åœ°æ¨¡æ‹Ÿç”Ÿäº§ç¯å¢ƒä¸­çš„çœŸå®æµé‡åˆ†å¸ƒã€‚\n    *   **æ‰§è¡Œ**ï¼šè®¾è®¡ç”¨äºåœ¨ CI/CD æµæ°´çº¿ä¸­è‡ªåŠ¨è§¦å‘ã€‚å¼€å‘è€…å¯ä»¥é…ç½®å¤šä¸ªæµ‹è¯•é˜¶æ®µï¼ˆå¦‚é¢„çƒ­ã€ç¨³å®šã€å³°å€¼ï¼‰ï¼Œæ¯ä¸ªé˜¶æ®µå¯é…ç½®æµ‹è¯•ç”¨ä¾‹ã€TPS å’ŒæŒç»­æ—¶é—´ã€‚\n\n    ![å›¾ç‰‡ 3](https://cdn-images-1.medium.com/max/977/1*WD4EWyWHDQMf_7nDIGkAuA.png)\n    *å›¾ 2: å®¹å™¨åŒ–è´Ÿè½½ç”Ÿæˆå™¨*\n\n2.  **ä¾èµ–æ¨¡æ‹Ÿå™¨ (Dependency Mocker)**ï¼š\n    *   ç”¨äºæ¨¡æ‹Ÿä¸‹æ¸¸æœåŠ¡çš„å“åº”ï¼ŒåŒ…æ‹¬å»¶è¿Ÿï¼Œä»è€Œä½¿è¢«æµ‹æœåŠ¡ (SUT) çš„è´Ÿè½½æµ‹è¯•æ— éœ€æ¶‰åŠæŸäº›ä¾èµ–æœåŠ¡ã€‚è¿™å¯¹äºä¸æ”¯æŒè´Ÿè½½æµ‹è¯•çš„ä¾›åº”å•†æœåŠ¡æˆ–åœ¨æ—¥å¸¸éƒ¨ç½²ä¸­ä¸å½±å“ä¸‹æ¸¸æœåŠ¡è¿›è¡Œå›å½’æµ‹è¯•å°¤ä¸ºé‡è¦ã€‚\n    *   Impulse æ˜¯ä¸€ä¸ªå»ä¸­å¿ƒåŒ–æ¡†æ¶ï¼Œæ¯ä¸ªæœåŠ¡éƒ½æœ‰è‡ªå·±çš„ä¾èµ–æ¨¡æ‹Ÿå™¨ï¼Œä»¥æ¶ˆé™¤æœåŠ¡é—´çš„å¹²æ‰°å¹¶é™ä½é€šä¿¡æˆæœ¬ã€‚\n    *   æ¨¡æ‹Ÿå™¨æ˜¯è¿›ç¨‹å¤–æœåŠ¡ï¼Œç‹¬ç«‹è¿è¡Œï¼Œé¿å…å½±å“ SUT æ€§èƒ½ã€‚å®ƒä»¬æ˜¯çŸ­ç”Ÿå‘½å‘¨æœŸçš„ï¼Œä»…åœ¨æµ‹è¯•è¿è¡Œå‰å¯åŠ¨ï¼Œæµ‹è¯•ç»“æŸåå…³é—­ï¼Œä»¥èŠ‚çœæˆæœ¬å’Œç»´æŠ¤å·¥ä½œã€‚\n    *   å“åº”å»¶è¿Ÿå’Œå¼‚å¸¸å¯é…ç½®ï¼Œæ¨¡æ‹Ÿå™¨å®ä¾‹æ•°é‡å¯æŒ‰éœ€è°ƒæ•´ä»¥æ”¯æŒå¤§é‡æµé‡ã€‚\n    *   **å…¶ä»–å€¼å¾—æ³¨æ„çš„ç‰¹æ€§**ï¼š\n        *   å¯é€‰æ‹©æ€§åœ°æ¨¡æ‹Ÿéƒ¨åˆ†ä¾èµ–é¡¹ï¼Œç›®å‰æ”¯æŒ HTTP JSONã€Airbnb Thrift å’Œ Airbnb GraphQL ä¾èµ–ã€‚\n        *   æ”¯æŒè´Ÿè½½æµ‹è¯•ä¹‹å¤–çš„ç”¨ä¾‹ï¼Œå¦‚é›†æˆæµ‹è¯•ã€‚\n    *   **ä¸¤ç§æ¨¡æ‹Ÿå“åº”ç”Ÿæˆé€‰é¡¹**ï¼š\n        *   **åˆæˆå“åº” (Synthetic response)**ï¼šç”±ç”¨æˆ·é€»è¾‘ç”Ÿæˆï¼Œç±»ä¼¼äºé›†æˆæµ‹è¯•ï¼Œä½†å“åº”æ¥è‡ªè¿œç¨‹ï¼ˆè¿›ç¨‹å¤–ï¼‰æœåŠ¡å™¨ï¼Œå¹¶æ¨¡æ‹Ÿå»¶è¿Ÿã€‚\n        *   **é‡æ”¾å“åº” (Replay response)**ï¼šä»ç”Ÿäº§ä¸‹æ¸¸è®°å½•ä¸­é‡æ”¾å“åº”ï¼Œç”±æµé‡æ”¶é›†å™¨ç»„ä»¶æ”¯æŒã€‚\n\n    ![å›¾ç‰‡ 4](https://cdn-images-1.medium.com/max/1024/1*QXMa3Nj3-aSUE_EOvlv1xw.png)\n    *å›¾ 3: ä¾èµ–æ¨¡æ‹Ÿå™¨*\n\n3.  **æµé‡æ”¶é›†å™¨ (Traffic Collector)**ï¼š\n    *   æ—¨åœ¨æ•è·ç”Ÿäº§ç¯å¢ƒä¸­çš„ä¸Šæ¸¸å’Œä¸‹æ¸¸æµé‡åŠå…¶ä¹‹é—´çš„å…³ç³»ã€‚\n    *   é€šè¿‡å¤åˆ¶ä¸‹æ¸¸å“åº”ï¼ˆåŒ…æ‹¬ç”Ÿäº§ç¯å¢ƒèˆ¬çš„å»¶è¿Ÿå’Œé”™è¯¯ï¼‰ï¼ŒImpulse èƒ½å¤Ÿå‡†ç¡®åœ°é‡æ”¾ç”Ÿäº§æµé‡è¿›è¡Œè´Ÿè½½æµ‹è¯•ï¼Œé¿å…ä¸‹æ¸¸æ•°æ®æˆ–è¡Œä¸ºçš„ä¸ä¸€è‡´ã€‚\n    *   ç¡®ä¿æµ‹è¯•ç¯å¢ƒä¸­çš„æœåŠ¡è¡Œä¸ºä¸ç”Ÿäº§ç¯å¢ƒä¸­çš„æœåŠ¡è¡Œä¸ºä¸€è‡´ï¼Œä»è€Œå®ç°æ›´çœŸå®ã€æ›´å¯é çš„æ€§èƒ½è¯„ä¼°ã€‚\n\n    ![å›¾ç‰‡ 5](https://cdn-images-1.medium.com/max/1024/1*EImg3JUEGzbos5r3_6U-FQ.png)\n    *å›¾ 4: æµé‡æ”¶é›†å™¨*\n\n4.  **æµ‹è¯• API ç”Ÿæˆå™¨ (Testing API Generator)**ï¼š\n    *   è§£å†³äº‹ä»¶é©±åŠ¨ã€å¼‚æ­¥å·¥ä½œæµï¼ˆå¦‚æ¶ˆæ¯é˜Ÿåˆ—äº‹ä»¶ã€å»¶è¿Ÿä½œä¸šï¼‰çš„æµ‹è¯•éš¾é¢˜ã€‚\n    *   åœ¨ CI é˜¶æ®µæ ¹æ®äº‹ä»¶æˆ–ä½œä¸šæ¨¡å¼åˆ›å»º HTTP APIã€‚è¿™äº› API ä½œä¸ºåº•å±‚å¼‚æ­¥æµçš„åŒ…è£…å™¨ï¼Œå¹¶ä¸“é—¨æ³¨å†Œåœ¨æµ‹è¯•ç¯å¢ƒä¸­ã€‚\n    *   ä½¿è´Ÿè½½æµ‹è¯•å·¥å…·ï¼ˆå¦‚è´Ÿè½½ç”Ÿæˆå™¨ï¼‰èƒ½å¤Ÿå‘è¿™äº›åˆæˆ API å‘é€æµé‡ï¼Œä»è€Œä½¿å¼‚æ­¥æµåƒåŒæ­¥æµä¸€æ ·è¢«æ‰§è¡Œã€‚\n    *   ç›®æ ‡æ˜¯å¸®åŠ©å¼€å‘è€…è¯†åˆ«å¼‚æ­¥æµå®ç°ä¸­çš„æ€§èƒ½ç“¶é¢ˆå’Œæ½œåœ¨é—®é¢˜ï¼Œä»¥åŠåœ¨é«˜æµé‡æ¡ä»¶ä¸‹çš„è¡¨ç°ï¼Œé€šè¿‡ç»•è¿‡æ¶ˆæ¯é˜Ÿåˆ—ç­‰ä¸­é—´ä»¶ç»„ä»¶ï¼Œç®€åŒ–è´Ÿè½½æµ‹è¯•è¿‡ç¨‹ã€‚\n\n    ![å›¾ç‰‡ 6](https://cdn-images-1.medium.com/max/660/1*F3qllm7qqMu4N2k0bBFbdQ.png)\n    *å›¾ 5: å¼‚æ­¥æµçš„æµ‹è¯• API ç”Ÿæˆå™¨*\n\n## ä¸å…¶ä»–æµ‹è¯•æ¡†æ¶çš„é›†æˆ\nImpulse çš„æ¨¡å—åŒ–è®¾è®¡ä¿ƒè¿›äº†å…¶ä¸å…¶ä»–å†…éƒ¨æµ‹è¯•æ¡†æ¶ï¼ˆå¦‚é›†æˆæµ‹è¯•å’Œ API æµ‹è¯•ï¼‰çš„é›†æˆï¼Œä¸ºç³»ç»ŸæœåŠ¡æµ‹è¯•æä¾›äº†ç³»ç»ŸåŒ–çš„æ–¹æ³•ã€‚\n\n![å›¾ç‰‡ 7](https://cdn-images-1.medium.com/max/1024/1*649CFxbpASxHotVVbqdQkQ.png)\n*å›¾ 6: Impulse å¦‚ä½•ä¸ Airbnb å…¶ä»–å†…éƒ¨æµ‹è¯•æ¡†æ¶äº¤äº’*\n\n## ç»“è®º\nImpulse åŠå…¶å››ä¸ªæ ¸å¿ƒç»„ä»¶å¸®åŠ© Airbnb çš„å¼€å‘è€…è¿›è¡Œè‡ªåŠ©å¼è´Ÿè½½æµ‹è¯•ã€‚å®ƒå·²åœ¨å¤šä¸ªå®¢æˆ·æ”¯æŒåç«¯æœåŠ¡ä¸­å®æ–½ï¼Œå¹¶è·å¾—äº†ç§¯æåé¦ˆï¼Œä¾‹å¦‚ï¼šå®ƒå¸®åŠ©è¯†åˆ«å¹¶è§£å†³äº†çº¿ç¨‹æ± å‹åŠ›å¯¼è‡´çš„ `ApiClientThreadToolExhaustionException`ã€å®¢æˆ·ç«¯ API è°ƒç”¨ä¸­çš„å¶å‘è¶…æ—¶é”™è¯¯ä»¥åŠä¸»æœåŠ¡å®¹å™¨ä¸­çš„é«˜å†…å­˜ä½¿ç”¨é—®é¢˜ï¼Œä»è€Œä¼˜åŒ–äº†èµ„æºåˆ†é…ã€‚Impulse è¢«é«˜åº¦æ¨èä½œä¸ºå¼€å‘å’Œæµ‹è¯•æµç¨‹ä¸å¯æˆ–ç¼ºçš„ä¸€éƒ¨åˆ†ã€‚",
      "shortSummary": "Airbnb å¼€å‘äº† Impulseï¼Œä¸€ä¸ªå†…éƒ¨çš„â€œè´Ÿè½½æµ‹è¯•å³æœåŠ¡â€æ¡†æ¶ï¼Œæ—¨åœ¨å®ç°å¥å£®ã€çµæ´»å’Œå»ä¸­å¿ƒåŒ–çš„è‡ªåŠ©å¼è´Ÿè½½æµ‹è¯•ã€‚å®ƒåŒ…å«è´Ÿè½½ç”Ÿæˆå™¨ã€ä¾èµ–æ¨¡æ‹Ÿå™¨ã€æµé‡æ”¶é›†å™¨å’Œæµ‹è¯• API ç”Ÿæˆå™¨å››ä¸ªæ ¸å¿ƒç»„ä»¶ã€‚Impulse èƒ½å¤Ÿç”Ÿæˆä¸Šä¸‹æ–‡æ„ŸçŸ¥è´Ÿè½½ã€æ¨¡æ‹Ÿä¾èµ–ã€é‡æ”¾ç”Ÿäº§æµé‡å¹¶æµ‹è¯•å¼‚æ­¥å·¥ä½œæµã€‚é€šè¿‡ä¸ CI/CD æ— ç¼é›†æˆï¼ŒImpulse å¸®åŠ©å›¢é˜Ÿä¸»åŠ¨è¯†åˆ«å¹¶è§£å†³æ€§èƒ½ç“¶é¢ˆã€è¯„ä¼°ç³»ç»Ÿå®¹é‡ï¼Œä»è€Œæé«˜æœåŠ¡å¯é æ€§å’Œæ•ˆç‡ï¼Œå¹¶æœ€å¤§é™åº¦åœ°å‡å°‘æ‰‹åŠ¨å·¥ä½œã€‚",
      "translated_title": "åœ¨ Airbnb ä½¿ç”¨ Impulse è¿›è¡Œè´Ÿè½½æµ‹è¯•",
      "images": [
        {
          "url": "https://cdn-images-1.medium.com/max/1024/1*3LijjQrJDLVA_ptfeRe83g.jpeg",
          "alt": "",
          "title": "",
          "position": 1
        },
        {
          "url": "https://cdn-images-1.medium.com/max/1024/1*SFDblGijyiLQfI7C5RpPXw.png",
          "alt": "",
          "title": "",
          "position": 2
        },
        {
          "url": "https://cdn-images-1.medium.com/max/977/1*WD4EWyWHDQMf_7nDIGkAuA.png",
          "alt": "",
          "title": "",
          "position": 3
        },
        {
          "url": "https://cdn-images-1.medium.com/max/1024/1*QXMa3Nj3-aSUE_EOvlv1xw.png",
          "alt": "",
          "title": "",
          "position": 4
        },
        {
          "url": "https://cdn-images-1.medium.com/max/1024/1*EImg3JUEGzbos5r3_6U-FQ.png",
          "alt": "",
          "title": "",
          "position": 5
        }
      ],
      "contentSource": "RSS",
      "content": "<p>Comprehensive Load Testing with Load Generator, Dependency Mocker, Traffic Collector, andÂ More</p><figure><img alt=\"\" src=\"https://cdn-images-1.medium.com/max/1024/1*3LijjQrJDLVA_ptfeRe83g.jpeg\" /></figure><p>Authors: <a href=\"https://www.linkedin.com/in/chenhao-yang-9799b022/\">Chenhao Yang</a>, <a href=\"https://www.linkedin.com/in/haoyue-wang-a722509a/\">Haoyue Wang</a>, <a href=\"https://www.linkedin.com/in/xiaoyawei/\">Xiaoya Wei</a>, <a href=\"https://www.linkedin.com/in/zhijie-guan/\">Zay Guan</a>, <a href=\"https://www.linkedin.com/in/yaolin-chen-591a31339/\">Yaolin Chen</a> and <a href=\"https://www.linkedin.com/in/fei-yuan/\">FeiÂ Yuan</a></p><p>System-level load testing is crucial for reliability and efficiency. It identifies bottlenecks, evaluates capacity for peak traffic, establishes performance baselines, and detects errors. At a company of Airbnbâ€™s size and complexity, weâ€™ve learned that load testing needs to be robust, flexible, and decentralized. This requires the right set of tools to enable engineering teams to do self-service load tests that integrate seamlessly withÂ CI.</p><p>Impulse is one of our internal load-testing-as-a-service frameworks. It provides tools that can generate synthetic loads, mock dependencies, and collect traffic data from production environments. In this blog post, weâ€™ll share how Impulse is architected to minimize manual effort, seamlessly integrate with our observability stack, and empower teams to proactively address potential issues.</p><h3>Architecture</h3><p>Impulse is a comprehensive load testing framework that allows service owners to conduct context-aware load tests, mock dependencies, and collect traffic data to ensure the systemâ€™s performance under various conditions. It includes the following components:</p><ol><li><strong>Load generator</strong> to generate context-aware requests on the fly, for testing different scenarios with synthetic or collected traffic.</li><li><strong>Dependency mocker</strong> to mock the downstream responses with latency, so that the load testing on the service under test (SUT) doesnâ€™t need to involve certain dependent services. This is especially crucial when the dependencies are vendor services that donâ€™t support load testing, or if the team wants to regression load test their service during day-to-day deployment without affecting downstreams.</li><li><strong>Traffic collector</strong> to collect both the upstream and downstream traffic from the production environment, and then apply the resulting data to the test environment.</li><li><strong>Testing API generator</strong> to wrap asynchronous workflows into synchronous API calls for loadÂ testing.</li></ol><figure><img alt=\"\" src=\"https://cdn-images-1.medium.com/max/1024/1*SFDblGijyiLQfI7C5RpPXw.png\" /><figcaption>Figure 1: The Impulse framework and its four main components</figcaption></figure><p>Each of these four tools are independent, allowing service owners the flexibility to select one or more components for their load testingÂ needs.</p><h4>Load generator</h4><figure><img alt=\"\" src=\"https://cdn-images-1.medium.com/max/977/1*WD4EWyWHDQMf_7nDIGkAuA.png\" /><figcaption>Figure 2: Containerized load generator</figcaption></figure><p><em>Context aware</em></p><p>When load testing, requests made to the SUT often require some information from the previous response or need to be sent in a specific order. For example, if an update API needs to provide an <em>entity_id</em> to update, we must ensure the entity already exists in the testing environment context.</p><p>Our load generator tool allows users to write arbitrary testing logic in Java or Kotlin and launch containers to run these tests at scale against the SUT. Why write code instead of DSL/configuration logic?</p><ul><li>Flexibility: Programming languages are more expressive than DSL and can better support complex contextual scenarios.</li><li>Reusability: The same testing code can be used in other tests, e.g., integration tests.</li><li>Developer proficiency: Low/no learning curve to onboard, donâ€™t need to learn how to write testingÂ logic.</li><li>Developer experience: IDE support, testing, debugging, etc.</li></ul><p>Here is an example of synthetic context-aware testÂ case:</p><pre>class HelloWorldLoadGenerator : LoadGenerator {<br>   override suspend fun run() {<br>       val createdEntity = sutApiClient.create(CreateRequest(name=&quot;foo&quot;, ...)).data<br><br>       // request with id from previous response (context)<br>       val updateResponse = sutApiClient.update(UpdateRequest(id=createdEntity.id, name=&quot;bar&quot;))<br>       <br>       // ... other operations<br>       <br>       // clean up<br>       sutApiClient.delete(DeleteRequest(id=createdEntity.id))<br>   }<br>}</pre><p><em>Decentralized</em></p><p>The load generator is decentralized and containerized, which means each time a load test is triggered, a set of new containers will be created to run the test. This design has several benefits:</p><ul><li>Isolation: Load testing runs between different services are isolated from each other, eliminating any interference.</li><li>Scalability: The number of containers can be scaled up or down according to the traffic requirements.</li><li>Cost efficiency: The containers are short-lived, as they only exist during the load testingÂ run.</li></ul><p>Whatâ€™s more, as our services are cloud based, a subtle point is that the Impulse framework will evenly distribute the workers among all our data centers, and the load will be emitted evenly from all the workers. Impulseâ€™s load generator ensures the overall trigger per second (TPS) is as configured. Based on this, we can better leverage the locality settings in load balancers, which can better mimic the real traffic distribution in production.</p><p><em>Execution</em></p><p>The load generator is designed to be executed in the CI/CD pipeline, which means we can trigger load testing automatically. Developers can configure the testing spec in multiple phases, e.g., a warm up phase, a steady state phase, a peak phase, etc. Each phase can be configured with:</p><ul><li>Test cases toÂ run</li><li>TPS (trigger per second) of each testÂ case</li><li>Test duration</li></ul><h4>Dependency mocker</h4><figure><img alt=\"\" src=\"https://cdn-images-1.medium.com/max/1024/1*QXMa3Nj3-aSUE_EOvlv1xw.png\" /><figcaption>Figure 3: Dependency mocker</figcaption></figure><p>Impulse is a decentralized framework where each service has its own dependency mocker. This can eliminate interference between services and reduce communication costs. Each dependency mocker is an out-of-process service, which means the SUT behaves just as it does in production. We run the mockers in separate instances to avoid any impact on the performance of the SUT. The mock servers are all short livedâ€Šâ€”â€Šthey only start before tests run and shut down afterwards to save costs and maintenance effort. The response latency and exceptions are configurable and the number of mocker instances can be adjusted on demand to support large amounts ofÂ traffic.</p><p>Other noteworthy features:</p><ul><li>You can selectively stub some of the dependencies. Currently, stubbing is supported for HTTP JSON, Airbnb Thrift, and Airbnb GraphQL dependencies.</li><li>The dependency mockers support use cases beyond load testing. For instance, integration tests often rely on other services or third-party API calls, which may not guarantee a stable testing environment or might only support ideal scenarios. Dependency mockers can address this by offering predefined responses or exceptions to fully test thoseÂ flows.</li></ul><p>Impulse supports two options for generating mock responses:</p><ol><li>Synthetic response: The response is generated by user logic, as in integration testing; the difference is that the response comes from a remote (out-of-process) server with simulated latency.<br>- Similar to the load generator, the logic is written in Java/Kotlin code and contains request matching and response generation.<br>- Latency can be simulated using p95/p99Â metrics.</li><li>Replay response: The response is replayed from the production downstream recording, supported by the traffic collector component.</li></ol><p>Here is an example of a synthetic response with latency inÂ Kotlin:</p><pre>downstreamsMocking.every(<br>      thriftRequest&lt;FooRequest&gt;().having { it.message == &quot;hello&quot; }<br>    ).returns { request -&gt;<br>      ThriftDownstream.Response.thriftEncoded(<br>        HttpStatus.OK,<br>        FooResponse.builder.reply(&quot;${request.message} world&quot;).build()<br>      )<br>    }.with {<br>      delay = latencyFromP95(p95=500.miliseconds, min=200.miliseconds, max=2000.miliseconds)<br>    }</pre><h4>Traffic collector</h4><figure><img alt=\"\" src=\"https://cdn-images-1.medium.com/max/1024/1*EImg3JUEGzbos5r3_6U-FQ.png\" /><figcaption>Figure 4: Traffic collector</figcaption></figure><p>The traffic collector component is designed to capture both upstream and downstream traffic, along with the relationships between them. This approach allows Impulse to accurately replay production traffic during load testing, avoiding inconsistencies in downstream data or behavior. By replicating downstream responsesâ€Šâ€”â€Šincluding production-like latency and errorsâ€Šâ€”â€Švia the dependency mocker, the system ensures high-fidelity load testing. As a result, services in the testing environment behave identically to those in production, enabling more realistic and reliable performance evaluations.</p><h4>Testing API generator</h4><p>We rely heavily on event-driven, asynchronous workflows that are critical to our business operations. These include processing events from a message queue (MQ) and executing delayed jobs. Most of the MQ events/jobs are emitted from synchronous flows (e.g., API calls), so theoretically they can be covered by API load testing. However, the real world is more complex. These asynchronous flows often involve long chains of event and job emissions originating from various sources, making it difficult to replicate and test them accurately using only API-based methods.</p><p>To address this, the testing API generator component creates HTTP APIs during the CI stage according to the event or job schema. These APIs act as wrappers around the underlying asynchronous flows and are registered exclusively in the testing environment. This setup enables load testing toolsâ€Šâ€”â€Šsuch as load generatorsâ€Šâ€”â€Što send traffic to these synthetic APIs, allowing asynchronous flows to be exercised as if they were synchronous. As a result, itâ€™s possible to perform targeted, realistic load testing on asynchronous logic that would otherwise be hard to simulate.</p><figure><img alt=\"\" src=\"https://cdn-images-1.medium.com/max/660/1*F3qllm7qqMu4N2k0bBFbdQ.png\" /><figcaption>Figure 5: Testing API generator for asyncÂ flows</figcaption></figure><p>The goal of the testing API generator is to help developers identify performance bottlenecks and potential issues in their async flow implementations and under high traffic conditions. It does this by enabling direct load testing of async flows without involving middleware components like MQs. The rationale is that developers typically aim to evaluate the behavior of their own logic, not the middleware, which is usually already well-tested. By bypassing these components, this approach simplifies the load testing process and empowers developers to independently manage and execute their ownÂ tests.</p><h4>Integration with other testing frameworks</h4><p>Airbnb emphasizes product quality, utilizing versatile testing frameworks that cover integration and API tests across development, staging, and production environments, and integrate smoothly into CI/CD pipelines. The modular design of Impulse facilitates its integration with these frameworks, offering systematic serviceÂ testing.</p><figure><img alt=\"\" src=\"https://cdn-images-1.medium.com/max/1024/1*649CFxbpASxHotVVbqdQkQ.png\" /><figcaption>Figure 6: How Impulse interfaces with other internal testing frameworks</figcaption></figure><h3>Conclusion</h3><p>In this blog post, we shared how Impulse and its four core components help developers perform self-service load testing at Airbnb. As of this writing, Impulse has been implemented in several customer support backend services and is currently under review with different teams across the company who are planning to leverage Impulse to conduct loadÂ testing.</p><p>Weâ€™ve received a lot of good feedback in the process. For example: â€œ<em>Impulse helps us to identify and address potential issues in our service. During testing, it detected an ApiClientThreadToolExhaustionException caused by thread pool pressure. Additionally, it alerted us about occasional timeout errors in client API calls during service deployments. Impulse helped us identify high memory usage in the main service container, enabling us to fine-tune the memory allocation and optimize our serviceâ€™s resource usage. Highly recommend utilizing Impulse as an integral part of the development and testing processes.</em>â€</p><h3>Acknowledgments</h3><p>Thanks to Jeremy Werner, Yashar Mehdad, Raj Rajagopal, Claire Cheng, Tim L., Wei Ji, Jay Wu, Brian Wallace for support on the ImpulseÂ project.</p><p>Does this type of work interest you? Check out our open rolesÂ <a href=\"https://careers.airbnb.com/\">here</a>.</p><img src=\"https://medium.com/_/stat?event=post.clientViewed&referrerSource=full_rss&postId=f466874d03d2\" width=\"1\" height=\"1\" alt=\"\"><hr><p><a href=\"https://medium.com/airbnb-engineering/load-testing-with-impulse-at-airbnb-f466874d03d2\">Load Testing with Impulse at Airbnb</a> was originally published in <a href=\"https://medium.com/airbnb-engineering\">The Airbnb Tech Blog</a> on Medium, where people are continuing the conversation by highlighting and responding to this story.</p>"
    },
    {
      "title": "å¤§è§„æ¨¡å€¾å¬ã€å­¦ä¹ ä¸å¸®åŠ©ï¼šæœºå™¨å­¦ä¹ å¦‚ä½•æ”¹å˜çˆ±å½¼è¿çš„è¯­éŸ³æ”¯æŒä½“éªŒ (åŸæ ‡é¢˜: Listening, Learning, and Helping at Scale: How Machine Learning Transforms Airbnbâ€™s Voice Supportâ€¦)",
      "link": "https://medium.com/airbnb-engineering/listening-learning-and-helping-at-scale-how-machine-learning-transforms-airbnbs-voice-support-b71f912d4760?source=rss----53c7c27702d5---4",
      "pubDate": "Thu, 29 May 2025 17:29:46 GMT",
      "isoDate": "2025-05-29T17:29:46.000Z",
      "creator": "Yuanpei Cao",
      "summary": "# å¤§è§„æ¨¡å€¾å¬ã€å­¦ä¹ ä¸å¸®åŠ©ï¼šæœºå™¨å­¦ä¹ å¦‚ä½•æ”¹å˜çˆ±å½¼è¿çš„è¯­éŸ³æ”¯æŒä½“éªŒ\n\nçˆ±å½¼è¿è‡´åŠ›äºæä¾›æµç•…ã€ç›´è§‚ä¸”æœ‰å¸®åŠ©çš„ç¤¾åŒºæ”¯æŒä½“éªŒï¼Œæ— è®ºæ˜¯ååŠ©æˆ¿å®¢å¤„ç†é¢„è®¢å˜æ›´ï¼Œè¿˜æ˜¯å¸®åŠ©æˆ¿ä¸œè§£å†³æˆ¿æºé—®é¢˜ã€‚å°½ç®¡å¸®åŠ©ä¸­å¿ƒå’Œå®¢æœèŠå¤©æœºå™¨äººèƒ½é«˜æ•ˆè§£å†³è®¸å¤šå’¨è¯¢ï¼Œä½†éƒ¨åˆ†ç”¨æˆ·æ›´å€¾å‘äºä¸æ”¯æŒä»£è¡¨è¿›è¡Œå³æ—¶è¯­éŸ³å¯¹è¯ã€‚ä¸ºäº†ä½¿è¿™äº›äº’åŠ¨æ›´å¿«ã€æ›´æœ‰æ•ˆï¼Œçˆ±å½¼è¿é€šè¿‡æœºå™¨å­¦ä¹ æ˜¾è‘—æ”¹è¿›äº†å…¶äº¤äº’å¼è¯­éŸ³åº”ç­”ï¼ˆIVRï¼‰ç³»ç»Ÿã€‚\n\n## é‡æ–°æ„æƒ³è¯­éŸ³æ”¯æŒæ—…ç¨‹\n\nä¼ ç»Ÿçš„IVRç³»ç»Ÿé€šå¸¸ä¾èµ–äºåƒµç¡¬çš„èœå•æ ‘ï¼Œè¦æ±‚å‘¼å«è€…æŒ‰é”®å¹¶å¯¼èˆªé¢„è®¾è·¯å¾„ã€‚çˆ±å½¼è¿è®¾è®¡äº†ä¸€ä¸ªè‡ªé€‚åº”ã€ä¼šè¯å¼çš„IVRç³»ç»Ÿï¼Œèƒ½å¤Ÿå®æ—¶å€¾å¬ã€ç†è§£å’Œå“åº”ã€‚å½“å‘¼å«è€…è”ç³»çˆ±å½¼è¿æ”¯æŒæ—¶ï¼Œé€šå¸¸ä¼šå‘ç”Ÿä»¥ä¸‹æµç¨‹ï¼š\n\n1.  **å‘¼å«ä¸é—®å€™**ï¼šIVRæ¥å¬å¹¶æç¤ºï¼šâ€œè¯·ç”¨å‡ å¥è¯å‘Šè¯‰æˆ‘æ‚¨ä»Šå¤©è‡´ç”µçš„åŸå› ã€‚â€\n2.  **è‡ªåŠ¨è¯­éŸ³è¯†åˆ«ï¼ˆASRï¼‰**ï¼šå‘¼å«è€…çš„å›ç­”é€šè¿‡çˆ±å½¼è¿ä¸“ç”¨çš„ASRç³»ç»Ÿè½¬å½•æˆæ–‡æœ¬ï¼Œä¿ç•™å…³é”®çš„é¢†åŸŸç‰¹å®šæœ¯è¯­ã€‚\n3.  **ç†è§£æ„å›¾**ï¼šä¸€ä¸ªâ€œè”ç³»åŸå› æ£€æµ‹â€æ¨¡å‹å°†é—®é¢˜åˆ†ç±»ä¸ºå–æ¶ˆã€é€€æ¬¾ã€è´¦æˆ·é—®é¢˜ç­‰ç±»åˆ«ã€‚\n4.  **å†³ç­–åˆ¶å®š**ï¼š\n    *   å¦‚æœå¯ä»¥è‡ªåŠ©æœåŠ¡ï¼Œç³»ç»Ÿä¼šé€šè¿‡çŸ­ä¿¡æˆ–åº”ç”¨é€šçŸ¥å‘é€ç›¸å…³çš„å¸®åŠ©æ–‡ç« æˆ–æ™ºèƒ½å·¥ä½œæµç¨‹ã€‚\n    *   å¦‚æœå‘¼å«è€…æ˜ç¡®è¯·æ±‚ä»£ç†æ”¯æŒæˆ–é—®é¢˜éœ€è¦äººå·¥å¹²é¢„ï¼Œå‘¼å«å°†è·¯ç”±åˆ°å®¢æˆ·æ”¯æŒä»£ç†ï¼Œå¹¶é™„å¸¦ç›¸å…³è¯¦ç»†ä¿¡æ¯ã€‚\n5.  **æ¾„æ¸…å“åº”**ï¼šä¸€ä¸ªâ€œé‡Šä¹‰æ¨¡å‹â€ç”Ÿæˆç”¨æˆ·æ„å›¾çš„æ‘˜è¦ï¼ŒIVRåœ¨æä¾›è§£å†³æ–¹æ¡ˆä¹‹å‰ä¸ç”¨æˆ·åˆ†äº«ã€‚è¿™ç¡®ä¿ç”¨æˆ·ç†è§£ä»–ä»¬æ”¶åˆ°çš„èµ„æºçš„ä¸Šä¸‹æ–‡ã€‚\n6.  **è§£å†³æˆ–å‡çº§**ï¼šå‘¼å«è€…æ”¶åˆ°åŒ…å«ç›¸å…³çˆ±å½¼è¿å¸®åŠ©ä¸­å¿ƒæ–‡ç« é“¾æ¥çš„çŸ­ä¿¡æˆ–åº”ç”¨é€šçŸ¥ã€‚å¦‚æœéœ€è¦è¿›ä¸€æ­¥å¸®åŠ©ï¼Œä»–ä»¬å¯ä»¥æŒ‰0è¿æ¥å®¢æˆ·æœåŠ¡ä»£è¡¨ã€‚\n\né€šè¿‡ä»åƒµç¡¬çš„èœå•è½¬å‘è‡ªç„¶è¯­è¨€ç†è§£ï¼Œçˆ±å½¼è¿å…è®¸æˆ¿å®¢å’Œæˆ¿ä¸œç”¨è‡ªå·±çš„è¯è¡¨è¾¾é—®é¢˜ï¼Œä»è€Œæé«˜æ»¡æ„åº¦å’Œè§£å†³æ•ˆç‡ã€‚\n\n![çˆ±å½¼è¿IVRæ ¸å¿ƒæœåŠ¡ä¸æœºå™¨å­¦ä¹ ç»„ä»¶äº¤äº’çš„é«˜çº§æ¶æ„](https://cdn-images-1.medium.com/max/1024/1*4MMPeZJDlFDELNNSZ8dGPA.png)\n*å›¾1ï¼šçˆ±å½¼è¿IVRæ ¸å¿ƒæœåŠ¡å¦‚ä½•ä¸æ ¸å¿ƒæœºå™¨å­¦ä¹ ç»„ä»¶äº¤äº’ä»¥é€šè¿‡ç”µè¯è§£å†³ç”¨æˆ·é—®é¢˜çš„é«˜çº§æ¶æ„ã€‚*\n\n## æœºå™¨å­¦ä¹ é©±åŠ¨çš„IVRç³»ç»Ÿæ ¸å¿ƒç»„ä»¶\n\nçˆ±å½¼è¿çš„IVRç³»ç»Ÿç”±ä»¥ä¸‹å…³é”®æœºå™¨å­¦ä¹ ç»„ä»¶é©±åŠ¨ï¼š\n\n### 1. è‡ªåŠ¨è¯­éŸ³è¯†åˆ«ï¼ˆASRï¼‰ï¼šç²¾å‡†è½¬å½•\n\nåœ¨è¯­éŸ³é©±åŠ¨çš„æ”¯æŒç³»ç»Ÿä¸­ï¼Œå®ç°é«˜è½¬å½•å‡†ç¡®æ€§è‡³å…³é‡è¦ï¼Œå°¤å…¶æ˜¯åœ¨å˜ˆæ‚çš„ç”µè¯ç¯å¢ƒä¸­ã€‚é€šç”¨è¯­éŸ³è¯†åˆ«æ¨¡å‹åœ¨å¤„ç†çˆ±å½¼è¿ç‰¹å®šæœ¯è¯­æ—¶å¸¸é‡åˆ°å›°éš¾ã€‚ä¸ºäº†æé«˜ASRå‡†ç¡®æ€§ï¼Œçˆ±å½¼è¿ï¼š\n\n*   ä»é€šç”¨é¢„è®­ç»ƒæ¨¡å‹è½¬å‘ä¸“é—¨ä¸ºå˜ˆæ‚ç”µè¯éŸ³é¢‘è°ƒæ•´çš„æ¨¡å‹ã€‚\n*   å¼•å…¥äº†é¢†åŸŸç‰¹å®šçŸ­è¯­åˆ—è¡¨ä¼˜åŒ–ï¼Œç¡®ä¿çˆ±å½¼è¿æœ¯è¯­è¢«æ­£ç¡®è¯†åˆ«ã€‚\n*   ç»“æœï¼šè¯é”™è¯¯ç‡ï¼ˆWERï¼‰ä»33%æ˜¾è‘—é™ä½åˆ°çº¦10%ã€‚è¿™æé«˜äº†ä¸‹æ¸¸å¸®åŠ©æ–‡ç« æ¨èçš„å‡†ç¡®æ€§ï¼Œå¢åŠ äº†ç”¨æˆ·å‚ä¸åº¦ï¼Œæ”¹å–„äº†ä¸ASRèœå•äº¤äº’ç”¨æˆ·çš„å®¢æˆ·NPSï¼ŒåŒæ—¶å‡å°‘äº†å¯¹äººå·¥ä»£ç†çš„ä¾èµ–å¹¶ç¼©çŸ­äº†å®¢æˆ·æœåŠ¡å¤„ç†æ—¶é—´ã€‚\n\n### 2. è”ç³»åŸå› é¢„æµ‹ï¼šç†è§£â€œä¸ºä»€ä¹ˆâ€\n\nè½¬å½•å‘¼å«è€…é™ˆè¿°åï¼Œä¸‹ä¸€æ­¥æ˜¯è¯†åˆ«å…¶æ„å›¾ã€‚çˆ±å½¼è¿é€šè¿‡åˆ›å»ºè¯¦ç»†çš„â€œè”ç³»åŸå› åˆ†ç±»æ³•â€æ¥å®ç°è¿™ä¸€ç‚¹ï¼Œè¯¥åˆ†ç±»æ³•æ¶µç›–äº†æ‰€æœ‰æ½œåœ¨çš„çˆ±å½¼è¿å’¨è¯¢ã€‚ä¸€ä¸ªæ„å›¾æ£€æµ‹æ¨¡å‹å°†å‘¼å«åˆ†ç±»åˆ°ç›¸åº”çš„â€œè”ç³»åŸå› â€ç±»åˆ«ã€‚\n\n*   **éƒ¨ç½²**ï¼šåœ¨ç”Ÿäº§ç¯å¢ƒä¸­ï¼Œçˆ±å½¼è¿éƒ¨ç½²äº†â€œé—®é¢˜æ£€æµ‹æœåŠ¡â€æ¥æ‰˜ç®¡æ„å›¾æ£€æµ‹æ¨¡å‹ï¼Œå¹¶è¡Œè¿è¡Œä»¥å®ç°æœ€ä½³çš„å¯æ‰©å±•æ€§ã€çµæ´»æ€§å’Œæ•ˆç‡ã€‚å¹³å‡æ„å›¾æ£€æµ‹å»¶è¿Ÿä¿æŒåœ¨50æ¯«ç§’ä»¥ä¸‹ï¼Œç¡®ä¿äº†æ— ç¼çš„å®æ—¶ä½“éªŒã€‚\n*   **ç‰¹æ®Šæƒ…å†µ**ï¼šå¯¹äºå‘¼å«è€…æ˜ç¡®è¦æ±‚ä¸äººå·¥ä»£ç†é€šè¯çš„æƒ…å†µï¼Œç³»ç»Ÿä½¿ç”¨ä¸åŒçš„æ„å›¾æ£€æµ‹æ¨¡å‹æ¥è¯†åˆ«æ­¤æ„å›¾ï¼Œå¹¶å°†å‘¼å«è·¯ç”±åˆ°åˆé€‚çš„å›¢é˜Ÿã€‚\n\n![æ„å›¾æ£€æµ‹æ¶æ„å’Œé—®é¢˜æ£€æµ‹æœåŠ¡](https://cdn-images-1.medium.com/max/1024/0*oj7NCOlBGYOnNBOx)\n*å›¾2ï¼šæ„å›¾æ£€æµ‹æ¶æ„å’Œé—®é¢˜æ£€æµ‹æœåŠ¡ã€‚*\n\n### 3. å¸®åŠ©æ–‡ç« æ£€ç´¢ï¼šæä¾›æ­£ç¡®ä¿¡æ¯\n\nè®¸å¤šå¸¸è§çš„çˆ±å½¼è¿é—®é¢˜å¯ä»¥é€šè¿‡æä¾›æ¸…æ™°ã€ç›¸å…³çš„æ•™è‚²ä¿¡æ¯å¿«é€Ÿè§£å†³ã€‚çˆ±å½¼è¿ä½¿ç”¨â€œå¸®åŠ©æ–‡ç« æ£€ç´¢å’Œæ’åç³»ç»Ÿâ€æ¥è‡ªåŠ¨è¯†åˆ«ç”¨æˆ·æŸ¥è¯¢ä¸­çš„é—®é¢˜ï¼Œå¹¶é€šè¿‡çŸ­ä¿¡å’Œçˆ±å½¼è¿åº”ç”¨é€šçŸ¥å‘é€æœ€ç›¸å…³çš„å¸®åŠ©æ–‡ç« é“¾æ¥ã€‚è¯¥è¿‡ç¨‹åŒ…å«ä¸¤ä¸ªæœºå™¨å­¦ä¹ é˜¶æ®µï¼š\n\n*   **è¯­ä¹‰æ£€ç´¢å’Œæ’å**ï¼šå°†çˆ±å½¼è¿å¸®åŠ©æ–‡ç« åµŒå…¥ç´¢å¼•åˆ°å‘é‡æ•°æ®åº“ä¸­ï¼Œä½¿ç”¨ä½™å¼¦ç›¸ä¼¼åº¦é«˜æ•ˆæ£€ç´¢å¤šè¾¾30ç¯‡ç›¸å…³æ–‡ç« ï¼ˆé€šå¸¸åœ¨60æ¯«ç§’å†…ï¼‰ã€‚ä¸€ä¸ªåŸºäºLLMçš„æ’åæ¨¡å‹éšåå¯¹è¿™äº›æ£€ç´¢åˆ°çš„æ–‡ç« è¿›è¡Œé‡æ–°æ’åï¼Œå°†æ’åæœ€é«˜çš„æ–‡ç« ç›´æ¥å‘ˆç°ç»™ç”¨æˆ·ã€‚\n*   **æ•ˆæœ**ï¼šè¯¥åŒé˜¶æ®µç³»ç»Ÿä¸ä»…æ”¯æŒIVRäº’åŠ¨ï¼Œè¿˜æ”¯æŒå®¢æˆ·æ”¯æŒèŠå¤©æœºå™¨äººå’Œå¸®åŠ©ä¸­å¿ƒæœç´¢ã€‚å…¶æœ‰æ•ˆæ€§é€šè¿‡Precision@Nç­‰æŒ‡æ ‡æŒç»­è¯„ä¼°ã€‚\n\n![å¸®åŠ©æ–‡ç« æ£€ç´¢å’Œæ’åç³»ç»Ÿæ¶æ„å›¾](https://cdn-images-1.medium.com/max/1024/1*wlkl-CT0czyGqNdKx-ffIw.png)\n*å›¾3ï¼šå¸®åŠ©æ–‡ç« æ£€ç´¢å’Œæ’åç³»ç»Ÿæ¶æ„å›¾ã€‚*\n\n### 4. é‡Šä¹‰æ¨¡å‹ï¼šå¢å¼ºç”¨æˆ·ç†è§£\n\nIVRå®¢æˆ·æ”¯æŒçš„ä¸€ä¸ªå…³é”®æŒ‘æˆ˜æ˜¯ç¡®ä¿ç”¨æˆ·åœ¨æ¥æ”¶å¸®åŠ©æ–‡ç« é“¾æ¥ä¹‹å‰æ¸…æ¥šç†è§£è§£å†³æ–¹æ¡ˆã€‚ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œçˆ±å½¼è¿å®æ–½äº†ä¸€ç§è½»é‡çº§çš„é‡Šä¹‰æ–¹æ³•ï¼Œåˆ©ç”¨ä¸€ç»„ç²¾é€‰çš„æ ‡å‡†åŒ–æ‘˜è¦ã€‚\n\n*   **å®ç°**ï¼šUXæ’°ç¨¿äººåˆ›å»ºäº†å¸¸è§çˆ±å½¼è¿åœºæ™¯çš„ç®€æ´æ˜äº†çš„é‡Šä¹‰ã€‚åœ¨çº¿æœåŠ¡æ—¶ï¼Œç”¨æˆ·æŸ¥è¯¢é€šè¿‡åŸºäºæ–‡æœ¬åµŒå…¥ç›¸ä¼¼åº¦çš„æœ€è¿‘é‚»åŒ¹é…æ˜ å°„åˆ°è¿™äº›ç²¾é€‰æ‘˜è¦ã€‚\n*   **æ•ˆæœ**ï¼šæ‰‹åŠ¨è¯„ä¼°ç«¯åˆ°ç«¯æ¨¡å‹è¾“å‡ºè¯å®ç²¾åº¦è¶…è¿‡90%ã€‚åœ¨é’ˆå¯¹è”ç³»å®¢æˆ·æ”¯æŒçš„è‹±è¯­æˆ¿ä¸œè¿›è¡Œçš„å®éªŒä¸­ï¼Œåœ¨å‘é€æ–‡ç« é“¾æ¥å‰å‘ˆç°é‡Šä¹‰æ‘˜è¦å¢åŠ äº†ç”¨æˆ·å¯¹æ–‡ç« å†…å®¹çš„å‚ä¸åº¦ï¼Œä»è€Œæé«˜äº†è‡ªåŠ©è§£å†³ç‡ï¼Œå‡å°‘äº†å¯¹ç›´æ¥å®¢æˆ·æ”¯æŒååŠ©çš„éœ€æ±‚ã€‚\n\n## ç»“è®º\n\né€šè¿‡ç»“åˆè‡ªåŠ¨è¯­éŸ³è¯†åˆ«ã€è”ç³»åŸå› æ£€æµ‹ç³»ç»Ÿã€å¸®åŠ©æ–‡ç« æ£€ç´¢ç³»ç»Ÿå’Œé‡Šä¹‰æ¨¡å‹ï¼Œçˆ±å½¼è¿åˆ›å»ºäº†ä¸€ä¸ªIVRç³»ç»Ÿï¼Œè¯¥ç³»ç»Ÿç®€åŒ–äº†æ”¯æŒäº’åŠ¨å¹¶æé«˜äº†ç”¨æˆ·æ»¡æ„åº¦ã€‚è¯¥è§£å†³æ–¹æ¡ˆä½¿å‘¼å«è€…èƒ½å¤Ÿè‡ªç„¶åœ°æè¿°é—®é¢˜ï¼Œå‡å°‘äº†å¸¸è§æŸ¥è¯¢å¯¹äººå·¥ä»£ç†çš„ä¾èµ–ï¼Œå¹¶é€šè¿‡è‡ªåŠ©æœåŠ¡æä¾›å³æ—¶ã€ç›¸å…³çš„æ”¯æŒã€‚å½“éœ€è¦äººå·¥ååŠ©æ—¶ï¼Œç³»ç»Ÿé€šè¿‡å°†ç”¨æˆ·è·¯ç”±åˆ°åˆé€‚çš„ä»£ç†å¹¶æä¾›å¿…è¦çš„ä¸Šä¸‹æ–‡ï¼Œç¡®ä¿äº†å¹³ç¨³çš„è¿‡æ¸¡ã€‚\n\n![å›¾ç‰‡ 1](https://cdn-images-1.medium.com/max/1024/1*zyT9hDwGkSCvZ-wKEx669w.jpeg)",
      "shortSummary": "çˆ±å½¼è¿åˆ©ç”¨æœºå™¨å­¦ä¹ å½»åº•æ”¹é€ å…¶è¯­éŸ³æ”¯æŒï¼ˆIVRï¼‰ç³»ç»Ÿã€‚é€šè¿‡æ™ºèƒ½IVRï¼Œç”¨æˆ·å¯ä»¥è‡ªç„¶è¡¨è¾¾é—®é¢˜ï¼Œç³»ç»Ÿé€šè¿‡è‡ªåŠ¨è¯­éŸ³è¯†åˆ«ï¼ˆASRï¼‰ã€æ„å›¾æ£€æµ‹ã€å¸®åŠ©æ–‡ç« æ£€ç´¢å’Œé‡Šä¹‰æ¨¡å‹æä¾›è‡ªåŠ©æœåŠ¡æˆ–æ™ºèƒ½è·¯ç”±ã€‚è¿™æ˜¾è‘—æé«˜äº†æ”¯æŒæ•ˆç‡å’Œç”¨æˆ·æ»¡æ„åº¦ï¼Œå‡å°‘äº†å¯¹äººå·¥ä»£ç†çš„ä¾èµ–ï¼Œå¹¶ç¡®ä¿äº†éœ€è¦æ—¶ä¸åˆé€‚ä»£ç†çš„æ— ç¼è¿æ¥ã€‚",
      "translated_title": "å¤§è§„æ¨¡å€¾å¬ã€å­¦ä¹ ä¸å¸®åŠ©ï¼šæœºå™¨å­¦ä¹ å¦‚ä½•æ”¹å˜çˆ±å½¼è¿çš„è¯­éŸ³æ”¯æŒä½“éªŒ",
      "images": [
        {
          "url": "https://cdn-images-1.medium.com/max/1024/1*zyT9hDwGkSCvZ-wKEx669w.jpeg",
          "alt": "",
          "title": "",
          "position": 1
        },
        {
          "url": "https://cdn-images-1.medium.com/max/1024/1*4MMPeZJDlFDELNNSZ8dGPA.png",
          "alt": "",
          "title": "",
          "position": 2
        },
        {
          "url": "https://cdn-images-1.medium.com/max/1024/0*oj7NCOlBGYOnNBOx",
          "alt": "",
          "title": "",
          "position": 3
        },
        {
          "url": "https://cdn-images-1.medium.com/max/1024/1*wlkl-CT0czyGqNdKx-ffIw.png",
          "alt": "",
          "title": "",
          "position": 4
        },
        {
          "url": "https://medium.com/_/stat?event=post.clientViewed&referrerSource=full_rss&postId=b71f912d4760",
          "alt": "",
          "title": "",
          "position": 5
        }
      ],
      "contentSource": "RSS",
      "content": "<h3><strong>Listening, Learning, and Helping at Scale: How Machine Learning Transforms Airbnbâ€™s Voice Support Experience</strong></h3><p>A look into how Airbnb uses speech recognition, intent detection, and language models to understand users and assist agents more effectively.</p><p><em>By </em><a href=\"https://www.linkedin.com/in/yuanpei-cao-792b103b/\"><em>Yuanpei Cao</em></a><em>, </em><a href=\"https://www.linkedin.com/in/heng-j-1a44a711/\"><em>H</em>eng Ji</a><em>, </em><a href=\"https://www.linkedin.com/in/elaineliu5/\"><em>Elaine Liu</em></a><em>, </em><a href=\"https://www.linkedin.com/in/peng-wang-13117371/\"><em>Peng Wang</em></a><em>, and </em><a href=\"https://www.linkedin.com/in/tiantian-zhang-a4208726/\"><em>TiantianÂ Zhang</em></a></p><figure><img alt=\"\" src=\"https://cdn-images-1.medium.com/max/1024/1*zyT9hDwGkSCvZ-wKEx669w.jpeg\" /></figure><p>At Airbnb, we aim to provide a smooth, intuitive, and helpful community support experience, whether itâ€™s helping a guest navigate a booking change or helping a host with a listing issue. While our Help Center and customer support chatbot helps resolve many inquiries efficiently, some users prefer the immediacy of a voice conversation with a support representative. To make these interactions faster and more effective, weâ€™ve significantly improved our Interactive Voice Response (IVR) system via machine learning.</p><p>Over the years, Airbnb has invested in conversational AI to enhance customer support. In our previous blog posts <a href=\"https://medium.com/airbnb-engineering/task-oriented-conversational-ai-in-airbnb-customer-support-5ebf49169eaa\"><em>Task-Oriented Conversational AI in Airbnb Customer Support</em></a> and<a href=\"https://medium.com/airbnb-engineering/using-chatbots-to-provide-faster-covid-19-community-support-567c97c5c1c9\"> <em>Using Chatbots to Provide Faster COVID-19 Community Support</em></a>, we explored how AI-driven chatbots streamline guest and host interactions through automated messaging. This post explains how we extend that work to voice-based support, leveraging machine learning to improve real-time phone interactions with our intelligent IVRÂ system.</p><p>Weâ€™ll take you through the end-to-end IVR journey, the key machine learning components that power it, and how we designed a system that delivers faster, more human-like, and more intuitive voice support for our community.</p><h3>Reimagining the voice supportÂ journey</h3><p>Traditional IVR systems often rely on rigid menu trees, requiring callers to press buttons and navigate pre-set paths. Instead, we designed an adaptive, conversational IVR that listens, understands, and responds in real time. Hereâ€™s normally what happens when a caller reaches out to AirbnbÂ support:</p><ol><li><strong>Call and greeting: </strong>IVR picks up and prompts, <em>â€œIn a few sentences, please tell us why youâ€™re callingÂ today.â€</em></li><li><strong>Automated speech recognition (ASR):</strong> The callerâ€™s response is transcribed with Airbnb-specific ASR. For example, if a caller says, <em>â€œI need to request a refund for my reservation,â€</em> ASR accurately converts this speech into text, preserving key domain-specific terms.</li><li><strong>Understanding intent:</strong> A Contact Reason Detection model classifies the issue into a category like cancellations, refunds, account issues,Â etc.</li><li><strong>Decision-making:</strong> If self-service is possible, the system retrieves and sends a relevant help article or an intelligent workflow via SMS or app notification. If the caller explicitly requests agent support or the issue requires human intervention, the call is routed to a customer support agent with relevant details attached.</li><li><strong>Clarifying response:</strong> A Paraphrasing model generates a summary of the user intent, which IVR shares with the user before delivering the solution. This ensures that users understand the context of the resource they receive. Continuing our example, the system would respond, â€œ<em>I understand your issue is regarding a refund request.</em> <em>We have sent you a link to resources about this topic. Follow the instructions to find answers. If you need to speak with an agent, press 0 to be connected to our customer service representative.</em>â€ The underscored Paraphrasing component enhances engagement by bridging the gap between system-generated responses and user comprehension, making the self-service experience more intuitive.</li><li><strong>Resolution or escalation:</strong> The caller receives an SMS or app notification with a direct link to a relevant <a href=\"https://www.airbnb.com/help\">Airbnb Help Center</a> article. If further assistance is needed, they can press 0 to connect with a customer service representative.</li></ol><p>By moving away from rigid menus to natural language understanding, we allow guests and hosts to express their issues in their own words, helping to increase satisfaction and resolution efficiency.</p><figure><img alt=\"\" src=\"https://cdn-images-1.medium.com/max/1024/1*BNyYIWtMRorDGJ935DcQJw.png\" /><figcaption>Figure 1: High-level architecture of how Airbnb IVR Core Service interacts with core machine learning components to resolve user issues over theÂ phone.</figcaption></figure><h3>Breaking down our ML-powered IVRÂ system</h3><h4>1. Automated speech recognition (ASR): transcribing with precision</h4><p>In a voice-driven support system, achieving high transcription accuracy is essential, particularly in noisy phone environments where speech can be unclear. General speech recognition models often struggle with Airbnb-specific terminology, leading to errors like misinterpreting â€œlistingâ€ as â€œliftingâ€ or â€œhelp with my stayâ€ as â€œhappy Christmas Day.â€ These inaccuracies create challenges in understanding user intent and impact downstream processes.</p><p>To enhance ASR accuracy, we transitioned from a generic high-quality pretrained model to one specifically adapted for noisy phone audio. Additionally, we introduced a domain-specific phrase list optimization that ensures Airbnb terms are properly recognized. Based on a sample of hundreds of clips, this significantly <strong>reduced the word error rate (WER) from 33% to approximately 10%</strong>. The reduced WER significantly enhanced the accuracy of downstream help article recommendations, increasing user engagement, improving customer NPS among users who interacted with the ASR menu, while reducing reliance on human agents and lowering customer service handlingÂ time.</p><h4>2. Contact Reason prediction: understanding theÂ why</h4><p>After transcribing the callerâ€™s statements, the next step involves identifying their intent. We accomplished this by creating a detailed Contact Reason taxonomy that categorizes all potential Airbnb inquiries, as elaborated in â€œ<a href=\"https://medium.com/airbnb-engineering/t-leaf-taxonomy-learning-and-evaluation-framework-30ae19ce8c52\">T-LEAF: Taxonomy Learning and EvaluAtion Framework</a>.â€ We then use an intent detection model to classify calls into a Contact Reason category, ensuring each inquiry is handled appropriately. For example, if a caller mentions â€œI havenâ€™t received my refund yet,â€ the model predicts the Contact Reason as Missing Refund and forwards it to the relevant downstream components.</p><p>In production, we deploy the Issue Detection Service to host the intent detection models, running them in parallel to achieve optimal scalability, flexibility, and efficiency. Parallel computing ensures that intent detection <strong>latency remains under 50ms on average</strong>, making the process imperceptible to IVR users and ensuring a seamless real-time experience. The detected intent is then analyzed within the IVR workflow to determine the next action, whether itâ€™s guiding the user through a self-service resolution or escalating directly to a humanÂ agent.</p><p>Occasionally, callers prefer to speak directly with a human agent instead of describing their issues, using terms like â€œagentâ€ or â€œescalation.â€ For such scenarios, we use a different intent detection model to recognize when a caller wants to escalate to a human agent. If this intent is detected, the IVR system honors the callerâ€™s request and routes the call to the suitable supportÂ team.</p><figure><img alt=\"\" src=\"https://cdn-images-1.medium.com/max/1024/1*Q7LxFhZitCrNdqKAy_ffOw.png\" /><figcaption>Figure 2. Intent detection architecture and Issue Detection Service.</figcaption></figure><h4>3. Help article retrieval: delivering the right information</h4><p>Many common Airbnb issues can be quickly resolved by providing clear and relevant educational information. To help provide useful information to users and minimize the need for human customer support, we use the Help Article Retrieval and Ranking system. This advanced system automatically identifies the issue in a userâ€™s inquiry and delivers the most relevant help article link via SMS text message and Airbnb app notification. Our process incorporates two machine learningÂ stages.</p><p><strong>Semantic retrieval and ranking:</strong> We index Airbnb Help Article embeddings into a vector database, enabling efficient retrieval of up to 30 relevant articles per user query using cosine similarity, typically within 60ms. An LLM-based ranking model then re-ranks these retrieved articles, with the top-ranked article directly presented to users via IVR channels. This dual-stage system not only powers IVR interactions but also supports our customer support chatbot and Help Center search. Across these platforms, its effectiveness is continuously evaluated using metrics like Precision@N, facilitating ongoing improvements and refinements.</p><figure><img alt=\"\" src=\"https://cdn-images-1.medium.com/max/1024/1*wlkl-CT0czyGqNdKx-ffIw.png\" /><figcaption>Figure 3. Architecture diagram for the Help Article Retrieval and RankingÂ system.</figcaption></figure><h4>4. Paraphrasing model: enhancing user understanding</h4><p>A key challenge in IVR-based customer support is ensuring users clearly understand the resolution before receiving help article links, as they typically lack visibility into the articleâ€™s contents or title. To address this, we implemented a lightweight paraphrasing approach leveraging a curated set of standardized summaries.</p><p>UX writers created concise and clear paraphrases for common Airbnb scenarios. During online serving, user inquiries are mapped to these curated summaries via nearest-neighbor matching based on text embedding similarity. We calibrated a similarity threshold to ensure high-quality matches. Manual evaluation of end-to-end model outputs confirmed precision exceeding 90%.</p><p>The outcome was a finite-state solution delivering the most appropriate paraphrased IVR prompt before presenting a help article link. For example, if a caller states, â€œI need to cancel my reservation and request a refund,â€ the model generates a response like â€œI understand your issue is about a refund requestâ€ before sending the retrieved help articleÂ link.</p><p>Integrating this model ensures users receive clear, contextually relevant summaries prior to accessing help articles. In an experiment targeting English hosts who contacted customer support, we found that presenting a paraphrased summary before sending the article link increases user engagement with article content, resulting in improvement in self-resolution rates, helping to reduce the need for direct customer support assistance.</p><h3>Conclusion</h3><p>By combining Automated Speech Recognition and Contact Reason Detection systems with a help article retrieval system, and a paraphrasing model, we have created an IVR system that streamlines support interactions and improves user satisfaction. Our solution enables callers to describe issues naturally, reduces dependency on human agents for common inquiries, and provides instant, relevant support through self-service. When human assistance is necessary, the system ensures a smooth transition by routing users to the right agent with essential context.</p><p>Interested in working at Airbnb? Check out our <a href=\"https://careers.airbnb.com/\">openÂ roles</a>.</p><h3><strong>Acknowledgements</strong></h3><p>Thanks to Zhenyu Zhao, Mia Zhao, Wayne Zhang, Lucca Siaudzionis, Lulu Chen, Sukey Xu, Floria Wan, Michael Zhou, Can Yang, Yaolin Chen, Shuaihu Wang, Huifan Qu, Ming Shang,Yu Jiang, Wanting Chen, Elena Zhao, Shanna Su, Cassie Cao, Hao Wang, Haoran Zhu, Xirui Liu, Ying Tan, Xiaohan Zeng, Xiaoyu Meng, Gavin Li, Gaurav Rai, Hemanth Kolla, Ihor Hordiienko, Matheus Scharf, and Stepan Sydoruk who helped bring this vision to life. Also thanks to Paige Schwartz, Stephanie Chu, Neal Cohen, Becky Ajuonuma, Iman Saleh, Dani Normanm, Javier Salido, and Lauren Mackevich for the review andÂ editing.</p><p>Thanks to Jeremy Werner, Joy Zhang, Claire Cheng, Yashar Mehdad, Shuohao Zhang, Shawn Yan, Kelvin Xiong, Michael Lubavin, Teng Wang, Wei Ji, and Chenhao Yangâ€™s leadership support on building conversational AI products atÂ Airbnb.</p><img src=\"https://medium.com/_/stat?event=post.clientViewed&referrerSource=full_rss&postId=b71f912d4760\" width=\"1\" height=\"1\" alt=\"\"><hr><p><a href=\"https://medium.com/airbnb-engineering/listening-learning-and-helping-at-scale-how-machine-learning-transforms-airbnbs-voice-support-b71f912d4760\">Listening, Learning, and Helping at Scale: How Machine Learning Transforms Airbnbâ€™s Voice Supportâ€¦</a> was originally published in <a href=\"https://medium.com/airbnb-engineering\">The Airbnb Tech Blog</a> on Medium, where people are continuing the conversation by highlighting and responding to this story.</p>"
    },
    {
      "title": "Airbnb å¦‚ä½•è¡¡é‡æˆ¿æºç”Ÿå‘½å‘¨æœŸä»·å€¼ (åŸæ ‡é¢˜: How Airbnb Measures Listing Lifetime Value)",
      "link": "https://medium.com/airbnb-engineering/how-airbnb-measures-listing-lifetime-value-a603bf05142c?source=rss----53c7c27702d5---4",
      "pubDate": "Wed, 26 Mar 2025 15:46:46 GMT",
      "isoDate": "2025-03-26T15:46:46.000Z",
      "creator": "Carlos Sanchez Martinez",
      "summary": "## Airbnb å¦‚ä½•è¡¡é‡æˆ¿æºç”Ÿå‘½å‘¨æœŸä»·å€¼\n\n### å¼•è¨€\n\nAirbnb è‡´åŠ›äºä¸ºç”¨æˆ·æä¾›æœ€ä½³ä½“éªŒï¼Œè¿™éœ€è¦æ·±å…¥ç†è§£å“ªäº›æˆ¿æºå¯¹æˆ¿å®¢å…·æœ‰é«˜ä»·å€¼ã€‚ä¸ºæ­¤ï¼ŒAirbnb è®¡ç®—å¹¶ä½¿ç”¨æˆ¿æºç”Ÿå‘½å‘¨æœŸä»·å€¼ï¼ˆListing Lifetime Value, LTVï¼‰çš„ä¼°ç®—å€¼ã€‚è¿™äº›ä¼°ç®—ä¸ä»…æœ‰åŠ©äºè¯†åˆ«æœ€å—æˆ¿å®¢æ¬¢è¿çš„æˆ¿æºç±»å‹ï¼Œè¿˜èƒ½å¸®åŠ© Airbnb ä¸ºæˆ¿ä¸œæä¾›èµ„æºå’Œå»ºè®®ï¼Œä»¥æå‡å…¶æˆ¿æºæ‰€å¸¦æ¥çš„ä»·å€¼ã€‚ä¸ä¼ ç»Ÿå•è¾¹é”€å”®æ¨¡å¼ï¼ˆå¦‚é›¶å”®å•†å‘é¡¾å®¢é”€å”®å•†å“ï¼‰ä¸åŒï¼Œæœ¬æ–‡é‡ç‚¹é˜è¿°äº† Airbnb å¦‚ä½•åœ¨å¤šå–å®¶å’Œå¤šä¹°å®¶çš„å¹³å°ç¯å¢ƒä¸­å»ºæ¨¡ LTVã€‚\n\n### æˆ¿æºç”Ÿå‘½å‘¨æœŸä»·å€¼ï¼ˆLTVï¼‰æ¡†æ¶\n\nAirbnb çš„æˆ¿æº LTV æ¡†æ¶ä¼°ç®—ä¸‰ä¸ªå…³é”®é‡ï¼šåŸºçº¿ LTVã€å¢é‡ LTV å’Œè¥é”€è¯±å¯¼å¢é‡ LTVã€‚\n\n#### 1. åŸºçº¿ LTV (Baseline LTV)\n\nåŸºçº¿ LTV è¢«å®šä¹‰å¹¶ä¼°ç®—ä¸ºæˆ¿æºåœ¨æœªæ¥ 365 å¤©å†…å°†åœ¨ Airbnb ä¸Šè·å¾—çš„é¢„è®¢æ€»æ•°ã€‚Airbnb ä¾é æœºå™¨å­¦ä¹ å’Œä¸°å¯Œçš„æˆ¿æºä¿¡æ¯æ¥ä¼°ç®—æ¯ä¸ªç‹¬ç«‹æˆ¿æºçš„è¿™ä¸€æ•°å€¼ã€‚åœ¨å®è·µä¸­ï¼Œè¿˜ä¼šéµå¾ªè´¢åŠ¡æŒ‡å¯¼ï¼Œé€šè¿‡é¢„æµ‹æœªæ¥ç»“æœå¹¶åº”ç”¨ç›¸å…³æŠ˜ç°ç‡æ¥è®¡ç®—ç°å€¼ã€‚\n\n![å›¾ç‰‡ 2: æˆ¿æºLTVä¼°ç®—ç¤ºä¾‹](https://cdn-images-1.medium.com/max/874/1*PLgiegXaNpY8nthDFZpmpA.png)\n\n*   **ç”¨é€”ï¼š** åŸºçº¿ LTV ä¼°ç®—ç”¨äºå¯¹æˆ¿æºè¿›è¡Œç»†åˆ†ï¼Œè¯†åˆ«æœ€å—æˆ¿å®¢æ¬¢è¿çš„æˆ¿æºç±»å‹ï¼Œä»è€ŒæŒ‡å¯¼ä¾›åº”æ‹“å±•ç­–ç•¥ã€‚å®ƒè¿˜ç”¨äºè¯†åˆ«é‚£äº›é¢„è®¡æœªèƒ½å……åˆ†å‘æŒ¥å…¶é¢„è®¢æ½œåŠ›çš„æˆ¿æºï¼Œè¿™äº›æˆ¿æºå¯èƒ½å—ç›Šäºé¢å¤–çš„æŒ‡å¯¼ã€‚\n\n#### 2. å¢é‡ LTV (Incremental LTV)\n\nåœ¨ä¼°ç®—ç”Ÿå‘½å‘¨æœŸä»·å€¼æ—¶ï¼Œå¤šè¾¹å¸‚åœºé¢ä¸´ä¸€ä¸ªå…±åŒæŒ‘æˆ˜ï¼šä¸€ä¸ªæˆ¿æºçš„äº¤æ˜“å¯èƒ½ä»¥ç‰ºç‰²å¦ä¸€ä¸ªæˆ¿æºçš„äº¤æ˜“ä¸ºä»£ä»·ï¼Œå³â€œèš•é£Ÿæ•ˆåº”â€ã€‚ä¾‹å¦‚ï¼Œå½“ä¸€ä¸ªæ–°æˆ¿æºåŠ å…¥å¸‚åœºæ—¶ï¼Œå®ƒå¯èƒ½ä¼šä»åŸæœ¬é¢„è®¢å…¶ä»–æˆ¿æºçš„æˆ¿å®¢é‚£é‡Œè·å¾—ä¸€äº›é¢„è®¢ã€‚ä¸ºäº†å‡†ç¡®è¡¡é‡æ¯ä¸ªæˆ¿æºæ‰€å¢åŠ çš„ä»·å€¼ï¼Œéœ€è¦è€ƒè™‘è¿™ç§åŠ¨æ€ã€‚\n\nAirbnb é€šè¿‡åˆ›å»ºâ€œå¢é‡ LTVâ€ä¼°ç®—æ¥è§£å†³è¿™ä¸€æŒ‘æˆ˜ã€‚å¢é‡ä»·å€¼æ˜¯æŒ‡è‹¥æ— è¯¥æˆ¿æºå‚ä¸ï¼Œåˆ™ä¸ä¼šå‘ç”Ÿçš„é¢å¤–äº¤æ˜“ï¼›è€Œèš•é£Ÿä»·å€¼æ˜¯æŒ‡å³ä½¿æ²¡æœ‰è¯¥æˆ¿æºå‚ä¸ï¼Œä¹Ÿä¼šå‘ç”Ÿçš„äº¤æ˜“ã€‚å¢é‡ LTV æ˜¯é€šè¿‡ä»åŸºçº¿ LTV ä¸­å‡å»èš•é£Ÿä»·å€¼ä¼°ç®—å¾—å‡ºçš„ã€‚\n\n![å›¾ç‰‡ 3: èš•é£Ÿæ•ˆåº”ç¤ºæ„å›¾](https://cdn-images-1.medium.com/max/1024/1*UH0hKFiaFYB-l_LL-CkSRQ.png)\n\n#### 3. è¥é”€è¯±å¯¼å¢é‡ LTV (Marketing-induced incremental LTV)\n\nç”Ÿå‘½å‘¨æœŸä»·å€¼å¹¶éé™æ€ä¸å˜ï¼ŒLTV æ¨¡å‹éœ€è¦åæ˜ å†…éƒ¨ä¸¾æªå¦‚ä½•å¸¦æ¥é¢å¤–çš„æˆ¿æºä»·å€¼ã€‚ä¾‹å¦‚ï¼Œå¦‚æœ Airbnb å¼€å±•ä¸€é¡¹è¥é”€æ´»åŠ¨ï¼Œå‘æˆ¿ä¸œæä¾›æˆåŠŸæ”¹å–„æˆ¿æºçš„æŠ€å·§ï¼Œä¸ºäº†ç†è§£è¯¥æ´»åŠ¨çš„å›æŠ¥ï¼Œéœ€è¦è¡¡é‡å› æ´»åŠ¨è€Œäº§ç”Ÿçš„ä»·å€¼ï¼Œä»¥åŠå¦‚æœæ²¡æœ‰è¥é”€å¹²é¢„ï¼Œè‡ªç„¶ä¼šäº§ç”Ÿçš„ä»·å€¼ã€‚è¥é”€è¯±å¯¼å¢é‡ LTV ç”¨äºè¡¡é‡å†…éƒ¨ä¸¾æªåˆ›é€ äº†å¤šå°‘é¢å¤–çš„æˆ¿æº LTVã€‚\n\n![å›¾ç‰‡ 4: æˆ¿æºLTVæ¡†æ¶æ¦‚è§ˆ](https://cdn-images-1.medium.com/max/1024/1*RIUqYmgP_5JWfAohtdCdBQ.png)\n\n### è¡¡é‡æˆ¿æºç”Ÿå‘½å‘¨æœŸä»·å€¼çš„æŒ‘æˆ˜\n\n#### 1. å‡†ç¡®è¡¡é‡åŸºçº¿ LTV\n\næ¡†æ¶æœ€é‡è¦çš„è¦æ±‚æ˜¯å‡†ç¡®ä¼°ç®—åŸºçº¿ LTVã€‚ä¼°ç®—è®¾ç½®åˆ©ç”¨åœ¨ä¼°ç®—æ—¶ç‚¹ `t` æ•è·çš„æˆ¿æºç‰¹å¾ï¼ˆåŒ…æ‹¬æˆ¿æºå’Œæˆ¿ä¸œçš„ä¸°å¯Œä¿¡æ¯ï¼‰ï¼Œç„¶åä½¿ç”¨è¿™äº›ç‰¹å¾è®­ç»ƒæœºå™¨å­¦ä¹ æ¨¡å‹ã€‚ä»·å€¼æ ‡ç­¾æ˜¯æœªæ¥ 365 å¤©å†…å‘ç”Ÿçš„é¢„è®¢æ•°é‡ï¼Œåœ¨ `t + 365` æ—¥è§‚å¯Ÿåˆ°ã€‚\n\n![å›¾ç‰‡ 5: æ ‡ç­¾ä¸ç‰¹å¾æ”¶é›†ç¤ºæ„å›¾](https://cdn-images-1.medium.com/max/1024/1*6EanAK-Y42jbcWyATva8GA.png)\n\n*   **å½±å“ï¼š** è¿™ç§è®¾ç½®æ„å‘³ç€éœ€è¦ç­‰å¾… 365 å¤©æ‰èƒ½å®Œå…¨è¯„ä¼°é¢„æµ‹çš„å‡†ç¡®æ€§ã€‚æ­¤å¤–ï¼Œå¦‚æœè®­ç»ƒæ•°æ®æ•è·æ—¶é—´ä¸æ¨¡å‹è¯„åˆ†æ—¶é—´ä¹‹é—´å‘ç”Ÿå‰§çƒˆå†²å‡»ï¼ˆå¦‚ COVID-19 å¤§æµè¡ŒæœŸé—´æ—…è¡Œåœæ»ï¼‰ï¼Œåˆå§‹è®­ç»ƒæ•°æ®å¯èƒ½æ— æ³•è¿›è¡Œå‡†ç¡®é¢„æµ‹ã€‚\n*   **åº”å¯¹ç­–ç•¥ï¼š** ç¼©çŸ­è®­ç»ƒçª—å£ä»¥å‡å°‘æ¨¡å‹æ¼‚ç§»ï¼›å‘æ¨¡å‹è¾“å…¥ç²¾ç»†çš„åœ°ç†æ•°æ®å’Œå…³äºå¤–éƒ¨å› ç´ çš„äººå·¥ä¿¡æ¯ï¼›é‡‡ç”¨ LightGBM æ¨¡å‹å¤„ç†é«˜åŸºæ•°ç‰¹å¾ã€‚\n\n#### 2. è¡¡é‡å¢é‡æ€§\n\nè¡¡é‡å¢é‡æ€§å…·æœ‰æŒ‘æˆ˜æ€§ï¼Œå› ä¸ºæ— æ³•è§‚å¯Ÿåˆ°çœŸå®æƒ…å†µã€‚è™½ç„¶å¯ä»¥è§‚å¯Ÿåˆ°æ¯ä¸ªæˆ¿æºçš„é¢„è®¢æ•°é‡ï¼Œä½†æ— æ³•åŒºåˆ†å“ªäº›é¢„è®¢æ˜¯å¢é‡çš„ï¼Œå“ªäº›æ˜¯ä»å…¶ä»–æˆ¿æºä¸­â€œèš•é£Ÿâ€è€Œæ¥çš„ã€‚\n\nç”±äºæ²¡æœ‰å¢é‡æ€§æ ‡ç­¾æ¥ç›´æ¥ä¼°ç®—è¿™ä¸€ç»“æœï¼ŒAirbnb è½¬è€Œä¼°ç®—ä¸€ä¸ªâ€œç”Ÿäº§å‡½æ•°â€ã€‚ç›´è§‚åœ°è®²ï¼Œå¢é‡æ€§åœ¨å¾ˆå¤§ç¨‹åº¦ä¸Šå–å†³äºè¿æ¥å¸‚åœºä¸¤ç«¯çš„èƒ½åŠ›ã€‚ç”Ÿäº§å‡½æ•°æœ‰åŠ©äºè¯†åˆ«æˆ¿æºä¾›åº”å’Œæˆ¿å®¢éœ€æ±‚ä½•æ—¶è¿æ¥å¹¶æä¾›å¢é‡ä»·å€¼ã€‚å½“æŸä¸ªç»†åˆ†å¸‚åœºæˆ¿å®¢éœ€æ±‚é«˜è€Œæˆ¿æºä¾›åº”ç›¸å¯¹è¾ƒä½æ—¶ï¼Œå¢é‡æ€§ä¼°ç®—å€¼ä¼šå¾ˆé«˜ï¼›åä¹‹ï¼Œå½“æˆ¿æºä¾›åº”é‡å¤§è€Œéœ€æ±‚ç›¸å¯¹è¾ƒä½æ—¶ï¼Œå¢é‡æ€§ä¼šå¾ˆä½ã€‚\n\n![å›¾ç‰‡ 6: ç”Ÿäº§å‡½æ•°å…¬å¼](https://cdn-images-1.medium.com/max/1024/1*ccUD00N5xq2IfTiMkZHNGA.png)\n\n#### 3. å¤„ç†ä¸ç¡®å®šæ€§\n\nä¸ºäº†åº”å¯¹ç–«æƒ…æœŸé—´ç»å†çš„ä¸ç¡®å®šæ€§ï¼ŒAirbnb å¼€å§‹æ ¹æ®æˆ¿æºå®é™…è·å¾—çš„é¢„è®¢æ•°é‡ä¸æœ€åˆé¢„æœŸæ•°é‡çš„å·®å¼‚æ¥æ›´æ–° LTV ä¼°ç®—å€¼ã€‚è¿™ç§æ–¹æ³•æœ‰åŠ©äºæ•æ‰åˆå§‹é¢„æµ‹åå‘ç”Ÿçš„ä»»ä½•å†²å‡»ã€‚\n\nåœ¨å®è·µä¸­ï¼ŒAirbnb æ ¹æ®æˆ¿æºçš„å·²å‘ç”Ÿä»·å€¼ã€æ›´æ–°åçš„æˆ¿æºç‰¹å¾ä»¥åŠä½¿ç”¨å†å²æ•°æ®ä¼°ç®—çš„ç±»ä¼¼æˆ¿æºçš„ä»·å€¼åˆ°è¾¾æ¨¡å¼ï¼Œæ¯æ—¥è°ƒæ•´æˆ¿æºçš„é¢„æœŸä»·å€¼ã€‚é€šè¿‡è¿™ç§æ–¹å¼ï¼Œé¢„æœŸé¢„è®¢é‡å’Œå·²å‘ç”Ÿé¢„è®¢é‡ä¼šéšç€æ—¶é—´æ¨ç§»è¶‹è¿‘äºæœ€ç»ˆçš„é¢„è®¢é‡ã€‚\n\n![å›¾ç‰‡ 7: æˆ¿æºç”Ÿå‘½å‘¨æœŸä»·å€¼ä¼°ç®—æ›´æ–°ç¤ºä¾‹](https://cdn-images-1.medium.com/max/1024/1*vNQ0046lY7rfWrHIJK6Oww.png)\n\n### ç»“è®º\n\nä¼°ç®—æ¯ä¸ªæˆ¿æºçš„ç”Ÿå‘½å‘¨æœŸä»·å€¼è‡³å…³é‡è¦ï¼Œå› ä¸ºå®ƒæœ‰åŠ©äº Airbnb æ›´æœ‰æ•ˆåœ°æœåŠ¡ç¤¾åŒºã€‚å…¶ç”¨ä¾‹åŒ…æ‹¬ï¼š\n\n*   è¯†åˆ«ç‹¬ç‰¹çš„æˆ¿æºç»†åˆ†å¸‚åœºï¼Œè®©æ–°æˆ¿ä¸œèƒ½å‘å¤§é‡æˆ¿å®¢å±•ç¤ºå…¶å¾…å®¢ä¹‹é“ã€‚\n*   æ‰¾å‡ºæˆ¿æºæœ‰æ›´å¤šé¢„è®¢æœºä¼šå¹¶å¯èƒ½å—ç›Šäºé¢å¤–éœ€æ±‚çš„åœ°ç‚¹ã€‚\n*   è¯†åˆ«å“ªäº›å†…éƒ¨è¥é”€ä¸¾æªä¸ºç¤¾åŒºå¸¦æ¥äº†æœ€å¤§ä»·å€¼ã€‚\n\nè¯¥è¡¡é‡æ¡†æ¶è¿˜å¯èƒ½æ‰©å±•åˆ°å…¶ä»–åº”ç”¨ï¼Œä¾‹å¦‚ Airbnb ä½“éªŒï¼ˆExperiencesï¼‰çš„ç”Ÿå‘½å‘¨æœŸä»·å€¼ï¼Œå…¶ä¸­ä½“éªŒæˆ¿æºçš„ä»·å€¼å°†ä¸¥é‡ä¾èµ–äºæ—…è¡Œè¶‹åŠ¿å’Œæˆ¿å®¢å‘ç°è¿™äº›ä½“éªŒçš„èƒ½åŠ›ã€‚\n\nAirbnb å›¢é˜ŸæŒç»­è§£å†³ LTV ç›¸å…³çš„æœ‰è¶£é—®é¢˜ï¼Œå¹¶é¼“åŠ±æœ‰å¿—ä¹‹å£«æ¢ç´¢å…¶å›¢é˜Ÿçš„å¼€æ”¾èŒä½ã€‚",
      "shortSummary": "Airbnbé€šè¿‡å…¶æˆ¿æºç”Ÿå‘½å‘¨æœŸä»·å€¼ï¼ˆLTVï¼‰æ¡†æ¶ï¼Œè¯†åˆ«å¹¶ä¼˜åŒ–å¯¹æˆ¿å®¢æœ‰ä»·å€¼çš„æˆ¿æºã€‚è¯¥æ¡†æ¶åŒ…å«åŸºçº¿LTVï¼ˆé¢„æµ‹æœªæ¥365å¤©é¢„è®¢é‡ï¼‰ã€å¢é‡LTVï¼ˆè€ƒè™‘æ–°æˆ¿æºå¯¹ç°æœ‰æˆ¿æºçš„â€œèš•é£Ÿæ•ˆåº”â€ï¼‰å’Œè¥é”€è¯±å¯¼å¢é‡LTVï¼ˆè¡¡é‡å†…éƒ¨æ´»åŠ¨å¸¦æ¥çš„ä»·å€¼ï¼‰ã€‚æ–‡ç« è¯¦ç»†é˜è¿°äº†LTVçš„è¡¡é‡æ–¹æ³•ï¼Œå¹¶æ¢è®¨äº†å‡†ç¡®æ€§ã€å¢é‡æ€§è¯„ä¼°å’Œä¸ç¡®å®šæ€§å¤„ç†ç­‰æŒ‘æˆ˜ï¼Œä¾‹å¦‚ç–«æƒ…æœŸé—´çš„å¸‚åœºå˜åŒ–ã€‚é€šè¿‡æœºå™¨å­¦ä¹ å’ŒåŠ¨æ€æ›´æ–°ï¼ŒLTVä¼°ç®—å¸®åŠ©Airbnbä¼˜åŒ–ä¾›åº”ç­–ç•¥ã€æŒ‡å¯¼æˆ¿ä¸œå¹¶è¯„ä¼°è¥é”€æ•ˆæœï¼Œä»è€Œæå‡ç¤¾åŒºä½“éªŒã€‚",
      "translated_title": "Airbnb å¦‚ä½•è¡¡é‡æˆ¿æºç”Ÿå‘½å‘¨æœŸä»·å€¼",
      "images": [
        {
          "url": "https://cdn-images-1.medium.com/max/1024/0*JSoY6CDkTMQEFXgP",
          "alt": "",
          "title": "",
          "position": 1
        },
        {
          "url": "https://cdn-images-1.medium.com/max/874/1*PLgiegXaNpY8nthDFZpmpA.png",
          "alt": "",
          "title": "",
          "position": 2
        },
        {
          "url": "https://cdn-images-1.medium.com/max/1024/1*UH0hKFiaFYB-l_LL-CkSRQ.png",
          "alt": "",
          "title": "",
          "position": 3
        },
        {
          "url": "https://cdn-images-1.medium.com/max/1024/1*RIUqYmgP_5JWfAohtdCdBQ.png",
          "alt": "",
          "title": "",
          "position": 4
        },
        {
          "url": "https://cdn-images-1.medium.com/max/1024/1*6EanAK-Y42jbcWyATva8GA.png",
          "alt": "",
          "title": "",
          "position": 5
        }
      ],
      "contentSource": "RSS",
      "content": "<p>A deep dive on the framework that lets us identify the most valuable listings for ourÂ guests.</p><p><strong>By:</strong> <a href=\"https://www.linkedin.com/in/carlossanchezmartinez/\">Carlos Sanchez-Martinez</a>, <a href=\"https://www.linkedin.com/in/seanmk2/\">Sean Oâ€™Donnell</a>, <a href=\"https://www.linkedin.com/in/lohua-yuan/\">Lo-Hua Yuan</a>, <a href=\"https://www.linkedin.com/in/yunshanz/\">YunshanÂ Zhu</a></p><figure><img alt=\"\" src=\"https://cdn-images-1.medium.com/max/1024/0*JSoY6CDkTMQEFXgP\" /></figure><p>At Airbnb, we always strive to provide our community with the best experience. To do so, itâ€™s important to understand what kinds of accommodation listings are valuable to our guests. We achieve this by calculating and using estimates of <strong>listing lifetime value</strong>. These estimates not only allow us to identify which types of listings resonate best with guests, but also help us develop resources and recommendations for hosts to increase the value driven by their listings.</p><p>Most of the existing literature on lifetime value focuses on traditional sales channels in which a single seller transacts with many buyers (e.g. a retailer selling clothing to a customer). In contrast, this blog post explains how we model lifetime value in a platform like Airbnb, with multiple sellers and buyers. In the first section, we describe our general listings lifetime value framework. In the second section, we discuss relevant challenges when putting this framework into practice.</p><h3>Our Listing Lifetime Value Framework</h3><p>Our listing lifetime value (LTV) framework estimates three different quantities of interest: baseline LTV, incremental LTV, and marketing-induced incremental LTV.</p><h4>(1) BaselineÂ LTV</h4><p>To measure LTV, we need to define what we mean by â€œvalueâ€ and what time horizon constitutes a â€œlifetime.â€ Simplifying slightly for the purposes of this blog post, we define and estimate our baseline listing LTV as the total number of bookings that a listing will make on Airbnb over the next 365Â days.</p><p>We rely on machine learning and the rich information we have about our listings to estimate this quantity for each individual listing. In practice, we also follow financial guidance to arrive at present value by projecting outcomes into the future and applying a relevant discount rate to futureÂ value.</p><p>Table 1 shows some hypothetical baseline LTV estimates. As you can see from the examples, LTV is not static, and can evolve as we improve the accuracy of our estimates, observe changes in our marketplace, or even develop a listing (e.g., by providing guidance that helps hosts improve the listing to get more bookings).</p><figure><img alt=\"\" src=\"https://cdn-images-1.medium.com/max/874/1*PLgiegXaNpY8nthDFZpmpA.png\" /><figcaption><strong>Table 1. Example Listing LTV Estimates</strong></figcaption></figure><p>We use baseline LTV estimates to segment our listings and identify which types of listings resonate best with our guests. This informs our supply expansion strategy. We also use baseline LTV to identify listings that are not expected to reach their full booking potential and may benefit from additional guidance.</p><h4>(2) Incremental LTV</h4><p>When estimating lifetime value, we face a challenge that is common across multi-sided marketplaces: the transactions made by one listing might come at the expense of another listingâ€™s transactions. For example, when a new listing joins our marketplace, this listing will get some bookings from guests who were previously booking other listings. We need to account for this dynamic if we want to accurately measure how much value is <em>added</em> by eachÂ listing.</p><p>We address this challenge by creating â€œincremental<em> </em>LTVâ€ estimates. We refer to the additional transactions that would not have occurred without the listingâ€™s participation as â€œincremental value,â€ and the transactions that would have occurred even without the listingâ€™s participation as â€œcannibalized value.â€ We estimate the incremental LTV for a listing by subtracting cannibalized value estimates from the baseline LTV. We explain this adjustment in more detail when discussing measurement challenges.</p><figure><img alt=\"\" src=\"https://cdn-images-1.medium.com/max/1024/1*UH0hKFiaFYB-l_LL-CkSRQ.png\" /><figcaption><strong>Figure 1. Cannibalization.</strong> In this context, cannibalization refers to the transactions that would have occurred even without a listingâ€™s participation in the marketplace. For example, when a new listing joins the platform, some bookings obtained by that listing would have been made at other listings on the platform had the new listing notÂ joined.</figcaption></figure><h4>(3) Marketing-induced incremental LTV</h4><p>Lifetime value is not static, and our LTV model needs to tell us how our internal initiatives bring additional listing value. For example, suppose we run a marketing campaign that provides hosts with tips on how to successfully improve their listings. To understand the return from the campaign, we need to measure how much value is accrued due to the campaign, and how much value would have been organically accrued without our marketing intervention. We calculate â€œmarketing-induced incremental LTVâ€ to measure how much additional listing LTV is created by our internal initiatives.</p><p>Having outlined our measurement framework (summarized in Figure 2), we now cover some of the technical challenges we faced when putting this framework into practice.</p><figure><img alt=\"\" src=\"https://cdn-images-1.medium.com/max/1024/1*RIUqYmgP_5JWfAohtdCdBQ.png\" /><figcaption><strong>Figure 2.</strong> <strong>Listing LTV Framework</strong></figcaption></figure><h3>Challenges when measuring Listing LifetimeÂ Value</h3><h4>Challenge (1): Accurately measuring baselineÂ LTV</h4><p>The most important requirement for our framework is accurate estimation of baseline LTV. Figure 3 illustrates our estimation setup. First, we leverage listing features snapshotted at estimation time t. This data includes rich knowledge we have about each listing and host (availability, price, location, host tenure, etc). We then use these features to train our machine learning model. As a value label, we use the number of bookings made within the next 365-day period, which is observed on date t +Â 365.</p><figure><img alt=\"\" src=\"https://cdn-images-1.medium.com/max/1024/1*6EanAK-Y42jbcWyATva8GA.png\" /><figcaption><strong>Figure 3. Label vs. Feature Collection. </strong>Our label lands 365 days after we collect the initial set of features for ourÂ model.</figcaption></figure><p>This setup has two important implications that impact accuracy and evaluation:</p><ul><li>We have to wait 365 days to fully evaluate the accuracy of a prediction.</li><li>Our initial training data might not allow us to make accurate predictions if we observe shocks between the time when the training data was captured, and the time when we score theÂ model.</li></ul><p>In practice, we felt the full consequences of these implications during the COVID-19 pandemic, when travel came to a halt and marketplace dynamics changed drastically. Our modelâ€™s training data from before the pandemic had dramatically different characteristics relative to the scoring data we collected after the pandemic. When dealing with this shock, we implemented various strategies that helped us improve model accuracy:</p><ul><li>Reducing training windows, allowing us to reduce modelÂ drift.</li><li>Feeding the model with granular geographic data and human-provided information about external factors as borders closed and reopened due to the pandemic.</li><li>Adopting <a href=\"http://lightgbm.readthedocs.io\">LightGBM</a>, which handles high cardinality features like the geographic variables mentioned previously.</li></ul><h4>Challenge (2): Measuring incrementality</h4><p>Accounting for incrementality is challenging because we never observe the ground truth. While we observe how many bookings are made per listing, we cannot tell which bookings are incremental and which bookings are cannibalized from other listings.</p><p>Since we donâ€™t have an incrementality label to estimate this outcome directly, we instead estimate a production function. Intuitively, incrementality is heavily dependent on our ability to connect both sides of our marketplace. Production functions allow us to identify when our supply of listings and demand from guests connect and provide incremental value. Incrementality estimates will be high when a segment has high guest demand and relatively low listing supply. In contrast, incrementality will be low when segments have a large volume of listing supply and relatively low demand, meaning guests have an easy time finding a place to stay and a new listing is more likely to cannibalize bookings from other listings.</p><p>Specifically, we model how our total supply of listings (S) and total demand from guests (D) impacts our target outcome bookings (O), as in equationÂ (1):</p><figure><img alt=\"\" src=\"https://cdn-images-1.medium.com/max/1024/1*ccUD00N5xq2IfTiMkZHNGA.png\" /></figure><p>We estimate this model with historical supply, demand, and outcome data aggregated across internally-defined segments that have little overlapping demand. Having estimated model (1), we calculate how extra supply of listings results in additional bookings in the given segment: this is our estimate of incrementality.</p><h4>Challenge (3): Handling uncertainty</h4><p>To handle the uncertainty we experienced during the pandemic, we began updating our LTV estimates as listings received greater or fewer numbers of bookings than initially expected. This approach has helped us capture any shocks that occur after making our initial predictions.</p><p>To show how this can be useful, letâ€™s go back to our marketing campaign example. Assume that we run this campaign for six months, and that we measure the success of this campaign by comparing marketing-induced incremental LTV against our total marketing investment in the campaign. As a first approach, we could use the initial baseline LTV figures (which feed into marketing-induced LTV) estimated at the time when the listing was first targeted by our initiative. However, listings targeted on day 1 of the marketing campaign will have six months of booking history by the time the campaign ends and we evaluate success. A more accurate approach uses realized bookings after the initial prediction to start correcting for modelÂ error.</p><p>Table 2 illustrates how this works. Suppose that on 2024â€“01â€“01, we expect that Listing A will get a total of 16 bookings by the end of the year. If six months into the 365 day period, Listing A has received 16 bookings, we should adjust its expected value upward to, say, 21 bookings. In fact, every day for 365 days after 2024â€“01â€“01, we can look at the bookings that Listing A has accrued and adjust the expected bookings accordingly. By construction, the expected and accrued bookings converge to the final bookings 365 days after the initial booking date. Going back to our marketing example, if Listing A ultimately receives 20 bookings, updating the initial estimate means we went from 20% underprediction on day 0 to a more reasonable 5% overprediction as of monthÂ 6.</p><figure><img alt=\"\" src=\"https://cdn-images-1.medium.com/max/1024/1*vNQ0046lY7rfWrHIJK6Oww.png\" /><figcaption><strong>Table 2.</strong> <strong>Example of how we update listing lifetime value estimates.</strong></figcaption></figure><p>In practice, we make daily adjustments to a listingâ€™s expected value based on the listingâ€™s accrued value, updated listing features, and value arrival patterns for similar listings estimated using historical data.</p><h3>Conclusion</h3><p>In this blog post, we explained how we approach listing lifetime value at Airbnb. We covered our measurement framework, including baseline LTV, incremental LTV, and marketing-induced incremental LTV. We also zoomed into measurement challenges, like when travel patterns changed drastically during the COVID pandemic and accurately estimating LTV became more difficult.</p><p>Estimating the lifetime value for each listing is important because it helps us serve our community more effectively. Use casesÂ include:</p><ul><li>Identifying unique listing segments through which new hosts can showcase their hospitality to a large guest audience.</li><li>Pinpointing locations where listings have an opportunity to get more bookings, and might benefit from additional demand.</li><li>Identifying which internal marketing initiatives bring the most value to our community.</li></ul><p>Itâ€™s also worth noting that our measurement framework may extend to other applications, such as the lifetime value for Airbnb Experiences listings, where the value of an experience listing will heavily depend on travel trends and on guestsâ€™ ability to discover these experiences.</p><p>We continue to solve interesting problems around LTV every day (and as more insights come up, weâ€™ll keep sharing them on our blog). Can you see yourself making an impact here? If so, we encourage you to explore the <a href=\"https://careers.airbnb.com/positions/?_departments=data-science\">open roles on ourÂ team</a>.</p><h3>Acknowledgments</h3><p>Finally, we need to give special thanks to Airfam and alumni Sam Barrows, Robert Chang, Linsha Chen, Richard Dear, Andrey Fradkin, Ruben Lobel, Brian De Luna, Dan T. Nguyen, Vaughn Quoss, Jason Ting, and Peng Ye. Without their foundational work, these LTV models would not have been possible.</p><p>Thanks as well to Rebecca Ajuonuma, Carolina Barcenas, Nathan Brixius, Jenny Chen, Peter Coles, Lauren Mackevich, Dan Schmierer, Yvonne Wang, Shanni Weilert, and Jane Zhang for their valuable feedback when writing this blogÂ post.</p><img src=\"https://medium.com/_/stat?event=post.clientViewed&referrerSource=full_rss&postId=a603bf05142c\" width=\"1\" height=\"1\" alt=\"\"><hr><p><a href=\"https://medium.com/airbnb-engineering/how-airbnb-measures-listing-lifetime-value-a603bf05142c\">How Airbnb Measures Listing Lifetime Value</a> was originally published in <a href=\"https://medium.com/airbnb-engineering\">The Airbnb Tech Blog</a> on Medium, where people are continuing the conversation by highlighting and responding to this story.</p>"
    },
    {
      "title": "åŸºäºåµŒå…¥çš„Airbnbæœç´¢å¬å›ç³»ç»Ÿ (åŸæ ‡é¢˜: Embedding-Based Retrieval for Airbnb Search)",
      "link": "https://medium.com/airbnb-engineering/embedding-based-retrieval-for-airbnb-search-aabebfc85839?source=rss----53c7c27702d5---4",
      "pubDate": "Wed, 19 Mar 2025 17:02:45 GMT",
      "isoDate": "2025-03-19T17:02:45.000Z",
      "creator": "Huiji Gao",
      "summary": "## åŸºäºåµŒå…¥çš„Airbnbæœç´¢å¬å›ç³»ç»Ÿ\n\n**å¼•è¨€**\n\nAirbnbæœç´¢æ—¨åœ¨ä¸ºç”¨æˆ·æä¾›æœ€ç›¸å…³çš„æˆ¿æºï¼Œä½†é¢å¯¹æ•°ç™¾ä¸‡æˆ¿æºã€å¤§åœ°ç†åŒºåŸŸæœç´¢ï¼ˆå¦‚åŠ åˆ©ç¦å°¼äºšã€æ³•å›½ï¼‰å’Œé«˜éœ€æ±‚ç›®çš„åœ°ï¼ˆå¦‚å·´é»ã€ä¼¦æ•¦ï¼‰çš„æŒ‘æˆ˜ï¼Œä»¥åŠçµæ´»æ—¥æœŸæœç´¢å¸¦æ¥çš„å¤æ‚æ€§ï¼Œå®ç°è¿™ä¸€ç›®æ ‡å¹¶éæ˜“äº‹ã€‚ä¸ºäº†è§£å†³è¿™äº›é—®é¢˜ï¼ŒAirbnbæ„å»ºäº†é¦–ä¸ªåŸºäºåµŒå…¥çš„å¬å›ï¼ˆEBRï¼‰æœç´¢ç³»ç»Ÿã€‚è¯¥ç³»ç»Ÿçš„ç›®æ ‡æ˜¯å°†åˆå§‹ç¬¦åˆæ¡ä»¶çš„æˆ¿æºé›†ç¼©å°åˆ°ä¸€ä¸ªæ›´å°çš„æ± å­ï¼Œä»¥ä¾¿åç»­æ›´è®¡ç®—å¯†é›†å‹çš„æœºå™¨å­¦ä¹ æ¨¡å‹è¿›è¡Œæ’åºã€‚\n\n![å›¾ç‰‡ 1](https://cdn-images-1.medium.com/max/1024/0*dhEL1kHnOpCWnqJa)\n\næœ¬æ–‡æ¢è®¨äº†æ„å»ºEBRç³»ç»Ÿçš„ä¸‰ä¸ªå…³é”®æŒ‘æˆ˜ï¼š\n1.  è®­ç»ƒæ•°æ®æ„å»º\n2.  æ¨¡å‹æ¶æ„è®¾è®¡\n3.  ä½¿ç”¨è¿‘ä¼¼æœ€è¿‘é‚»ï¼ˆANNï¼‰è§£å†³æ–¹æ¡ˆçš„åœ¨çº¿æœåŠ¡ç­–ç•¥\n\n![å›¾ç‰‡ 2](https://cdn-images-1.medium.com/max/924/0*TCeRWXyWhaTJeGfp)\n*å›¾1ï¼šAirbnbæœç´¢ä¸­å„ç±»æ’åºæ¨¡å‹çš„é€šç”¨é˜¶æ®µå’Œè§„æ¨¡ã€‚*\n\n**è®­ç»ƒæ•°æ®æ„å»º**\n\næ„å»ºEBRç³»ç»Ÿçš„ç¬¬ä¸€æ­¥æ˜¯è®­ç»ƒä¸€ä¸ªæœºå™¨å­¦ä¹ æ¨¡å‹ï¼Œå°†æˆ¿æºå’Œå»æ ‡è¯†åŒ–çš„æœç´¢æŸ¥è¯¢æ˜ å°„ä¸ºæ•°å€¼å‘é‡ï¼ˆåµŒå…¥ï¼‰ã€‚ä¸ºæ­¤ï¼Œå›¢é˜Ÿæ„å»ºäº†ä¸€ä¸ªåˆ©ç”¨å¯¹æ¯”å­¦ä¹ çš„è®­ç»ƒæ•°æ®ç®¡é“ï¼Œè¯¥ç­–ç•¥æ¶‰åŠä¸ºç»™å®šæŸ¥è¯¢è¯†åˆ«æ­£è´Ÿæ ·æœ¬å¯¹ã€‚æ¨¡å‹åœ¨è®­ç»ƒè¿‡ç¨‹ä¸­å­¦ä¹ å°†æŸ¥è¯¢ã€æ­£æ ·æœ¬æˆ¿æºå’Œè´Ÿæ ·æœ¬æˆ¿æºæ˜ å°„åˆ°æ•°å€¼å‘é‡ï¼Œä½¿å¾—æŸ¥è¯¢ä¸æ­£æ ·æœ¬æˆ¿æºçš„ç›¸ä¼¼åº¦è¿œé«˜äºä¸è´Ÿæ ·æœ¬æˆ¿æºçš„ç›¸ä¼¼åº¦ã€‚\n\nä¸ºäº†æ„å»ºè¿™äº›æ ·æœ¬å¯¹ï¼Œå›¢é˜Ÿè®¾è®¡äº†ä¸€ç§åŸºäºç”¨æˆ·è¡Œç¨‹çš„é‡‡æ ·æ–¹æ³•ï¼Œè¿™å¯¹äºæ•æ‰ç”¨æˆ·å¤šé˜¶æ®µæœç´¢æ—…ç¨‹è‡³å…³é‡è¦ã€‚æ•°æ®è¡¨æ˜ï¼Œç”¨æˆ·åœ¨æœ€ç»ˆé¢„è®¢å‰ä¼šè¿›è¡Œå¤šæ¬¡æœç´¢å¹¶é‡‡å–å„ç§æ“ä½œã€‚å› æ­¤ï¼Œè¯¥ç­–ç•¥èƒ½å¤Ÿæ•è·æ•´ä¸ªå¤šé˜¶æ®µæ—…ç¨‹å¹¶è€ƒè™‘ç”¨æˆ·å¯èƒ½æ¢ç´¢çš„å„ç§æˆ¿æºç±»å‹ã€‚\n\nå…·ä½“è€Œè¨€ï¼Œå›¢é˜Ÿé¦–å…ˆæ ¹æ®ä½ç½®ã€å®¢äººæ•°é‡å’Œå…¥ä½æ—¶é•¿ç­‰å…³é”®æŸ¥è¯¢å‚æ•°ï¼Œå¯¹æ‰€æœ‰å·²é¢„è®¢ç”¨æˆ·çš„å†å²æŸ¥è¯¢è¿›è¡Œåˆ†ç»„ï¼Œå®šä¹‰ä¸ºâ€œè¡Œç¨‹â€ã€‚å¯¹äºæ¯ä¸ªè¡Œç¨‹ï¼Œåˆ†æç”¨æˆ·æ‰§è¡Œçš„æ‰€æœ‰æœç´¢ï¼Œå¹¶å°†æœ€ç»ˆé¢„è®¢çš„æˆ¿æºä½œä¸ºæ­£æ ·æœ¬ã€‚è´Ÿæ ·æœ¬åˆ™ä»ç”¨æˆ·åœ¨æœç´¢ç»“æœä¸­çœ‹åˆ°ä½†æœªé¢„è®¢çš„æˆ¿æºä¸­é€‰æ‹©ï¼Œä»¥åŠé‚£äº›ç”¨æˆ·æ›¾æœ‰æ›´å¼ºäº¤äº’ï¼ˆå¦‚åŠ å…¥å¿ƒæ„¿å•ï¼‰ä½†æœ€ç»ˆæœªé¢„è®¢çš„æˆ¿æºã€‚è¿™ç§è´Ÿæ ·æœ¬çš„é€‰æ‹©è‡³å…³é‡è¦ï¼Œå› ä¸ºéšæœºé‡‡æ ·æˆ¿æºä¼šä½¿é—®é¢˜è¿‡äºç®€å•ï¼Œå¯¼è‡´æ¨¡å‹æ€§èƒ½ä¸ä½³ã€‚\n\n![å›¾ç‰‡ 3](https://cdn-images-1.medium.com/max/878/0*3rXf0K0bJoObo17-)\n*å›¾2ï¼šä¸ºç»™å®šç”¨æˆ·æ—…ç¨‹æ„å»ºï¼ˆæ­£ï¼Œè´Ÿï¼‰æ ·æœ¬å¯¹çš„ç¤ºä¾‹ã€‚é¢„è®¢çš„æˆ¿æºå§‹ç»ˆè¢«è§†ä¸ºæ­£æ ·æœ¬ã€‚è´Ÿæ ·æœ¬ä»å‡ºç°åœ¨æœç´¢ç»“æœä¸­ï¼ˆå¹¶å¯èƒ½è¢«äº¤äº’è¿‡ï¼‰ä½†ç”¨æˆ·æœ€ç»ˆæœªé¢„è®¢çš„æˆ¿æºä¸­é€‰æ‹©ã€‚*\n\n![å›¾ç‰‡ 4](https://cdn-images-1.medium.com/max/558/0*AUApsIPfEFdmx_S-)\n*å›¾3ï¼šç”¨äºæ„å»ºEBRæ¨¡å‹è®­ç»ƒæ•°æ®çš„æ•´ä½“æ•°æ®ç®¡é“ç¤ºä¾‹ã€‚*\n\n**æ¨¡å‹æ¶æ„**\n\næ¨¡å‹æ¶æ„éµå¾ªä¼ ç»Ÿçš„åŒå¡”ç½‘ç»œè®¾è®¡ï¼š\n*   **æˆ¿æºå¡”**ï¼šå¤„ç†æˆ¿æºæœ¬èº«çš„ç‰¹å¾ï¼Œå¦‚å†å²äº’åŠ¨ã€è®¾æ–½å’Œå®¢äººå®¹é‡ã€‚\n*   **æŸ¥è¯¢å¡”**ï¼šå¤„ç†ä¸æœç´¢æŸ¥è¯¢ç›¸å…³çš„ç‰¹å¾ï¼Œå¦‚åœ°ç†æœç´¢ä½ç½®ã€å®¢äººæ•°é‡å’Œå…¥ä½æ—¶é•¿ã€‚\n\nè¿™ä¸¤ä¸ªå¡”å…±åŒç”Ÿæˆæˆ¿æºå’Œæœç´¢æŸ¥è¯¢çš„åµŒå…¥ã€‚ä¸€ä¸ªå…³é”®çš„è®¾è®¡å†³ç­–æ˜¯é€‰æ‹©ç‰¹å¾ï¼Œä½¿å¾—æˆ¿æºå¡”å¯ä»¥æ¯å¤©ç¦»çº¿è®¡ç®—ã€‚è¿™ä½¿å¾—å›¢é˜Ÿèƒ½å¤Ÿé€šè¿‡æ¯æ—¥æ‰¹å¤„ç†ä½œä¸šé¢„è®¡ç®—æˆ¿æºåµŒå…¥ï¼Œæ˜¾è‘—é™ä½äº†åœ¨çº¿å»¶è¿Ÿï¼Œå› ä¸ºåªæœ‰æŸ¥è¯¢å¡”éœ€è¦åœ¨å®æ—¶å¤„ç†ä¼ å…¥çš„æœç´¢è¯·æ±‚æ—¶è¿›è¡Œè¯„ä¼°ã€‚\n\n![å›¾ç‰‡ 5](https://cdn-images-1.medium.com/max/827/0*rLXZmgqFE5BiSOGS)\n*å›¾4ï¼šEBRæ¨¡å‹ä¸­ä½¿ç”¨çš„åŒå¡”æ¶æ„ã€‚è¯·æ³¨æ„ï¼Œæˆ¿æºå¡”æ¯å¤©ç¦»çº¿è®¡ç®—æ‰€æœ‰æˆ¿æºçš„åµŒå…¥ã€‚*\n\n**åœ¨çº¿æœåŠ¡**\n\næ„å»ºEBRç³»ç»Ÿçš„æœ€åä¸€æ­¥æ˜¯é€‰æ‹©åœ¨çº¿æœåŠ¡çš„åŸºç¡€è®¾æ–½ã€‚å›¢é˜Ÿæ¢ç´¢äº†å¤šç§è¿‘ä¼¼æœ€è¿‘é‚»ï¼ˆANNï¼‰è§£å†³æ–¹æ¡ˆï¼Œå¹¶æœ€ç»ˆé€‰æ‹©äº†å€’æ’æ–‡ä»¶ç´¢å¼•ï¼ˆIVFï¼‰ä½œä¸ºæœ€ä½³æƒè¡¡æ–¹æ¡ˆï¼Œå°½ç®¡åˆ†å±‚å¯å¯¼èˆªå°ä¸–ç•Œï¼ˆHNSWï¼‰åœ¨å¬å›ç‡æ–¹é¢ç•¥èƒœä¸€ç­¹ã€‚\n\né€‰æ‹©IVFçš„ä¸»è¦åŸå› åŒ…æ‹¬ï¼š\n*   **å®æ—¶æ›´æ–°é‡å¤§**ï¼šAirbnbæˆ¿æºçš„å®šä»·å’Œå¯ç”¨æ€§æ•°æ®é¢‘ç¹æ›´æ–°ï¼Œå¯¼è‡´HNSWç´¢å¼•çš„å†…å­˜å ç”¨è¿‡å¤§ã€‚\n*   **è¿‡æ»¤å™¨å…¼å®¹æ€§**ï¼šå¤§å¤šæ•°Airbnbæœç´¢åŒ…å«è¿‡æ»¤å™¨ï¼ˆå°¤å…¶æ˜¯åœ°ç†è¿‡æ»¤å™¨ï¼‰ï¼ŒHNSWä¸è¿‡æ»¤å™¨çš„å¹¶è¡Œæ£€ç´¢å¯¼è‡´å»¶è¿Ÿæ€§èƒ½ä¸ä½³ã€‚\n\nç›¸æ¯”ä¹‹ä¸‹ï¼ŒIVFè§£å†³æ–¹æ¡ˆé¢„å…ˆå¯¹æˆ¿æºè¿›è¡Œèšç±»ï¼Œåªéœ€åœ¨æœç´¢ç´¢å¼•ä¸­å­˜å‚¨èšç±»ä¸­å¿ƒå’Œèšç±»åˆ†é…ã€‚åœ¨æœåŠ¡æ—¶ï¼Œé€šè¿‡å°†èšç±»åˆ†é…è§†ä¸ºæ ‡å‡†æœç´¢è¿‡æ»¤å™¨ï¼Œä»æœ€æ¥è¿‘æŸ¥è¯¢åµŒå…¥çš„èšç±»ä¸­æ£€ç´¢æˆ¿æºï¼Œè¿™ä½¿å¾—ä¸ç°æœ‰æœç´¢ç³»ç»Ÿçš„é›†æˆéå¸¸ç›´æ¥ã€‚\n\n![å›¾ç‰‡ 6](https://cdn-images-1.medium.com/max/603/0*WH3lbXvph3aBkPBY)\n*å›¾5ï¼šä½¿ç”¨IVFçš„æ•´ä½“æœåŠ¡æµç¨‹ã€‚æˆ¿æºé¢„å…ˆèšç±»ï¼Œåœ¨åœ¨çº¿æœåŠ¡æœŸé—´ï¼Œæˆ¿æºä»æœ€æ¥è¿‘æŸ¥è¯¢åµŒå…¥çš„èšç±»ä¸­æ£€ç´¢ã€‚*\n\nåœ¨EBRæ¨¡å‹ä¸­é€‰æ‹©ç›¸ä¼¼åº¦å‡½æ•°ä¹Ÿäº§ç”Ÿäº†æœ‰è¶£çš„å½±å“ã€‚å›¢é˜Ÿæ¢ç´¢äº†ç‚¹ç§¯å’Œæ¬§å‡ é‡Œå¾—è·ç¦»ï¼›è™½ç„¶ä¸¤è€…åœ¨æ¨¡å‹æ€§èƒ½ä¸Šç›¸ä¼¼ï¼Œä½†ä½¿ç”¨æ¬§å‡ é‡Œå¾—è·ç¦»å¹³å‡äº§ç”Ÿäº†æ›´å‡è¡¡çš„èšç±»ã€‚è¿™æ˜¯ä¸€ä¸ªå…³é”®çš„å‘ç°ï¼Œå› ä¸ºIVFæ£€ç´¢çš„è´¨é‡å¯¹èšç±»å¤§å°çš„å‡åŒ€æ€§é«˜åº¦æ•æ„Ÿï¼šå¦‚æœä¸€ä¸ªèšç±»åŒ…å«å¤ªå¤šæˆ¿æºï¼Œå°†å¤§å¤§é™ä½æ£€ç´¢ç³»ç»Ÿçš„åŒºåˆ†èƒ½åŠ›ã€‚å›¢é˜Ÿæ¨æµ‹ï¼Œç‚¹ç§¯ç›¸ä¼¼åº¦äº§ç”Ÿè¿™ç§ä¸å¹³è¡¡æ˜¯å› ä¸ºå®ƒæœ¬è´¨ä¸Šåªè€ƒè™‘ç‰¹å¾å‘é‡çš„æ–¹å‘è€Œå¿½ç•¥å…¶å¤§å°ï¼Œè€Œè®¸å¤šåº•å±‚ç‰¹å¾æ˜¯åŸºäºå†å²è®¡æ•°çš„ï¼Œä½¿å¾—å¤§å°æˆä¸ºä¸€ä¸ªé‡è¦å› ç´ ã€‚\n\n![å›¾ç‰‡ 7](https://cdn-images-1.medium.com/max/695/0*RlVEZwdCwA5j4cwo)\n*å›¾6ï¼šä½¿ç”¨ç‚¹ç§¯ä¸æ¬§å‡ é‡Œå¾—è·ç¦»ä½œä¸ºç›¸ä¼¼åº¦åº¦é‡æ—¶èšç±»å¤§å°åˆ†å¸ƒçš„ç¤ºä¾‹ã€‚æˆ‘ä»¬å‘ç°æ¬§å‡ é‡Œå¾—è·ç¦»äº§ç”Ÿäº†æ›´å‡è¡¡çš„èšç±»å¤§å°ã€‚*\n\n**æˆæœ**\n\næœ¬æ–‡æè¿°çš„EBRç³»ç»Ÿå·²åœ¨æœç´¢å’Œé‚®ä»¶è¥é”€ç”Ÿäº§ç¯å¢ƒä¸­å…¨é¢ä¸Šçº¿ï¼Œå¹¶é€šè¿‡A/Bæµ‹è¯•å¸¦æ¥äº†æ€»é¢„è®¢é‡çš„ç»Ÿè®¡æ˜¾è‘—å¢é•¿ã€‚å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œè¿™ä¸€æ–°å¬å›ç³»ç»Ÿå¸¦æ¥çš„é¢„è®¢é‡æå‡ä¸è¿‡å»ä¸¤å¹´æœç´¢æ’åä¸­ä¸€äº›æœ€å¤§çš„æœºå™¨å­¦ä¹ æ”¹è¿›ç›¸å½“ã€‚ä¸åŸºçº¿ç›¸æ¯”ï¼ŒEBRç³»ç»Ÿçš„ä¸»è¦æ”¹è¿›åœ¨äºå®ƒæœ‰æ•ˆåœ°èå…¥äº†æŸ¥è¯¢ä¸Šä¸‹æ–‡ï¼Œä»è€Œåœ¨å¬å›é˜¶æ®µæ›´å‡†ç¡®åœ°å¯¹æˆ¿æºè¿›è¡Œæ’åã€‚è¿™æœ€ç»ˆå¸®åŠ©Airbnbå‘ç”¨æˆ·å±•ç¤ºäº†æ›´ç›¸å…³çš„ç»“æœï¼Œç‰¹åˆ«æ˜¯å¯¹äºç¬¦åˆæ¡ä»¶ç»“æœæ•°é‡è¾ƒå¤šçš„æŸ¥è¯¢ã€‚",
      "shortSummary": "AirbnbæˆåŠŸæ„å»ºå¹¶éƒ¨ç½²äº†é¦–ä¸ªåŸºäºåµŒå…¥çš„å¬å›ï¼ˆEBRï¼‰ç³»ç»Ÿï¼Œä»¥ä¼˜åŒ–å…¶æœç´¢ä½“éªŒã€‚è¯¥ç³»ç»Ÿé€šè¿‡å°†æˆ¿æºå’ŒæŸ¥è¯¢æ˜ å°„ä¸ºæ•°å€¼å‘é‡ï¼Œæœ‰æ•ˆç¼©å°äº†åˆå§‹æˆ¿æºæ± ã€‚å…¶æ ¸å¿ƒåœ¨äºåŸºäºç”¨æˆ·è¡Œç¨‹æ„å»ºè®­ç»ƒæ•°æ®ã€é‡‡ç”¨åŒå¡”æ¨¡å‹æ¶æ„ï¼ˆæˆ¿æºåµŒå…¥ç¦»çº¿è®¡ç®—ï¼‰ï¼Œå¹¶é€‰æ‹©IVFä½œä¸ºåœ¨çº¿æœåŠ¡æ–¹æ¡ˆä»¥åº”å¯¹å®æ—¶æ›´æ–°å’Œè¿‡æ»¤å™¨æŒ‘æˆ˜ã€‚EBRç³»ç»Ÿå·²åœ¨æœç´¢å’Œé‚®ä»¶è¥é”€ä¸­å…¨é¢ä¸Šçº¿ï¼ŒA/Bæµ‹è¯•æ˜¾ç¤ºæ€»é¢„è®¢é‡æ˜¾è‘—å¢é•¿ï¼Œæ•ˆæœä¸é‡å¤§æœºå™¨å­¦ä¹ æ”¹è¿›ç›¸å½“ï¼Œæ˜¾è‘—æå‡äº†æœç´¢ç»“æœçš„ç›¸å…³æ€§ã€‚",
      "translated_title": "åŸºäºåµŒå…¥çš„Airbnbæœç´¢å¬å›ç³»ç»Ÿ",
      "images": [
        {
          "url": "https://cdn-images-1.medium.com/max/1024/0*dhEL1kHnOpCWnqJa",
          "alt": "",
          "title": "",
          "position": 1
        },
        {
          "url": "https://cdn-images-1.medium.com/max/924/0*TCeRWXyWhaTJeGfp",
          "alt": "",
          "title": "",
          "position": 2
        },
        {
          "url": "https://cdn-images-1.medium.com/max/878/0*3rXf0K0bJoObo17-",
          "alt": "",
          "title": "",
          "position": 3
        },
        {
          "url": "https://cdn-images-1.medium.com/max/558/0*AUApsIPfEFdmx_S-",
          "alt": "",
          "title": "",
          "position": 4
        },
        {
          "url": "https://cdn-images-1.medium.com/max/827/0*rLXZmgqFE5BiSOGS",
          "alt": "",
          "title": "",
          "position": 5
        }
      ],
      "contentSource": "RSS",
      "content": "<figure><img alt=\"\" src=\"https://cdn-images-1.medium.com/max/1024/0*dhEL1kHnOpCWnqJa\" /></figure><p>Our journey in applying embedding-based retrieval techniques to build an accurate and scalable candidate retrieval system for Airbnb HomesÂ search</p><p>Authors: <a href=\"https://www.linkedin.com/in/mustafa-moose-abdool-8aab037a/\">Mustafa (Moose) Abdool</a>, <a href=\"https://www.linkedin.com/in/soumyadip-banerjee-75991b42/\">Soumyadip Banerjee</a>, <a href=\"https://www.linkedin.com/in/kouyang1/\">Karen Ouyang</a>, <a href=\"https://www.linkedin.com/in/do-kyum-kim-9a810417/\">Do-Kyum Kim</a>, <a href=\"https://www.linkedin.com/in/moutupsi-paul/\">Moutupsi Paul</a>, <a href=\"https://www.linkedin.com/in/xiaowei-liu-60415841/\">Xiaowei Liu</a>, <a href=\"https://www.linkedin.com/in/bin-xu-96253aa5/\">Bin Xu</a>, <a href=\"https://www.linkedin.com/in/tracy-xiaoxi-yu/\">Tracy Yu</a>, <a href=\"https://www.linkedin.com/in/hui-gao-275a924/\">Hui Gao</a>, <a href=\"https://www.linkedin.com/in/yangbo-zhu/\">Yangbo Zhu</a>, <a href=\"https://www.linkedin.com/in/huiji-gao/\">Huiji Gao</a>, <a href=\"https://www.linkedin.com/in/liweihe/\">Liwei He</a>, <a href=\"https://www.linkedin.com/in/sanjeevkatariya/\">SanjeevÂ Katariya</a></p><h3>Introduction</h3><p>Search plays a crucial role in helping Airbnb guests find the perfect stay. The goal of Airbnb Search is to surface the most relevant listings for each userâ€™s queryâ€Šâ€”â€Šbut with millions of available homes, thatâ€™s no easy task. Itâ€™s especially difficult when searches include large geographic areas (like California or France) or high-demand destinations (like Paris or London). Recent innovationsâ€Šâ€”â€Šsuch as <em>flexible date search</em>, which allows guests to explore stays without fixed check-in and check-out datesâ€Šâ€”â€Šhave added yet another layer of complexity to ranking and finding the rightÂ results.</p><p>To tackle these challenges, we need a system that can retrieve relevant homes while also being scalable enough (in terms of latency and compute) to handle queries with a large candidate count. In this blog post, we share our journey in building Airbnbâ€™s first-ever Embedding-Based Retrieval (EBR) search system. The goal of this system is to narrow down the initial set of eligible homes into a smaller pool, which can then be scored by more compute-intensive machine learning models later in the search rankingÂ process.</p><figure><img alt=\"\" src=\"https://cdn-images-1.medium.com/max/924/0*TCeRWXyWhaTJeGfp\" /></figure><p><strong>Figure 1:</strong> The general stages and scale for the various types of ranking models used in AirbnbÂ Search</p><p>Weâ€™ll explore three key challenges in building this EBR system: (1) constructing training data, (2) designing the model architecture, and (3) developing an online serving strategy using Approximate Nearest Neighbor (ANN) solutions.</p><h3>Training Data Construction</h3><p>The first step in building our EBR system was training a machine learning model to map both homes and de-identified search queries into numerical vectors. To achieve this, we built a training data pipeline (Figure 3) that leveraged contrastive learningâ€Šâ€”â€Ša strategy that involves identifying pairs of positive- and negative-labeled homes for a given query. During training, the model learns to map a query, a positive home, and a negative home into a numerical vector, such that the similarity between the query and the positive home is much higher than the similarity between the query and the negativeÂ home.</p><p>To construct these pairs, we devised a sampling method based on user trips. This was an important design decision, since users on Airbnb generally undergo a multi-stage search journey. Data shows that before making a final booking, users tend to perform multiple searches and take various actionsâ€Šâ€”â€Šsuch as clicking into a homeâ€™s details, reading reviews, or adding a home to a wishlist. As such, it was crucial to develop a strategy that captures this entire multi-stage journey and accounts for the diverse types of listings a user mightÂ explore.</p><p>Diving deeper, we first grouped all historical queries of users who made bookings, using key query parameters such as location, number of guests, and length of stayâ€Šâ€”â€Šour definition of a â€œtrip.â€ For each trip, we analyzed all searches performed by the user, with the final booked listing as the positive label. To construct (positive, negative) pairs, we paired this booked listing with other homes the user had seen but not booked. Negative labels were selected from homes the user encountered in search results, along with those they had interacted with more intentfullyâ€Šâ€”â€Šsuch as by wishlistingâ€Šâ€”â€Šbut ultimately did not book. This choice of negative labels was key: Randomly sampling homes made the problem too easy and resulted in poor model performance.</p><figure><img alt=\"\" src=\"https://cdn-images-1.medium.com/max/878/0*3rXf0K0bJoObo17-\" /></figure><p><strong>Figure 2: </strong>Example of constructing (positive, negative) pairs for a given user journey. The booked home is always treated as a positive. Negatives are selected from homes that appeared in the search result (and were potentially interacted with) but that the user did not end upÂ booking.</p><figure><img alt=\"\" src=\"https://cdn-images-1.medium.com/max/558/0*AUApsIPfEFdmx_S-\" /></figure><p><strong>Figure 3: </strong>Example of overall data pipeline used to construct training data for the EBRÂ model.</p><h3>Model Architecture</h3><p>The model architecture followed a traditional two-tower network design. One tower (the <em>listing tower</em>) processes features about the home listing itselfâ€Šâ€”â€Šsuch as historical engagement, amenities, and guest capacity. The other tower (the <em>query tower</em>) processes features related to the search queryâ€Šâ€”â€Šsuch as the geographic search location, number of guests, and length of stay. Together, these towers generate the embeddings for home listings and search queries, respectively.</p><p>A key design decision here was choosing features such that the listing tower could be computed offline on a daily basis. This enabled us to pre-compute the home embeddings in a daily batch job, significantly reducing online latency, since only the query tower had to be evaluated in real-time for incoming search requests.</p><figure><img alt=\"\" src=\"https://cdn-images-1.medium.com/max/827/0*rLXZmgqFE5BiSOGS\" /></figure><p><strong>Figure 4: </strong>Two-tower architecture as used in the EBR model. Note that the listing tower is computed offline daily for allÂ homes.</p><h3>Online Serving</h3><p>The final step in building our EBR system was choosing the infrastructure for online serving. We explored a number of approximate nearest neighbor (ANN) solutions and narrowed them down to two main candidates: inverted file index (IVF) and hierarchical navigable small worlds (HNSW). While HNSW performed slightly better in terms of evaluation metricsâ€Šâ€”â€Šusing recall as our main evaluation metricâ€Šâ€”â€Šwe ultimately found that IVF offered the best trade-off between speed and performance.</p><p>The core reason for this is the high volume of real-time updates per second for Airbnb home listings, as pricing and availability data is frequently updated. This caused the memory footprint of the HNSW index to grow too large. In addition, most Airbnb searches include filters, especially geographic filters. We found that parallel retrieval with HNSW alongside filters resulted in poor latency performance.</p><p>In contrast, the IVF solution, where listings are clustered beforehand, only required storing cluster centroids and cluster assignments within our search index. At serving time, we simply retrieve listings from the top clusters by treating the cluster assignments as a standard search filter, making integration with our existing search system quite straightforward.</p><figure><img alt=\"\" src=\"https://cdn-images-1.medium.com/max/603/0*WH3lbXvph3aBkPBY\" /></figure><p><strong>Figure 5: </strong>Overall serving flow using IVF. Homes are clustered beforehand and, during online serving, homes are retrieved from the closest clusters to the query embedding.</p><p>In this approach, our choice of similarity function in the EBR model itself ended up having interesting implications. We explored both dot product and Euclidean distance; while both performed similarly from a model perspective, using Euclidean distance produced much more balanced clusters on average. This was a key insight, as the quality of IVF retrieval is highly sensitive to cluster size uniformity: If one cluster had too many homes, it would greatly reduce the discriminative power of our retrieval system.</p><p>We hypothesize that this imbalance arises with dot product similarity because it inherently only considers the direction of feature vectors while ignoring their magnitudesâ€Šâ€”â€Šwhereas many of our underlying features are based on historical counts, making magnitude an important factor.</p><figure><img alt=\"\" src=\"https://cdn-images-1.medium.com/max/695/0*RlVEZwdCwA5j4cwo\" /></figure><p><strong>Figure 6: </strong>Example of the distribution of cluster sizes when using dot product vs. Euclidean distance as a similarity measure. We found that Euclidean distance produced much more balanced clusterÂ sizes.</p><h3>Results</h3><p>The EBR system described in this post was fully launched in both Search and Email Marketing production and led to a statistically-significant gain in overall bookings when A/B tested. Notably, the bookings lift from this new retrieval system was on par with some of the largest machine learning improvements to our search ranking in the past twoÂ years.</p><p>The key improvement over the baseline was that our EBR system effectively incorporated query context, allowing homes to be ranked more accurately during retrieval. This ultimately helped us display more relevant results to users, especially for queries with a high number of eligibleÂ results.</p><h3>Acknowledgments</h3><p>We would like to especially thank the entire Search and Knowledge Infrastructure &amp; ML Infrastructure org (led by <a href=\"https://www.linkedin.com/in/yi-li-755a6b24/\">Yi Li</a>) and Marketing Technology org (led by <a href=\"https://www.linkedin.com/in/michael-kinoti-7a309215/\">Michael Kinoti</a>) for their great collaborations throughout thisÂ project!</p><img src=\"https://medium.com/_/stat?event=post.clientViewed&referrerSource=full_rss&postId=aabebfc85839\" width=\"1\" height=\"1\" alt=\"\"><hr><p><a href=\"https://medium.com/airbnb-engineering/embedding-based-retrieval-for-airbnb-search-aabebfc85839\">Embedding-Based Retrieval for Airbnb Search</a> was originally published in <a href=\"https://medium.com/airbnb-engineering\">The Airbnb Tech Blog</a> on Medium, where people are continuing the conversation by highlighting and responding to this story.</p>"
    },
    {
      "title": "ä½¿ç”¨å¤§å‹è¯­è¨€æ¨¡å‹åŠ é€Ÿå¤§è§„æ¨¡æµ‹è¯•è¿ç§» (åŸæ ‡é¢˜: Accelerating Large-Scale Test Migration with LLMs)",
      "link": "https://medium.com/airbnb-engineering/accelerating-large-scale-test-migration-with-llms-9565c208023b?source=rss----53c7c27702d5---4",
      "pubDate": "Thu, 13 Mar 2025 17:01:05 GMT",
      "isoDate": "2025-03-13T17:01:05.000Z",
      "creator": "Charles Covey-Brandt",
      "summary": "Airbnbæœ€è¿‘å®Œæˆäº†ä¸€é¡¹ç”±å¤§å‹è¯­è¨€æ¨¡å‹ï¼ˆLLMï¼‰é©±åŠ¨çš„å¤§è§„æ¨¡ä»£ç è¿ç§»ï¼Œå°†è¿‘3500ä¸ªReactç»„ä»¶æµ‹è¯•æ–‡ä»¶ä»Enzymeæ›´æ–°ä¸ºä½¿ç”¨React Testing Library (RTL)ã€‚è¿™é¡¹å·¥ä½œåŸé¢„è®¡éœ€è¦1.5å¹´çš„å·¥ç¨‹æ—¶é—´ï¼Œä½†é€šè¿‡ç»“åˆå‰æ²¿æ¨¡å‹å’Œå¼ºå¤§çš„è‡ªåŠ¨åŒ–ï¼Œä»…ç”¨6å‘¨å°±å®Œæˆäº†æ•´ä¸ªè¿ç§»ã€‚\n\n**èƒŒæ™¯ä¸æŒ‘æˆ˜**\n\n*   **æŠ€æœ¯æ ˆæ¼”è¿›ï¼š** Airbnbè‡ª2020å¹´èµ·ä¸ºæ‰€æœ‰æ–°çš„Reactç»„ä»¶æµ‹è¯•å¼€å‘é‡‡ç”¨äº†RTLï¼Œé€æ­¥æ·˜æ±°Enzymeã€‚\n*   **Enzymeçš„å±€é™æ€§ï¼š** Enzymeè®¾è®¡ç”¨äºæ—©æœŸReactç‰ˆæœ¬ï¼Œå…¶å¯¹ç»„ä»¶å†…éƒ¨çš„æ·±åº¦è®¿é—®ä¸å†ç¬¦åˆç°ä»£Reactæµ‹è¯•å®è·µã€‚\n*   **è¿ç§»éš¾é¢˜ï¼š** ç”±äºEnzymeå’ŒRTLä¹‹é—´çš„æ ¹æœ¬å·®å¼‚ï¼Œæ— æ³•ç®€å•æ›¿æ¢æˆ–åˆ é™¤Enzymeæ–‡ä»¶ï¼Œè¿™ä¼šé€ æˆä»£ç è¦†ç›–ç‡çš„æ˜¾è‘—ç¼ºå¤±ã€‚éœ€è¦ä¸€ç§è‡ªåŠ¨åŒ–æ–¹æ³•æ¥é‡æ„æµ‹è¯•æ–‡ä»¶ï¼ŒåŒæ—¶ä¿ç•™åŸå§‹æµ‹è¯•æ„å›¾å’Œä»£ç è¦†ç›–ç‡ã€‚\n\n**LLMé©±åŠ¨çš„è¿ç§»æ–¹æ¡ˆ**\n\n2023å¹´çš„ä¸€æ¬¡é»‘å®¢é©¬æ‹‰æ¾è¯æ˜LLMèƒ½å¤ŸæˆåŠŸè½¬æ¢Enzymeæ–‡ä»¶ã€‚åœ¨æ­¤åŸºç¡€ä¸Šï¼ŒAirbnbäº2024å¹´å¼€å‘äº†ä¸€ä¸ªå¯æ‰©å±•çš„LLMé©±åŠ¨è¿ç§»ç®¡é“ï¼Œå…¶æ ¸å¿ƒç­–ç•¥åŒ…æ‹¬ï¼š\n\n1.  **æ–‡ä»¶éªŒè¯ä¸é‡æ„æ­¥éª¤**\n    *   å°†è¿ç§»åˆ†è§£ä¸ºä¸€ç³»åˆ—è‡ªåŠ¨åŒ–çš„éªŒè¯å’Œé‡æ„æ­¥éª¤ï¼Œç±»ä¼¼äºç”Ÿäº§æµæ°´çº¿ã€‚\n    *   æµç¨‹è¢«å»ºæ¨¡ä¸ºçŠ¶æ€æœºï¼Œæ–‡ä»¶åªæœ‰åœ¨é€šè¿‡å‰ä¸€é˜¶æ®µçš„éªŒè¯åæ‰èƒ½è¿›å…¥ä¸‹ä¸€é˜¶æ®µï¼Œå¤±è´¥æ—¶LLMä¼šä»‹å…¥ä¿®å¤ã€‚\n    *   è¿™ç§åˆ†æ­¥æ–¹æ³•æä¾›äº†åšå®çš„åŸºç¡€ï¼Œä¾¿äºè·Ÿè¸ªè¿›åº¦ã€æ”¹è¿›ç‰¹å®šæ­¥éª¤çš„å¤±è´¥ç‡ï¼Œå¹¶æ”¯æŒå¹¶å‘å¤„ç†æ•°ç™¾ä¸ªæ–‡ä»¶ã€‚\n    *   ![å›¾ç‰‡ 2](https://cdn-images-1.medium.com/max/587/0*cHwpLgo6nzx8bROe)\n        *   å›¾ç¤ºï¼šä»Enzymeé‡æ„ã€ä¿®å¤Jestã€ä¿®å¤lintå’Œtscï¼Œåˆ°æ ‡è®°æ–‡ä»¶å®Œæˆçš„é‡æ„æ­¥éª¤ã€‚\n\n2.  **é‡è¯•å¾ªç¯ä¸åŠ¨æ€æç¤º**\n    *   æœ€æœ‰æ•ˆçš„æ”¹è¿›ç­–ç•¥æ˜¯â€œæš´åŠ›â€é‡è¯•ï¼šå¤šæ¬¡é‡è¯•æ­¥éª¤ç›´åˆ°é€šè¿‡æˆ–è¾¾åˆ°é™åˆ¶ã€‚\n    *   æ¯æ¬¡é‡è¯•éƒ½ä½¿ç”¨åŠ¨æ€æç¤ºï¼Œå°†éªŒè¯é”™è¯¯å’Œæ–‡ä»¶çš„æœ€æ–°ç‰ˆæœ¬æä¾›ç»™LLMã€‚\n    *   ![å›¾ç‰‡ 3](https://cdn-images-1.medium.com/max/962/0*XtBaesbBgYOBY_uP)\n        *   å›¾ç¤ºï¼šé‡è¯•å¾ªç¯ã€‚å¯¹äºç»™å®šæ­¥éª¤Nï¼Œå¦‚æœæ–‡ä»¶æœ‰é”™è¯¯ï¼Œåˆ™é‡è¯•éªŒè¯å¹¶å°è¯•ä¿®å¤ï¼Œç›´åˆ°è¾¾åˆ°æœ€å¤§é‡è¯•æ¬¡æ•°æˆ–æ–‡ä»¶ä¸å†åŒ…å«é”™è¯¯ã€‚\n    *   æ­¤æ–¹æ³•æˆåŠŸè¿ç§»äº†å¤§é‡ä¸­ä½å¤æ‚åº¦çš„æµ‹è¯•æ–‡ä»¶ï¼Œå¤šæ•°åœ¨10æ¬¡å°è¯•å†…å®Œæˆã€‚\n\n3.  **å¢åŠ ä¸Šä¸‹æ–‡**\n    *   å¯¹äºå¤æ‚æ–‡ä»¶ï¼Œé€šè¿‡å‘æç¤ºä¸­æ³¨å…¥å°½å¯èƒ½å¤šçš„ç›¸å…³ä¸Šä¸‹æ–‡æ¥æé«˜æˆåŠŸç‡ã€‚\n    *   æç¤ºæ‰©å±•åˆ°4ä¸‡è‡³10ä¸‡ä¸ªtokenï¼ŒåŒ…å«å¤šè¾¾50ä¸ªç›¸å…³æ–‡ä»¶ã€æ‰‹åŠ¨ç¼–å†™çš„å°‘é‡ç¤ºä¾‹ä»¥åŠé¡¹ç›®ä¸­ç°æœ‰çš„ä¼˜ç§€æµ‹è¯•æ–‡ä»¶ã€‚\n    *   æ¯ä¸ªæç¤ºåŒ…å«ï¼šè¢«æµ‹ç»„ä»¶çš„æºä»£ç ã€å¾…è¿ç§»çš„æµ‹è¯•æ–‡ä»¶ã€å½“å‰æ­¥éª¤çš„éªŒè¯å¤±è´¥ä¿¡æ¯ã€åŒç›®å½•ä¸‹çš„ç›¸å…³æµ‹è¯•ï¼ˆä¿æŒå›¢é˜Ÿç‰¹å®šæ¨¡å¼ï¼‰ã€é€šç”¨è¿ç§»æŒ‡å—å’Œå¸¸è§è§£å†³æ–¹æ¡ˆã€‚\n    *   è¿™ç§ä¸°å¯Œçš„ä¸Šä¸‹æ–‡æ–¹æ³•å¯¹äºå¤æ‚æ–‡ä»¶éå¸¸æœ‰æ•ˆï¼Œå¸®åŠ©LLMæ›´å¥½åœ°ç†è§£å›¢é˜Ÿæ¨¡å¼å’Œä»£ç åº“æ¶æ„ã€‚\n    *   é¦–æ¬¡æ‰¹é‡è¿è¡Œåœ¨4å°æ—¶å†…æˆåŠŸè¿ç§»äº†75%çš„ç›®æ ‡æ–‡ä»¶ã€‚\n\n4.  **ä»75%åˆ°97%ï¼šç³»ç»Ÿæ€§æ”¹è¿›**\n    *   ä¸ºè§£å†³å‰©ä½™çš„â€œé•¿å°¾â€æ–‡ä»¶ï¼ˆçº¦900ä¸ªï¼‰ï¼Œæ„å»ºäº†ç³»ç»Ÿæ€§æ”¹è¿›å·¥å…·ã€‚\n    *   **å¯è§æ€§ï¼š** è‡ªåŠ¨ç”Ÿæˆä»£ç æ³¨é‡Šï¼Œè®°å½•æ¯ä¸ªè¿ç§»æ­¥éª¤çš„çŠ¶æ€ï¼Œä¾¿äºè¯†åˆ«å¸¸è§é—®é¢˜ã€‚\n    *   **çµæ´»é‡è·‘ï¼š** èƒ½å¤Ÿè½»æ¾é‡è·‘å•ä¸ªæ–‡ä»¶æˆ–æŒ‰ç‰¹å®šæ­¥éª¤è¿‡æ»¤çš„æ–‡ä»¶ã€‚\n    *   é€šè¿‡â€œé‡‡æ ·ã€è°ƒæ•´ã€æ‰«æâ€çš„åé¦ˆå¾ªç¯ï¼šè¿è¡Œæ‰€æœ‰å¤±è´¥æ–‡ä»¶ï¼Œæ‰¾å‡ºLLMå¸¸è§é—®é¢˜ï¼›é€‰æ‹©ä»£è¡¨æ€§æ ·æœ¬ï¼›æ›´æ–°æç¤ºå’Œè„šæœ¬ï¼›å¯¹æ ·æœ¬éªŒè¯ä¿®å¤ï¼›å†æ¬¡å¯¹æ‰€æœ‰å‰©ä½™æ–‡ä»¶è¿è¡Œã€‚\n    *   ç»è¿‡4å¤©çš„æ­¤å¾ªç¯ï¼Œå®Œæˆç‡ä»75%æå‡åˆ°97%ï¼Œä»…å‰©ä¸åˆ°100ä¸ªæ–‡ä»¶ã€‚\n\n**ç»“æœä¸å½±å“**\n\n*   **æ•ˆç‡æ˜¾è‘—æå‡ï¼š** è‡ªåŠ¨åŒ–è¿ç§»äº†3500ä¸ªEnzymeæ–‡ä»¶ä¸­çš„97%ï¼Œä»…ç”¨6å‘¨æ—¶é—´ï¼Œè€Œæ‰‹åŠ¨é¢„è®¡éœ€1.5å¹´ã€‚\n*   **æ‰‹åŠ¨å¹²é¢„ï¼š** å‰©ä½™3%çš„æ–‡ä»¶ï¼ˆçº¦100ä¸ªï¼‰é€šè¿‡è‡ªåŠ¨åŒ–ç”Ÿæˆçš„åŸºçº¿è¿›è¡Œæ‰‹åŠ¨ä¿®å¤ï¼Œé¢å¤–è€—æ—¶ä¸€å‘¨ã€‚\n*   **è´¨é‡ä¿è¯ï¼š** æˆåŠŸæ›¿æ¢Enzymeï¼ŒåŒæ—¶ä¿æŒäº†åŸå§‹æµ‹è¯•æ„å›¾å’Œæ•´ä½“ä»£ç è¦†ç›–ç‡ã€‚\n*   **æˆæœ¬æ•ˆç›Šï¼š** æ€»æˆæœ¬ï¼ˆåŒ…æ‹¬LLM APIä½¿ç”¨å’Œ6å‘¨å·¥ç¨‹æ—¶é—´ï¼‰è¿œä½äºæ‰‹åŠ¨è¿ç§»çš„ä¼°è®¡ã€‚\n*   ![å›¾ç‰‡ 1](https://cdn-images-1.medium.com/max/1024/1*j0QXnA13Sy5ruaIAU5C_eg.jpeg)\n    *   å›¾ç¤ºï¼šAirbnbä½¿ç”¨LLMå°†3500ä¸ªReactç»„ä»¶æµ‹è¯•æ–‡ä»¶ä»Enzymeè¿ç§»åˆ°React Testing Libraryï¼Œå°†é¢„è®¡1.5å¹´çš„å·¥ä½œé‡ç¼©çŸ­è‡³6å‘¨ã€‚\n\n**å±•æœ›**\n\næ­¤æ¬¡è¿ç§»å‡¸æ˜¾äº†LLMåœ¨å¤§è§„æ¨¡ä»£ç è½¬æ¢ä¸­çš„å¼ºå¤§æ½œåŠ›ã€‚Airbnbè®¡åˆ’æ‰©å±•æ­¤æ–¹æ³•ï¼Œå¼€å‘æ›´å¤æ‚çš„è¿ç§»å·¥å…·ï¼Œå¹¶æ¢ç´¢LLMé©±åŠ¨è‡ªåŠ¨åŒ–åœ¨æå‡å¼€å‘è€…ç”Ÿäº§åŠ›æ–¹é¢çš„æ–°åº”ç”¨ã€‚",
      "shortSummary": "Airbnbåˆ©ç”¨å¤§å‹è¯­è¨€æ¨¡å‹ï¼ˆLLMsï¼‰æˆåŠŸåœ°å°†è¿‘3500ä¸ªReactç»„ä»¶æµ‹è¯•æ–‡ä»¶ä»Enzymeè¿ç§»åˆ°React Testing Libraryã€‚é€šè¿‡æ„å»ºè‡ªåŠ¨åŒ–ç®¡é“ã€é‡‡ç”¨é‡è¯•æœºåˆ¶å’Œå¢åŠ ä¸Šä¸‹æ–‡ï¼Œä»–ä»¬å°†åŸé¢„è®¡1.5å¹´çš„æ‰‹åŠ¨å·¥ä½œé‡ç¼©çŸ­è‡³ä»…6å‘¨ï¼Œå¹¶å®ç°äº†97%çš„è‡ªåŠ¨åŒ–è¿ç§»ç‡ã€‚æ­¤ä¸¾æ˜¾è‘—æå‡äº†å¼€å‘æ•ˆç‡ï¼Œå¹¶å±•ç¤ºäº†LLMåœ¨å¤§è§„æ¨¡ä»£ç è½¬æ¢ä¸­çš„å·¨å¤§æ½œåŠ›ã€‚",
      "translated_title": "ä½¿ç”¨å¤§å‹è¯­è¨€æ¨¡å‹åŠ é€Ÿå¤§è§„æ¨¡æµ‹è¯•è¿ç§»",
      "images": [
        {
          "url": "https://cdn-images-1.medium.com/max/1024/1*j0QXnA13Sy5ruaIAU5C_eg.jpeg",
          "alt": "",
          "title": "",
          "position": 1
        },
        {
          "url": "https://cdn-images-1.medium.com/max/587/0*cHwpLgo6nzx8bROe",
          "alt": "",
          "title": "",
          "position": 2
        },
        {
          "url": "https://cdn-images-1.medium.com/max/962/0*XtBaeswbgYOBY_uP",
          "alt": "",
          "title": "",
          "position": 3
        },
        {
          "url": "https://medium.com/_/stat?event=post.clientViewed&referrerSource=full_rss&postId=9565c208023b",
          "alt": "",
          "title": "",
          "position": 4
        }
      ],
      "contentSource": "RSS",
      "content": "<figure><img alt=\"\" src=\"https://cdn-images-1.medium.com/max/1024/1*j0QXnA13Sy5ruaIAU5C_eg.jpeg\" /></figure><p>By: <a href=\"https://www.linkedin.com/in/chazcb\">Charles Covey-Brandt</a></p><p>Airbnb recently completed our first large-scale, LLM-driven code migration, updating nearly 3.5K React component test files from Enzyme to use React Testing Library (RTL) instead. Weâ€™d originally estimated this would take 1.5 years of engineering time to do by hand, butâ€Šâ€”â€Šusing a combination of frontier models and robust automationâ€Šâ€”â€Šwe finished the entire migration in just 6Â weeks.</p><p>In this blog post, weâ€™ll highlight the unique challenges we faced migrating from Enzyme to RTL, how LLMs excel at solving this particular type of challenge, and how we structured our migration tooling to run an LLM-driven migration atÂ scale.</p><h3>Background</h3><p>In 2020, Airbnb adopted React Testing Library (RTL) for all new React component test development, marking our first steps away from Enzyme. Although Enzyme had served us well since 2015, it was designed for earlier versions of React, and the frameworkâ€™s deep access to component internals no longer aligned with modern React testing practices.</p><p>However, because of the fundamental differences between these frameworks, we couldnâ€™t easily swap out one for the other (read more about the differences <a href=\"https://kentcdodds.com/blog/introducing-the-react-testing-library\">here</a>). We also couldnâ€™t just delete the Enzyme files, as analysis showed this would create significant gaps in our code coverage. To complete this migration, we needed an automated way to refactor test files from Enzyme to RTL while preserving the intent of the original tests <em>and</em> their code coverage.</p><h3>How We DidÂ It</h3><p>In mid-2023, an Airbnb hackathon team demonstrated that large language models could successfully convert hundreds of Enzyme files to RTL in just a fewÂ days.</p><p>Building on this promising result, in 2024 we developed a scalable pipeline for an LLM-driven migration. We broke the migration into discrete, per-file steps that we could parallelize, added configurable retry loops, and significantly expanded our prompts with additional context. Finally, we performed breadth-first prompt tuning for the long tail of complexÂ files.</p><h3>1. File Validation and RefactorÂ Steps</h3><p>We started by breaking down the migration into a series of automated validation and refactor steps. Think of it like a production pipeline: each file moves through stages of validation, and when a check fails, we bring in the LLM to fixÂ it.</p><p>We modeled this flow like a state machine, moving the file to the next state only after validation on the previous stateÂ passed:</p><figure><img alt=\"\" src=\"https://cdn-images-1.medium.com/max/587/0*cHwpLgo6nzx8bROe\" /><figcaption>Diagram shows refactor steps from Enzyme refactor, fixing Jest, fixing lint and tsc, and marking file as complete.</figcaption></figure><p>This step-based approach provided a solid foundation for our automation pipeline. It enabled us to track progress, improve failure rates for specific steps, and rerun files or steps when needed. The step-based approach also made it simple to run migrations on hundreds of files concurrently, which was critical for both quickly migrating simple files, and chipping away at the long tail of files later in the migration.</p><h3>2. Retry Loops &amp; Dynamic Prompting</h3><p>Early on in the migration, we experimented with different prompt engineering strategies to improve our per-file migration success rate. However, building on the stepped approach, we found the most effective route to improve outcomes was simply brute force: retry steps multiple times until they passed or we reached a limit. We updated our steps to use dynamic prompts for each retry, giving the validation errors and the most recent version of the file to the LLM, and built a loop runner that ran each step up to a configurable number of attempts.</p><figure><img alt=\"\" src=\"https://cdn-images-1.medium.com/max/962/0*XtBaeswbgYOBY_uP\" /><figcaption><em>Diagram of a retry loop. For a given step N, if the file has errors, we retry validation and attempt to fix errors unless we hit the max retries or the file no longer containsÂ errors.</em></figcaption></figure><p>With this simple retry loop, we found we could successfully migrate a large number of our simple-to-medium complexity test files, with some finishing successfully after a few retries, and most by 10 attempts.</p><h3>3. Increasing theÂ Context</h3><p>For test files up to a certain complexity, just increasing our retry attempts worked well. However, to handle files with intricate test state setups or excessive indirection, we found the best approach was to push as much relevant context as possible into ourÂ prompts.</p><p>By the end of the migration, our prompts had expanded to anywhere between 40,000 to 100,000 tokens, pulling in as many as 50 related files, a whole host of manually written <a href=\"https://docs.anthropic.com/en/docs/build-with-claude/prompt-engineering/multishot-prompting\">few-shot</a> examples, as well as examples of existing, well-written, passing test files from within the sameÂ project.</p><p>Each prompt included:</p><ul><li>The source code of the component underÂ test</li><li>The test file we were migrating</li><li>Validation failures for theÂ step</li><li>Related tests from the same directory (maintaining team-specific patterns)</li><li>General migration guidelines and common solutions</li></ul><p>Hereâ€™s how that looked in practice (significantly trimmed down for readability):</p><pre>// Code example shows a trimmed down version of a prompt <br>// including the raw source code from related files, imports, <br>// examples, the component source itself, and the test file to migrate.<br><br>const prompt = [<br>  &#39;Convert this Enzyme test to React Testing Library:&#39;,<br>  `SIBLING TESTS:\\n${siblingTestFilesSourceCode}`,<br>  `RTL EXAMPLES:\\n${reactTestingLibraryExamples}`,<br>  `IMPORTS:\\n${nearestImportSourceCode}`,<br>  `COMPONENT SOURCE:\\n${componentFileSourceCode}`,<br>  `TEST TO MIGRATE:\\n${testFileSourceCode}`,<br>].join(&#39;\\n\\n&#39;);</pre><p>This rich context approach proved highly effective for these more complex filesâ€Šâ€”â€Šthe LLM could better understand team-specific patterns, common testing approaches, and the overall architecture of the codebase.</p><p>We should note that, although we did some prompt engineering at this step, the main success driver we saw was choosing the <em>right</em> related files (finding nearby files, good example files from the same project, filtering the dependencies for files that were relevant to the component, etc.), rather than getting the prompt engineering perfect.</p><p>After building and testing our migration scripts with retries and rich contexts, when we ran our first bulk run, <strong>we successfully migrated 75% of our target files in just fourÂ hours</strong>.</p><h3>4. From 75% to 97%: Systematic Improvement</h3><p>That 75% success rate was really exciting to get to, but it still left us with nearly 900 files failing our step-based validation criteria. To tackle this long tail, we needed a systematic way to understand where remaining files were getting stuck and improve our migration scripts to address these issues. We also wanted to do this <em>breadth first</em> to aggressively chip away at our remaining files without getting stuck on the most difficult migration cases.</p><p>To do this, we built two features into our migration tooling.</p><p>First, we built a simple system to give us visibility into common issues our scripts were facing by stamping files with an automatically-generated comment to record the status of each migration step. Hereâ€™s what that code comment lookedÂ like:</p><pre>// MIGRATION STATUS: {&quot;enyzme&quot;:&quot;done&quot;,&quot;jest&quot;:{&quot;passed&quot;:8,&quot;failed&quot;:2,&quot;total&quot;:10,&quot;skipped&quot;:0,&quot;successRate&quot;:80},&quot;eslint&quot;:&quot;pending&quot;,&quot;tsc&quot;:&quot;pending&quot;,}</pre><p>And second, we added the ability to easily re-run single files or path patterns, filtered by the specific step they were stuckÂ on:</p><pre>$ llm-bulk-migration --step=fix-jest --match=project-abc/**</pre><p>Using these two features, we could quickly run a feedback loop to improve our prompts andÂ tooling:</p><ol><li>Run all remaining failing files to find common issues the LLM is getting stuckÂ on</li><li>Select a sample of files (5 to 10) that exemplify a commonÂ issue</li><li>Update our prompts and scripts to address thatÂ issue</li><li>Re-run against the sample of failing files to validate ourÂ fix</li><li>Repeat by running against all remaining filesÂ again</li></ol><p>After running this â€œsample, tune, sweepâ€ loop for 4 days, we had pushed our completed files from 75% to 97% of the total files, and had just under 100 files remaining. By this point, we had retried many of these long tail files anywhere between 50 to 100 times, and it seemed we were pushing into a ceiling of what we could fix via automation. Rather than invest in more tuning, we opted to manually fix the remaining files, working from the baseline (failing) refactors to reduce the time to get those files over the finishÂ line.</p><h3>Results andÂ Impact</h3><p>With the validation and refactor pipeline, retry loops, and expanded context in place, we were able to automatically migrate 75% of our target files in 4Â hours.</p><p>After four days of prompt and script refinement using the â€œsample, tune, and sweepâ€ strategy, we reached 97% of the 3.5K original EnzymeÂ files.</p><p>And for the remaining 3% of files that didnâ€™t complete through automation, our scripts provided a great baseline for manual intervention, allowing us to complete the migration for those remaining files in another week ofÂ work.</p><p>Most importantly, we were able to replace Enzyme while maintaining original test intent and our overall code coverage. And even with high retry counts on the long tail of the migration, the total costâ€Šâ€”â€Šincluding LLM API usage and six weeks of engineering timeâ€Šâ€”â€Šproved far more efficient than our original manual migration estimate.</p><h3>Whatâ€™s Next</h3><p>This migration underscores the power of LLMs for large-scale code transformation. We plan to expand this approach, develop more sophisticated migration tools, and explore new applications of LLM-powered automation to enhance developer productivity.</p><p>Want to help shape the future of developer tools? Weâ€™re hiring engineers who love solving complex problems at scale. Check out our <a href=\"https://careers.airbnb.com\">careers page</a> to learnÂ more.</p><h3>****************</h3><p><em>All product names, logos, and brands are property of their respective owners. All company, product and service names used in this website are for identification purposes only. Use of these names, logos, and brands does not imply endorsement.</em></p><img src=\"https://medium.com/_/stat?event=post.clientViewed&referrerSource=full_rss&postId=9565c208023b\" width=\"1\" height=\"1\" alt=\"\"><hr><p><a href=\"https://medium.com/airbnb-engineering/accelerating-large-scale-test-migration-with-llms-9565c208023b\">Accelerating Large-Scale Test Migration with LLMs</a> was originally published in <a href=\"https://medium.com/airbnb-engineering\">The Airbnb Tech Blog</a> on Medium, where people are continuing the conversation by highlighting and responding to this story.</p>"
    },
    {
      "title": "æ”¹è¿›åœ°å›¾æœç´¢æ’å (åŸæ ‡é¢˜: Improving Search Ranking for Maps)",
      "link": "https://medium.com/airbnb-engineering/improving-search-ranking-for-maps-13b03f2c2cca?source=rss----53c7c27702d5---4",
      "pubDate": "Wed, 18 Dec 2024 18:02:37 GMT",
      "isoDate": "2024-12-18T18:02:37.000Z",
      "creator": "Malay Haldar",
      "summary": "## æ”¹è¿›Airbnbåœ°å›¾æœç´¢æ’å\n\nAirbnbçš„æœç´¢ç»“æœé€šè¿‡ä¸¤ç§ç•Œé¢å±•ç¤ºï¼šåˆ—è¡¨è§†å›¾ï¼ˆlist-resultsï¼‰å’Œåœ°å›¾è§†å›¾ï¼ˆmap-resultsï¼‰ã€‚æœ€åˆï¼Œä¸¤è€…çš„æ ¸å¿ƒæ’åç®—æ³•ç›¸åŒï¼Œéƒ½åŸºäºæˆ¿æºçš„é¢„è®¢æ¦‚ç‡ã€‚ç„¶è€Œï¼Œé’ˆå¯¹åˆ—è¡¨è§†å›¾è®¾è®¡çš„æ’åå‡è®¾åœ¨åœ°å›¾è§†å›¾ä¸­ä¸å†é€‚ç”¨ï¼Œå› ä¸ºåœ°å›¾ä¸Šçš„æˆ¿æºæ˜¯åˆ†æ•£çš„ï¼Œæ²¡æœ‰å›ºå®šçš„æ’åé¡ºåºï¼Œç”¨æˆ·æ³¨æ„åŠ›ä¹Ÿä¸ä¼šåƒåˆ—è¡¨é‚£æ ·ä»ä¸Šåˆ°ä¸‹è¡°å‡ã€‚\n\n### åœ°å›¾è§†å›¾çš„ç‹¬ç‰¹ä¹‹å¤„\n\n*   **åˆ—è¡¨è§†å›¾ï¼š** ç”¨æˆ·æ³¨æ„åŠ›ä»åˆ—è¡¨é¡¶éƒ¨å¼€å§‹è¡°å‡ï¼Œè¶Šå¾€ä¸‹å…³æ³¨åº¦è¶Šä½ã€‚æ’åç®—æ³•é€šè¿‡é¢„è®¢æ¦‚ç‡å¯¹æˆ¿æºè¿›è¡Œæ’åºï¼Œä»¥æœ€å¤§åŒ–ç”¨æˆ·ä¸æˆ¿ä¸œçš„è¿æ¥ã€‚ \n    ![å›¾1ï¼šæŒ‰æˆ¿æºæœç´¢æ’ååˆ’åˆ†çš„ç‚¹å‡»ç‡](https://cdn-images-1.medium.com/max/1024/0*Y9drAzLenJ9GAYEA)\n*   **åœ°å›¾è§†å›¾ï¼š** æˆ¿æºä»¥å›¾é’‰å½¢å¼æ•£å¸ƒåœ¨åœ°å›¾ä¸Šï¼Œæ²¡æœ‰å›ºå®šçš„æ’ååˆ—è¡¨ï¼Œç”¨æˆ·æ³¨æ„åŠ›ä¹Ÿä¸ä¼šå› æ’åä½ç½®è€Œè¡°å‡ã€‚å› æ­¤ï¼Œç›´æ¥æŒ‰é¢„è®¢æ¦‚ç‡æ’åºçš„ç­–ç•¥ä¸å†é€‚ç”¨ã€‚ \n    ![å›¾2ï¼šåœ°å›¾ç»“æœ](https://cdn-images-1.medium.com/max/624/0*6iaMrBpbSQjVnsLF)\n\n### é€æ­¥ä¼˜åŒ–ç”¨æˆ·æ³¨æ„åŠ›æ¨¡å‹\n\nä¸ºäº†é€‚åº”åœ°å›¾ç•Œé¢ï¼ŒAirbnbé€æ­¥æ”¹è¿›äº†ç”¨æˆ·æ³¨æ„åŠ›æ¨¡å‹ï¼š\n\n#### 1. å‡åŒ€ç”¨æˆ·æ³¨æ„åŠ›æ¨¡å‹\n\n*   **å‡è®¾ï¼š** åˆå§‹å‡è®¾ç”¨æˆ·æ³¨æ„åŠ›å‡åŒ€åˆ†å¸ƒåœ¨æ‰€æœ‰åœ°å›¾å›¾é’‰ä¸Šã€‚ç„¶è€Œï¼Œç”¨æˆ·ç‚¹å‡»çš„å›¾é’‰æ•°é‡æœ‰é™ï¼Œå¤§é‡å›¾é’‰å¯èƒ½å¯¼è‡´ç”¨æˆ·é”™è¿‡æœ€ä½³é€‰æ‹©ã€‚ \n    ![å›¾3ï¼šæŒ‰æœç´¢è€…ç™¾åˆ†æ¯”åˆ’åˆ†çš„ç‚¹å‡»ä¸åŒåœ°å›¾å›¾é’‰æ•°é‡](https://cdn-images-1.medium.com/max/1024/0*Vi5l4XPrl3YdHsP0)\n*   **è§£å†³æ–¹æ¡ˆï¼š** å¼•å…¥ä¸€ä¸ªå‚æ•°ï¼Œé™åˆ¶æ‰€é€‰åœ°å›¾å›¾é’‰ä¸­æœ€é«˜é¢„è®¢æ¦‚ç‡ä¸æœ€ä½é¢„è®¢æ¦‚ç‡çš„æ¯”ç‡ã€‚é™åˆ¶è¶Šä¸¥æ ¼ï¼Œæ˜¾ç¤ºçš„åœ°å›¾å›¾é’‰çš„å¹³å‡é¢„è®¢æ¦‚ç‡è¶Šé«˜ã€‚\n*   **æ•ˆæœï¼š** é€šè¿‡A/Bæµ‹è¯•ï¼Œé™åˆ¶ç‰ˆæœ¬æ˜¾è‘—æå‡äº†é¢„è®¢é‡ï¼Œå°¤å…¶æ˜¯é«˜è´¨é‡é¢„è®¢ï¼ˆ5æ˜Ÿè¯„ä»·çš„è¡Œç¨‹å¢åŠ ï¼‰ï¼Œå¹¶å‡å°‘äº†ç”¨æˆ·å‘ç°æ‰€éœ€æˆ¿æºæ‰€éœ€çš„å°è±¡æ•°å’Œç‚¹å‡»æ•°ã€‚ \n    ![å›¾4ï¼šé€šè¿‡åœ¨çº¿A/Bå®éªŒè¿›è¡Œæ¢ç´¢](https://cdn-images-1.medium.com/max/1024/0*trGxNfKu4rHa4Gpx)\n\n#### 2. åˆ†å±‚ç”¨æˆ·æ³¨æ„åŠ›æ¨¡å‹\n\n*   **èƒŒæ™¯ï¼š** åœ¨æ¡Œé¢æœç´¢ä¸­ï¼Œå·¦ä¾§é€šå¸¸æ˜¾ç¤ºå›ºå®šæ•°é‡ï¼ˆä¾‹å¦‚18ä¸ªï¼‰çš„åˆ—è¡¨ç»“æœï¼Œæ¯ä¸ªç»“æœéƒ½éœ€è¦ä¸€ä¸ªå¯¹åº”çš„åœ°å›¾å›¾é’‰ï¼Œå› æ­¤æ— æ³•ç®€å•é™åˆ¶å›¾é’‰æ•°é‡ã€‚ \n    ![å›¾6ï¼šæ¡Œé¢æœç´¢ç»“æœ](https://cdn-images-1.medium.com/max/1024/0*A83SEjyDlyTUCI06)\n*   **è§£å†³æ–¹æ¡ˆï¼š** å°†åœ°å›¾å›¾é’‰åˆ†ä¸ºä¸¤å±‚ï¼š\n    *   **å¸¸è§„æ¤­åœ†å½¢å›¾é’‰ï¼ˆå¸¦ä»·æ ¼ï¼‰ï¼š** ç”¨äºé¢„è®¢æ¦‚ç‡æœ€é«˜çš„æˆ¿æºã€‚\n    *   **è¿·ä½ å›¾é’‰ï¼ˆä¸å¸¦ä»·æ ¼ï¼‰ï¼š** ç”¨äºé¢„è®¢æ¦‚ç‡ç›¸å¯¹è¾ƒä½çš„æˆ¿æºã€‚è¿·ä½ å›¾é’‰çš„ç‚¹å‡»ç‡æ¯”å¸¸è§„å›¾é’‰ä½çº¦8å€ï¼Œä»è€Œå¼•å¯¼ç”¨æˆ·æ³¨æ„åŠ›ã€‚ \n        ![å›¾5ï¼šå¸¦ä»·æ ¼çš„æ¤­åœ†å½¢å›¾é’‰å’Œè¿·ä½ å›¾é’‰](https://cdn-images-1.medium.com/max/1024/0*pkL4ovuWpR1Rz9z-)\n*   **æ•ˆæœï¼š** é€šè¿‡A/Bå®éªŒï¼Œè¯¥æ–¹æ³•æˆåŠŸå°†ç”¨æˆ·æ³¨æ„åŠ›ä¼˜å…ˆå¼•å‘é¢„è®¢æ¦‚ç‡æœ€é«˜çš„æˆ¿æºã€‚ \n    ![å›¾7ï¼šåˆ†å±‚åœ°å›¾å›¾é’‰çš„å®éªŒç»“æœ](https://cdn-images-1.medium.com/max/842/0*1V-XbGegLzPch25O)\n\n#### 3. æŠ˜æ‰£ç”¨æˆ·æ³¨æ„åŠ›æ¨¡å‹\n\n*   **æ´å¯Ÿï¼š** é€šè¿‡ç»˜åˆ¶åœ°å›¾ä¸Šä¸åŒåæ ‡å¤„å›¾é’‰çš„ç‚¹å‡»ç‡ï¼Œå‘ç°ç”¨æˆ·æ³¨æ„åŠ›å¹¶éå®Œå…¨å‡åŒ€ï¼Œè€Œæ˜¯éšä½ç½®å˜åŒ–ï¼ˆç§»åŠ¨ç«¯å’Œæ¡Œé¢ç«¯æœ‰æ‰€ä¸åŒï¼‰ã€‚ \n    ![å›¾8ï¼šåœ°å›¾åæ ‡ä¸Šåœ°å›¾å›¾é’‰çš„ç‚¹å‡»ç‡](https://cdn-images-1.medium.com/max/598/0*rDDubemWn97XvCN2)\n    ![å›¾8ï¼šåœ°å›¾åæ ‡ä¸Šåœ°å›¾å›¾é’‰çš„ç‚¹å‡»ç‡](https://cdn-images-1.medium.com/max/602/0*I9GtvJEw5BGfHn96)\n*   **è§£å†³æ–¹æ¡ˆï¼š** è®¾è®¡ç®—æ³•é‡æ–°å®šä½åœ°å›¾ä¸­å¿ƒï¼Œä½¿é¢„è®¢æ¦‚ç‡æœ€é«˜çš„æˆ¿æºæ›´é è¿‘ä¸­å¿ƒã€‚ç®—æ³•è¯„ä¼°ä¸€ç³»åˆ—æ½œåœ¨åæ ‡ï¼Œé€‰æ‹©æœ€æ¥è¿‘é«˜é¢„è®¢æ¦‚ç‡æˆ¿æºçš„ä½œä¸ºæ–°ä¸­å¿ƒã€‚ \n    ![å›¾9ï¼šå¯»æ‰¾æœ€ä¼˜ä¸­å¿ƒçš„ç®—æ³•](https://cdn-images-1.medium.com/max/1024/0*IqlsENiSd-9IdQ5v)\n*   **æ•ˆæœï¼š** åœ¨çº¿A/Bå®éªŒæ˜¾ç¤ºï¼Œè¯¥ç®—æ³•ä½¿æœªå–æ¶ˆé¢„è®¢é‡æå‡0.27%ï¼Œåœ°å›¾ç§»åŠ¨æ¬¡æ•°å‡å°‘1.5%ï¼Œè¡¨æ˜ç”¨æˆ·ä½¿ç”¨åœ°å›¾çš„åŠªåŠ›ç¨‹åº¦é™ä½ã€‚\n\n### ç»“è®ºä¸å±•æœ›\n\nç”¨æˆ·ä¸åœ°å›¾çš„äº¤äº’æ–¹å¼ä¸åˆ—è¡¨æˆªç„¶ä¸åŒã€‚é€šè¿‡é€æ­¥ç²¾ç»†åŒ–ç”¨æˆ·ä¸åœ°å›¾çš„äº¤äº’æ¨¡å‹ï¼ŒAirbnbæ˜¾è‘—æ”¹å–„äº†ç”¨æˆ·çš„å®é™…ä½“éªŒã€‚ç„¶è€Œï¼Œå½“å‰æ–¹æ³•ä»é¢ä¸´æŒ‘æˆ˜ï¼šå¦‚ä½•åœ¨åœ°å›¾ä¸Šå±•ç¤ºæ‰€æœ‰å¯ç”¨æˆ¿æºï¼Ÿè¿™å°†æ˜¯æœªæ¥çš„å·¥ä½œé‡ç‚¹ã€‚æ›´æ·±å…¥çš„æŠ€æœ¯ç»†èŠ‚å·²åœ¨KDD '24ä¼šè®®ä¸Šå‘è¡¨çš„ç ”ç©¶è®ºæ–‡ä¸­è®¨è®ºã€‚",
      "shortSummary": "Airbnbæ”¹è¿›äº†å…¶åœ°å›¾æœç´¢æ’åç®—æ³•ï¼Œä»¥é€‚åº”åœ°å›¾ç•Œé¢ä¸åˆ—è¡¨ç•Œé¢çš„æ ¹æœ¬å·®å¼‚ã€‚é’ˆå¯¹åœ°å›¾ä¸Šç”¨æˆ·æ³¨æ„åŠ›åˆ†å¸ƒçš„ç‰¹ç‚¹ï¼Œå›¢é˜Ÿè¿­ä»£å¼€å‘äº†ä¸‰ç§æ¨¡å‹ï¼šé¦–å…ˆï¼Œé€šè¿‡é™åˆ¶å›¾é’‰é¢„è®¢æ¦‚ç‡èŒƒå›´ï¼Œæå‡äº†é¢„è®¢é‡å’Œé¢„è®¢è´¨é‡ï¼›å…¶æ¬¡ï¼Œåœ¨å›ºå®šå›¾é’‰æ•°é‡çš„åœºæ™¯ä¸‹ï¼Œå¼•å…¥åˆ†å±‚å›¾é’‰ï¼ˆå¸¸è§„å›¾é’‰å’Œè¿·ä½ å›¾é’‰ï¼‰ä»¥å¼•å¯¼ç”¨æˆ·æ³¨æ„åŠ›ï¼›æœ€åï¼Œé€šè¿‡ç®—æ³•é‡æ–°å®šä½åœ°å›¾ä¸­å¿ƒï¼Œä½¿é«˜é¢„è®¢æ¦‚ç‡æˆ¿æºæ›´é è¿‘ä¸­å¿ƒï¼Œè¿›ä¸€æ­¥ä¼˜åŒ–äº†ç”¨æˆ·ä½“éªŒå¹¶å‡å°‘äº†æ“ä½œã€‚è¿™äº›æ”¹è¿›æ˜¾è‘—æå‡äº†ç”¨æˆ·ä½“éªŒå’Œé¢„è®¢è½¬åŒ–ç‡ï¼Œä½†å¦‚ä½•åœ¨åœ°å›¾ä¸Šå±•ç¤ºæ‰€æœ‰æˆ¿æºä»æ˜¯æœªæ¥çš„æŒ‘æˆ˜ã€‚",
      "translated_title": "æ”¹è¿›åœ°å›¾æœç´¢æ’å",
      "images": [
        {
          "url": "https://cdn-images-1.medium.com/max/1024/0*DO7m1JZFPSvVRlBG",
          "alt": "",
          "title": "",
          "position": 1
        },
        {
          "url": "https://cdn-images-1.medium.com/max/1024/0*Y9drAzLenJ9GAYEA",
          "alt": "",
          "title": "",
          "position": 2
        },
        {
          "url": "https://cdn-images-1.medium.com/max/624/0*6iaMrBpbSQjVnsLF",
          "alt": "",
          "title": "",
          "position": 3
        },
        {
          "url": "https://cdn-images-1.medium.com/max/1024/0*Vi5l4XPrl3YdHsP0",
          "alt": "",
          "title": "",
          "position": 4
        },
        {
          "url": "https://cdn-images-1.medium.com/max/1024/0*trGxNfKu4rHa4Gpx",
          "alt": "",
          "title": "",
          "position": 5
        }
      ],
      "contentSource": "RSS",
      "content": "<p>How Airbnb is adapting ranking for our map interface.</p><figure><img alt=\"\" src=\"https://cdn-images-1.medium.com/max/1024/0*DO7m1JZFPSvVRlBG\" /></figure><p><a href=\"https://www.linkedin.com/in/malayhaldar/\">Malay Haldar</a>, <a href=\"https://www.linkedin.com/in/hongwei-zhang-86b15624/\">Hongwei Zhang</a>, <a href=\"https://www.linkedin.com/in/kedar-bellare-3048128a/\">Kedar Bellare</a> <a href=\"https://www.linkedin.com/in/sherrytchen/\">SherryÂ Chen</a></p><p>Search is the core mechanism that connects guests with Hosts at Airbnb. Results from a guestâ€™s search for listings are displayed through two interfaces: (1) as a list of rectangular cards that contain the listing image, price, rating, and other details on it, referred to as <em>list-results</em> and (2) as oval pins on a map showing the listing price, called <em>map-results</em>. Since its inception, the core of the ranking algorithm that powered both these interfaces was the sameâ€Šâ€”â€Šordering listings by their booking probabilities and selecting the top listings forÂ display.</p><p>But some of the basic assumptions underlying ranking, built for a world where search results are presented as lists, simply break down forÂ maps.</p><h3>What Is Different AboutÂ Maps?</h3><p>The central concept that drives ranking for list-results is that <em>user attention decays</em> starting from the top of the list, going down towards the bottom. A plot of rank vs click-through rates in Figure 1 illustrates this concept. X-axis represents the rank of listings in search results. Y-axis represents the click-through rate (CTR) for listings at the particular rank.</p><figure><img alt=\"\" src=\"https://cdn-images-1.medium.com/max/1024/0*Y9drAzLenJ9GAYEA\" /><figcaption>Figure 1: Click-through rates by listing searchÂ rank</figcaption></figure><p>To maximize the connections between guests and Hosts, the ranking algorithm sorts listings by their booking probabilities based on a <a href=\"https://www.airbnb.com/help/article/39\">number of factors</a> and sequentially assigns their position in the list-results. This often means that the larger a listingâ€™s booking probability, the more attention it receives from searchers.</p><p>But in map-results, listings are scattered as pins over an area (see Figure 2). There is no ranked list, and there is no decay of user attention by ranking position. Therefore, for listings that are shown on the map, the strategy of sorting by booking probabilities is no longer applicable.</p><figure><img alt=\"\" src=\"https://cdn-images-1.medium.com/max/624/0*6iaMrBpbSQjVnsLF\" /><figcaption>Figure 2: MapÂ results</figcaption></figure><h3>Uniform User Attention</h3><p>To adapt ranking to the map interface, we look at new ways of modeling user attention flow across a map. We start with the most straightforward assumption that user attention is spread equally across the map pins. User attention is a very precious commodity and most searchers only click through a few map pins (see Figure 3). A large number of pins on the map means those limited clicks may miss discovering the best options available. Conversely, limiting the number of pins to the topmost choices increases the probability of the searcher finding something suitable, but runs the risk of removing their preferred choice.</p><figure><img alt=\"\" src=\"https://cdn-images-1.medium.com/max/1024/0*Vi5l4XPrl3YdHsP0\" /><figcaption>Figure 3: Number of distinct map pins clicked by percentage of searchers</figcaption></figure><p>We test this hypothesis, controlled by a parameterÂ . The parameter serves as an upper bound on the ratio of the highest booking probability vs the lowest booking probability when selecting the map pins. The bounds set by the parameter controls the booking probability of the listings behind the map pins. The more restricted the bounds, the higher the average booking probability of the listings presented as map pins. Figure 4 summarizes the results from A/B testing a range of parameters.</p><p>The reduction in the average impressions to discovery metric in Figure 4 denotes the fewer number of map pins a searcher has to process before clicking the listing that they eventually book. Similarly, the reduction in average clicks to discovery shows the fewer number of map pins a searcher has to click through to find the listing theyÂ booked.</p><figure><img alt=\"\" src=\"https://cdn-images-1.medium.com/max/1024/0*trGxNfKu4rHa4Gpx\" /><figcaption>Figure 4: Exploring through online A/B experiments</figcaption></figure><p>Launching the restricted version resulted in one of the largest bookings improvement in Airbnb ranking history. More importantly, the gains were not only for bookings, but for quality bookings. This could be seen by the increase in trips that resulted in 5-star rating after the stay from the treatment group, in comparison to trips from the controlÂ group.</p><h3>Tiered User Attention</h3><p>In our next iteration of modeling user attention, we separate the map pins into two tiers. The listings with the highest booking probabilities are displayed as regular oval pins with price. Listings with comparatively lower booking probabilities are displayed as smaller ovals without price, referred to as mini-pins (Figure 5). By design, mini-pins draw less user attention, with click-through rates about 8x less than regularÂ pins.</p><figure><img alt=\"\" src=\"https://cdn-images-1.medium.com/max/1024/0*pkL4ovuWpR1Rz9z-\" /><figcaption>Figure 5: Oval pins with price and mini-pins</figcaption></figure><p>This comes in handy particularly for searches on desktop where 18 results are shown in a grid on the left, each of them requiring a map pin on the right (FigureÂ 6).</p><figure><img alt=\"\" src=\"https://cdn-images-1.medium.com/max/1024/0*A83SEjyDlyTUCI06\" /><figcaption>Figure 6: Search results onÂ desktop</figcaption></figure><p>The number of map pins is fixed in this case, and limiting them, as we did in the previous section, is not an option. Creating the two tiers prioritizes user attention towards the map pins with the highest probabilities of getting booked. Figure 7 shows the results of testing the idea through an online A/B experiment.</p><figure><img alt=\"\" src=\"https://cdn-images-1.medium.com/max/842/0*1V-XbGegLzPch25O\" /><figcaption>Figure 7: Experiment results for tiered mapÂ pins</figcaption></figure><h3>Discounted User Attention</h3><p>In our final iteration, we refine our understanding of how user attention is distributed over the map by plotting the click-through rate of map pins located at different coordinates on the map. Figure 8 shows these plots for the mobile (top) and the desktop apps (bottom).</p><figure><img alt=\"\" src=\"https://cdn-images-1.medium.com/max/598/0*rDDubemWn97XvCN2\" /></figure><figure><img alt=\"\" src=\"https://cdn-images-1.medium.com/max/602/0*I9GtvJEw5BGfHn96\" /><figcaption>Figure 8: Click-through rates of map pins across map coordinates.</figcaption></figure><p>To maximize the chances that a searcher will discover the listings with the highest booking probabilities, we design an algorithm that re-centers the map such that the listings with the highest booking probabilities appear closer to the center. The steps of this algorithm are illustrated in Figure 9, where a range of potential coordinates are evaluated and the one which is closer to the listings with the highest booking probabilities is chosen as the newÂ center.</p><figure><img alt=\"\" src=\"https://cdn-images-1.medium.com/max/1024/0*IqlsENiSd-9IdQ5v\" /><figcaption>Figure 9: Algorithm for finding optimalÂ center</figcaption></figure><p>When tested in an online A/B experiment, the algorithm improved uncancelled bookings by 0.27%. We also observed a reduction of 1.5% in map moves, indicating less effort from the searchers to use theÂ map.</p><h3>Conclusion</h3><p>Users interact with maps in a way thatâ€™s fundamentally different from interacting with items in a list. By modeling the user interaction with maps in a progressively sophisticated manner, we were able to improve the user experience for guests in the real world. However, the current approach has a challenge that remains unsolved: how can we represent the full range of available listings on the map? This is part of our future work. A more in-depth discussion of the topics covered here, along with technical details, is presented in our research paper that was <a href=\"https://arxiv.org/pdf/2407.00091\">published at the <strong>KDD â€™24</strong> conference</a>. We welcome all feedback and suggestions.</p><p>If this type of work interests you, we encourage you to apply for an<a href=\"https://careers.airbnb.com/\"> open position</a>Â today.</p><img src=\"https://medium.com/_/stat?event=post.clientViewed&referrerSource=full_rss&postId=13b03f2c2cca\" width=\"1\" height=\"1\" alt=\"\"><hr><p><a href=\"https://medium.com/airbnb-engineering/improving-search-ranking-for-maps-13b03f2c2cca\">Improving Search Ranking for Maps</a> was originally published in <a href=\"https://medium.com/airbnb-engineering\">The Airbnb Tech Blog</a> on Medium, where people are continuing the conversation by highlighting and responding to this story.</p>"
    }
  ],
  "lastUpdated": "2025-08-29T04:33:23.079Z"
}